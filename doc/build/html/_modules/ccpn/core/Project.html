
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ccpn.core.Project &#8212; Python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Python  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ccpn.core.Project</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.core.Project</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (https://www.ccpn.ac.uk) 2014 - 2022&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Ed Brooksbank, Joanna Fox, Victoria A Higman, Luca Mureddu, Eliza Płoskoń&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Timothy J Ragan, Brian O Smith, Gary S Thompson &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See https://ccpn.ac.uk/software/licensing/&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Skinner, S.P., Fogh, R.H., Boucher, W., Ragan, T.J., Mureddu, L.G., &amp; Vuister, G.W.&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;CcpNmr AnalysisAssign: a flexible platform for integrated NMR analysis&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;J.Biomol.Nmr (2016), 66, 111-124, http://doi.org/10.1007/s10858-016-0060-y&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: Ed Brooksbank $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2022-07-05 13:20:37 +0100 (Tue, July 05, 2022) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.1.0 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:41 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="c1"># import os</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="c1"># from time import time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">ccpn.core._implementation.AbstractWrapperObject</span> <span class="kn">import</span> <span class="n">AbstractWrapperObject</span>
<span class="kn">from</span> <span class="nn">ccpn.core._implementation.Updater</span> <span class="kn">import</span> <span class="n">UPDATE_POST_PROJECT_INITIALISATION</span>
<span class="kn">from</span> <span class="nn">ccpn.core._implementation.V3CoreObjectABC</span> <span class="kn">import</span> <span class="n">V3CoreObjectABC</span>

<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">Pid</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">Undo</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.ProjectSaveHistory</span> <span class="kn">import</span> <span class="n">getProjectSaveHistory</span><span class="p">,</span> <span class="n">fetchProjectSaveHistory</span><span class="p">,</span> <span class="n">newProjectSaveHistory</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.ContextManagers</span> <span class="kn">import</span> <span class="n">notificationBlanking</span><span class="p">,</span> <span class="n">undoBlock</span><span class="p">,</span> <span class="n">undoBlockWithoutSideBar</span><span class="p">,</span> \
    <span class="n">inactivity</span><span class="p">,</span> <span class="n">logCommandManager</span>

<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Logging</span>
<span class="kn">from</span> <span class="nn">ccpn.util.ExcelReader</span> <span class="kn">import</span> <span class="n">ExcelReader</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Path</span> <span class="kn">import</span> <span class="n">aPath</span><span class="p">,</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">ccpn.util.decorators</span> <span class="kn">import</span> <span class="n">logCommand</span>

<span class="kn">from</span> <span class="nn">ccpn.framework.lib.pipeline.PipelineBase</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">ccpn.framework.PathsAndUrls</span> <span class="kn">import</span> <span class="n">CCPN_EXTENSION</span>
<span class="kn">from</span> <span class="nn">ccpn.framework.PathsAndUrls</span> <span class="kn">import</span> \
    <span class="n">CCPN_ARCHIVES_DIRECTORY</span><span class="p">,</span> \
    <span class="n">CCPN_STATE_DIRECTORY</span><span class="p">,</span> \
    <span class="n">CCPN_DATA_DIRECTORY</span><span class="p">,</span> \
    <span class="n">CCPN_SPECTRA_DIRECTORY</span><span class="p">,</span> \
    <span class="n">CCPN_PLUGINS_DIRECTORY</span><span class="p">,</span> \
    <span class="n">CCPN_SCRIPTS_DIRECTORY</span><span class="p">,</span> \
    <span class="n">CCPN_SUB_DIRECTORIES</span>

<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.api.ccp.nmr.Nmr</span> <span class="kn">import</span> <span class="n">NmrProject</span> <span class="k">as</span> <span class="n">ApiNmrProject</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops</span> <span class="kn">import</span> <span class="n">Notifiers</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.ApiError</span> <span class="kn">import</span> <span class="n">ApiError</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.molecule</span> <span class="kn">import</span> <span class="n">MoleculeQuery</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.spectrum</span> <span class="kn">import</span> <span class="n">NmrExpPrototype</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.api.ccp.nmr.NmrExpPrototype</span> <span class="kn">import</span> <span class="n">RefExperiment</span>
<span class="c1"># from ccpnmodel.ccpncore.lib import Constants</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Api</span> <span class="k">as</span> <span class="n">apiIo</span>
<span class="c1"># from ccpnmodel.ccpncore.lib.Io import Formats as ioFormats</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib</span> <span class="kn">import</span> <span class="n">ApiPath</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Fasta</span> <span class="k">as</span> <span class="n">fastaIo</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.api.memops</span> <span class="kn">import</span> <span class="n">Implementation</span>


<span class="c1"># TODO These should be merged with the same constants in CcpnNefIo</span>
<span class="c1"># (and likely those in ExportNefPopup) and moved elsewhere</span>
<span class="n">CHAINS</span> <span class="o">=</span> <span class="s1">&#39;chains&#39;</span>
<span class="n">CHEMICALSHIFTLISTS</span> <span class="o">=</span> <span class="s1">&#39;chemicalShiftLists&#39;</span>
<span class="n">RESTRAINTTABLES</span> <span class="o">=</span> <span class="s1">&#39;restraintTables&#39;</span>
<span class="n">PEAKLISTS</span> <span class="o">=</span> <span class="s1">&#39;peakLists&#39;</span>
<span class="n">INTEGRALLISTS</span> <span class="o">=</span> <span class="s1">&#39;integralLists&#39;</span>
<span class="n">MULTIPLETLISTS</span> <span class="o">=</span> <span class="s1">&#39;multipletLists&#39;</span>
<span class="n">SAMPLES</span> <span class="o">=</span> <span class="s1">&#39;samples&#39;</span>
<span class="n">SUBSTANCES</span> <span class="o">=</span> <span class="s1">&#39;substances&#39;</span>
<span class="n">NMRCHAINS</span> <span class="o">=</span> <span class="s1">&#39;nmrChains&#39;</span>
<span class="c1"># DATASETS = &#39;dataSets&#39;</span>
<span class="n">STRUCTUREDATA</span> <span class="o">=</span> <span class="s1">&#39;structureData&#39;</span>
<span class="n">COMPLEXES</span> <span class="o">=</span> <span class="s1">&#39;complexes&#39;</span>
<span class="n">SPECTRUMGROUPS</span> <span class="o">=</span> <span class="s1">&#39;spectrumGroups&#39;</span>
<span class="n">NOTES</span> <span class="o">=</span> <span class="s1">&#39;notes&#39;</span>
<span class="n">PEAKCLUSTERS</span> <span class="o">=</span> <span class="s1">&#39;peakClusters&#39;</span>
<span class="n">COLLECTIONS</span> <span class="o">=</span> <span class="s1">&#39;collections&#39;</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="n">AbstractWrapperObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The Project is the object that contains all data objects and serves as the hub for</span>
<span class="sd">    navigating between them.</span>

<span class="sd">    There are 15 top-level data objects directly within a project, of which 8 have child</span>
<span class="sd">    objects of their own, e.g. Spectrum, Sample, Chain, NmrChain, ChemicalShiftList, DataSet</span>
<span class="sd">    and StructureEnsemble. The child data objects are organised in a logical hierarchy; for example,</span>
<span class="sd">    a Spectrum has PeakLists, which in turn, are made up of Peaks, whereas a Chain is made up of Residues,</span>
<span class="sd">    which are made up of Atoms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Short class name, for PID.</span>
    <span class="n">shortClassName</span> <span class="o">=</span> <span class="s1">&#39;PR&#39;</span>
    <span class="c1"># Attribute it necessary as subclasses must use superclass className</span>
    <span class="n">className</span> <span class="o">=</span> <span class="s1">&#39;Project&#39;</span>

    <span class="c1">#: Name of plural link to instances of class</span>
    <span class="n">_pluralLinkName</span> <span class="o">=</span> <span class="s1">&#39;projects&#39;</span>

    <span class="c1">#: List of child classes.</span>
    <span class="n">_childClasses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># All non-abstractWrapperClasses - filled in by</span>
    <span class="n">_allLinkedWrapperClasses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Utility map - class shortName and longName to class.</span>
    <span class="n">_className2Class</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># 20211113:ED - added extra for searching the Collection objects as these are immutable</span>
    <span class="n">_classNameLower2Class</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_className2ClassList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_classNameLower2ClassList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># List of CCPN pre-registered api notifiers</span>
    <span class="c1"># Format is (wrapperFuncName, parameterDict, apiClassName, apiFuncName)</span>
    <span class="c1">#</span>
    <span class="c1"># The function self.wrapperFuncName(**parameterDict) will be registered in the CCPN api notifier system</span>
    <span class="c1"># api notifiers are set automatically, and are cleared by self._clearAllApiNotifiers and by self.delete()</span>
    <span class="c1">#</span>
    <span class="c1"># RESTRICTED. Direct access in core classes ONLY</span>
    <span class="n">_apiNotifiers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Actions you can notify</span>
    <span class="n">_notifierActions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">)</span>

    <span class="c1"># Qualified name of matching API class</span>
    <span class="n">_apiClassQualifiedName</span> <span class="o">=</span> <span class="n">ApiNmrProject</span><span class="o">.</span><span class="n">_metaclass</span><span class="o">.</span><span class="n">qualifiedName</span><span class="p">()</span>

    <span class="c1"># Top level mapping dictionaries:</span>
    <span class="c1"># pid to object and ccpnData to object</span>
    <span class="c1">#__slots__ = [&#39;_pid2Obj&#39;, &#39;_data2Obj&#39;]</span>

    <span class="c1"># Needs to know this for restoring the GuiSpectrum Module. Could be removed after decoupling Gui and Data!</span>
    <span class="n">_isNew</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#-----------------------------------------------------------------------------------------</span>
    <span class="c1"># Attributes of the data structure (incomplete)</span>
    <span class="c1">#-----------------------------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">peakLists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">multipletLists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">integralLists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectrumViews</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chemicalShiftLists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">restraintTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">violationTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">substances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nmrChains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structureData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">complexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectrumGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">notes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">peakClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STUB: hot-fixed later&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chemicalShifts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of chemicalShifts in the project</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_shifts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">shiftList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemicalShiftLists</span><span class="p">:</span>
            <span class="n">_shifts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shiftList</span><span class="o">.</span><span class="n">chemicalShifts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_shifts</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of collections in the project</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectionList</span><span class="o">.</span><span class="n">collections</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_collectionData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">collectionData</span>

    <span class="nd">@_collectionData</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_collectionData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">collectionData</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">#-----------------------------------------------------------------------------------------</span>
    <span class="c1"># (Sub-)directories of the project</span>
    <span class="c1">#-----------------------------------------------------------------------------------------</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projectPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience, as project.path (currently) does not yield a Path instance</span>
<span class="sd">        :return: the absolute path to the project as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">aPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statePath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the state sub-directory of the current project</span>
<span class="sd">                 as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectPath</span> <span class="o">/</span> <span class="n">CCPN_STATE_DIRECTORY</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipelinePath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the state/pipeline sub-directory of</span>
<span class="sd">                 the current project as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statePath</span><span class="o">.</span><span class="n">fetchDir</span><span class="p">(</span><span class="n">Pipeline</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the data sub-directory of the current project</span>
<span class="sd">                 as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectPath</span> <span class="o">/</span> <span class="n">CCPN_DATA_DIRECTORY</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectraPath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the data sub-directory of the current project</span>
<span class="sd">                 as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectPath</span> <span class="o">/</span> <span class="n">CCPN_SPECTRA_DIRECTORY</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pluginDataPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the data/plugins sub-directory of the</span>
<span class="sd">                 current project as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectPath</span> <span class="o">/</span> <span class="n">CCPN_PLUGINS_DIRECTORY</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scriptsPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the script sub-directory of the current project</span>
<span class="sd">                 as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectPath</span> <span class="o">/</span> <span class="n">CCPN_SCRIPTS_DIRECTORY</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">archivesPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the absolute path to the archives sub-directory of the current project</span>
<span class="sd">                 as a Path instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">aPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">CCPN_ARCHIVES_DIRECTORY</span>

    <span class="c1"># TODO: define not using API</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backupPath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;path to directory containing  backup Project&quot;&quot;&quot;</span>
        <span class="n">backupRepository</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">findFirstRepository</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;backup&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">backupRepository</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Warning: no backup path set, so no backup done&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">backupUrl</span> <span class="o">=</span> <span class="n">backupRepository</span><span class="o">.</span><span class="n">url</span>
        <span class="n">backupPath</span> <span class="o">=</span> <span class="n">backupUrl</span><span class="o">.</span><span class="n">path</span>
        <span class="k">return</span> <span class="n">backupPath</span>

    <span class="c1">#-----------------------------------------------------------------------------------------</span>
    <span class="c1"># Implementation methods</span>
    <span class="c1">#-----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">:</span> <span class="n">ApiNmrProject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Special init for root (Project) object</span>

<span class="sd">        NB Project is NOT complete before the _initProject function is run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">,</span> <span class="n">ApiNmrProject</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Project initialised with </span><span class="si">%s</span><span class="s2">, should be ccp.nmr.Nmr.NmrProject.&quot;</span>
                             <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

        <span class="c1"># Define linkage attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="n">wrappedData</span>

        <span class="c1"># self._appBase = None (delt with below)</span>
        <span class="c1"># Reference to application; defined by Framework</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_application</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># setup object handling dictionaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span> <span class="o">=</span> <span class="p">{</span><span class="n">wrappedData</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

        <span class="c1"># Set up notification machinery</span>
        <span class="c1"># Active notifiers - saved for later cleanup. CORE APPLICATION ONLY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># list or None. When set used to accumulate pending notifiers</span>
        <span class="c1"># Optional list. Elements are (func, onceOnly, wrapperObject, optional oldPid)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pendingNotifications</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Notification suspension level - to allow for nested notification suspension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progressSuspension</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Notification blanking level - to allow for nested notification disabling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># api &#39;change&#39; notification blanking level - to allow for api &#39;change&#39; call to be</span>
        <span class="c1"># disabled in the _modifiedApiObject method.</span>
        <span class="c1"># To be used with the apiNotificationBlanking contact manager; e.g.</span>
        <span class="c1"># with apiNotificationBlanking():</span>
        <span class="c1">#   do something</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apiNotificationBlanking</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Wrapper level notifier tracking.  APPLICATION ONLY</span>
        <span class="c1"># {(className,action):OrderedDict(notifier:onceOnly)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Special attributes:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_implExperimentTypeMap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># reference to a ProjectSaveHistory instance; defined _newProject() or _loadProject()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saveHistory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># reference to the logger; defined in call to _initialiseProject())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># reference to special v3 core lists without abstractWrapperObject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collectionList</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_checkProjectSubDirectories</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_application</span>

    <span class="c1"># GWV: 20181102: insert _appBase to retain consistency with current data loading models</span>
    <span class="n">_appBase</span> <span class="o">=</span> <span class="n">application</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isNew</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if the project is new</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE:ED - based on original check in _initProject</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">isModified</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isTemporary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if the project is temporary, i.e., not saved or updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">apiProject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">apiProject</span><span class="p">,</span> <span class="s1">&#39;_temporaryDirectory&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if any part of the project has been modified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">isProjectModified</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_isUpgradedFromV2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if project was upgraded from V2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apiNmrProject</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_upgradedFromV2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_needsUpgrading</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if project defined by path needs upgrading</span>
<span class="sd">        :param path: a ccpn project-path</span>
<span class="sd">        :return: True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.framework.lib.DataLoaders.CcpNmrV2ProjectDataLoader</span> <span class="kn">import</span> <span class="n">CcpNmrV2ProjectDataLoader</span>
        <span class="kn">from</span> <span class="nn">ccpn.framework.lib.DataLoaders.CcpNmrV3ProjectDataLoader</span> <span class="kn">import</span> <span class="n">CcpNmrV3ProjectDataLoader</span>

        <span class="c1"># Check for V2 project; always needs upgrading</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataloader</span> <span class="o">:=</span> <span class="n">CcpNmrV2ProjectDataLoader</span><span class="o">.</span><span class="n">checkForValidFormat</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dataloader</span> <span class="o">:=</span> <span class="n">CcpNmrV3ProjectDataLoader</span><span class="o">.</span><span class="n">checkForValidFormat</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Path &quot;</span><span class="si">%s</span><span class="s1">&quot; does not define a valid ccpn project&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">projectHistory</span> <span class="o">:=</span> <span class="n">getProjectSaveHistory</span><span class="p">(</span><span class="n">dataloader</span><span class="o">.</span><span class="n">path</span><span class="p">)):</span>
            <span class="c1"># check whether the history exists</span>
            <span class="k">return</span> <span class="n">projectHistory</span><span class="o">.</span><span class="n">lastSavedVersion</span> <span class="o">&lt;=</span> <span class="s1">&#39;3.0.4&#39;</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the contents of the data property from the model</span>
<span class="sd">        CCPNInternal only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@_data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the contents of the data property from the model</span>
<span class="sd">        CCPNInternal only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;value must be a dict&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_checkProjectSubDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;if need be, create all project subdirectories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">CCPN_SUB_DIRECTORIES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectPath</span><span class="o">.</span><span class="n">fetchDir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialiseProject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Complete initialisation of project,</span>
<span class="sd">        set up logger and notifiers, and wrap underlying data</span>
<span class="sd">        This routine is called from Framework, as some other machinery first needs to set up</span>
<span class="sd">        (linkages, Current, notifiers and such)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The logger has already been set up when creating/loading the API project</span>
        <span class="c1"># so just get it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

        <span class="c1"># Set up notifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registerPresetApiNotifiers</span><span class="p">()</span>

        <span class="c1"># initialise, creating the children; pass in self as we are initialising</span>
        <span class="k">with</span> <span class="n">inactivity</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restoreChildren</span><span class="p">()</span>
            <span class="c1"># perform any required restoration of project not covered by children</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restoreObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">)</span>

            <span class="c1"># we always have the default chemicalShift list</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chemicalShiftLists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newChemicalShiftList</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

            <span class="c1"># Call any updates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_restoreObject</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">apiObj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process data that must always be performed after updating all children</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core._implementation.CollectionList</span> <span class="kn">import</span> <span class="n">CollectionList</span>

        <span class="c1"># create new collection table</span>
        <span class="n">project</span><span class="o">.</span><span class="n">_collectionList</span> <span class="o">=</span> <span class="n">CollectionList</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">)</span>

        <span class="c1"># create new collections from table</span>
        <span class="n">project</span><span class="o">.</span><span class="n">_collectionList</span><span class="o">.</span><span class="n">_restoreObject</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># don&#39;t need to call super here</span>
        <span class="k">return</span> <span class="n">project</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Project.close"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean up the wrapper project previous to deleting or replacing</span>
<span class="sd">        Cleanup includes wrapped data graphics objects (e.g. Window, Strip, ...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># close any spectra</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>

        <span class="c1"># Remove undo stack:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetUndo</span><span class="p">(</span><span class="n">maxWaypoints</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">apiIo</span><span class="o">.</span><span class="n">cleanupProject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clearAllApiNotifiers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteAllNotifiers</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_data2Obj&#39;</span><span class="p">,</span> <span class="s1">&#39;_pid2Obj&#39;</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="c1"># delattr(self,tag)</span>
        <span class="c1"># del self._wrappedData</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Project:</span><span class="si">%s</span><span class="s2">, isDeleted=True&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Project:</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;PR:</span><span class="si">%s</span><span class="s2">, isDeleted=True&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;PR:</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># CCPN properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Project id: Globally unique identifier (guid)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">guid</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">remapSeparators</span><span class="p">)</span>

    <span class="c1"># _uniqueId: Some classes require a unique identifier per class</span>
    <span class="c1"># use _uniqueId property defined in AbstractWrapperObject; values are maintained for project instance</span>
    <span class="k">def</span> <span class="nf">_queryNextUniqueIdValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;query the next uniqueId for class className; does not increment its value</span>
<span class="sd">        CCPNINTERNAL: used in NmrAtom on _uniqueName</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># _nextUniqueIdValues = {}    # a (className, nexIdValue) dictionary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">,</span> <span class="s1">&#39;_nextUniqueIdValues&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">,</span> <span class="s1">&#39;_nextUniqueIdValues&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">_nextUniqueIdValues</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">_nextUniqueIdValues</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">nextUniqueId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">_nextUniqueIdValues</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nextUniqueId</span>

    <span class="k">def</span> <span class="nf">_getNextUniqueIdValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the next uniqueId for class className; increments its value</span>
<span class="sd">        CCPNINTERNAL: used in AbstractWrapper on __init__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nextUniqueId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryNextUniqueIdValue</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">_nextUniqueIdValues</span><span class="p">[</span><span class="n">className</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">nextUniqueId</span>

    <span class="k">def</span> <span class="nf">_setNextUniqueIdValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the next uniqueId for class className</span>
<span class="sd">        CCPNINTERNAL: should only be used in _restoreObject or Nef</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queryNextUniqueIdValue</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">_nextUniqueIdValues</span><span class="p">[</span><span class="n">className</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractWrapperObject</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parent (containing) object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Project.save"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">changeBackup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">createFallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">checkValid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">changeDataLocations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save project with all data, optionally to new location or with new name.</span>
<span class="sd">        Unlike lower-level functions, this function ensures that data in high level caches are saved.</span>
<span class="sd">        Return True if save succeeded otherwise return False (or throw error)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self._flushCachedData()</span>

        <span class="c1"># Update the spectrum internal settings</span>
        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="n">spectrum</span><span class="o">.</span><span class="n">_saveObject</span><span class="p">()</span>

        <span class="c1"># path is empty for save under the same name</span>
        <span class="k">if</span> <span class="n">newPath</span><span class="p">:</span>
            <span class="c1"># check validity of the newPath</span>
            <span class="n">newPath</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">newPath</span><span class="p">)</span>
            <span class="n">newPath</span><span class="o">.</span><span class="n">assureSuffix</span><span class="p">(</span><span class="n">CCPN_EXTENSION</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newPath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwriteExisting</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot overwrite existing file &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">newPath</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">newPath</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is a limit (1024) to the length of the path (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">_saveAs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">_saveAs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">apiStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getAPIObjectsStatus</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">apiStatus</span><span class="o">.</span><span class="n">invalidObjects</span><span class="p">:</span>
                <span class="c1"># if deleteInvalidObjects:</span>
                <span class="c1"># delete here ...</span>
                <span class="c1"># run save and apiStatus again. Ensure nothing else has been compromised on the deleting process</span>
                <span class="c1"># else:</span>
                <span class="n">errorMsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">apiStatus</span><span class="o">.</span><span class="n">invalidObjectsErrors</span><span class="p">)</span>
                <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Found compromised items. Project might be left in an invalid state. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">errorMsg</span><span class="p">)</span>
                <span class="c1"># raise ValueError(error)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error checking project status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>

        <span class="c1"># don&#39;t check valid inside this routine as it is not optimised and only results in a crash. Use apiStatus object.</span>
        <span class="n">savedOk</span> <span class="o">=</span> <span class="n">apiIo</span><span class="o">.</span><span class="n">saveProject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">newPath</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                    <span class="n">changeBackup</span><span class="o">=</span><span class="n">changeBackup</span><span class="p">,</span> <span class="n">createFallback</span><span class="o">=</span><span class="n">createFallback</span><span class="p">,</span>
                                    <span class="n">overwriteExisting</span><span class="o">=</span><span class="n">overwriteExisting</span><span class="p">,</span> <span class="n">checkValid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">changeDataLocations</span><span class="o">=</span><span class="n">changeDataLocations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savedOk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>
            <span class="c1"># check for application and Gui; might not yet be there (e.g. on save of converted V2</span>
            <span class="c1"># project)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">hasGui</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">sideBar</span><span class="o">.</span><span class="n">setProjectName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># store the version history in state subfolder json file</span>
            <span class="k">if</span> <span class="n">_saveAs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkProjectSubDirectories</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saveHistory</span> <span class="o">=</span> <span class="n">newProjectSaveHistory</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveHistory</span><span class="o">.</span><span class="n">addSaveRecord</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">savedOk</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;name of Project&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return absolute path to directory containing Project</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">apiIo</span><span class="o">.</span><span class="n">getRepositoryPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;userData&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Project.deleteObjects"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.deleteObjects">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">deleteObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">,</span> <span class="n">AbstractWrapperObject</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;Delete one or more objects, given as either objects or Pids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getByPid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getByPid</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">getByPid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">undoBlockWithoutSideBar</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_apiNmrProject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiNmrProject</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;API equivalent to object: NmrProject&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span>

    <span class="c1"># Undo machinery</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;undo stack for Project. Implementation attribute&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_resetUndo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxWaypoints</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Undo</span><span class="o">.</span><span class="n">MAXUNDOWAYPOINTS</span><span class="p">,</span>
                   <span class="n">maxOperations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Undo</span><span class="o">.</span><span class="n">MAXUNDOOPERATIONS</span><span class="p">,</span>
                   <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset undo stack, using passed-in parameters.</span>
<span class="sd">        NB setting either parameter to 0 removes the undo stack.&quot;&quot;&quot;</span>
        <span class="n">Undo</span><span class="o">.</span><span class="n">resetUndo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">maxWaypoints</span><span class="o">=</span><span class="n">maxWaypoints</span><span class="p">,</span>
                       <span class="n">maxOperations</span><span class="o">=</span><span class="n">maxOperations</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="n">application</span><span class="p">)</span>

<div class="viewcode-block" id="Project.newUndoPoint"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newUndoPoint">[docs]</a>    <span class="k">def</span> <span class="nf">newUndoPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a point in the undo stack, you can undo/redo to &quot;&quot;&quot;</span>
        <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to add undoPoint but undo is not initialised&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">newWaypoint</span><span class="p">()</span>  <span class="c1"># DO NOT CHANGE THIS ONE newWaypoint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added undoPoint&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.blockWaypoints"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.blockWaypoints">[docs]</a>    <span class="k">def</span> <span class="nf">blockWaypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block the setting of undo waypoints,</span>
<span class="sd">        so that command echoing (_startCommandBLock) does not set waypoints</span>

<span class="sd">        NB The programmer must GUARANTEE (try: ... finally) that waypoints are unblocked again&quot;&quot;&quot;</span>
        <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to block waypoints but undo is not initialised&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">increaseWaypointBlocking</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waypoint setting blocked&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.unblockWaypoints"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.unblockWaypoints">[docs]</a>    <span class="k">def</span> <span class="nf">unblockWaypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block the setting of undo waypoints,</span>
<span class="sd">        so that command echoing (_startCommandBLock) does not set waypoints</span>

<span class="sd">        NB The programmer must GUARANTEE (try: ... finally) that waypoints are unblocked again&quot;&quot;&quot;</span>
        <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to unblock waypoints but undo is not initialised&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">decreaseWaypointBlocking</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waypoint setting unblocked&quot;</span><span class="p">)</span></div>

    <span class="c1"># Should be removed:</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_residueName2chemCompId</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;dict of {residueName:(molType,ccpCode)}&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MoleculeQuery</span><span class="o">.</span><span class="n">fetchStdResNameMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_experimentTypeMap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;{dimensionCount : {sortedNucleusCodeTuple :</span>
<span class="sd">                              OrderedDict(experimentTypeSynonym : experimentTypeName)}}</span>
<span class="sd">        dictionary</span>

<span class="sd">        NB The OrderedDicts are ordered ad-hoc, with the most common experiments (hopefully) first</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># NB This is a hack, in order to rename experiments that we care particularly about</span>
        <span class="c1"># This should disappear under refactoring</span>
        <span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.spectrum.NmrExpPrototype</span> <span class="kn">import</span> <span class="n">priorityNameRemapping</span>

        <span class="c1"># NBNB TODO FIXME fetchIsotopeRefExperimentMap should be merged with</span>
        <span class="c1"># getExpClassificationDict output - we should NOT have two parallel dictionaries</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implExperimentTypeMap</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">refExperimentMap</span> <span class="o">=</span> <span class="n">NmrExpPrototype</span><span class="o">.</span><span class="n">fetchIsotopeRefExperimentMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apiNmrProject</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">nucleusCodes</span><span class="p">,</span> <span class="n">refExperiments</span> <span class="ow">in</span> <span class="n">refExperimentMap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nucleusCodes</span><span class="p">)</span>
                <span class="n">dd1</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">result</span><span class="p">[</span><span class="n">ndim</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd1</span>

                <span class="n">dd2</span> <span class="o">=</span> <span class="n">dd1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nucleusCodes</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
                <span class="n">dd1</span><span class="p">[</span><span class="n">nucleusCodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd2</span>
                <span class="k">for</span> <span class="n">refExperiment</span> <span class="ow">in</span> <span class="n">refExperiments</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">refExperiment</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">refExperiment</span><span class="o">.</span><span class="n">synonym</span> <span class="ow">or</span> <span class="n">name</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">priorityNameRemapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="n">dd2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_implExperimentTypeMap</span> <span class="o">=</span> <span class="n">result</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_getReferenceExperimentFromType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RefExperiment</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Search for a reference experiment matching name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># nmrExpPrototype = self._wrappedData.root.findFirstNmrExpPrototype(name=value) # Why not findFirst instead of looping all sortedNmrExpPrototypes</span>
        <span class="k">for</span> <span class="n">nmrExpPrototype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">sortedNmrExpPrototypes</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">refExperiment</span> <span class="ow">in</span> <span class="n">nmrExpPrototype</span><span class="o">.</span><span class="n">sortedRefExperiments</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">refExperiment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">refExperiment</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shiftAveraging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return shiftAveraging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">shiftAveraging</span>

    <span class="nd">@shiftAveraging</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">shiftAveraging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set shiftAveraging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;shiftAveraging must be True/False&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">shiftAveraging</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">#===========================================================================================</span>
    <span class="c1">#  Notifiers system</span>
    <span class="c1">#</span>
    <span class="c1"># Old, API-level functions:</span>
    <span class="c1">#</span>
    <span class="c1">#===========================================================================================</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_setupApiNotifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setting up API notifiers for subsequent registration on each new project</span>
<span class="sd">           RESTRICTED. Use in core classes ONLY&quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_apiNotifierParameters</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span>
                                        <span class="n">parameterDict</span><span class="o">=</span><span class="n">parameterDict</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_apiNotifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_apiNotifierParameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define func as method of project and return API parameters for notifier setup</span>
<span class="sd">        APPLICATION ONLY&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parameterDict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameterDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">apiClassName</span> <span class="o">=</span> <span class="p">(</span><span class="n">apiClassOrName</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">apiClassOrName</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">apiClassOrName</span><span class="o">.</span><span class="n">_metaclass</span><span class="o">.</span><span class="n">qualifiedName</span><span class="p">())</span>

        <span class="n">dot</span> <span class="o">=</span> <span class="s1">&#39;_dot_&#39;</span>
        <span class="n">wrapperFuncName</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">dot</span><span class="p">),</span> <span class="n">dot</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">Project</span><span class="p">,</span> <span class="n">wrapperFuncName</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">wrapperFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="p">,</span> <span class="n">apiClassName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_registerApiNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register notifier for immediate action on current project (only)</span>

<span class="sd">        func must be a function taking two parameters: the ccpn.core.Project and an Api object</span>
<span class="sd">        matching apiClassOrName.</span>

<span class="sd">        &#39;apiFuncName&#39; is either the name of an API modifier function (a setter, adder, remover),</span>
<span class="sd">        in which case the notifier is triggered by this function</span>
<span class="sd">        Or it is one of the following tags:</span>
<span class="sd">        (&#39;&#39;, &#39;__init__&#39;, &#39;postInit&#39;, &#39;preDelete&#39;, &#39;delete&#39;, &#39;startDeleteBlock&#39;, &#39;endDeleteBlock&#39;).</span>
<span class="sd">        &#39;&#39; registers the notifier to any modifier function call ( setter, adder, remover),</span>
<span class="sd">        __init__ and postInit triggers the notifier at the end of object creation, before resp.</span>
<span class="sd">        after execution of postConstructorCode, the four delete-related tags</span>
<span class="sd">        trigger notifiers at four different points in the deletion process</span>
<span class="sd">        (see memops.Implementation.DataObject.delete() code for details).</span>


<span class="sd">        ADVANCED, but free to use. Must be unregistered when any object referenced is deleted.</span>
<span class="sd">        Use return value as input parameter for _unregisterApiNotifier (if desired)&quot;&quot;&quot;</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_apiNotifierParameters</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span>
                                                   <span class="n">parameterDict</span><span class="o">=</span><span class="n">parameterDict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activateApiNotifier</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unregisterApiNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notifierTuple</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove acxtive notifier from project. ADVANVED but free to use.</span>
<span class="sd">        Use return value of _registerApiNotifier to identify the relevant notiifier&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">notifierTuple</span><span class="p">)</span>
        <span class="n">Notifiers</span><span class="o">.</span><span class="n">unregisterNotify</span><span class="p">(</span><span class="o">*</span><span class="n">notifierTuple</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_registerPresetApiNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register preset API notifiers. APPLCATION ONLY&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apiNotifiers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_activateApiNotifier</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_activateApiNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapperFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="p">,</span> <span class="n">apiClassName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Activate API notifier. APPLICATION ONLY&quot;&quot;&quot;</span>

        <span class="n">notify</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapperFuncName</span><span class="p">),</span> <span class="o">**</span><span class="n">parameterDict</span><span class="p">)</span>
        <span class="n">notifierTuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">apiClassName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notifierTuple</span><span class="p">)</span>
        <span class="n">Notifiers</span><span class="o">.</span><span class="n">registerNotify</span><span class="p">(</span><span class="o">*</span><span class="n">notifierTuple</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">notifierTuple</span>

    <span class="k">def</span> <span class="nf">_clearAllApiNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CLear all notifiers, previous to closing or deleting Project</span>
<span class="sd">        APPLICATION ONLY</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">Notifiers</span><span class="o">.</span><span class="n">unregisterNotify</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>

    <span class="c1">#===========================================================================================</span>
    <span class="c1">#  Notifiers system</span>
    <span class="c1">#</span>
    <span class="c1"># New notifier system (Free for use in application code):</span>
    <span class="c1">#</span>
    <span class="c1">#===========================================================================================</span>

<div class="viewcode-block" id="Project.registerNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.registerNotifier">[docs]</a>    <span class="k">def</span> <span class="nf">registerNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                         <span class="n">parameterDict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">onceOnly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register notifiers to be triggered when data change</span>

<span class="sd">        :param str className: className of wrapper class to monitor (AbstractWrapperObject for &#39;all&#39;)</span>

<span class="sd">        :param str target: can have the following values</span>

<span class="sd">          *&#39;create&#39;* is called after the creation (or undeletion) of the object and its wrapper.</span>
<span class="sd">          Notifier functions are called with the created V3 core object as the only parameter.</span>

<span class="sd">          *&#39;delete&#39;* is called before the object is deleted</span>
<span class="sd">          Notifier functions are called with the deleted to be deleted V3 core object as the only</span>
<span class="sd">          parameter.</span>

<span class="sd">          *&#39;rename&#39;* is called after the id and pid of an object has changed</span>
<span class="sd">          Notifier functions are called with the renamed V3 core object and the old pid as parameters.</span>

<span class="sd">          *&#39;change&#39;* when any object attribute changes value.</span>
<span class="sd">          Notifier functions are called with the changed V3 core object as the only parameter.</span>
<span class="sd">          rename and crosslink notifiers (see below) may also trigger change notifiers.</span>

<span class="sd">          Any other value is interpreted as the name of a V3 core class, and the notifier</span>
<span class="sd">          is triggered when a cross link (NOT a parent-child link) between the className and</span>
<span class="sd">          the target class is modified</span>

<span class="sd">        :param Callable func: The function to call when the notifier is triggered.</span>

<span class="sd">          for actions &#39;create&#39;, &#39;delete&#39; and &#39;change&#39; the function is called with the object</span>
<span class="sd">          created (deleted, undeleted, changed) as the only parameter</span>

<span class="sd">          For action &#39;rename&#39; the function is called with an additional parameter: oldPid,</span>
<span class="sd">          the value of the pid before renaming.</span>

<span class="sd">          If target is a second className, the function is called with the project as the only</span>
<span class="sd">          parameter.</span>

<span class="sd">        :param dict parameterDict: Parameters passed to the notifier function before execution.</span>

<span class="sd">          This allows you to use the same function with different parameters in different contexts</span>

<span class="sd">        :param bool onceOnly: If True, only one of multiple copies is executed</span>

<span class="sd">          when notifiers are resumed after a suspension.</span>

<span class="sd">        :return The registered notifier (which can be passed to removeNotifier or duplicateNotifier)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifierActions</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is right, it just looks strange. But if target is not an action it is</span>
            <span class="c1"># another className, and if so the names must be sorted.</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">]))</span>

        <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">parameterDict</span><span class="p">:</span>
            <span class="n">notifier</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">parameterDict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">notifier</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">if</span> <span class="n">od</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="n">notifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">onceOnly</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Coding error - notifier </span><span class="si">%s</span><span class="s2"> set twice for </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> &quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">notifier</span></div>

<div class="viewcode-block" id="Project.unRegisterNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.unRegisterNotifier">[docs]</a>    <span class="k">def</span> <span class="nf">unRegisterNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notifier</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Unregister the notifier from this className, and target&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifierActions</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is right, it just looks strange. But if target is not an action it is</span>
            <span class="c1"># another className, and if so the names must be sorted.</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">]))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_context2Notifiers&#39;</span><span class="p">):</span>
                <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">tt</span><span class="p">),</span> <span class="p">{})</span>
                <span class="k">del</span> <span class="n">od</span><span class="p">[</span><span class="n">notifier</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempt to unregister unknown notifier </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Project.removeNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.removeNotifier">[docs]</a>    <span class="k">def</span> <span class="nf">removeNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notifier</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Unregister the the notifier from all places where it appears.&quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">od</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">od</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">od</span><span class="p">[</span><span class="n">notifier</span><span class="p">]</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempt to remove unknown notifier: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">notifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.blankNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.blankNotification">[docs]</a>    <span class="k">def</span> <span class="nf">blankNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disable notifiers temporarily</span>
<span class="sd">        e.g. to disable &#39;object modified&#39; notifiers during object creation</span>

<span class="sd">        Caller is responsible to make sure necessary notifiers are called, and to unblank after use&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Project.unblankNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.unblankNotification">[docs]</a>    <span class="k">def</span> <span class="nf">unblankNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resume notifier execution after blanking&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Code Error: _notificationBlanking below zero!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.suspendNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.suspendNotification">[docs]</a>    <span class="k">def</span> <span class="nf">suspendNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Suspend notifier execution and accumulate notifiers for later execution&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">hasGui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">qtApp</span><span class="o">.</span><span class="n">progressAboutToChangeSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progressSuspension</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progressSuspension</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span>
        <span class="c1"># TODO suspension temporarily disabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Project.resumeNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.resumeNotification">[docs]</a>    <span class="k">def</span> <span class="nf">resumeNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute accumulated notifiers and resume immediate notifier execution&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progressSuspension</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progressSuspension</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Code Error: _progressSuspension below zero&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">hasGui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">qtApp</span><span class="o">.</span><span class="n">progressChangedSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progressSuspension</span><span class="p">)</span>

        <span class="k">return</span>

        <span class="c1"># TODO suspension temporarily disabled</span>
        <span class="c1"># This was broken at one point, and we never found time to fix it</span>
        <span class="c1"># It is a time-saving measure, allowing you to e.g. execute a</span>
        <span class="c1"># peak-created notifier only once when creating hundreds of peaks in one operation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Should not be necessary, but in this way we never get below 0 no matter what errors happen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">scheduledNotifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="n">executeNotifications</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pendingNotifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pendingNotifications</span>
            <span class="k">while</span> <span class="n">pendingNotifications</span><span class="p">:</span>
                <span class="n">notification</span> <span class="o">=</span> <span class="n">pendingNotifications</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">notifier</span> <span class="o">=</span> <span class="n">notification</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">onceOnly</span> <span class="o">=</span> <span class="n">notification</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">onceOnly</span><span class="p">:</span>

                    <span class="c1"># check whether the match pair, (function, object) is in the found set</span>
                    <span class="n">matchNotifier</span> <span class="o">=</span> <span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="n">notification</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">matchNotifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scheduledNotifiers</span><span class="p">:</span>
                        <span class="n">scheduledNotifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">matchNotifier</span><span class="p">)</span>

                        <span class="c1"># append the function call (function, object, *params)</span>
                        <span class="n">executeNotifications</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">notification</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                    <span class="c1"># if notifier not in scheduledNotifiers:</span>
                    <span class="c1">#     scheduledNotifiers.add(notifier)</span>
                    <span class="c1">#     executeNotifications.append((notifier, notification[2:]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">executeNotifications</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">notification</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">executeNotifications</span><span class="p">):</span>
                <span class="n">notifier</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span></div>

    <span class="c1"># Standard notified functions.</span>
    <span class="c1"># RESTRICTED. Use in core classes ONLY</span>

    <span class="k">def</span> <span class="nf">_startDeleteCommandBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">allWrappedData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call startCommandBlock for wrapper object delete. Implementation only</span>

<span class="sd">        If commented: _activateApiNotifier fails</span>

<span class="sd">        Used by the preset Api notifiers populated for self._apiNotifiers;</span>
<span class="sd">        have _newApiObject, _startDeleteCommandBlock, _finaliseApiDelete, _endDeleteCommandBlock, _finaliseApiUnDelete</span>
<span class="sd">        and _modifiedApiObject for each V3 class</span>
<span class="sd">        Initialised from _linkWrapperObjects in AbstractWrapperObject.py:954</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># set undo step</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">newWaypoint</span><span class="p">()</span>  <span class="c1"># DO NOT CHANGE THIS</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">increaseWaypointBlocking</span><span class="p">()</span>

            <span class="c1"># self.suspendNotification()</span>

    <span class="k">def</span> <span class="nf">_endDeleteCommandBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">dummyWrappedData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End block for delete command echoing</span>

<span class="sd">        MUST be paired with _startDeleteCommandBlock call - use try ... finally to ensure both are called</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># self.resumeNotification()</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">decreaseWaypointBlocking</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_newApiObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">AbstractWrapperObject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new wrapper object of class cls, associated with wrappedData.</span>
<span class="sd">        and call creation notifiers&quot;&quot;&quot;</span>

        <span class="n">factoryFunction</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_factoryFunction</span>
        <span class="k">if</span> <span class="n">factoryFunction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Necessary for classes where you need to instantiate a subclass instead</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">)</span>
            <span class="c1"># There are cases where _newApiObject is registered twice,</span>
            <span class="c1"># when two wrapper classes share the same API class</span>
            <span class="c1"># (Peak,Integral; PeakList, IntegralList)</span>
            <span class="c1"># In those cases only the notifiers are done the second time</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">factoryFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modifiedApiObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; call object-has-changed notifiers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apiNotificationBlanking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_finaliseApiDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean up after object deletion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_finaliseApiDelete called before wrapped data are deleted: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

        <span class="c1"># get object</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="c1"># NOTE:ED - it shouldn&#39;t get here but occasionally it does :|</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_finaliseApiDelete: no V3 object for </span><span class="si">{</span><span class="n">wrappedData</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># obj._finaliseAction(&#39;delete&#39;)  # GWV: 20181127: now as notify(&#39;delete&#39;) decorator on delete method</span>

            <span class="c1"># remove from wrapped2Obj</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span>

            <span class="c1"># remove from pid2Obj</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">][</span><span class="n">obj</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span>

            <span class="c1"># Mark object as obviously deleted, and set up for undeletion</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_id</span> <span class="o">+=</span> <span class="s1">&#39;-Deleted&#39;</span>
            <span class="n">wrappedData</span><span class="o">.</span><span class="n">_oldWrapperObject</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_finaliseApiUnDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;restore undeleted wrapper object, and call creation notifiers,</span>
<span class="sd">        same as _newObject&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_finaliseApiUnDelete called before wrapped data are deleted: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">oldWrapperObject</span> <span class="o">=</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">_oldWrapperObject</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ApiError</span><span class="p">(</span><span class="s2">&quot;Wrapper object to undelete wrongly set up - lacks _oldWrapperObject attribute&quot;</span><span class="p">)</span>

        <span class="c1"># put back in from wrapped2Obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldWrapperObject</span>

        <span class="k">if</span> <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-Deleted&#39;</span><span class="p">):</span>
            <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>

        <span class="c1"># put back in pid2Obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">][</span><span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldWrapperObject</span>

        <span class="c1"># Restore object to pre-undeletion state</span>
        <span class="k">del</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">_oldWrapperObject</span>
        <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="n">wrappedData</span>

        <span class="c1"># oldWrapperObject._finaliseAction(&#39;create&#39;)  # EJB: 20211119: now as notify(&#39;delete&#39;) decorator on delete method</span>

    <span class="k">def</span> <span class="nf">_notifyRelatedApiObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">,</span> <span class="n">pathToObject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; call &#39;action&#39; type notifiers for getattribute(pathToObject)(wrappedData)</span>
<span class="sd">        pathToObject is a navigation path (may contain dots) and must yield an API object</span>
<span class="sd">        or an iterable of API objects&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apiNotificationBlanking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">getDataObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span>

            <span class="n">target</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">pathToObject</span><span class="p">)(</span><span class="n">wrappedData</span><span class="p">)</span>

            <span class="c1"># GWV: a bit too much for now; should be the highest debug level only</span>
            <span class="c1">#self._project._logger.debug(&#39;%s: %s.%s = %s&#39;</span>
            <span class="c1">#                            % (action, wrappedData, pathToObject, target))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;_metaclass&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
                    <span class="c1"># Hack. This is an API object - only if exists</span>
                    <span class="n">getDataObj</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This must be an iterable</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
                        <span class="n">getDataObj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="c1"># def _finaliseApiRename(self, wrappedData):</span>
    <span class="c1">#     &quot;&quot;&quot;Reset Finalise rename - called from API object (for API notifiers)</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # Should be handled by decorators</span>
    <span class="c1">#     if self._apiNotificationBlanking == 0:</span>
    <span class="c1">#         getLogger().debug2(f&#39;***   SHOULD THIS BE CALLED? {self._data2Obj.get(wrappedData)}&#39;)</span>
    <span class="c1">#         # obj = self._data2Obj.get(wrappedData)</span>
    <span class="c1">#         # obj._finaliseAction(&#39;rename&#39;)</span>

    <span class="k">def</span> <span class="nf">_finalisePid2Obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;New/Delete object to the general dict for v3 pids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update pid:object mapping dictionary</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">className</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="c1"># set/delete on action</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;create&#39;</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="c1"># should never fail</span>
            <span class="k">del</span> <span class="n">dd</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_modifiedLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">classNames</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; call link-has-changed notifiers</span>
<span class="sd">        The notifier function called must have the signature</span>
<span class="sd">        func(project, **parameterDict)</span>

<span class="sd">        NB</span>
<span class="sd">        1) calls to this function must be set up explicitly in the wrapper for each crosslink</span>
<span class="sd">        2) This function is only called when the link is changed explicitly, not when</span>
<span class="sd">        a linked object is created or deleted&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># get object</span>
        <span class="n">className</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">classNames</span><span class="p">))</span>
        <span class="c1"># self._doNotification(classNames[0], classNames[1], self)</span>
        <span class="c1"># NB &#39;AbstractWrapperObject&#39; not currently in use (Sep 2016), but kept for future needs</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="n">OrderedDict</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="s1">&#39;AbstractWrapperObject&#39;</span><span class="p">))</span>
        <span class="c1"># Notification suspension postpones notifications (and removes duplicates)</span>
        <span class="c1"># It is broken and has been disabled for a long time.</span>
        <span class="c1"># There may be some accumulated bugs when (if)it is turned back on.</span>
        <span class="c1"># if False and self._notificationSuspension:</span>
        <span class="c1">#     ll = self._pendingNotifications</span>
        <span class="c1">#     for dd in iterator:</span>
        <span class="c1">#         for notifier, onceOnly in dd.items():</span>
        <span class="c1">#             ll.append((notifier, onceOnly, self))</span>
        <span class="c1"># else:</span>

        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
                <span class="n">notifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
    <span class="c1"># Library functions</span>
    <span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

    <span class="k">def</span> <span class="nf">_updateApiDataUrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the data url to path; for legacy purposes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset remoteData DataStores to match path</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;_updateApiDataUrl: invalid path </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;_updateApiDataUrl: path </span><span class="si">%r</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">memopsRoot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span>
        <span class="n">dataUrl</span> <span class="o">=</span> <span class="n">memopsRoot</span><span class="o">.</span><span class="n">findFirstDataLocationStore</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findFirstDataUrl</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;remoteData&#39;</span>
                <span class="p">)</span>
        <span class="n">dataUrl</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">Implementation</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_getAPIObjectsStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completeScan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">includeDefaultChildren</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan all API objects and check their validity.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        completeScan: bool, True to perform a complete validity check of all found API objects</span>
<span class="sd">        includeDefaultChildren: bool, False to exclude default objects for inspection such as</span>
<span class="sd">                                ChemComps and associated, nmrExpPrototypes etc.See _APIStatus._excludedChildren</span>
<span class="sd">                                for the full list of exclusions.</span>

<span class="sd">        Return: the API Status object. See _APIStatus for full description</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Validating Project integrity...&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">ccpn.core._implementation.APIStatus</span> <span class="kn">import</span> <span class="n">APIStatus</span>

        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apiNmrProject</span><span class="o">.</span><span class="n">root</span>
        <span class="n">apiStatus</span> <span class="o">=</span> <span class="n">APIStatus</span><span class="p">(</span><span class="n">apiObj</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">completeScan</span><span class="o">=</span><span class="n">completeScan</span><span class="p">,</span> <span class="n">includeDefaultChildren</span><span class="o">=</span><span class="n">includeDefaultChildren</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">apiStatus</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the _updateObject method on all objects, including self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateObject</span><span class="p">(</span><span class="n">UPDATE_POST_PROJECT_INITIALISATION</span><span class="p">)</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getAllDecendants</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_updateObject</span><span class="p">(</span><span class="n">UPDATE_POST_PROJECT_INITIALISATION</span><span class="p">)</span>

<div class="viewcode-block" id="Project.exportNef"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.exportNef">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exportNef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">overwriteExisting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">skipPrefixes</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
                  <span class="n">expandSelection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">includeOrphans</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">pidList</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export selected contents of the project to a Nef file.</span>

<span class="sd">        skipPrefixes: ( &#39;ccpn&#39;, ..., &lt;str&gt; )</span>
<span class="sd">        expandSelection: &lt;bool&gt;</span>
<span class="sd">        includeOrphans: &lt;bool&gt;</span>

<span class="sd">        Include &#39;ccpn&#39; in the skipPrefixes list will exclude ccpn specific items from the file</span>
<span class="sd">        expandSelection = True      will include all data from the project, this may not be data that</span>
<span class="sd">                                    is not defined in the Nef standard.</span>
<span class="sd">        includeOrphans = True       will include chemicalShifts that have no peak assignments (orphans)</span>

<span class="sd">        PidList is a list of &lt;str&gt;, e.g. &#39;NC:@-&#39;, obtained from the objects to be included.</span>
<span class="sd">        The Nef file may also contain further dependent items associated with the pidList.</span>

<span class="sd">        :param path: output path and filename</span>
<span class="sd">        :param skipPrefixes: items to skip</span>
<span class="sd">        :param expandSelection: expand the selection</span>
<span class="sd">        :param includeOrphans: include chemicalShift orphans</span>
<span class="sd">        :param pidList: a list of pids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.framework.lib.ccpnNef</span> <span class="kn">import</span> <span class="n">CcpnNefIo</span>

        <span class="k">with</span> <span class="n">undoBlock</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">notificationBlanking</span><span class="p">():</span>
                <span class="n">CcpnNefIo</span><span class="o">.</span><span class="n">exportNef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                                    <span class="n">overwriteExisting</span><span class="o">=</span><span class="n">overwriteExisting</span><span class="p">,</span>
                                    <span class="n">skipPrefixes</span><span class="o">=</span><span class="n">skipPrefixes</span><span class="p">,</span>
                                    <span class="n">expandSelection</span><span class="o">=</span><span class="n">expandSelection</span><span class="p">,</span>
                                    <span class="n">includeOrphans</span><span class="o">=</span><span class="n">includeOrphans</span><span class="p">,</span>
                                    <span class="n">pidList</span><span class="o">=</span><span class="n">pidList</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.isCoreObject"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.isCoreObject">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isCoreObject</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if obj is a core ccpn object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">AbstractWrapperObject</span><span class="p">,</span> <span class="n">V3CoreObjectABC</span><span class="p">))</span></div>

<div class="viewcode-block" id="Project.isCoreClass"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.isCoreClass">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isCoreClass</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if type(klass) is a core ccpn object type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="p">(</span><span class="n">AbstractWrapperObject</span><span class="p">,</span> <span class="n">V3CoreObjectABC</span><span class="p">))</span></div>

    <span class="c1">#===========================================================================================</span>
    <span class="c1"># Data loaders</span>
    <span class="c1">#===========================================================================================</span>

<div class="viewcode-block" id="Project.loadData"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.loadData">[docs]</a>    <span class="k">def</span> <span class="nf">loadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a stub for backward compatibility</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_loadFastaFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load Fasta sequence(s) from file into Wrapper project</span>
<span class="sd">        CCPNINTERNAL: called from FastDataLoader</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">logCommandManager</span><span class="p">(</span><span class="s1">&#39;application.&#39;</span><span class="p">,</span> <span class="s1">&#39;loadData&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="n">fastaIo</span><span class="o">.</span><span class="n">parseFastaFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">newChain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createChain</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">compoundName</span><span class="o">=</span><span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">molType</span><span class="o">=</span><span class="s1">&#39;protein&#39;</span><span class="p">)</span>
                <span class="n">chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newChain</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chains</span>

    <span class="k">def</span> <span class="nf">_loadPdbFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load data from pdb file path into new StructureEnsemble object(s)</span>
<span class="sd">        CCPNINTERNAL: called from pdb dataLoader</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.util.StructureData</span> <span class="kn">import</span> <span class="n">EnsembleData</span><span class="p">,</span> <span class="n">averageStructure</span>

        <span class="k">with</span> <span class="n">logCommandManager</span><span class="p">(</span><span class="s1">&#39;application.&#39;</span><span class="p">,</span> <span class="s1">&#39;loadData&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span>

            <span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleData</span><span class="o">.</span><span class="n">from_pdb</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newStructureEnsemble</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ensemble</span><span class="p">)</span>

            <span class="c1"># create a new ensemble-average in a dataTable</span>
            <span class="n">dTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newDataTable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">-average&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">averageStructure</span><span class="p">(</span><span class="n">ensemble</span><span class="p">))</span>
            <span class="n">dTable</span><span class="o">.</span><span class="n">setMetadata</span><span class="p">(</span><span class="s1">&#39;structureEnsemble&#39;</span><span class="p">,</span> <span class="n">se</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">se</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_loadTextFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load text from file path into new Note object</span>
<span class="sd">        CCPNINTERNAL: called from text dataLoader</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">logCommandManager</span><span class="p">(</span><span class="s1">&#39;application.&#39;</span><span class="p">,</span> <span class="s1">&#39;loadData&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span>

            <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="c1"># cannot do read() as we want one string</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
            <span class="n">note</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newNote</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">note</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_loadLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">),</span> <span class="n">subType</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># this is a GUI only function call. Please move to the appropriate location on 3.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_restoreLayoutFromFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadExcelFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load data from a Excel file.</span>
<span class="sd">        :returns list of loaded objects (awaiting adjust ment of excelReader)</span>
<span class="sd">        CCPNINTERNAL: used in Excel data loader</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">logCommandManager</span><span class="p">(</span><span class="s1">&#39;application.&#39;</span><span class="p">,</span> <span class="s1">&#39;loadData&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">undoBlock</span><span class="p">():</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">ExcelReader</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">excelPath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1">#===========================================================================================</span>
    <span class="c1"># End data loaders</span>
    <span class="c1">#===========================================================================================</span>

<div class="viewcode-block" id="Project.getObjectsByPartialId"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getObjectsByPartialId">[docs]</a>    <span class="k">def</span> <span class="nf">getObjectsByPartialId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">idStartsWith</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">AbstractWrapperObject</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;get objects from class name / shortName and the start of the ID.</span>

<span class="sd">        The function does NOT interrogate the API level, which makes it faster in a</span>
<span class="sd">        number fo cases, e.g. for NmrResidues&quot;&quot;&quot;</span>

        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
            <span class="c1"># NB the _pid2Obj entry is set in the object init.</span>
            <span class="c1"># The relevant dictionary may therefore be missing if no object has yet been created</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">idStartsWith</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Project.getObjectsById"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getObjectsById">[docs]</a>    <span class="k">def</span> <span class="nf">getObjectsById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">AbstractWrapperObject</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;get objects from class name / shortName and the start of the ID.</span>

<span class="sd">        The function does NOT interrogate the API level, which makes it faster in a</span>
<span class="sd">        number fo cases, e.g. for NmrResidues&quot;&quot;&quot;</span>

        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
            <span class="c1"># NB the _pid2Obj entry is set in the object init.</span>
            <span class="c1"># The relevant dictionary may therefore be missing if no object has yet been created</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Project.getObjectsByPids"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getObjectsByPids">[docs]</a>    <span class="k">def</span> <span class="nf">getObjectsByPids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pids</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optimise method to get all found objects from a list of pids. Remove any None.</span>
<span class="sd">         Warning: do not use with zip&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">pids</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Project.getByPids"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getByPids">[docs]</a>    <span class="k">def</span> <span class="nf">getByPids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pids</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optimise method to get all found objects from a list of pids. Remove any None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">isCoreObject</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">objs</span><span class="p">))</span></div>

<div class="viewcode-block" id="Project.getPidsByObjects"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getPidsByObjects">[docs]</a>    <span class="k">def</span> <span class="nf">getPidsByObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optimise method to get all found pids from a list of objects. Remove any None.</span>
<span class="sd">         Warning: do not use with zip&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pid</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">AbstractWrapperObject</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">objs</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Project.getCcpCodeData"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getCcpCodeData">[docs]</a>    <span class="k">def</span> <span class="nf">getCcpCodeData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccpCode</span><span class="p">,</span> <span class="n">molType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atomType</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the CcpCode for molType/AtomType</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.assignment.ChemicalShift</span> <span class="kn">import</span> <span class="n">getCcpCodeData</span>

        <span class="k">return</span> <span class="n">getCcpCodeData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apiNmrProject</span><span class="p">,</span> <span class="n">ccpCode</span><span class="p">,</span> <span class="n">molType</span><span class="o">=</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="n">atomType</span><span class="o">=</span><span class="n">atomType</span><span class="p">)</span></div>

    <span class="c1"># def packageProject(self, filePrefix, includeBackups=True, includeLogs=True):</span>
    <span class="c1">#     &quot;&quot;&quot;Package the project</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     from ccpnmodel.ccpncore.lib.Io import Api as apiIo</span>
    <span class="c1">#</span>
    <span class="c1">#     return apiIo.packageProject(self._wrappedData.parent, filePrefix,</span>
    <span class="c1">#                                 includeBackups=includeBackups, includeLogs=includeLogs)</span>

<div class="viewcode-block" id="Project.saveToArchive"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.saveToArchive">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">saveToArchive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make new time-stamped archive of project</span>
<span class="sd">        :return path to .tgz archive file as a Path object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.lib.ProjectArchiver</span> <span class="kn">import</span> <span class="n">ProjectArchiver</span>

        <span class="n">archiver</span> <span class="o">=</span> <span class="n">ProjectArchiver</span><span class="p">(</span><span class="n">projectPath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">archivePath</span> <span class="o">=</span> <span class="n">archiver</span><span class="o">.</span><span class="n">makeArchive</span><span class="p">()</span>
        <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==&gt; Project archived to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">archivePath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archivePath</span></div>

    <span class="k">def</span> <span class="nf">_getArchivePaths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;:return list of archives from archive directory</span>
<span class="sd">        CCPNINTERAL: used in GuiMainWindow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.lib.ProjectArchiver</span> <span class="kn">import</span> <span class="n">ProjectArchiver</span>

        <span class="n">archiver</span> <span class="o">=</span> <span class="n">ProjectArchiver</span><span class="p">(</span><span class="n">projectPath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">archiver</span><span class="o">.</span><span class="n">archives</span>

<div class="viewcode-block" id="Project.getExperimentClassifications"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getExperimentClassifications">[docs]</a>    <span class="k">def</span> <span class="nf">getExperimentClassifications</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a dictionary of dictionaries of dimensionCount:sortedNuclei:ExperimentClassification named tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE:ED - better than being in spectrumLib but still needs moving</span>
        <span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.spectrum.NmrExpPrototype</span> <span class="kn">import</span> <span class="n">getExpClassificationDict</span>

        <span class="k">return</span> <span class="n">getExpClassificationDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">)</span></div>

    <span class="c1">#===========================================================================================</span>
    <span class="c1"># new&lt;Object&gt; and other methods</span>
    <span class="c1"># Call appropriate routines in their respective locations</span>
    <span class="c1">#===========================================================================================</span>

<div class="viewcode-block" id="Project.newMark"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newMark">[docs]</a>    <span class="k">def</span> <span class="nf">newMark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">axisCodes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">labels</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be depreciated in next version; use mainWindow.newMark() instead</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">newMark</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
                                                   <span class="n">axisCodes</span><span class="o">=</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
                                                   <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newSpectrum"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newSpectrum">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creation of new Spectrum defined by path; optionally set name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Spectrum</span> <span class="kn">import</span> <span class="n">_newSpectrum</span>

        <span class="k">return</span> <span class="n">_newSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

    <span class="c1"># @logCommand(&#39;project.&#39;)</span>
    <span class="c1"># def createDummySpectrum(self, axisCodes: Sequence[str], name=None, chemicalShiftList=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Make dummy spectrum from isotopeCodes list - without data and with default parameters.</span>
    <span class="c1">#</span>
    <span class="c1">#     :param axisCodes:</span>
    <span class="c1">#     :param name:</span>
    <span class="c1">#     :param chemicalShiftList:</span>
    <span class="c1">#     :return: a new Spectrum instance.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     raise NotImplementedError(&#39;Use Project.newEmptySpectrum&#39;)</span>

<div class="viewcode-block" id="Project.newEmptySpectrum"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newEmptySpectrum">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newEmptySpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotopeCodes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">dimensionCount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;emptySpectrum&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make new Empty spectrum from isotopeCodes list - without data and with default parameters.</span>
<span class="sd">        default parameters are defined in: SpectrumDataSourceABC.isotopeDefaultDataDict</span>

<span class="sd">        :param isotopeCodes: a tuple/list of isotope codes that define the dimensions; e.g. (&#39;1H&#39;, &#39;13C&#39;)</span>
<span class="sd">        :dimensionCount: an optional dimensionCount parameter; default derived from len(isotopeCodes)</span>
<span class="sd">        :param name: the name of the resulting spectrum</span>
<span class="sd">        :param path: an optional path to be stored with the Spectrum instance</span>
<span class="sd">        :param **parameters: optional spectrum (parameter, value) pairs</span>
<span class="sd">        :return: a new Spectrum instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Spectrum</span> <span class="kn">import</span> <span class="n">_newEmptySpectrum</span>

        <span class="k">return</span> <span class="n">_newEmptySpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotopeCodes</span><span class="o">=</span><span class="n">isotopeCodes</span><span class="p">,</span> <span class="n">dimensionCount</span><span class="o">=</span><span class="n">dimensionCount</span><span class="p">,</span>
                                 <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newHdf5Spectrum"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newHdf5Spectrum">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newHdf5Spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotopeCodes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hdf5Spectrum&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make new hdf5 spectrum from isotopeCodes list - without data and with default parameters.</span>

<span class="sd">        :param isotopeCodes:</span>
<span class="sd">        :param name: name of the spectrum</span>
<span class="sd">        :param path: optional path (autogenerated from name when None; resulting file will be in</span>
<span class="sd">                     data/spectra folder of the project)</span>
<span class="sd">        :param **parameters: optional spectrum (parameter, value) pairs</span>
<span class="sd">        :return: a new Spectrum instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Spectrum</span> <span class="kn">import</span> <span class="n">_newHdf5Spectrum</span>

        <span class="k">return</span> <span class="n">_newHdf5Spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotopeCodes</span><span class="o">=</span><span class="n">isotopeCodes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newNmrChain"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newNmrChain">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isConnected</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
                    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new NmrChain. Setting isConnected=True produces a connected NmrChain.</span>

<span class="sd">        :param str shortName: shortName for new nmrChain (optional, defaults to &#39;@ijk&#39; or &#39;#ijk&#39;,  ijk positive integer</span>
<span class="sd">        :param bool isConnected: (default to False) If true the NmrChain is a connected stretch. This can NOT be changed later</span>
<span class="sd">        :param str label: Modifiable NmrChain identifier that does not change with reassignment. Defaults to &#39;@ijk&#39;/&#39;#ijk&#39;</span>
<span class="sd">        :param str comment: comment for new nmrChain (optional)</span>
<span class="sd">        :return: a new NmrChain instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.NmrChain</span> <span class="kn">import</span> <span class="n">_newNmrChain</span>

        <span class="k">return</span> <span class="n">_newNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortName</span><span class="o">=</span><span class="n">shortName</span><span class="p">,</span> <span class="n">isConnected</span><span class="o">=</span><span class="n">isConnected</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.fetchNmrChain"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.fetchNmrChain">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetchNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch chain with given shortName; If none exists call newNmrChain to make one first</span>

<span class="sd">        If shortName is None returns a new NmrChain with name starting with &#39;@&#39;</span>

<span class="sd">        :param shortName: string name of required nmrAtom</span>
<span class="sd">        :return: an NmrChain instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.NmrChain</span> <span class="kn">import</span> <span class="n">_fetchNmrChain</span>

        <span class="k">return</span> <span class="n">_fetchNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortName</span><span class="o">=</span><span class="n">shortName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.produceNmrAtom"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.produceNmrAtom">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">produceNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chainCode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">sequenceCode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">residueType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get chainCode, sequenceCode, residueType and atomName from dot-separated atomId or Pid</span>
<span class="sd">            or explicit parameters, and find or create an NmrAtom that matches</span>
<span class="sd">            Empty chainCode gets NmrChain:@- ; empty sequenceCode get a new NmrResidue</span>

<span class="sd">        :param atomId:</span>
<span class="sd">        :param chainCode:</span>
<span class="sd">        :param sequenceCode:</span>
<span class="sd">        :param residueType:</span>
<span class="sd">        :param name: new or existing nmrAtom, matching parameters</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.NmrAtom</span> <span class="kn">import</span> <span class="n">_produceNmrAtom</span>

        <span class="k">return</span> <span class="n">_produceNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomId</span><span class="o">=</span><span class="n">atomId</span><span class="p">,</span> <span class="n">chainCode</span><span class="o">=</span><span class="n">chainCode</span><span class="p">,</span>
                               <span class="n">sequenceCode</span><span class="o">=</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="o">=</span><span class="n">residueType</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newNote"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newNote">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newNote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new Note.</span>

<span class="sd">        See the Note class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Note._newNote for details.</span>

<span class="sd">        :param name: name for the note.</span>
<span class="sd">        :param text: contents of the note.</span>
<span class="sd">        :return: a new Note instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Note</span> <span class="kn">import</span> <span class="n">_newNote</span>

        <span class="k">return</span> <span class="n">_newNote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newWindow"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newWindow">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">size</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new child Window.</span>

<span class="sd">        See the Window class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Window._newWindow for details.</span>

<span class="sd">        :param str title: window  title (optional, defaults to &#39;W1&#39;, &#39;W2&#39;, &#39;W3&#39;, ...</span>
<span class="sd">        :param tuple position: x,y position for new window in integer pixels.</span>
<span class="sd">        :param tuple size: x,y size for new window in integer pixels.</span>
<span class="sd">        :return: a new Window instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.ui._implementation.Window</span> <span class="kn">import</span> <span class="n">_newWindow</span>

        <span class="k">return</span> <span class="n">_newWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newStructureEnsemble"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newStructureEnsemble">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newStructureEnsemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new StructureEnsemble.</span>

<span class="sd">        See the StructureEnsemble class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see StructureEnsemble._newStructureEnsemble for details.</span>

<span class="sd">        :param name: new name for the StructureEnsemble.</span>
<span class="sd">        :param data: Pandas dataframe.</span>
<span class="sd">        :param comment: optional comment string</span>
<span class="sd">        :return: a new StructureEnsemble instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.StructureEnsemble</span> <span class="kn">import</span> <span class="n">_newStructureEnsemble</span>

        <span class="k">return</span> <span class="n">_newStructureEnsemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newDataTable"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newDataTable">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newDataTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new DataTable.</span>

<span class="sd">        See the DataTable class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see DataTable._newDataTable for details.</span>

<span class="sd">        :param name: new name for the DataTable.</span>
<span class="sd">        :param data: Pandas dataframe.</span>
<span class="sd">        :param comment: optional comment string</span>
<span class="sd">        :return: a new DataTable instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.DataTable</span> <span class="kn">import</span> <span class="n">_newDataTable</span>

        <span class="k">return</span> <span class="n">_newDataTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.fetchDataTable"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.fetchDataTable">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetchDataTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get or create new DataTable.</span>
<span class="sd">        :param name: name for the DataTable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.DataTable</span> <span class="kn">import</span> <span class="n">_fetchDataTable</span>

        <span class="k">return</span> <span class="n">_fetchDataTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newPeakCluster"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newPeakCluster">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newPeakCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Peak&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;PeakCluster&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create new PeakCluster.</span>

<span class="sd">        See the PeakCluster class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see PeakCluster._newPeakCluster for details.</span>

<span class="sd">        :param peaks: optional list of peaks as objects or pids.</span>
<span class="sd">        :return: a new PeakCluster instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.PeakCluster</span> <span class="kn">import</span> <span class="n">_newPeakCluster</span>

        <span class="k">return</span> <span class="n">_newPeakCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="o">=</span><span class="n">peaks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newCollection"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newCollection">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Collection&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create new Collection.</span>

<span class="sd">        See the Collection class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Collection._newCollection for details.</span>

<span class="sd">        :param items: optional list of core objects as objects or pids.</span>
<span class="sd">        :return: a new Collection instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectionList</span><span class="o">.</span><span class="n">newCollection</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newSample"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newSample">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newSample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pH</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ionicStrength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">amountUnit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isVirtual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">isHazardous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">creationDate</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batchIdentifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plateIdentifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">rowNumber</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">columnNumber</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new Sample.</span>

<span class="sd">        See the Sample class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Sample._newSample for details.</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param pH:</span>
<span class="sd">        :param ionicStrength:</span>
<span class="sd">        :param amount:</span>
<span class="sd">        :param amountUnit:</span>
<span class="sd">        :param isVirtual:</span>
<span class="sd">        :param isHazardous:</span>
<span class="sd">        :param creationDate:</span>
<span class="sd">        :param batchIdentifier:</span>
<span class="sd">        :param plateIdentifier:</span>
<span class="sd">        :param rowNumber:</span>
<span class="sd">        :param columnNumber:</span>
<span class="sd">        :param comment:</span>
<span class="sd">        :param serial: optional serial number.</span>
<span class="sd">        :return: a new Sample instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Sample</span> <span class="kn">import</span> <span class="n">_newSample</span>

        <span class="k">return</span> <span class="n">_newSample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="n">pH</span><span class="p">,</span> <span class="n">ionicStrength</span><span class="o">=</span><span class="n">ionicStrength</span><span class="p">,</span>
                          <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span> <span class="n">amountUnit</span><span class="o">=</span><span class="n">amountUnit</span><span class="p">,</span> <span class="n">isVirtual</span><span class="o">=</span><span class="n">isVirtual</span><span class="p">,</span> <span class="n">isHazardous</span><span class="o">=</span><span class="n">isHazardous</span><span class="p">,</span>
                          <span class="n">creationDate</span><span class="o">=</span><span class="n">creationDate</span><span class="p">,</span> <span class="n">batchIdentifier</span><span class="o">=</span><span class="n">batchIdentifier</span><span class="p">,</span> <span class="n">plateIdentifier</span><span class="o">=</span><span class="n">plateIdentifier</span><span class="p">,</span>
                          <span class="n">rowNumber</span><span class="o">=</span><span class="n">rowNumber</span><span class="p">,</span> <span class="n">columnNumber</span><span class="o">=</span><span class="n">columnNumber</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.fetchSample"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.fetchSample">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetchSample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get or create Sample with given name.</span>
<span class="sd">        See the Sample class for details.</span>
<span class="sd">        :param self: project</span>
<span class="sd">        :param name: sample name</span>
<span class="sd">        :return: new or existing Sample instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Sample</span> <span class="kn">import</span> <span class="n">_fetchSample</span>

        <span class="k">return</span> <span class="n">_fetchSample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newStructureData"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newStructureData">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newStructureData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">programName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">programVersion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">dataPath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">creationDate</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">moleculeFilePath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new StructureData</span>

<span class="sd">        See the StructureData class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see StructureData._newStructureData for details.</span>

<span class="sd">        :param title: deprecated - original name for StructureData, please use .name</span>
<span class="sd">        :param name:</span>
<span class="sd">        :param programName:</span>
<span class="sd">        :param programVersion:</span>
<span class="sd">        :param dataPath:</span>
<span class="sd">        :param creationDate:</span>
<span class="sd">        :param uuid:</span>
<span class="sd">        :param comment:</span>
<span class="sd">        :return: a new StructureData instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.StructureData</span> <span class="kn">import</span> <span class="n">_newStructureData</span>

        <span class="k">return</span> <span class="n">_newStructureData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">programName</span><span class="o">=</span><span class="n">programName</span><span class="p">,</span> <span class="n">programVersion</span><span class="o">=</span><span class="n">programVersion</span><span class="p">,</span>
                                 <span class="n">dataPath</span><span class="o">=</span><span class="n">dataPath</span><span class="p">,</span> <span class="n">creationDate</span><span class="o">=</span><span class="n">creationDate</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuid</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                                 <span class="n">moleculeFilePath</span><span class="o">=</span><span class="n">moleculeFilePath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newSpectrumGroup"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newSpectrumGroup">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newSpectrumGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spectra</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new SpectrumGroup</span>

<span class="sd">        See the SpectrumGroup class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see SpectrumGroup._newSpectrumGroup for details.</span>

<span class="sd">        :param name: name for the new SpectrumGroup</span>
<span class="sd">        :param spectra: optional list of spectra as objects or pids</span>
<span class="sd">        :return: a new SpectrumGroup instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.SpectrumGroup</span> <span class="kn">import</span> <span class="n">_newSpectrumGroup</span>

        <span class="k">return</span> <span class="n">_newSpectrumGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">spectra</span><span class="o">=</span><span class="n">spectra</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.createChain"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.createChain">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">createChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">compoundName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">startNumber</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">molType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isCyclic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">shortName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">expandFromAtomSets</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">addPseudoAtoms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">addNonstereoAtoms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new chain from sequence of residue codes, using default variants.</span>

<span class="sd">        Automatically creates the corresponding polymer Substance if the compoundName is not already taken</span>

<span class="sd">        See the Chain class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Chain._createChain for details.</span>

<span class="sd">        :param Sequence sequence: string of one-letter codes or sequence of residue types</span>
<span class="sd">        :param str compoundName: name of new Substance (e.g. &#39;Lysozyme&#39;) Defaults to &#39;Molecule_n</span>
<span class="sd">        :param str molType: molType (&#39;protein&#39;,&#39;DNA&#39;, &#39;RNA&#39;). Needed only if sequence is a string.</span>
<span class="sd">        :param int startNumber: number of first residue in sequence</span>
<span class="sd">        :param str shortName: shortName for new chain (optional)</span>
<span class="sd">        :param str role: role for new chain (optional)</span>
<span class="sd">        :param str comment: comment for new chain (optional)</span>
<span class="sd">        :param bool expandFromAtomSets: Create new Atoms corresponding to the ChemComp AtomSets definitions.</span>
<span class="sd">                Eg. H1, H2, H3 equivalent atoms will add a new H% atom. This will facilitate assignments workflows.</span>
<span class="sd">                See ccpn.core.lib.MoleculeLib.expandChainAtoms for details.</span>
<span class="sd">        :return: a new Chain instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Chain</span> <span class="kn">import</span> <span class="n">_createChain</span>

        <span class="k">return</span> <span class="n">_createChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">compoundName</span><span class="o">=</span><span class="n">compoundName</span><span class="p">,</span>
                            <span class="n">startNumber</span><span class="o">=</span><span class="n">startNumber</span><span class="p">,</span> <span class="n">molType</span><span class="o">=</span><span class="n">molType</span><span class="p">,</span> <span class="n">isCyclic</span><span class="o">=</span><span class="n">isCyclic</span><span class="p">,</span>
                            <span class="n">shortName</span><span class="o">=</span><span class="n">shortName</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                            <span class="n">expandFromAtomSets</span><span class="o">=</span><span class="n">expandFromAtomSets</span><span class="p">,</span> <span class="n">addPseudoAtoms</span><span class="o">=</span><span class="n">addPseudoAtoms</span><span class="p">,</span>
                            <span class="n">addNonstereoAtoms</span><span class="o">=</span><span class="n">addNonstereoAtoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newSubstance"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newSubstance">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">labelling</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">substanceType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Molecule&#39;</span><span class="p">,</span>
                     <span class="n">userCode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inChi</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">casNumber</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">empiricalFormula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">molecularMass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">synonyms</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">atomCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bondCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">ringCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hBondDonorCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hBondAcceptorCount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">polarSurfaceArea</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logPartitionCoefficient</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new substance WITHOUT storing the sequence internally</span>
<span class="sd">        (and hence not suitable for making chains). SubstanceType defaults to &#39;Molecule&#39;.</span>

<span class="sd">        ADVANCED alternatives are &#39;Cell&#39; and &#39;Material&#39;</span>

<span class="sd">        See the Substance class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Substance._newSubstance for details.</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param labelling:</span>
<span class="sd">        :param substanceType:</span>
<span class="sd">        :param userCode:</span>
<span class="sd">        :param smiles:</span>
<span class="sd">        :param inChi:</span>
<span class="sd">        :param casNumber:</span>
<span class="sd">        :param empiricalFormula:</span>
<span class="sd">        :param molecularMass:</span>
<span class="sd">        :param comment:</span>
<span class="sd">        :param synonyms:</span>
<span class="sd">        :param atomCount:</span>
<span class="sd">        :param bondCount:</span>
<span class="sd">        :param ringCount:</span>
<span class="sd">        :param hBondDonorCount:</span>
<span class="sd">        :param hBondAcceptorCount:</span>
<span class="sd">        :param polarSurfaceArea:</span>
<span class="sd">        :param logPartitionCoefficient:</span>
<span class="sd">        :return: a new Substance instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Substance</span> <span class="kn">import</span> <span class="n">_newSubstance</span>

        <span class="k">return</span> <span class="n">_newSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">labelling</span><span class="o">=</span><span class="n">labelling</span><span class="p">,</span> <span class="n">substanceType</span><span class="o">=</span><span class="n">substanceType</span><span class="p">,</span>
                             <span class="n">userCode</span><span class="o">=</span><span class="n">userCode</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">inChi</span><span class="o">=</span><span class="n">inChi</span><span class="p">,</span> <span class="n">casNumber</span><span class="o">=</span><span class="n">casNumber</span><span class="p">,</span>
                             <span class="n">empiricalFormula</span><span class="o">=</span><span class="n">empiricalFormula</span><span class="p">,</span> <span class="n">molecularMass</span><span class="o">=</span><span class="n">molecularMass</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                             <span class="n">synonyms</span><span class="o">=</span><span class="n">synonyms</span><span class="p">,</span> <span class="n">atomCount</span><span class="o">=</span><span class="n">atomCount</span><span class="p">,</span> <span class="n">bondCount</span><span class="o">=</span><span class="n">bondCount</span><span class="p">,</span>
                             <span class="n">ringCount</span><span class="o">=</span><span class="n">ringCount</span><span class="p">,</span> <span class="n">hBondDonorCount</span><span class="o">=</span><span class="n">hBondDonorCount</span><span class="p">,</span> <span class="n">hBondAcceptorCount</span><span class="o">=</span><span class="n">hBondAcceptorCount</span><span class="p">,</span>
                             <span class="n">polarSurfaceArea</span><span class="o">=</span><span class="n">polarSurfaceArea</span><span class="p">,</span> <span class="n">logPartitionCoefficient</span><span class="o">=</span><span class="n">logPartitionCoefficient</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.fetchNefSubstance"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.fetchNefSubstance">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetchNefSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch Substance that matches sequence of NEF rows and/or name</span>

<span class="sd">        See the Substance class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Substance._fetchNefSubstance for details.</span>

<span class="sd">        :param self:</span>
<span class="sd">        :param sequence:</span>
<span class="sd">        :param name:</span>
<span class="sd">        :return: a new Nef Substance instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Substance</span> <span class="kn">import</span> <span class="n">_fetchNefSubstance</span>

        <span class="k">return</span> <span class="n">_fetchNefSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.getNefSubstance"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getNefSubstance">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getNefSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get existing Substance that matches sequence of NEF rows and/or name</span>

<span class="sd">        See the Substance class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Substance._fetchNefSubstance for details.</span>

<span class="sd">        :param self:</span>
<span class="sd">        :param sequence:</span>
<span class="sd">        :param name:</span>
<span class="sd">        :return: a new Nef Substance instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Substance</span> <span class="kn">import</span> <span class="n">_getNefSubstance</span>

        <span class="k">return</span> <span class="n">_getNefSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.createPolymerSubstance"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.createPolymerSubstance">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">createPolymerSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">labelling</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">userCode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">synonyms</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">startNumber</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">molType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isCyclic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make new Substance from sequence of residue codes, using default linking and variants</span>

<span class="sd">        NB: For more complex substances, you must use advanced, API-level commands.</span>

<span class="sd">        See the Substance class for details.</span>

<span class="sd">        Optional keyword arguments can be passed in; see Substance._fetchNefSubstance for details.</span>

<span class="sd">        :param Sequence sequence: string of one-letter codes or sequence of residueNames</span>
<span class="sd">        :param str name: name of new substance</span>
<span class="sd">        :param str labelling: labelling for new substance. Optional - None means &#39;natural abundance&#39;</span>
<span class="sd">        :param str userCode: user code for new substance (optional)</span>
<span class="sd">        :param str smiles: smiles string for new substance (optional)</span>
<span class="sd">        :param Sequence[str] synonyms: synonyms for Substance name</span>
<span class="sd">        :param str comment: comment for new substance (optional)</span>
<span class="sd">        :param int startNumber: number of first residue in sequence</span>
<span class="sd">        :param str molType: molType (&#39;protein&#39;,&#39;DNA&#39;, &#39;RNA&#39;). Required only if sequence is a string.</span>
<span class="sd">        :param bool isCyclic: Should substance created be cyclic?</span>
<span class="sd">        :return: a new Substance instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Substance</span> <span class="kn">import</span> <span class="n">_createPolymerSubstance</span>

        <span class="k">return</span> <span class="n">_createPolymerSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">labelling</span><span class="o">=</span><span class="n">labelling</span><span class="p">,</span> <span class="n">userCode</span><span class="o">=</span><span class="n">userCode</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span>
                                       <span class="n">synonyms</span><span class="o">=</span><span class="n">synonyms</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                                       <span class="n">startNumber</span><span class="o">=</span><span class="n">startNumber</span><span class="p">,</span> <span class="n">molType</span><span class="o">=</span><span class="n">molType</span><span class="p">,</span> <span class="n">isCyclic</span><span class="o">=</span><span class="n">isCyclic</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.fetchSubstance"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.fetchSubstance">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetchSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">labelling</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get or create Substance with given name and labelling.</span>
<span class="sd">        See the Substance class for details.</span>

<span class="sd">        :param self:</span>
<span class="sd">        :param name:</span>
<span class="sd">        :param labelling:</span>
<span class="sd">        :return: new or existing Substance instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Substance</span> <span class="kn">import</span> <span class="n">_fetchSubstance</span>

        <span class="k">return</span> <span class="n">_fetchSubstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">labelling</span><span class="o">=</span><span class="n">labelling</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newComplex"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newComplex">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newComplex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new Complex.</span>
<span class="sd">        See the Complex class for details.</span>
<span class="sd">        Optional keyword arguments can be passed in; see Complex._newComplex for details.</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param chains:</span>
<span class="sd">        :return: a new Complex instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Complex</span> <span class="kn">import</span> <span class="n">_newComplex</span>

        <span class="k">return</span> <span class="n">_newComplex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.newChemicalShiftList"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newChemicalShiftList">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">newChemicalShiftList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spectra</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new ChemicalShiftList.</span>
<span class="sd">        See the ChemicalShiftList class for details.</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param spectra:</span>
<span class="sd">        :return: a new ChemicalShiftList instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.ChemicalShiftList</span> <span class="kn">import</span> <span class="n">_newChemicalShiftList</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Spectrum</span> <span class="kn">import</span> <span class="n">Spectrum</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">:=</span> <span class="n">_newChemicalShiftList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)):</span>
            <span class="c1"># needs to be here so that all chemicalShiftTables are notified correctly</span>
            <span class="k">if</span> <span class="n">spectra</span><span class="p">:</span>
                <span class="n">getByPid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">getByPid</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">spectra</span> <span class="o">:=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">Spectrum</span><span class="p">),</span>
                                           <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="n">getByPid</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">sp</span><span class="p">,</span> <span class="n">spectra</span><span class="p">)))):</span>
                    <span class="c1"># add/transfer the spectra</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span>

            <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getChemicalShiftList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get existing ChemicalShiftList.</span>
<span class="sd">        See the ChemicalShiftList class for details.</span>

<span class="sd">        :param name:</span>
<span class="sd">        :return: a new ChemicalShiftList instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.ChemicalShiftList</span> <span class="kn">import</span> <span class="n">_getChemicalShiftList</span>

        <span class="k">return</span> <span class="n">_getChemicalShiftList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

<div class="viewcode-block" id="Project.getCollection"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getCollection">[docs]</a>    <span class="k">def</span> <span class="nf">getCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Collection&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the collection from the supplied name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Collection</span> <span class="kn">import</span> <span class="n">_getCollection</span>

        <span class="k">return</span> <span class="n">_getCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.fetchCollection"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.fetchCollection">[docs]</a>    <span class="nd">@logCommand</span><span class="p">(</span><span class="s1">&#39;project.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetchCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Collection&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get or create Collection.</span>
<span class="sd">        See the Collection class for details.</span>

<span class="sd">        :param name:</span>
<span class="sd">        :return: a new Collection instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.core.Collection</span> <span class="kn">import</span> <span class="n">_fetchCollection</span>

        <span class="k">return</span> <span class="n">_fetchCollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div></div>


<span class="c1">#=========================================================================================</span>
<span class="c1"># Code adapted from prior _implementation/Io.py</span>
<span class="c1">#=========================================================================================</span>

<span class="k">def</span> <span class="nf">_loadProject</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Project</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load the project defined by path</span>
<span class="sd">    :return Project instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ccpn.core._implementation.updates.update_v2</span> <span class="kn">import</span> <span class="n">updateProject_fromV2</span>

    <span class="n">_path</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Path </span><span class="si">{</span><span class="n">_path</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">apiProject</span> <span class="o">:=</span> <span class="n">apiIo</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">useFileLogger</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No valid project loaded from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="n">apiNmrProject</span> <span class="o">=</span> <span class="n">apiProject</span><span class="o">.</span><span class="n">fetchNmrProject</span><span class="p">()</span>
    <span class="n">apiNmrProject</span><span class="o">.</span><span class="n">initialiseData</span><span class="p">()</span>
    <span class="n">apiNmrProject</span><span class="o">.</span><span class="n">initialiseGraphicsData</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">apiNmrProject</span><span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_isNew</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># NB: linkages are set in Framework._intialiseProject()</span>

    <span class="c1"># If path pointed to a V2 project, save the result</span>
    <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">_isUpgradedFromV2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call the update</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==&gt; Upgrading </span><span class="si">%s</span><span class="s1"> to version-3&#39;</span> <span class="o">%</span> <span class="n">project</span><span class="p">)</span>
            <span class="n">updateProject_fromV2</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
            <span class="c1"># Using api calls as V3-Project has not yet been fully instantiated</span>
            <span class="n">apiProject</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
            <span class="n">apiProject</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==&gt; Writing model data&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed upgrading </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">)))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check if it has been moved</span>
        <span class="n">projectPath</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">path</span>
        <span class="n">oldName</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">name</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">projectPath</span><span class="p">)</span><span class="o">.</span><span class="n">basename</span>
        <span class="k">if</span> <span class="n">oldName</span> <span class="o">!=</span> <span class="n">newName</span><span class="p">:</span>
            <span class="c1"># Directory name has changed. Change project name and move Project xml file.</span>
            <span class="n">oldProjectFilePath</span> <span class="o">=</span> <span class="n">aPath</span><span class="p">(</span><span class="n">ApiPath</span><span class="o">.</span><span class="n">getProjectFile</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">oldName</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">oldProjectFilePath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">oldProjectFilePath</span><span class="o">.</span><span class="n">removeFile</span><span class="p">()</span>
            <span class="n">apiProject</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newName</span>
            <span class="c1"># Using api calls as V3-Project has not yet been fully instantiated</span>
            <span class="n">apiProject</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
            <span class="n">apiProject</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">project</span><span class="o">.</span><span class="n">_resetUndo</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">application</span><span class="o">.</span><span class="n">_debugLevel</span> <span class="o">&lt;=</span> <span class="n">Logging</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="n">application</span><span class="p">)</span>

    <span class="c1"># Do some admin</span>
    <span class="c1"># need project.path, as it may have have changed; e.g. for a V2 project</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_saveHistory</span> <span class="o">=</span> <span class="n">fetchProjectSaveHistory</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># the initialisation is completed by Framework when it has done its things</span>
    <span class="c1"># project._initialiseProject()</span>

    <span class="k">return</span> <span class="n">project</span>


<span class="k">def</span> <span class="nf">_newProject</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Project</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Make new project, putting underlying data storage (API project) at path</span>
<span class="sd">    :return Project instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># apiIo.newProject will create a temp path if path is None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">apiProject</span> <span class="o">:=</span> <span class="n">apiIo</span><span class="o">.</span><span class="n">newProject</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">useFileLogger</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;New project could not be created (overlaps exiting project?) name:</span><span class="si">%s</span><span class="s2">, path:</span><span class="si">%s</span><span class="s2">, overwrite:&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">))</span>

    <span class="n">apiNmrProject</span> <span class="o">=</span> <span class="n">apiProject</span><span class="o">.</span><span class="n">fetchNmrProject</span><span class="p">()</span>
    <span class="n">apiNmrProject</span><span class="o">.</span><span class="n">initialiseData</span><span class="p">()</span>
    <span class="n">apiNmrProject</span><span class="o">.</span><span class="n">initialiseGraphicsData</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">apiNmrProject</span><span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_isNew</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># NB: linkages are set in Framework._initialiseProject()</span>

    <span class="n">project</span><span class="o">.</span><span class="n">_objectVersion</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">applicationVersion</span>

    <span class="n">project</span><span class="o">.</span><span class="n">_resetUndo</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">application</span><span class="o">.</span><span class="n">_debugLevel</span> <span class="o">&lt;=</span> <span class="n">Logging</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="n">application</span><span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_saveHistory</span> <span class="o">=</span> <span class="n">newProjectSaveHistory</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># the initialisation is completed by Framework when it has done its things</span>
    <span class="c1"># project._initialiseProject()</span>

    <span class="k">return</span> <span class="n">project</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Python  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ccpn.core.Project</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>