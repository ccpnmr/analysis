<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.ui.gui.widgets.CompoundView &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.ui.gui.widgets.CompoundView</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This widget is based on the CcpNmr ChemBuild.</span>
<span class="sd">Credits to Tim Stevens, University of Cambridge December 2010-2012</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:32:52 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b3 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:41 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="n">PI</span> <span class="o">=</span> <span class="mf">3.1415926535898</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtSvg</span><span class="p">,</span> <span class="n">QtPrintSupport</span>
<span class="kn">from</span>  <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QGraphicsView</span><span class="p">,</span> <span class="n">QGraphicsScene</span>
<span class="n">Qt</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span>
<span class="n">QPointF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span>
<span class="n">QRectF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">atan2</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">radians</span><span class="p">,</span> <span class="n">hypot</span><span class="p">,</span> <span class="n">pi</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Base</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.FileDialog</span> <span class="kn">import</span> <span class="n">FileDialog</span>

<div class="viewcode-block" id="CompoundView"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView">[docs]</a><span class="k">class</span> <span class="nc">CompoundView</span><span class="p">(</span><span class="n">QGraphicsView</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">variant</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">preferences</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">CompoundView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">QGraphicsScene</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setScene</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">CacheBackground</span><span class="p">)</span>
    <span class="c1"># QtWidgets.QGraphicsView.__init__(self, parent)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span> <span class="o">=</span> <span class="n">preferences</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">colourScheme</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">==</span> <span class="s1">&#39;light&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;background-color: #bd8413&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;background-color: #020F31&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAtomColorWhite</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bondColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">white</span>
    <span class="c1">#</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bondColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">black</span>


    <span class="c1"># self.setCompound = self.setCompound</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rotatePos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">variant</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">compound</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dustbin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">groupItems</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nameAtoms</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showChargeSymbols</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showChiralities</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showStats</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showGroups</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">movePos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">zoomLevel</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="c1"># Context menu</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">needMenuAtom</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">needSelectedAtom</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">needFurtherCheck</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">contextMenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setupContextMenu</span><span class="p">()</span>

    <span class="c1"># self.setGeometry(20, 40, 350, 350) #[(1) &lt; left, (2) &lt; up, (3)Width, (4)Height</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">CacheBackground</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setResizeAnchor</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">AnchorViewCenter</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setDragMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">RubberBandDrag</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setViewportUpdateMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">FullViewportUpdate</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setInteractive</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetView</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span> <span class="o">=</span> <span class="n">SelectionBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">editAtom</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">setMaxLength</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

    <span class="n">effect</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsDropShadowEffect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">effect</span><span class="o">.</span><span class="n">setBlurRadius</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">effect</span><span class="o">.</span><span class="n">setOffset</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#self.editWidget.setGraphicsEffect(effect)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">returnPressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setAtomName</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editProxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editProxy</span><span class="o">.</span><span class="n">setZValue</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>



    <span class="c1"># self.setBackgroundBrush(self.backgroundColor)</span>

    <span class="c1"># TODO: Add settings for this</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showSkeletalFormula</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showSkeletalFormulaColor</span> <span class="o">=</span>  <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">snapToGrid</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">autoChirality</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">addGraphicsItems</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">showSkeletalFormula</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">snapAtomsToGrid</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setSmiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>

<div class="viewcode-block" id="CompoundView.setSmiles"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.setSmiles">[docs]</a>  <span class="k">def</span> <span class="nf">setSmiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">):</span>
    <span class="s1">&#39;set the smiles&#39;</span>
    <span class="n">compound</span> <span class="o">=</span> <span class="n">importSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="n">variant</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setVariant</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>
    <span class="n">variant</span><span class="o">.</span><span class="n">snapAtomsToGrid</span><span class="p">(</span><span class="n">ignoreHydrogens</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">centerView</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetView</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="CompoundView.resizeEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.resizeEvent">[docs]</a>  <span class="k">def</span> <span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>
    
  <span class="c1"># def paintEvent(self, event: QtGui.QPaintEvent):</span>
  <span class="c1">#   return QtWidgets.QGraphicsView.paintEvent(self, event)</span>

<div class="viewcode-block" id="CompoundView.setAtomName"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.setAtomName">[docs]</a>  <span class="k">def</span> <span class="nf">setAtomName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editAtom</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>
      <span class="k">return</span>
    
    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="p">(</span><span class="n">text</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
      <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
        <span class="n">prevAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">text</span><span class="p">]</span>
        <span class="n">name2</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span>
        <span class="k">while</span> <span class="n">name2</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
          <span class="n">name2</span> <span class="o">=</span> <span class="n">name2</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span>
        <span class="n">prevAtom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span>  
        <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> 
        
      <span class="k">else</span><span class="p">:</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> 


    <span class="bp">self</span><span class="o">.</span><span class="n">editAtom</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span></div>
  
<div class="viewcode-block" id="CompoundView.queryAtomName"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.queryAtomName">[docs]</a>  <span class="k">def</span> <span class="nf">queryAtomName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomLabel</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">editAtom</span> <span class="o">=</span> <span class="n">atom</span> <span class="o">=</span> <span class="n">atomLabel</span><span class="o">.</span><span class="n">atom</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editWidget</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">center</span><span class="p">())</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">atomLabel</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">-</span> <span class="n">center</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">editProxy</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompoundView.drawForeground"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.drawForeground">[docs]</a>  <span class="k">def</span> <span class="nf">drawForeground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">viewRect</span><span class="p">):</span>
  
    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">drawForeground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">viewRect</span><span class="p">)</span></div>



<div class="viewcode-block" id="CompoundView.drawBackground"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.drawBackground">[docs]</a>  <span class="k">def</span> <span class="nf">drawBackground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">viewRect</span><span class="p">):</span>
    
    <span class="n">transform</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">m11</span><span class="p">())</span>
    <span class="n">unScale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">scale</span>
    
    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">drawBackground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">viewRect</span><span class="p">)</span>

    <span class="c1"># Text</span>
    
    <span class="n">pad</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">qPoint</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span>
    <span class="n">qRectF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">ATOM_NAME_FG</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;DejaVu Sans Mono&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">unScale</span><span class="p">,</span> <span class="n">unScale</span><span class="p">)</span>
    <span class="n">fontMetric</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>

    <span class="n">tl</span> <span class="o">=</span> <span class="n">viewRect</span><span class="o">.</span><span class="n">topLeft</span><span class="p">()</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">viewRect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span></div>


    
<div class="viewcode-block" id="CompoundView.resetView"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.resetView">[docs]</a>  <span class="k">def</span> <span class="nf">resetView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">resetCachedContent</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span></div>
  
<div class="viewcode-block" id="CompoundView.setupContextMenu"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.setupContextMenu">[docs]</a>  <span class="k">def</span> <span class="nf">setupContextMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="c1">#</span>
    <span class="n">QAction</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Reset View&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resetView</span><span class="p">)</span>
    <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="n">subMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="s1">&#39;Export&#39;</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Export PDF(3D)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exportPdf</span><span class="p">)</span>
    <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Export SVG(2D)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exportSvg</span><span class="p">)</span>
    <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="n">subMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="s1">&#39;Edit&#39;</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Show Skeletal structure &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showSkeletal</span><span class="p">)</span>
    <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Show 3D structure &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">show3D</span><span class="p">)</span>
    <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Rotate Left&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotateLeft</span><span class="p">)</span>
    <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">needMenuAtom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Rotate Right&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">triggered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotateRight</span><span class="p">)</span>
    <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">menu</span></div>

<div class="viewcode-block" id="CompoundView.popupContextMenu"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.popupContextMenu">[docs]</a>  <span class="k">def</span> <span class="nf">popupContextMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>

    <span class="n">menuAtomView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span>
    <span class="n">menuAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span>

    <span class="k">if</span> <span class="n">menuAtom</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needMenuAtom</span><span class="p">:</span>
        <span class="n">action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needMenuAtom</span><span class="p">:</span>
        <span class="n">action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needSelectedAtom</span><span class="p">:</span>
        <span class="n">action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needSelectedAtom</span><span class="p">:</span>
        <span class="n">action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needFurtherCheck</span><span class="p">:</span>
      <span class="n">action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">func</span><span class="p">()))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">contextMenu</span><span class="o">.</span><span class="n">popup</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span></div>




<div class="viewcode-block" id="CompoundView.getMenuAtom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.getMenuAtom">[docs]</a>  <span class="k">def</span> <span class="nf">getMenuAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posFilter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">negFilter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="p">:</span>
      <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="o">.</span><span class="n">element</span>

      <span class="k">if</span> <span class="n">posFilter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">negFilter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span>
        <span class="k">elif</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">negFilter</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span>

      <span class="k">elif</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">posFilter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">negFilter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span>
        <span class="k">elif</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">negFilter</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span></div>


<div class="viewcode-block" id="CompoundView.getMenuLinkAtoms"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.getMenuLinkAtoms">[docs]</a>  <span class="k">def</span> <span class="nf">getMenuLinkAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="p">,]</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="o">.</span><span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">):</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="p">,]</span>
        <span class="k">for</span> <span class="n">atomB</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atomB</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

      <span class="k">return</span> <span class="n">atoms</span></div>

<div class="viewcode-block" id="CompoundView.setVariant"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.setVariant">[docs]</a>  <span class="k">def</span> <span class="nf">setVariant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">variant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="p">:</span>
      <span class="n">scene</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">groupItems</span> <span class="o">=</span> <span class="p">{}</span>
      
      <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
      <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editProxy</span><span class="p">)</span>
      <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="p">)</span>
      <span class="c1"># print(items)</span>

      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">item</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
      
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">item</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">resetCachedContent</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">compound</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">addGraphicsItems</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">centerView</span><span class="p">()</span></div>

<div class="viewcode-block" id="CompoundView.updateAll"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.updateAll">[docs]</a>  <span class="k">def</span> <span class="nf">updateAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span>
    
    <span class="k">if</span> <span class="n">var</span><span class="p">:</span>
      <span class="n">getView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span><span class="o">.</span><span class="n">get</span>
      <span class="n">bondItems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span>
      <span class="n">getBondItem</span> <span class="o">=</span> <span class="n">bondItems</span><span class="o">.</span><span class="n">get</span>
      <span class="n">groupDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupItems</span>
      
      <span class="n">usedGroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">usedGroups</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupDict</span><span class="p">:</span>
          <span class="n">groupDict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">syncGroup</span><span class="p">()</span>
          
        <span class="k">elif</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">EQUIVALENT</span><span class="p">:</span>
          <span class="n">EquivItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">PROCHIRAL</span><span class="p">:</span>
          <span class="n">ProchiralItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
          <span class="n">AromaticItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
      
      <span class="n">zombieGroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">groupDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">usedGroups</span>
      <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">zombieGroups</span><span class="p">:</span>
        <span class="n">groupItem</span> <span class="o">=</span> <span class="n">groupDict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">groupDict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">groupItem</span>
      
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">atomView</span> <span class="o">=</span> <span class="n">getView</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
     
        <span class="k">if</span> <span class="n">atomView</span><span class="p">:</span>
          <span class="n">atomView</span><span class="o">.</span><span class="n">syncToAtom</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">atomView</span> <span class="o">=</span> <span class="n">AtomItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>

      <span class="n">zombieBonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">zombieBonds</span><span class="p">:</span>
        <span class="n">bondItem</span> <span class="o">=</span>  <span class="n">bondItems</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">bondItems</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">bondItem</span>
      
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">bondItem</span> <span class="o">=</span> <span class="n">getBondItem</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bondItem</span><span class="p">:</span>
          <span class="n">bondItem</span> <span class="o">=</span> <span class="n">BondItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">bond</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="CompoundView.addGraphicsItems"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.addGraphicsItems">[docs]</a>  <span class="k">def</span> <span class="nf">addGraphicsItems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="p">:</span>
      <span class="k">return</span>
   
    <span class="n">scene</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span>
         
    <span class="c1"># Draw groups</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">EQUIVALENT</span><span class="p">:</span>
        <span class="n">EquivItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
      
      <span class="k">elif</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">PROCHIRAL</span><span class="p">:</span>
        <span class="n">ProchiralItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
        <span class="n">AromaticItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    
    <span class="c1"># Draw atoms</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">AtomItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>
      <span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># Draw bonds</span>
    <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span> <span class="o">=</span> <span class="n">bondDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
        <span class="k">pass</span>
        
      <span class="n">bondItem</span> <span class="o">=</span> <span class="n">BondItem</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">bond</span><span class="p">)</span>
      <span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">bondItem</span><span class="p">)</span>
      <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span></div>



 
<div class="viewcode-block" id="CompoundView.centroid"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.centroid">[docs]</a>  <span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">views</span><span class="p">):</span>
  
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
      <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">x0</span> <span class="o">+=</span> <span class="n">x1</span>
      <span class="n">y0</span> <span class="o">+=</span> <span class="n">y1</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mf">1.0</span>
    
    <span class="n">x0</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">y0</span> <span class="o">/=</span> <span class="n">n</span>
    
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> </div>

<div class="viewcode-block" id="CompoundView.centroidAtoms"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.centroidAtoms">[docs]</a>  <span class="k">def</span> <span class="nf">centroidAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
  
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">x0</span> <span class="o">+=</span> <span class="n">x1</span>
      <span class="n">y0</span> <span class="o">+=</span> <span class="n">y1</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mf">1.0</span>
    
    <span class="n">x0</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">y0</span> <span class="o">/=</span> <span class="n">n</span>
    
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span></div>



<div class="viewcode-block" id="CompoundView.changeBackground"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.changeBackground">[docs]</a>  <span class="k">def</span> <span class="nf">changeBackground</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="CompoundView.exportPdf"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.exportPdf">[docs]</a>  <span class="k">def</span> <span class="nf">exportPdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="p">:</span>
      <span class="n">printer</span> <span class="o">=</span> <span class="n">QtPrintSupport</span><span class="o">.</span><span class="n">QPrinter</span><span class="p">()</span>
      <span class="n">oldRes</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">resolution</span><span class="p">()</span>
      <span class="n">newRes</span> <span class="o">=</span> <span class="mf">600.0</span>
      <span class="n">fRes</span> <span class="o">=</span> <span class="n">oldRes</span><span class="o">/</span><span class="n">newRes</span>
      <span class="n">printer</span><span class="o">.</span><span class="n">setResolution</span><span class="p">(</span><span class="n">newRes</span><span class="p">)</span>

      <span class="n">fType</span> <span class="o">=</span> <span class="s1">&#39;PDF (*.pdf)&#39;</span>
      <span class="n">dialog</span> <span class="o">=</span> <span class="n">FileDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acceptMode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fileMode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">fType</span><span class="p">,</span> <span class="n">preferences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">)</span>
      <span class="n">filePaths</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">selectedFiles</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filePaths</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">filePath</span> <span class="o">=</span> <span class="n">filePaths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">filePath</span><span class="p">:</span>
          <span class="n">printer</span><span class="o">.</span><span class="n">setOutputFileName</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
          <span class="n">pdfPainter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">bondColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">black</span>
          <span class="n">scene</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span>
          <span class="n">items</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
          <span class="n">cache</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">cacheMode</span><span class="p">()</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">NoCache</span><span class="p">)</span>
          <span class="n">scene</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">pdfPainter</span><span class="p">)</span>
          <span class="n">pdfPainter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">bondColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">white</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)):</span>
            <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="CompoundView.exportSvg"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.exportSvg">[docs]</a>  <span class="k">def</span> <span class="nf">exportSvg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="p">:</span>
      <span class="n">printer</span> <span class="o">=</span> <span class="n">QtSvg</span><span class="o">.</span><span class="n">QSvgGenerator</span><span class="p">()</span>
      <span class="n">scene</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span>

      <span class="n">w</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
      <span class="n">paperWidth</span> <span class="o">=</span> <span class="mi">200</span>
      <span class="n">paperHeight</span> <span class="o">=</span> <span class="n">paperWidth</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span>
      <span class="n">resolution</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">resolution</span><span class="p">()</span> <span class="o">/</span> <span class="mf">25.4</span>
      <span class="n">printer</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">paperWidth</span><span class="o">*</span><span class="n">resolution</span><span class="p">,</span> <span class="n">paperHeight</span><span class="o">*</span><span class="n">resolution</span><span class="p">))</span>

      <span class="n">fType</span> <span class="o">=</span> <span class="s1">&#39;SVG (*.svg)&#39;</span>
      <span class="n">dialog</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span>
      <span class="n">filePath</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">filter</span><span class="o">=</span><span class="n">fType</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">filePath</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondColor</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">black</span>
        <span class="n">printer</span><span class="o">.</span><span class="n">setFileName</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
        <span class="n">svgPainter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
        <span class="n">oldBackground</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backgroundColor</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
          <span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">cacheMode</span><span class="p">()</span>
          <span class="n">item</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">NoCache</span><span class="p">)</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">svgPainter</span><span class="p">)</span>
        <span class="n">svgPainter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">oldBackground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondColor</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">white</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)):</span>
          <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="CompoundView.showSkeletal"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.showSkeletal">[docs]</a>  <span class="k">def</span> <span class="nf">showSkeletal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showSkeletalFormula</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span></div>

<div class="viewcode-block" id="CompoundView.show3D"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.show3D">[docs]</a>  <span class="k">def</span> <span class="nf">show3D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">showSkeletalFormula</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span></div>

<div class="viewcode-block" id="CompoundView.rotateLeft"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.rotateLeft">[docs]</a>  <span class="k">def</span> <span class="nf">rotateLeft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">PI</span><span class="o">*</span><span class="mf">5.0</span><span class="o">/</span><span class="mi">180</span><span class="p">):</span>
    
    <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
 
    <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
      <span class="k">return</span>
      
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rotateAtoms</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="CompoundView.rotateRight"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.rotateRight">[docs]</a>  <span class="k">def</span> <span class="nf">rotateRight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">PI</span><span class="o">*</span><span class="mf">5.0</span><span class="o">/</span><span class="mi">180</span><span class="p">):</span>
    
    <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
 
    <span class="k">if</span> <span class="ow">not</span> <span class="n">selected</span><span class="p">:</span>
      <span class="k">return</span>
      
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rotateAtoms</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompoundView.rotateAtoms"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.rotateAtoms">[docs]</a>  <span class="k">def</span> <span class="nf">rotateAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">deltaAngle</span><span class="p">):</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">x0</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">y0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">angle2</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">deltaAngle</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle2</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle2</span><span class="p">)</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
          <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>
          <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">x0</span>
          <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">y0</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>
          <span class="n">angle2</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">deltaAngle</span>

          <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle2</span><span class="p">)</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle2</span><span class="p">)</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span></div>
  
<div class="viewcode-block" id="CompoundView.centerView"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.centerView">[docs]</a>  <span class="k">def</span> <span class="nf">centerView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">getCentroid</span><span class="p">()</span>
    
    <span class="k">else</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      
    <span class="bp">self</span><span class="o">.</span><span class="n">ensureVisible</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span></div>
  
<div class="viewcode-block" id="CompoundView.resetZoom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.resetZoom">[docs]</a>  <span class="k">def</span> <span class="nf">resetZoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  
    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoomLevel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">fac</span><span class="p">,</span> <span class="n">fac</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">zoomLevel</span> <span class="o">=</span> <span class="mf">1.0</span></div>
  
<div class="viewcode-block" id="CompoundView.wheelEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.wheelEvent">[docs]</a>  <span class="k">def</span> <span class="nf">wheelEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">angleDelta</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">fac</span> <span class="o">=</span> <span class="mf">0.8333</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.2</span>
    
    <span class="n">newLevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoomLevel</span> <span class="o">*</span> <span class="n">fac</span>
    
    <span class="k">if</span> <span class="mf">0.5</span> <span class="o">&lt;</span> <span class="n">newLevel</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">zoomLevel</span> <span class="o">=</span> <span class="n">newLevel</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">fac</span><span class="p">,</span> <span class="n">fac</span><span class="p">)</span>
  
    <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>

<div class="viewcode-block" id="CompoundView.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
   
    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    
    <span class="n">button</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
    <span class="n">mods</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span>
    <span class="n">haveCtrl</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span>
    <span class="n">haveShift</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SHIFT</span>
    
    <span class="n">bondItem</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">AtomItem</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="n">item</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">atom</span>
    <span class="k">elif</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">AtomLabel</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">atomView</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">atom</span>
    <span class="k">elif</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">BondItem</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">getDistToBond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">bondItem</span> <span class="o">=</span> <span class="n">item</span>
    <span class="k">elif</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">AromaticItem</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">bondItem</span> <span class="o">=</span> <span class="n">item</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="bp">None</span> 
    
    <span class="c1"># deal with inconsistency in Qt versions for button naming</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">MiddleButton</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">MiddleButton</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="n">MiddleButton</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">MidButton</span>
    
    <span class="k">if</span> <span class="n">button</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">:</span>
      
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="o">.</span><span class="n">updateRegion</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bondItem</span> <span class="ow">or</span> <span class="n">haveCtrl</span> <span class="ow">or</span> <span class="n">haveShift</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">):</span>
            <span class="n">view</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
    
    <span class="k">elif</span> <span class="n">button</span> <span class="o">==</span> <span class="n">MiddleButton</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">haveCtrl</span> <span class="ow">or</span> <span class="n">haveShift</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">spos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
          <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
          <span class="n">startAngle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">spos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span> <span class="n">spos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">rotatePos</span> <span class="o">=</span> <span class="p">(</span><span class="n">startAngle</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
      
      <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">sliderPosition</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">sliderPosition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">movePos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">+</span><span class="n">v</span>
      
    <span class="k">elif</span> <span class="n">button</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">RightButton</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">popupContextMenu</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">globalPos</span><span class="p">())</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">atomView</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">:</span>
      <span class="n">atomView</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">editProxy</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setAtomName</span><span class="p">()</span></div>

<div class="viewcode-block" id="CompoundView.mouseMoveEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.mouseMoveEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
      
    <span class="n">pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">menuAtomView</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">menuAtom</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">movePos</span><span class="p">:</span>

      <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">movePos</span>
      <span class="n">pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">horizontalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">setSliderPosition</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">setSliderPosition</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotatePos</span><span class="p">:</span>


      <span class="n">startAngle</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotatePos</span>
      <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">center</span>
      <span class="n">spos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
      <span class="n">dx</span> <span class="o">=</span> <span class="n">spos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">x0</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="n">spos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="n">y0</span>
      <span class="n">angle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
      <span class="n">deltaAngle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">-</span> <span class="n">startAngle</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">rotateAtoms</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">deltaAngle</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rotatePos</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="o">.</span><span class="n">updateRegion</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
    
    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompoundView.mouseReleaseEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.mouseReleaseEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>

      <span class="n">posA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">topLeft</span><span class="p">()</span>
      <span class="n">posB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">bottomRight</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">posA</span> <span class="o">!=</span> <span class="n">posB</span><span class="p">:</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">posA</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">posB</span><span class="o">.</span><span class="n">x</span><span class="p">()]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">posA</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">posB</span><span class="o">.</span><span class="n">y</span><span class="p">()]</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">xs</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">ys</span>

        <span class="k">for</span> <span class="n">atomView</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomViews</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">pos</span> <span class="o">=</span> <span class="n">atomView</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">):</span>
            <span class="n">atomView</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">selectionBox</span><span class="o">.</span><span class="n">updateRegion</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rotatePos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">movePos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="o">.</span><span class="n">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompoundView.getStats"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.CompoundView.getStats">[docs]</a>  <span class="k">def</span> <span class="nf">getStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span></div></div>

<span class="c1"># def getAddPoint(self):</span>
<span class="c1">#     &#39;&#39;&#39; Set the compound on the specific position on the graphic scene. &#39;&#39;&#39;</span>
<span class="c1">#     compoundView = CompoundView</span>
<span class="c1">#     globalPos = QtGui.QCursor.pos()</span>
<span class="c1">#     pos = compoundView.mapFromGlobal(globalPos)</span>
<span class="c1">#     widget = compoundView.childAt(pos)</span>
<span class="c1">#     if widget:</span>
<span class="c1">#       x = pos.x()</span>
<span class="c1">#       y = pos.y()</span>
<span class="c1">#     else:</span>
<span class="c1">#       x = compoundView.width()/2.0</span>
<span class="c1">#       y = compoundView.height()/2.0</span>
<span class="c1">#     point = compoundView.mapToScene(x, y)</span>
<span class="c1">#     return point.x(), point.y()</span>




<span class="c1"># Constants</span>


<span class="n">PI</span> <span class="o">=</span> <span class="mf">3.1415926535898</span>

<span class="n">MIMETYPE_ELEMENT</span> <span class="o">=</span> <span class="s1">&#39;application/x-ccpn-element&#39;</span>
<span class="n">MIMETYPE_COMPOUND</span> <span class="o">=</span> <span class="s1">&#39;application/x-ccpn-compound&#39;</span>
<span class="n">MIMETYPE</span> <span class="o">=</span> <span class="s1">&#39;application/x-ccpn&#39;</span>

<span class="n">EQUIVALENT</span> <span class="o">=</span> <span class="s1">&#39;equivalent&#39;</span>
<span class="n">PROCHIRAL</span> <span class="o">=</span> <span class="s1">&#39;prochiral&#39;</span>
<span class="n">NONSTEREO</span> <span class="o">=</span> <span class="s1">&#39;prochiral&#39;</span>
<span class="n">AROMATIC</span> <span class="o">=</span> <span class="s1">&#39;aromatic&#39;</span>

<span class="n">CCPN_MOLTYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;DNA&#39;</span><span class="p">,</span> <span class="s1">&#39;RNA&#39;</span><span class="p">,</span> <span class="s1">&#39;carbohydrate&#39;</span><span class="p">)</span>

<span class="n">ELEMENTS</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;Common&#39;</span><span class="p">:[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;Se&#39;</span><span class="p">],</span>
             <span class="s1">&#39;Halogens&#39;</span><span class="p">:[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span><span class="s1">&#39;Br&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
             <span class="s1">&#39;Others&#39;</span><span class="p">:[</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span><span class="s1">&#39;As&#39;</span><span class="p">],</span> <span class="p">}</span>

<span class="n">COVALENT_ELEMENTS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;Se&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span><span class="s1">&#39;Br&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span><span class="s1">&#39;As&#39;</span><span class="p">])</span>

<span class="n">PERIODIC_TABLE</span> <span class="o">=</span> <span class="p">[</span>
                 <span class="p">[</span><span class="s1">&#39;Fr&#39;</span><span class="p">,</span><span class="s1">&#39;Cs&#39;</span><span class="p">,</span><span class="s1">&#39;Rb&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span><span class="s1">&#39;Li&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,],</span>
                 <span class="p">[</span><span class="s1">&#39;Ra&#39;</span><span class="p">,</span><span class="s1">&#39;Ba&#39;</span><span class="p">,</span><span class="s1">&#39;Sr&#39;</span><span class="p">,</span><span class="s1">&#39;Ca&#39;</span><span class="p">,</span><span class="s1">&#39;Mg&#39;</span><span class="p">,</span><span class="s1">&#39;Be&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Ac&#39;</span><span class="p">,</span><span class="s1">&#39;La&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Th&#39;</span><span class="p">,</span><span class="s1">&#39;Ce&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Pa&#39;</span><span class="p">,</span><span class="s1">&#39;Pr&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="s1">&#39;Nd&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span><span class="s1">&#39;Pm&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Pu&#39;</span><span class="p">,</span><span class="s1">&#39;Sm&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Am&#39;</span><span class="p">,</span><span class="s1">&#39;Eu&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Cm&#39;</span><span class="p">,</span><span class="s1">&#39;Gd&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Bk&#39;</span><span class="p">,</span><span class="s1">&#39;Tb&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Cf&#39;</span><span class="p">,</span><span class="s1">&#39;Dy&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Es&#39;</span><span class="p">,</span><span class="s1">&#39;Ho&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Fm&#39;</span><span class="p">,</span><span class="s1">&#39;Er&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Md&#39;</span><span class="p">,</span><span class="s1">&#39;Tm&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;No&#39;</span><span class="p">,</span><span class="s1">&#39;Yb&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Lr&#39;</span><span class="p">,</span><span class="s1">&#39;Lu&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Sc&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Hf&#39;</span><span class="p">,</span><span class="s1">&#39;Zr&#39;</span><span class="p">,</span><span class="s1">&#39;Ti&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Db&#39;</span><span class="p">,</span><span class="s1">&#39;Ta&#39;</span><span class="p">,</span><span class="s1">&#39;Nb&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Sg&#39;</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;Mo&#39;</span><span class="p">,</span><span class="s1">&#39;Cr&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Bh&#39;</span><span class="p">,</span><span class="s1">&#39;Re&#39;</span><span class="p">,</span><span class="s1">&#39;Tc&#39;</span><span class="p">,</span><span class="s1">&#39;Mn&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Hs&#39;</span><span class="p">,</span><span class="s1">&#39;Os&#39;</span><span class="p">,</span><span class="s1">&#39;Ru&#39;</span><span class="p">,</span><span class="s1">&#39;Fe&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Mt&#39;</span><span class="p">,</span><span class="s1">&#39;Ir&#39;</span><span class="p">,</span><span class="s1">&#39;Rh&#39;</span><span class="p">,</span><span class="s1">&#39;Co&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Ds&#39;</span><span class="p">,</span><span class="s1">&#39;Pt&#39;</span><span class="p">,</span><span class="s1">&#39;Pd&#39;</span><span class="p">,</span><span class="s1">&#39;Ni&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Rg&#39;</span><span class="p">,</span><span class="s1">&#39;Au&#39;</span><span class="p">,</span><span class="s1">&#39;Ag&#39;</span><span class="p">,</span><span class="s1">&#39;Cu&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="s1">&#39;Cn&#39;</span><span class="p">,</span><span class="s1">&#39;Hg&#39;</span><span class="p">,</span><span class="s1">&#39;Cd&#39;</span><span class="p">,</span><span class="s1">&#39;Zn&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="s1">&#39;Tl&#39;</span><span class="p">,</span><span class="s1">&#39;In&#39;</span><span class="p">,</span><span class="s1">&#39;Ga&#39;</span><span class="p">,</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="s1">&#39;Pb&#39;</span><span class="p">,</span><span class="s1">&#39;Sn&#39;</span><span class="p">,</span><span class="s1">&#39;Ge&#39;</span><span class="p">,</span><span class="s1">&#39;Si&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="s1">&#39;Bi&#39;</span><span class="p">,</span><span class="s1">&#39;Sb&#39;</span><span class="p">,</span><span class="s1">&#39;As&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="s1">&#39;Po&#39;</span><span class="p">,</span><span class="s1">&#39;Te&#39;</span><span class="p">,</span><span class="s1">&#39;Se&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="s1">&#39;At&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Br&#39;</span><span class="p">,</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span>
                 <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="s1">&#39;Rn&#39;</span><span class="p">,</span><span class="s1">&#39;Xe&#39;</span><span class="p">,</span><span class="s1">&#39;Kr&#39;</span><span class="p">,</span><span class="s1">&#39;Ar&#39;</span><span class="p">,</span><span class="s1">&#39;Ne&#39;</span><span class="p">,</span><span class="s1">&#39;He&#39;</span><span class="p">],</span>
                 <span class="p">]</span>

<span class="n">VAR_TAG_ORDER</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;neutral&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                 <span class="s1">&#39;prot&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                 <span class="s1">&#39;deprot&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;link&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                 <span class="s1">&#39;stereo_1&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;stereo_2&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>

<span class="n">LINKS</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Previous residue&#39;</span><span class="p">,</span> <span class="s1">&#39;prev&#39;</span><span class="p">,</span> <span class="s1">&#39;link-prev.png&#39;</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;Next residue&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;link-next.png&#39;</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;Generic link&#39;</span><span class="p">,</span> <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;link.png&#39;</span><span class="p">)]</span>
<span class="n">LINK</span> <span class="o">=</span> <span class="s1">&#39;link&#39;</span>

<span class="n">DISALLOWED</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">([</span><span class="n">LINK</span><span class="p">,</span> <span class="n">LINK</span><span class="p">]),</span>
              <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">]),</span>
              <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">LINK</span><span class="p">])]</span>

<span class="n">HIGHLIGHT</span>    <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">HIGHLIGHT_BG</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">64</span><span class="p">)</span>
<span class="n">ATOM_NAME_FG</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">LINK_COLOR</span>   <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">EQUIV_COLOR</span>  <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span>  <span class="mi">128</span><span class="p">,</span>  <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">PROCHIRAL_COLOR</span>  <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span>  <span class="mi">192</span><span class="p">,</span>  <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">ELEMENT_FONT</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;DejaVu Sans Mono&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">ELEMENT_DATA</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">LINK</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span> <span class="n">LINK_COLOR</span><span class="p">),</span>
            <span class="c1"># element: (default valances, colour, (common valances))</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)),</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,)),</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)),</span>
            <span class="s1">&#39;Se&#39;</span><span class="p">:(</span><span class="mi">2</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
            <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
            <span class="s1">&#39;Cl&#39;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
            <span class="s1">&#39;Br&#39;</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
            <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
            <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span>
            <span class="s1">&#39;Si&#39;</span><span class="p">:(</span><span class="mi">4</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)),</span>
            <span class="s1">&#39;As&#39;</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span>
            <span class="s1">&#39;Be&#39;</span><span class="p">:(</span><span class="mi">2</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
            <span class="s1">&#39;Mg&#39;</span><span class="p">:(</span><span class="mi">2</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,)),</span>
            <span class="s1">&#39;Al&#39;</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,)),</span>
            <span class="s1">&#39;Fe&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)),</span>
            <span class="s1">&#39;?&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)),}</span>

<span class="n">PERIODIC_TABLE_COLORS</span> <span class="o">=</span> <span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                         <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                         <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                         <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                         <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                         <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PERIODIC_TABLE</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ELEMENT_DATA</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_COLORS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">elif</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_COLORS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">elif</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_COLORS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

      <span class="k">elif</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_COLORS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

      <span class="k">elif</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_COLORS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">PERIODIC_TABLE_COLORS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

      <span class="n">ELEMENT_DATA</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>






<span class="c1"># Constants</span>

<span class="n">ELEMENT_DEFAULT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

<span class="c1"># Other oxidation states? Coordination</span>

<span class="n">ATOM</span> <span class="o">=</span> <span class="s1">&#39;atom&#39;</span>
<span class="n">PROPERTY</span> <span class="o">=</span> <span class="s1">&#39;property&#39;</span>
<span class="n">PROPERTIES_ATOM</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">(</span><span class="s1">&#39;Bonding&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;Toggle aromatic ring&#39;</span><span class="p">,</span> <span class="s1">&#39;toggle-aromatic.png&#39;</span><span class="p">,</span> <span class="s1">&#39;bond-aromatic&#39;</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;Toggle dative bond&#39;</span><span class="p">,</span> <span class="s1">&#39;bond-dative.png&#39;</span><span class="p">,</span> <span class="s1">&#39;bond-dative&#39;</span><span class="p">))),</span>
              <span class="p">(</span><span class="s1">&#39;Atomic Charge&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;Add positive charge&#39;</span><span class="p">,</span> <span class="s1">&#39;charge-pos.png&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;Set neutral charge&#39;</span><span class="p">,</span> <span class="s1">&#39;charge-none.png&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;Add negative charge&#39;</span><span class="p">,</span> <span class="s1">&#39;charge-neg.png&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))),</span>
              <span class="p">(</span><span class="s1">&#39;Valence Slots&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;Add valance&#39;</span><span class="p">,</span> <span class="s1">&#39;valence-add.png&#39;</span><span class="p">,</span> <span class="s1">&#39;v+&#39;</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;Remove valance&#39;</span><span class="p">,</span> <span class="s1">&#39;valence-remove.png&#39;</span><span class="p">,</span> <span class="s1">&#39;v-&#39;</span><span class="p">))),</span>
              <span class="p">(</span><span class="s1">&#39;Stereochemistry&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;Toggle stereo centre&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo.png&#39;</span><span class="p">,</span> <span class="s1">&#39;st&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;Move atom forward&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo-up.png&#39;</span><span class="p">,</span> <span class="s1">&#39;st+&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;Move atom backward&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo-down.png&#39;</span><span class="p">,</span> <span class="s1">&#39;st-&#39;</span><span class="p">))),</span>
              <span class="p">(</span><span class="s1">&#39;Chirality Label&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;R chirality&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo-R.png&#39;</span><span class="p">,</span> <span class="s1">&#39;chiral-r&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;S chirality&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo-S.png&#39;</span><span class="p">,</span> <span class="s1">&#39;chiral-s&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;No chirality label&#39;</span><span class="p">,</span><span class="s1">&#39;stereo-none.png&#39;</span><span class="p">,</span>  <span class="s1">&#39;chiral-n&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;Alpha chirality&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo-a.png&#39;</span><span class="p">,</span> <span class="s1">&#39;chiral-a&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;Beta chirality&#39;</span><span class="p">,</span> <span class="s1">&#39;stereo-b.png&#39;</span><span class="p">,</span> <span class="s1">&#39;chiral-b&#39;</span><span class="p">),</span>
                             <span class="p">)),]</span> <span class="c1"># (&#39;R/S&#39;, None, &#39;chiral-rs&#39;),</span>
<span class="n">PROPERTIES_MULTI</span> <span class="o">=</span> <span class="p">[</span>
              <span class="p">(</span><span class="s1">&#39;Atomic Exchange&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;Toggle variable atom&#39;</span><span class="p">,</span> <span class="s1">&#39;variable-atom.png&#39;</span><span class="p">,</span> <span class="s1">&#39;xv&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;Toggle fast exchange (H+)&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange-hydrogen.png&#39;</span><span class="p">,</span> <span class="s1">&#39;xf&#39;</span><span class="p">))),</span>
              <span class="p">(</span><span class="s1">&#39;NMR Groups&#39;</span><span class="p">,</span> <span class="p">((</span><span class="s1">&#39;NMR equivalent&#39;</span><span class="p">,</span> <span class="s1">&#39;nmr-equivalent.png&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;NMR non-stereo (e.g. prochiral)&#39;</span><span class="p">,</span> <span class="s1">&#39;nmr-prochiral.png&#39;</span><span class="p">,</span>  <span class="s1">&#39;p&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;No atom group&#39;</span><span class="p">,</span> <span class="s1">&#39;nmr-no-group.png&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">))),</span>
             <span class="p">]</span>
<span class="n">CHARGE_FONT</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;DejaVu Sans Mono&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">)</span>
<span class="n">NEG_COLOR</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">POS_COLOR</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">CHARGE_BG_COLOR</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">CHIRAL_FONT</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;DejaVu Sans Mono&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">)</span>
<span class="n">CHIRAL_COLOR</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="n">ELEMENT_ISO_ABUN</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;Ac&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">227</span><span class="p">,</span><span class="mf">227.0277470</span><span class="p">),),</span>
  <span class="s1">&#39;Ag&#39;</span><span class="p">:((</span><span class="mf">0.518390</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mf">106.9050930</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.481610</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mf">108.9047560</span><span class="p">),),</span>
  <span class="s1">&#39;Al&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mf">26.9815384</span><span class="p">),),</span>
  <span class="s1">&#39;Am&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">243</span><span class="p">,</span><span class="mf">243.0613727</span><span class="p">),(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="mf">241.0568229</span><span class="p">),),</span>
  <span class="s1">&#39;Ar&#39;</span><span class="p">:((</span><span class="mf">0.996003</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mf">39.9623831</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.003365</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mf">35.9675463</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000632</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mf">37.9627322</span><span class="p">),),</span>
  <span class="s1">&#39;As&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mf">74.9215964</span><span class="p">),),</span>
  <span class="s1">&#39;At&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">211</span><span class="p">,</span><span class="mf">210.9874810</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mf">209.9871310</span><span class="p">),),</span>
  <span class="s1">&#39;Au&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">197</span><span class="p">,</span><span class="mf">196.9665520</span><span class="p">),),</span>
  <span class="s1">&#39;B&#39;</span><span class="p">:((</span><span class="mf">0.801000</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mf">11.0093055</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.199000</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mf">10.0129370</span><span class="p">),),</span>
  <span class="s1">&#39;Ba&#39;</span><span class="p">:((</span><span class="mf">0.716980</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mf">137.9052410</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.112320</span><span class="p">,</span><span class="mi">137</span><span class="p">,</span><span class="mf">136.9058210</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.078540</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mf">135.9045700</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.065920</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mf">134.9056830</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.024170</span><span class="p">,</span><span class="mi">134</span><span class="p">,</span><span class="mf">133.9045030</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001060</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mf">129.9063100</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.001010</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mf">131.9050560</span><span class="p">),),</span>
  <span class="s1">&#39;Be&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mf">9.0121821</span><span class="p">),),</span>
  <span class="s1">&#39;Bh&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">264</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;Bi&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">209</span><span class="p">,</span><span class="mf">208.9803830</span><span class="p">),),</span>
  <span class="s1">&#39;Bk&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">249</span><span class="p">,</span><span class="mf">249.0749800</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">247</span><span class="p">,</span><span class="mf">247.0702990</span><span class="p">),),</span>
  <span class="s1">&#39;Br&#39;</span><span class="p">:((</span><span class="mf">0.506900</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mf">78.9183376</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.493100</span><span class="p">,</span><span class="mi">81</span><span class="p">,</span><span class="mf">80.9162910</span><span class="p">),),</span>
  <span class="s1">&#39;C&#39;</span><span class="p">:((</span><span class="mf">0.989300</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mf">12.0000000</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.010700</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mf">13.0033548</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mf">14.0032420</span><span class="p">),),</span>
  <span class="s1">&#39;Ca&#39;</span><span class="p">:((</span><span class="mf">0.969410</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mf">39.9625912</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.020860</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mf">43.9554811</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.006470</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mf">41.9586183</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.001870</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mf">47.9525340</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001350</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mf">42.9587668</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000040</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mf">45.9536928</span><span class="p">),),</span>
  <span class="s1">&#39;Cd&#39;</span><span class="p">:((</span><span class="mf">0.287300</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mf">113.9033581</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.241300</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mf">111.9027572</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.128000</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mf">110.9041820</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.124900</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mf">109.9030060</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.122200</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mf">112.9044009</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.074900</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mf">115.9047550</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.012500</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mf">105.9064580</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.008900</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mf">107.9041830</span><span class="p">),),</span>
  <span class="s1">&#39;Ce&#39;</span><span class="p">:((</span><span class="mf">0.884500</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mf">139.9054340</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.111140</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mf">141.9092400</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.002510</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mf">137.9059860</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.001850</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mf">135.9071400</span><span class="p">),),</span>
  <span class="s1">&#39;Cf&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">252</span><span class="p">,</span><span class="mf">252.0816200</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">251</span><span class="p">,</span><span class="mf">251.0795800</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mf">250.0764000</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">249</span><span class="p">,</span><span class="mf">249.0748470</span><span class="p">),),</span>
  <span class="s1">&#39;Cl&#39;</span><span class="p">:((</span><span class="mf">0.757800</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mf">34.9688527</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.242200</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mf">36.9659026</span><span class="p">),),</span>
  <span class="s1">&#39;Cm&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">248</span><span class="p">,</span><span class="mf">248.0723420</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">247</span><span class="p">,</span><span class="mf">247.0703470</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">246</span><span class="p">,</span><span class="mf">246.0672176</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">245</span><span class="p">,</span><span class="mf">245.0654856</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">244</span><span class="p">,</span><span class="mf">244.0627463</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">243</span><span class="p">,</span><span class="mf">243.0613822</span><span class="p">),),</span>
  <span class="s1">&#39;Co&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mf">58.9332002</span><span class="p">),),</span>
  <span class="s1">&#39;Cr&#39;</span><span class="p">:((</span><span class="mf">0.837890</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mf">51.9405119</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.095010</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mf">52.9406538</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.043450</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mf">49.9460496</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.023650</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mf">53.9388849</span><span class="p">),),</span>
  <span class="s1">&#39;Cs&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mf">132.9054470</span><span class="p">),),</span>
  <span class="s1">&#39;Cu&#39;</span><span class="p">:((</span><span class="mf">0.691700</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mf">62.9296011</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.308300</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mf">64.9277937</span><span class="p">),),</span>
  <span class="s1">&#39;Db&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">262</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;Dy&#39;</span><span class="p">:((</span><span class="mf">0.281800</span><span class="p">,</span><span class="mi">164</span><span class="p">,</span><span class="mf">163.9291710</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.255100</span><span class="p">,</span><span class="mi">162</span><span class="p">,</span><span class="mf">161.9267950</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.249000</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span><span class="mf">162.9287280</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.189100</span><span class="p">,</span><span class="mi">161</span><span class="p">,</span><span class="mf">160.9269300</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.023400</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mf">159.9251940</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001000</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span><span class="mf">157.9244050</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.000600</span><span class="p">,</span><span class="mi">156</span><span class="p">,</span><span class="mf">155.9242780</span><span class="p">),),</span>
  <span class="s1">&#39;Er&#39;</span><span class="p">:((</span><span class="mf">0.336100</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mf">165.9302900</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.267800</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mf">167.9323680</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.229300</span><span class="p">,</span><span class="mi">167</span><span class="p">,</span><span class="mf">166.9320450</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.149300</span><span class="p">,</span><span class="mi">170</span><span class="p">,</span><span class="mf">169.9354600</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.016100</span><span class="p">,</span><span class="mi">164</span><span class="p">,</span><span class="mf">163.9291970</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001400</span><span class="p">,</span><span class="mi">162</span><span class="p">,</span><span class="mf">161.9287750</span><span class="p">),),</span>
  <span class="s1">&#39;Es&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">252</span><span class="p">,</span><span class="mf">252.0829700</span><span class="p">),),</span>
  <span class="s1">&#39;Eu&#39;</span><span class="p">:((</span><span class="mf">0.521900</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mf">152.9212260</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.478100</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mf">150.9198460</span><span class="p">),),</span>
  <span class="s1">&#39;F&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mf">18.9984032</span><span class="p">),),</span>
  <span class="s1">&#39;Fe&#39;</span><span class="p">:((</span><span class="mf">0.917540</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mf">55.9349421</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.058450</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mf">53.9396148</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.021190</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mf">56.9353987</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.002820</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mf">57.9332805</span><span class="p">),),</span>
  <span class="s1">&#39;Fm&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">257</span><span class="p">,</span><span class="mf">257.0950990</span><span class="p">),),</span>
  <span class="s1">&#39;Fr&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mf">223.0197307</span><span class="p">),),</span>
  <span class="s1">&#39;Ga&#39;</span><span class="p">:((</span><span class="mf">0.601080</span><span class="p">,</span><span class="mi">69</span><span class="p">,</span><span class="mf">68.9255810</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.398920</span><span class="p">,</span><span class="mi">71</span><span class="p">,</span><span class="mf">70.9247050</span><span class="p">),),</span>
  <span class="s1">&#39;Gd&#39;</span><span class="p">:((</span><span class="mf">0.248400</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span><span class="mf">157.9241010</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.218600</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mf">159.9270510</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.204700</span><span class="p">,</span><span class="mi">156</span><span class="p">,</span><span class="mf">155.9221200</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.156500</span><span class="p">,</span><span class="mi">157</span><span class="p">,</span><span class="mf">156.9239570</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.148000</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mf">154.9226190</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.021800</span><span class="p">,</span><span class="mi">154</span><span class="p">,</span><span class="mf">153.9208620</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.002000</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mf">151.9197880</span><span class="p">),),</span>
  <span class="s1">&#39;Ge&#39;</span><span class="p">:((</span><span class="mf">0.362800</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mf">73.9211782</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.275400</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span><span class="mf">71.9220762</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.208400</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mf">69.9242504</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.077300</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mf">72.9234594</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.076100</span><span class="p">,</span><span class="mi">76</span><span class="p">,</span><span class="mf">75.9214027</span><span class="p">),),</span>
  <span class="s1">&#39;H&#39;</span><span class="p">:((</span><span class="mf">0.999850</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.0078250</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000150</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.0141018</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">3.0160492</span><span class="p">),),</span>
  <span class="s1">&#39;He&#39;</span><span class="p">:((</span><span class="mf">0.999999</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">4.0026032</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000001</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">3.0160293</span><span class="p">),),</span>
  <span class="s1">&#39;Hf&#39;</span><span class="p">:((</span><span class="mf">0.350800</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mf">179.9465488</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.272800</span><span class="p">,</span><span class="mi">178</span><span class="p">,</span><span class="mf">177.9436977</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.186000</span><span class="p">,</span><span class="mi">177</span><span class="p">,</span><span class="mf">176.9432200</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.136200</span><span class="p">,</span><span class="mi">179</span><span class="p">,</span><span class="mf">178.9458151</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.052600</span><span class="p">,</span><span class="mi">176</span><span class="p">,</span><span class="mf">175.9414018</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001600</span><span class="p">,</span><span class="mi">174</span><span class="p">,</span><span class="mf">173.9400400</span><span class="p">),),</span>
  <span class="s1">&#39;Hg&#39;</span><span class="p">:((</span><span class="mf">0.298600</span><span class="p">,</span><span class="mi">202</span><span class="p">,</span><span class="mf">201.9706260</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.231000</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mf">199.9683090</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.168700</span><span class="p">,</span><span class="mi">199</span><span class="p">,</span><span class="mf">198.9682620</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.131800</span><span class="p">,</span><span class="mi">201</span><span class="p">,</span><span class="mf">200.9702850</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.099700</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span><span class="mf">197.9667520</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.068700</span><span class="p">,</span><span class="mi">204</span><span class="p">,</span><span class="mf">203.9734760</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.001500</span><span class="p">,</span><span class="mi">196</span><span class="p">,</span><span class="mf">195.9658150</span><span class="p">),),</span>
  <span class="s1">&#39;Ho&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mf">164.9303190</span><span class="p">),),</span>
  <span class="s1">&#39;Hs&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">277</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;I&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mf">126.9044680</span><span class="p">),),</span>
  <span class="s1">&#39;In&#39;</span><span class="p">:((</span><span class="mf">0.957100</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mf">114.9038780</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.042900</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mf">112.9040610</span><span class="p">),),</span>
  <span class="s1">&#39;Ir&#39;</span><span class="p">:((</span><span class="mf">0.627000</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mf">192.9629240</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.373000</span><span class="p">,</span><span class="mi">191</span><span class="p">,</span><span class="mf">190.9605910</span><span class="p">),),</span>
  <span class="s1">&#39;K&#39;</span><span class="p">:((</span><span class="mf">0.932581</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mf">38.9637069</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.067302</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mf">40.9618260</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000117</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mf">39.9639987</span><span class="p">),),</span>
  <span class="s1">&#39;Kr&#39;</span><span class="p">:((</span><span class="mf">0.570000</span><span class="p">,</span><span class="mi">84</span><span class="p">,</span><span class="mf">83.9115070</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.173000</span><span class="p">,</span><span class="mi">86</span><span class="p">,</span><span class="mf">85.9106103</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.115800</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mf">81.9134846</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.114900</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mf">82.9141360</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.022800</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mf">79.9163780</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.003500</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mf">77.9203860</span><span class="p">),),</span>
  <span class="s1">&#39;La&#39;</span><span class="p">:((</span><span class="mf">0.999100</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mf">138.9063480</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000900</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mf">137.9071070</span><span class="p">),),</span>
  <span class="s1">&#39;Li&#39;</span><span class="p">:((</span><span class="mf">0.924100</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mf">7.0160040</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.075900</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mf">6.0151223</span><span class="p">),),</span>
  <span class="s1">&#39;Lr&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">262</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;Lu&#39;</span><span class="p">:((</span><span class="mf">0.974100</span><span class="p">,</span><span class="mi">175</span><span class="p">,</span><span class="mf">174.9407679</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.025900</span><span class="p">,</span><span class="mi">176</span><span class="p">,</span><span class="mf">175.9426824</span><span class="p">),),</span>
  <span class="s1">&#39;Md&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">258</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mf">256.0940500</span><span class="p">),),</span>
  <span class="s1">&#39;Mg&#39;</span><span class="p">:((</span><span class="mf">0.789900</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mf">23.9850419</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.110100</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mf">25.9825930</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.100000</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mf">24.9858370</span><span class="p">),),</span>
  <span class="s1">&#39;Mn&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mf">54.9380496</span><span class="p">),),</span>
  <span class="s1">&#39;Mo&#39;</span><span class="p">:((</span><span class="mf">0.241300</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mf">97.9054078</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.166800</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mf">95.9046789</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.159200</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mf">94.9058415</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.148400</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mf">91.9068100</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.096300</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mf">99.9074770</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.095500</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mf">96.9060210</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.092500</span><span class="p">,</span><span class="mi">94</span><span class="p">,</span><span class="mf">93.9050876</span><span class="p">),),</span>
  <span class="s1">&#39;Mt&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">268</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;N&#39;</span><span class="p">:((</span><span class="mf">0.996320</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mf">14.0030740</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.003680</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mf">15.0001089</span><span class="p">),),</span>
  <span class="s1">&#39;Na&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mf">22.9897697</span><span class="p">),),</span>
  <span class="s1">&#39;Nb&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">93</span><span class="p">,</span><span class="mf">92.9063775</span><span class="p">),),</span>
  <span class="s1">&#39;Nd&#39;</span><span class="p">:((</span><span class="mf">0.272000</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mf">141.9077190</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.238000</span><span class="p">,</span><span class="mi">144</span><span class="p">,</span><span class="mf">143.9100830</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.172000</span><span class="p">,</span><span class="mi">146</span><span class="p">,</span><span class="mf">145.9131120</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.122000</span><span class="p">,</span><span class="mi">143</span><span class="p">,</span><span class="mf">142.9098100</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.083000</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mf">144.9125690</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.057000</span><span class="p">,</span><span class="mi">148</span><span class="p">,</span><span class="mf">147.9168890</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.056000</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mf">149.9208870</span><span class="p">),),</span>
  <span class="s1">&#39;Ne&#39;</span><span class="p">:((</span><span class="mf">0.904800</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mf">19.9924402</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.092500</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mf">21.9913855</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.002700</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mf">20.9938467</span><span class="p">),),</span>
  <span class="s1">&#39;Ni&#39;</span><span class="p">:((</span><span class="mf">0.680769</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mf">57.9353479</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.262231</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mf">59.9307906</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.036345</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mf">61.9283488</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.011399</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mf">60.9310604</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.009256</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mf">63.9279696</span><span class="p">),),</span>
  <span class="s1">&#39;No&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">259</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;Np&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">239</span><span class="p">,</span><span class="mf">239.0529314</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">237</span><span class="p">,</span><span class="mf">237.0481673</span><span class="p">),),</span>
  <span class="s1">&#39;O&#39;</span><span class="p">:((</span><span class="mf">0.997570</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mf">15.9949146</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.002050</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mf">17.9991604</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000380</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mf">16.9991315</span><span class="p">),),</span>
  <span class="s1">&#39;Os&#39;</span><span class="p">:((</span><span class="mf">0.407800</span><span class="p">,</span><span class="mi">192</span><span class="p">,</span><span class="mf">191.9614790</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.262600</span><span class="p">,</span><span class="mi">190</span><span class="p">,</span><span class="mf">189.9584450</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.161500</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mf">188.9581449</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.132400</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mf">187.9558360</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.019600</span><span class="p">,</span><span class="mi">187</span><span class="p">,</span><span class="mf">186.9557479</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.015900</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mf">185.9538380</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.000200</span><span class="p">,</span><span class="mi">184</span><span class="p">,</span><span class="mf">183.9524910</span><span class="p">),),</span>
  <span class="s1">&#39;P&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mf">30.9737615</span><span class="p">),),</span>
  <span class="s1">&#39;Pa&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mf">231.0358789</span><span class="p">),),</span>
  <span class="s1">&#39;Pb&#39;</span><span class="p">:((</span><span class="mf">0.524000</span><span class="p">,</span><span class="mi">208</span><span class="p">,</span><span class="mf">207.9766360</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.241000</span><span class="p">,</span><span class="mi">206</span><span class="p">,</span><span class="mf">205.9744490</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.221000</span><span class="p">,</span><span class="mi">207</span><span class="p">,</span><span class="mf">206.9758810</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.014000</span><span class="p">,</span><span class="mi">204</span><span class="p">,</span><span class="mf">203.9730290</span><span class="p">),),</span>
  <span class="s1">&#39;Pd&#39;</span><span class="p">:((</span><span class="mf">0.273300</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mf">105.9034830</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.264600</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mf">107.9038940</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.223300</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mf">104.9050840</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.117200</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mf">109.9051520</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.111400</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mf">103.9040350</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.010200</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mf">101.9056080</span><span class="p">),),</span>
  <span class="s1">&#39;Pm&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mf">146.9151340</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mf">144.9127440</span><span class="p">),),</span>
  <span class="s1">&#39;Po&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mf">209.9828570</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">209</span><span class="p">,</span><span class="mf">208.9824160</span><span class="p">),),</span>
  <span class="s1">&#39;Pr&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">141</span><span class="p">,</span><span class="mf">140.9076480</span><span class="p">),),</span>
  <span class="s1">&#39;Pt&#39;</span><span class="p">:((</span><span class="mf">0.338320</span><span class="p">,</span><span class="mi">195</span><span class="p">,</span><span class="mf">194.9647740</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.329670</span><span class="p">,</span><span class="mi">194</span><span class="p">,</span><span class="mf">193.9626640</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.252420</span><span class="p">,</span><span class="mi">196</span><span class="p">,</span><span class="mf">195.9649350</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.071630</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span><span class="mf">197.9678760</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.007820</span><span class="p">,</span><span class="mi">192</span><span class="p">,</span><span class="mf">191.9610350</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000140</span><span class="p">,</span><span class="mi">190</span><span class="p">,</span><span class="mf">189.9599300</span><span class="p">),),</span>
  <span class="s1">&#39;Pu&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">244</span><span class="p">,</span><span class="mf">244.0641980</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">242</span><span class="p">,</span><span class="mf">242.0587368</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="mf">241.0568453</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">240</span><span class="p">,</span><span class="mf">240.0538075</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">239</span><span class="p">,</span><span class="mf">239.0521565</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">238</span><span class="p">,</span><span class="mf">238.0495534</span><span class="p">),),</span>
  <span class="s1">&#39;Ra&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">228</span><span class="p">,</span><span class="mf">228.0310641</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">226</span><span class="p">,</span><span class="mf">226.0254026</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mf">224.0202020</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mf">223.0184970</span><span class="p">),),</span>
  <span class="s1">&#39;Rb&#39;</span><span class="p">:((</span><span class="mf">0.721700</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mf">84.9117893</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.278300</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mf">86.9091835</span><span class="p">),),</span>
  <span class="s1">&#39;Re&#39;</span><span class="p">:((</span><span class="mf">0.626000</span><span class="p">,</span><span class="mi">187</span><span class="p">,</span><span class="mf">186.9557508</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.374000</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mf">184.9529557</span><span class="p">),),</span>
  <span class="s1">&#39;Rf&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">261</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;Rh&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mf">102.9055040</span><span class="p">),),</span>
  <span class="s1">&#39;Rn&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">222</span><span class="p">,</span><span class="mf">222.0175705</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">220</span><span class="p">,</span><span class="mf">220.0113841</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">211</span><span class="p">,</span><span class="mf">210.9905850</span><span class="p">),),</span>
  <span class="s1">&#39;Ru&#39;</span><span class="p">:((</span><span class="mf">0.315500</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mf">101.9043495</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.186200</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mf">103.9054300</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.170600</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mf">100.9055822</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.127600</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mf">98.9059393</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.126000</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mf">99.9042197</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.055400</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mf">95.9075980</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.018700</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mf">97.9052870</span><span class="p">),),</span>
  <span class="s1">&#39;S&#39;</span><span class="p">:((</span><span class="mf">0.949300</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mf">31.9720707</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.042900</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mf">33.9678668</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.007600</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mf">32.9714585</span><span class="p">),</span>
       <span class="p">(</span><span class="mf">0.000200</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mf">35.9670809</span><span class="p">),),</span>
  <span class="s1">&#39;Sb&#39;</span><span class="p">:((</span><span class="mf">0.572100</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mf">120.9038180</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.427900</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mf">122.9042157</span><span class="p">),),</span>
  <span class="s1">&#39;Sc&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mf">44.9559102</span><span class="p">),),</span>
  <span class="s1">&#39;Se&#39;</span><span class="p">:((</span><span class="mf">0.496100</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mf">79.9165218</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.237700</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mf">77.9173095</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.093700</span><span class="p">,</span><span class="mi">76</span><span class="p">,</span><span class="mf">75.9192141</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.087300</span><span class="p">,</span><span class="mi">82</span><span class="p">,</span><span class="mf">81.9167000</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.076300</span><span class="p">,</span><span class="mi">77</span><span class="p">,</span><span class="mf">76.9199146</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.008900</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mf">73.9224766</span><span class="p">),),</span>
  <span class="s1">&#39;Sg&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">266</span><span class="p">,</span><span class="mf">258.0984250</span><span class="p">),),</span>
  <span class="s1">&#39;Si&#39;</span><span class="p">:((</span><span class="mf">0.922297</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mf">27.9769265</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.046832</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mf">28.9764947</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.030872</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mf">29.9737702</span><span class="p">),),</span>
  <span class="s1">&#39;Sm&#39;</span><span class="p">:((</span><span class="mf">0.267500</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mf">151.9197280</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.227500</span><span class="p">,</span><span class="mi">154</span><span class="p">,</span><span class="mf">153.9222050</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.149900</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mf">146.9148930</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.138200</span><span class="p">,</span><span class="mi">149</span><span class="p">,</span><span class="mf">148.9171800</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.112400</span><span class="p">,</span><span class="mi">148</span><span class="p">,</span><span class="mf">147.9148180</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.073800</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mf">149.9172710</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.030700</span><span class="p">,</span><span class="mi">144</span><span class="p">,</span><span class="mf">143.9119950</span><span class="p">),),</span>
  <span class="s1">&#39;Sn&#39;</span><span class="p">:((</span><span class="mf">0.325800</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mf">119.9021966</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.242200</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mf">117.9016060</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.145400</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mf">115.9017440</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.085900</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mf">118.9033090</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.076800</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mf">116.9029540</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.057900</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mf">123.9052746</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.046300</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mf">121.9034401</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.009700</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mf">111.9048210</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.006600</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mf">113.9027820</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.003400</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mf">114.9033460</span><span class="p">),),</span>
  <span class="s1">&#39;Sr&#39;</span><span class="p">:((</span><span class="mf">0.825800</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mf">87.9056143</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.098600</span><span class="p">,</span><span class="mi">86</span><span class="p">,</span><span class="mf">85.9092624</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.070000</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mf">86.9088793</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.005600</span><span class="p">,</span><span class="mi">84</span><span class="p">,</span><span class="mf">83.9134250</span><span class="p">),),</span>
  <span class="s1">&#39;Ta&#39;</span><span class="p">:((</span><span class="mf">0.999880</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mf">180.9479960</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000120</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mf">179.9474660</span><span class="p">),),</span>
  <span class="s1">&#39;Tb&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">159</span><span class="p">,</span><span class="mf">158.9253430</span><span class="p">),),</span>
  <span class="s1">&#39;Tc&#39;</span><span class="p">:((</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mf">98.9062546</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mf">97.9072160</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mf">96.9063650</span><span class="p">),),</span>
  <span class="s1">&#39;Te&#39;</span><span class="p">:((</span><span class="mf">0.340800</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mf">129.9062228</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.317400</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mf">127.9044614</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.188400</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mf">125.9033055</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.070700</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span><span class="mf">124.9044247</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.047400</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mf">123.9028195</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.025500</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mf">121.9030471</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.008900</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mf">122.9042730</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000900</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mf">119.9040200</span><span class="p">),),</span>
  <span class="s1">&#39;Th&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">232</span><span class="p">,</span><span class="mf">232.0380504</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mf">230.0331266</span><span class="p">),),</span>
  <span class="s1">&#39;Ti&#39;</span><span class="p">:((</span><span class="mf">0.737200</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mf">47.9479471</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.082500</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mf">45.9526295</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.074400</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mf">46.9517638</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.054100</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mf">48.9478708</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.051800</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mf">49.9447921</span><span class="p">),),</span>
  <span class="s1">&#39;Tl&#39;</span><span class="p">:((</span><span class="mf">0.704760</span><span class="p">,</span><span class="mi">205</span><span class="p">,</span><span class="mf">204.9744120</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.295240</span><span class="p">,</span><span class="mi">203</span><span class="p">,</span><span class="mf">202.9723290</span><span class="p">),),</span>
  <span class="s1">&#39;Tm&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">169</span><span class="p">,</span><span class="mf">168.9342110</span><span class="p">),),</span>
  <span class="s1">&#39;U&#39;</span><span class="p">:((</span><span class="mf">0.992745</span><span class="p">,</span><span class="mi">238</span><span class="p">,</span><span class="mf">238.0507826</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.007200</span><span class="p">,</span><span class="mi">235</span><span class="p">,</span><span class="mf">235.0439231</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000055</span><span class="p">,</span><span class="mi">234</span><span class="p">,</span><span class="mf">234.0409456</span><span class="p">),</span>
       <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">236</span><span class="p">,</span><span class="mf">236.0455619</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">233</span><span class="p">,</span><span class="mf">233.0396280</span><span class="p">),),</span>
  <span class="s1">&#39;V&#39;</span><span class="p">:((</span><span class="mf">0.997500</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mf">50.9439637</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.002500</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mf">49.9471628</span><span class="p">),),</span>
  <span class="s1">&#39;W&#39;</span><span class="p">:((</span><span class="mf">0.306400</span><span class="p">,</span><span class="mi">184</span><span class="p">,</span><span class="mf">183.9509326</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.284300</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mf">185.9543620</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.265000</span><span class="p">,</span><span class="mi">182</span><span class="p">,</span><span class="mf">181.9482060</span><span class="p">),</span>
       <span class="p">(</span><span class="mf">0.143100</span><span class="p">,</span><span class="mi">183</span><span class="p">,</span><span class="mf">182.9502245</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001200</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mf">179.9467060</span><span class="p">),),</span>
  <span class="s1">&#39;Xe&#39;</span><span class="p">:((</span><span class="mf">0.268900</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mf">131.9041545</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.264400</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mf">128.9047795</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.211800</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mf">130.9050819</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.104400</span><span class="p">,</span><span class="mi">134</span><span class="p">,</span><span class="mf">133.9053945</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.088700</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mf">135.9072200</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.040800</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mf">129.9035079</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.019200</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mf">127.9035304</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000900</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mf">125.9042690</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000900</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mf">123.9058958</span><span class="p">),),</span>
  <span class="s1">&#39;Y&#39;</span><span class="p">:((</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mf">88.9058479</span><span class="p">),),</span>
  <span class="s1">&#39;Yb&#39;</span><span class="p">:((</span><span class="mf">0.318300</span><span class="p">,</span><span class="mi">174</span><span class="p">,</span><span class="mf">173.9388581</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.218300</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mf">171.9363777</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.161300</span><span class="p">,</span><span class="mi">173</span><span class="p">,</span><span class="mf">172.9382068</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.142800</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mf">170.9363220</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.127600</span><span class="p">,</span><span class="mi">176</span><span class="p">,</span><span class="mf">175.9425680</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.030400</span><span class="p">,</span><span class="mi">170</span><span class="p">,</span><span class="mf">169.9347590</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.001300</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mf">167.9338940</span><span class="p">),),</span>
  <span class="s1">&#39;Zn&#39;</span><span class="p">:((</span><span class="mf">0.486300</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mf">63.9291466</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.279000</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mf">65.9260368</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.187500</span><span class="p">,</span><span class="mi">68</span><span class="p">,</span><span class="mf">67.9248476</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.041000</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mf">66.9271309</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.006200</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mf">69.9253250</span><span class="p">),),</span>
  <span class="s1">&#39;Zr&#39;</span><span class="p">:((</span><span class="mf">0.514500</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mf">89.9047037</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.173800</span><span class="p">,</span><span class="mi">94</span><span class="p">,</span><span class="mf">93.9063158</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.171500</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mf">91.9050401</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">0.112200</span><span class="p">,</span><span class="mi">91</span><span class="p">,</span><span class="mf">90.9056450</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.028000</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mf">95.9082760</span><span class="p">),),</span>
  <span class="p">}</span>




<span class="n">Qt</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span>
<span class="n">QPointF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span>
<span class="n">QRectF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span>

<span class="n">RADIUS</span> <span class="o">=</span> <span class="mf">50.0</span>
<span class="n">BOND_SEP</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">NULL_RECT</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">()</span>
<span class="n">NULL_POINT</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">()</span>
<span class="n">FONT_METRIC</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">ELEMENT_FONT</span><span class="p">)</span>

<span class="n">SHADOW_COLOR</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span>
<span class="n">SHADOW_RADIUS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">SHADOW_OFFSET</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">AURA_COLOR</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
<span class="n">AURA_OFFSET</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">AURA_RADIUS</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">ItemIsMovable</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemIsMovable</span>
<span class="n">ItemIsSelectable</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemIsSelectable</span>
<span class="n">ItemPositionChange</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemPositionChange</span>
<span class="n">ItemSendsGeometryChanges</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemSendsGeometryChanges</span>

<span class="n">REGION_PEN</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">)</span>


<span class="n">BOND_CHANGE_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;single&#39;</span><span class="p">:</span><span class="s1">&#39;double&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span><span class="s1">&#39;double&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;singleplanar&#39;</span><span class="p">:</span><span class="s1">&#39;double&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;double&#39;</span><span class="p">:</span><span class="s1">&#39;triple&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;triple&#39;</span><span class="p">:</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;dative&#39;</span><span class="p">:</span><span class="s1">&#39;single&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="AtomLabel"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel">[docs]</a><span class="k">class</span> <span class="nc">AtomLabel</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">atomView</span><span class="p">,</span> <span class="n">compoundView</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">AtomLabel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="c1"># QtWidgets.QGraphicsItem.__init__(self)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>

    <span class="c1">#effect = QtWidgets.QGraphicsDropShadowEffect(compoundView)</span>
    <span class="c1">#effect.setBlurRadius(SHADOW_RADIUS)</span>
    <span class="c1">#effect.setColor(SHADOW_COLOR)</span>
    <span class="c1">#effect.setOffset(*SHADOW_OFFSET)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptHoverEvents</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptedMouseButtons</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">)</span>
    <span class="c1">#self.setGraphicsEffect(effect)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setZValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span> <span class="o">=</span> <span class="n">compoundView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomView</span> <span class="o">=</span> <span class="n">atomView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">NULL_RECT</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">syncLabel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceCoordinateCache</span><span class="p">)</span>



<div class="viewcode-block" id="AtomLabel.hoverEnterEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel.hoverEnterEvent">[docs]</a>  <span class="k">def</span> <span class="nf">hoverEnterEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomLabel.hoverLeaveEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel.hoverLeaveEvent">[docs]</a>  <span class="k">def</span> <span class="nf">hoverLeaveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomLabel.mouseDoubleClickEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel.mouseDoubleClickEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">queryAtomName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="AtomLabel.syncLabel"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel.syncLabel">[docs]</a>  <span class="k">def</span> <span class="nf">syncLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="mf">15.0</span>

    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">za</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">bonds</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>

      <span class="n">angles</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">getBondAngles</span><span class="p">()</span>
      <span class="n">angles</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span>
      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">]</span>
      <span class="n">angles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>
      <span class="n">diffs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">round</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angles</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
      <span class="n">diffs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

      <span class="n">delta</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">diffs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">angle</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">angle</span> <span class="o">=</span> <span class="mf">1.0</span>


    <span class="n">name</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
      <span class="n">text</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>

    <span class="n">textRect</span> <span class="o">=</span> <span class="n">FONT_METRIC</span><span class="o">.</span><span class="n">tightBoundingRect</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">textRect</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1.5</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">textRect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">xa</span><span class="o">+</span><span class="p">(</span><span class="n">rad</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ya</span><span class="o">+</span><span class="p">(</span><span class="n">rad</span><span class="o">+</span><span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="c1"># Global absolute centre</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="p">),</span>
                  <span class="n">QPointF</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomLabel.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">nameAtoms</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">NULL_RECT</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span></div>

<div class="viewcode-block" id="AtomLabel.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomLabel.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="c1">#if self.compoundView.showSkeletalFormula and self.atom.element == &#39;H&#39;:</span>
      <span class="c1">#for n in self.atom.neighbours:</span>
        <span class="c1">#if n.element != &#39;C&#39;:</span>
          <span class="c1">#return</span>

    <span class="n">useName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">nameAtoms</span>

    <span class="k">if</span> <span class="n">useName</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span><span class="p">:</span>
      <span class="n">point</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>

      <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">ELEMENT_FONT</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hover</span><span class="p">:</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">white</span><span class="p">)</span>
      <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="p">,</span> <span class="s1">&#39;setAtomColorWhite&#39;</span><span class="p">):</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">white</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>

      <span class="n">painter</span><span class="o">.</span><span class="n">drawText</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SelectionBox"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.SelectionBox">[docs]</a><span class="k">class</span> <span class="nc">SelectionBox</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">compoundView</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">SelectionBox</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="c1"># QtWidgets.QGraphicsItem.__init__(self)</span>
    <span class="c1"># self._scene = scene</span>
    <span class="c1"># print(self.scene(), scene, &#39;TEST&#39;)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setZValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span> <span class="o">=</span> <span class="n">compoundView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="SelectionBox.updateRegion"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.SelectionBox.updateRegion">[docs]</a>  <span class="k">def</span> <span class="nf">updateRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">begin</span> <span class="ow">and</span> <span class="n">end</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">begin</span>

    <span class="k">elif</span> <span class="n">begin</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">begin</span>

    <span class="k">elif</span> <span class="n">end</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="SelectionBox.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.SelectionBox.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
      <span class="n">pad</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">NULL_RECT</span></div>

<div class="viewcode-block" id="SelectionBox.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.SelectionBox.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">REGION_PEN</span><span class="p">)</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">HIGHLIGHT_BG</span><span class="p">)</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">drawRect</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="p">)</span></div></div>

<div class="viewcode-block" id="AtomGroupItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomGroupItem">[docs]</a><span class="k">class</span> <span class="nc">AtomGroupItem</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">compoundView</span><span class="p">,</span> <span class="n">atomGroup</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">AtomGroupItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="c1"># QtWidgets.QGraphicsItem.__init__(self)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>

    <span class="n">compoundView</span><span class="o">.</span><span class="n">groupItems</span><span class="p">[</span><span class="n">atomGroup</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span> <span class="o">=</span> <span class="n">compoundView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomGroup</span> <span class="o">=</span> <span class="n">atomGroup</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atomGroup</span><span class="o">.</span><span class="n">varAtoms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setZValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">NULL_RECT</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">NULL_POINT</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">syncGroup</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceCoordinateCache</span><span class="p">)</span>


<div class="viewcode-block" id="AtomGroupItem.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomGroupItem.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span></div>

<div class="viewcode-block" id="AtomGroupItem.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomGroupItem.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">pass</span></div></div>

<div class="viewcode-block" id="EquivItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.EquivItem">[docs]</a><span class="k">class</span> <span class="nc">EquivItem</span><span class="p">(</span><span class="n">AtomGroupItem</span><span class="p">):</span>

<div class="viewcode-block" id="EquivItem.syncGroup"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.EquivItem.syncGroup">[docs]</a>  <span class="k">def</span> <span class="nf">syncGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">coords</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>

    <span class="n">xl</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>
    <span class="n">yl</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>

    <span class="n">xc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>

    <span class="n">xa</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>
    <span class="n">ya</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>

    <span class="n">xb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>
    <span class="n">yb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">xb</span><span class="o">-</span><span class="n">xa</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">yb</span><span class="o">-</span><span class="n">ya</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="o">-</span><span class="n">xa</span><span class="p">,</span> <span class="n">yc</span><span class="o">-</span><span class="n">ya</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">[</span><span class="n">QPointF</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xa</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ya</span><span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">))</span>

    <span class="n">rect</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span>
                         <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

    <span class="n">pad</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="EquivItem.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.EquivItem.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showGroups</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">EQUIV_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DotLine</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">EQUIV_COLOR</span><span class="p">)</span>

    <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span><span class="p">:</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>

    <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">EQUIV_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ProchiralItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.ProchiralItem">[docs]</a><span class="k">class</span> <span class="nc">ProchiralItem</span><span class="p">(</span><span class="n">AtomGroupItem</span><span class="p">):</span>

<div class="viewcode-block" id="ProchiralItem.syncGroup"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.ProchiralItem.syncGroup">[docs]</a>  <span class="k">def</span> <span class="nf">syncGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">atomA</span><span class="p">,</span> <span class="n">atomB</span> <span class="o">=</span> <span class="n">atoms</span>

      <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">atomA</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">atomB</span><span class="o">.</span><span class="n">coords</span>

      <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>

      <span class="n">anchorPoint</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
      <span class="n">startPoint</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
      <span class="n">endPoint</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">groupDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">groupItems</span>

      <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomGroup</span><span class="o">.</span><span class="n">subGroups</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">groupA</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">groupB</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">gItemA</span> <span class="o">=</span> <span class="n">groupDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupA</span><span class="p">)</span>
        <span class="n">gItemB</span> <span class="o">=</span> <span class="n">groupDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupB</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gItemA</span> <span class="ow">and</span> <span class="n">gItemB</span><span class="p">:</span>

          <span class="n">centerA</span> <span class="o">=</span> <span class="n">gItemA</span><span class="o">.</span><span class="n">center</span>
          <span class="n">centerB</span> <span class="o">=</span> <span class="n">gItemB</span><span class="o">.</span><span class="n">center</span>

          <span class="n">anchorPoint</span> <span class="o">=</span> <span class="n">centerA</span>
          <span class="n">startPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapFromItem</span><span class="p">(</span><span class="n">gItemA</span><span class="p">,</span> <span class="n">centerA</span><span class="p">)</span>
          <span class="n">endPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapFromItem</span><span class="p">(</span><span class="n">gItemB</span><span class="p">,</span> <span class="n">centerB</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="k">return</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span>

    <span class="n">pad</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">startPoint</span><span class="p">,</span> <span class="n">endPoint</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">startPoint</span><span class="p">,</span> <span class="n">endPoint</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">anchorPoint</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProchiralItem.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.ProchiralItem.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showGroups</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span><span class="p">:</span>
      <span class="n">startPoint</span><span class="p">,</span> <span class="n">endPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>

      <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">PROCHIRAL_COLOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DotLine</span><span class="p">)</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">startPoint</span><span class="p">,</span> <span class="n">endPoint</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AromaticItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AromaticItem">[docs]</a><span class="k">class</span> <span class="nc">AromaticItem</span><span class="p">(</span><span class="n">AtomGroupItem</span><span class="p">):</span>

<div class="viewcode-block" id="AromaticItem.syncGroup"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AromaticItem.syncGroup">[docs]</a>  <span class="k">def</span> <span class="nf">syncGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">coords</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="n">xl</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>
    <span class="n">yl</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>

    <span class="n">xc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>

    <span class="n">xa</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>
    <span class="n">ya</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>

    <span class="n">xb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>
    <span class="n">yb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">xb</span><span class="o">-</span><span class="n">xa</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">yb</span><span class="o">-</span><span class="n">ya</span>

    <span class="n">dx2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xl</span><span class="p">]</span>
    <span class="n">dy2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">y</span><span class="o">-</span><span class="n">yc</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yc</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">yl</span><span class="p">]</span>

    <span class="n">d2</span> <span class="o">=</span> <span class="p">[</span><span class="n">dx2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">dy2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nl</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">d2</span><span class="p">))</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">PI</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">BOND_SEP</span><span class="p">,</span> <span class="n">r</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BOND_SEP</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="o">-</span><span class="n">xa</span><span class="p">,</span> <span class="n">yc</span><span class="o">-</span><span class="n">ya</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">))</span>

    <span class="n">rect</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span>
                         <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

    <span class="n">pad</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>


<div class="viewcode-block" id="AromaticItem.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AromaticItem.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>
    <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>

    <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">black</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AtomItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem">[docs]</a><span class="k">class</span> <span class="nc">AtomItem</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">compoundView</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">AtomItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="c1"># QtWidgets.QGraphicsItem.__init__(self)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>

    <span class="n">compoundView</span><span class="o">.</span><span class="n">atomViews</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span> <span class="o">=</span> <span class="n">compoundView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">variant</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">NULL_RECT</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">ItemIsSelectable</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">ItemIsMovable</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">ItemSendsGeometryChanges</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptHoverEvents</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptedMouseButtons</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">)</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">ELEMENT_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>  <span class="n">ELEMENT_DEFAULT</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QRadialGradient</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">darker</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">lighter</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient2</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QRadialGradient</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient2</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">darker</span><span class="p">()</span><span class="o">.</span><span class="n">darker</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient2</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">darker</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradient2</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="c1">#effect = QtWidgets.QGraphicsDropShadowEffect(compoundView)</span>
    <span class="c1">#effect.setBlurRadius(SHADOW_RADIUS)</span>
    <span class="c1">#effect.setColor(SHADOW_COLOR)</span>
    <span class="c1">#effect.setOffset(*SHADOW_OFFSET)</span>

    <span class="c1">#self.setGraphicsEffect(effect)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceCoordinateCache</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">highlights</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">makeBonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rightBond</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">freeDrag</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span> <span class="o">=</span> <span class="n">AtomLabel</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">compoundView</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>
    <span class="n">compoundView</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">syncToAtom</span><span class="p">()</span>

<div class="viewcode-block" id="AtomItem.itemChange"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.itemChange">[docs]</a>  <span class="k">def</span> <span class="nf">itemChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">change</span> <span class="o">==</span> <span class="n">ItemPositionChange</span><span class="p">:</span>
      <span class="n">compoundView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span>
      <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

      <span class="n">x</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
      <span class="n">dx</span> <span class="o">=</span> <span class="n">x0</span><span class="o">-</span><span class="n">x</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="n">y0</span><span class="o">-</span><span class="n">y</span>

      <span class="n">freeDrag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrag</span>

      <span class="n">nSelected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compoundView</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">)</span>

      <span class="c1"># This code block is to handle position changes of branches when snapping to grid.</span>
      <span class="c1"># In practice it will allow two branches to swap places.</span>
      <span class="k">if</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">snapToGrid</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nSelected</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Find which of the neighbouring atoms form the longest branch. A more proper check</span>
        <span class="c1"># to ensure the backbone is found could be done.</span>
        <span class="c1"># The shortest branch and the branch of the selected atom can be moved.</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">prevAtom</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">longestBranchLen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="n">branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">findAtomsInBranch</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
          <span class="n">branchLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">branchLen</span> <span class="o">&gt;</span> <span class="n">longestBranchLen</span><span class="p">:</span>
            <span class="n">prevAtom</span> <span class="o">=</span> <span class="n">neighbour</span>
            <span class="n">longestBranch</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="n">longestBranchLen</span> <span class="o">=</span> <span class="n">branchLen</span>
        <span class="k">if</span> <span class="n">prevAtom</span><span class="p">:</span>
          <span class="n">xP</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">yP</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="c1">#        bondLength = hypot(x0 - xP, y0 - yP)</span>
          <span class="n">bondLength</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># TODO: A smarter way of setting the right bondlength</span>
          <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="n">longestBranchLen</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="c1"># Find a reference atom next to prevAtom to calculate bond angles.</span>
          <span class="n">frozenNeighbour</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neighbour</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="ow">and</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
              <span class="n">branch</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">findAtomsInBranch</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
              <span class="n">branchLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">branchLen</span> <span class="o">&gt;</span> <span class="n">longestBranchLen</span><span class="p">:</span>
                <span class="n">longestBranch</span> <span class="o">=</span> <span class="n">branch</span>
                <span class="n">longestBranchLen</span> <span class="o">=</span> <span class="n">branchLen</span>
                <span class="n">frozenNeighbour</span> <span class="o">=</span> <span class="n">neighbour</span>
                <span class="n">prevAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">degrees</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">frozenNeighbour</span><span class="p">:</span>
            <span class="n">neighbour</span> <span class="o">=</span> <span class="n">frozenNeighbour</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">findAtomsInBranch</span><span class="p">(</span><span class="n">prevAtom</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">prevAtom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">])</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                <span class="n">frozenNeighbour</span> <span class="o">=</span> <span class="n">prevAtom</span>
                <span class="n">prevAngle</span> <span class="o">=</span> <span class="mi">330</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="k">break</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="n">frozenNeighbour</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No frozenNeighbour&quot;</span><span class="p">,</span>  <span class="n">longestBranchLen</span><span class="p">)</span>
            <span class="n">prevAtom</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">freeDrag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">freeDrag</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># If the item was selected and Ctrl is pressed when the item is moved the item does not count a selected. Let it be freely movable.</span>
        <span class="c1"># If there are more atoms selected also let them be freely movable.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">freeDrag</span><span class="p">:</span>
          <span class="n">prefAngles</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getPreferredBondAngles</span><span class="p">(</span><span class="n">prevAngle</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
          <span class="c1"># If the dragged atom only has neighbours with hydrogens (i.e. the reference atom has no other visible atoms connected) add</span>
          <span class="c1"># an extra possible angle.</span>
          <span class="k">if</span> <span class="n">frozenNeighbour</span> <span class="o">==</span> <span class="n">prevAtom</span> <span class="ow">and</span> <span class="n">prevAngle</span> <span class="o">==</span> <span class="mi">330</span><span class="p">:</span>
            <span class="n">prefAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefAngles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span><span class="c1"># or self.atom.atomInSameRing(prevAtom):</span>
            <span class="n">value</span><span class="o">.</span><span class="n">setX</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
            <span class="n">value</span><span class="o">.</span><span class="n">setY</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">itemChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

          <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">prevAngle</span><span class="p">)</span>
          <span class="n">currAngle</span> <span class="o">=</span> <span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span> <span class="o">-</span> <span class="n">prevAngle</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>
          <span class="n">newAngle</span> <span class="o">=</span> <span class="p">(</span><span class="n">atan2</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">yP</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xP</span><span class="p">)</span> <span class="o">-</span> <span class="n">prevAngle</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>

          <span class="c1"># Find which preferred angle is closest to the new angle.</span>
          <span class="n">bestAngle</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="n">bestDiff</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">prefAngles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">angle</span> <span class="o">+=</span> <span class="mi">360</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">newAngle</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bestAngle</span> <span class="ow">or</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">bestDiff</span><span class="p">:</span>
              <span class="n">bestAngle</span> <span class="o">=</span> <span class="n">angle</span>
              <span class="n">bestDiff</span> <span class="o">=</span> <span class="n">diff</span>

          <span class="c1"># If the current angle is agreeing best just set the selection circle to where the atom is</span>
          <span class="c1"># and return.</span>
          <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bestAngle</span> <span class="o">-</span> <span class="n">currAngle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">setX</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
            <span class="n">value</span><span class="o">.</span><span class="n">setY</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">itemChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

          <span class="n">bestAngle</span> <span class="o">+=</span> <span class="n">prevAngle</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xP</span> <span class="o">+</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">bestAngle</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">yP</span> <span class="o">+</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">bestAngle</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xP</span> <span class="o">+</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">bestAngle</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">yP</span> <span class="o">+</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">bestAngle</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prevAtom</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">atomInSameRing</span><span class="p">(</span><span class="n">prevAtom</span><span class="p">):</span>
          <span class="c1"># First snap the atoms in the same branch as the selected atom (these will not take the other branch into account when</span>
          <span class="c1"># deciding their positions).</span>
          <span class="n">sameBranch</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">findAtomsInBranch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">]))</span>
          <span class="n">atoms</span> <span class="o">-=</span> <span class="n">longestBranch</span>
          <span class="n">atoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sameBranch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sameBranch</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">snapAtomsToGrid</span><span class="p">(</span><span class="n">sameBranch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">,</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">showSkeletalFormula</span><span class="p">,</span> <span class="n">bondLength</span> <span class="o">=</span> <span class="n">bondLength</span><span class="p">)</span>

          <span class="c1"># Snap the second branch to the grid taking the first branch into account.</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">snapAtomsToGrid</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">prevAtom</span><span class="p">,</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">showSkeletalFormula</span><span class="p">,</span> <span class="n">bondLength</span> <span class="o">=</span> <span class="n">bondLength</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span>

      <span class="c1"># Synch positions</span>
      <span class="c1"># implicitly set bonds too</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

      <span class="c1"># Make bond detection</span>

      <span class="n">d</span> <span class="o">=</span> <span class="n">RADIUS</span>
      <span class="c1"># When using snapToGrid the distance between the atoms is so small that double and tripe bonds are created too easily if d2 is not made smaller.</span>
      <span class="k">if</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">snapToGrid</span><span class="p">:</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="mf">0.25</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="mf">0.5</span>
      <span class="n">r2</span> <span class="o">=</span> <span class="mi">15</span>
      <span class="n">atomViews</span> <span class="o">=</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">atomViews</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">makeBonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

      <span class="n">addBond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeBonds</span><span class="o">.</span><span class="n">add</span>
      <span class="n">valencesS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">])</span>
      <span class="n">positionsS</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="n">r2</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span>
                     <span class="n">y</span><span class="o">+</span><span class="n">r2</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">angle</span><span class="p">)</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">valencesS</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">valencesS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="n">valences</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="n">valences</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">atomView</span> <span class="o">=</span> <span class="n">atomViews</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">atomView</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

          <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span><span class="o">-</span><span class="n">x</span>
          <span class="n">dy</span> <span class="o">=</span> <span class="n">y1</span><span class="o">-</span><span class="n">y</span>
          <span class="n">dist2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>

          <span class="c1"># consider using items directly</span>
          <span class="k">if</span> <span class="n">dist2</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">*</span><span class="n">d</span><span class="p">:</span>

            <span class="c1"># Other atom</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x1</span><span class="o">+</span><span class="n">r2</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
                          <span class="n">y1</span><span class="o">+</span><span class="n">r2</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">valences</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
              <span class="k">for</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">a3</span> <span class="ow">in</span> <span class="n">positionsS</span><span class="p">:</span>
                <span class="n">dx2</span> <span class="o">=</span> <span class="n">x3</span><span class="o">-</span><span class="n">x2</span>
                <span class="n">dy2</span> <span class="o">=</span> <span class="n">y3</span><span class="o">-</span><span class="n">y2</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">dx2</span><span class="o">*</span><span class="n">dx2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy2</span><span class="o">*</span><span class="n">dy2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">d2</span> <span class="o">*</span> <span class="n">d2</span><span class="p">):</span>
                  <span class="n">atomView</span><span class="o">.</span><span class="n">highlights</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">highlights</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
                  <span class="n">addBond</span><span class="p">(</span> <span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span> <span class="p">)</span>

          <span class="n">atomView</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">bondItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span><span class="p">:</span>
        <span class="n">bondItem</span><span class="o">.</span><span class="n">syncToBond</span><span class="p">()</span>

      <span class="n">groupItems</span> <span class="o">=</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">groupItems</span>
      <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">:</span>
        <span class="n">groupItems</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">syncGroup</span><span class="p">()</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span><span class="o">.</span><span class="n">syncLabel</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">itemChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="AtomItem.moveAtom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.moveAtom">[docs]</a>  <span class="k">def</span> <span class="nf">moveAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">syncToAtom</span><span class="p">()</span></div>


<div class="viewcode-block" id="AtomItem.syncToAtom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.syncToAtom">[docs]</a>  <span class="k">def</span> <span class="nf">syncToAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">compoundView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span>

    <span class="n">bondDict</span> <span class="o">=</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">bondItems</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span> <span class="o">=</span> <span class="p">[</span><span class="n">bondDict</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bonds</span> <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bondDict</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="mf">21.0</span>
    <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="mf">18.0</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="mf">15.0</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

    <span class="c1"># Global location</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Define where local origin is in global</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

    <span class="n">rightBond</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">leftBond</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">:</span>
      <span class="n">adj</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">adj</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#if self.compoundView.showSkeletalFormula:</span>
      <span class="c1">#for neighbour in atom.neighbours:</span>
      <span class="c1">#nH = 0</span>
        <span class="c1">#if neighbour.element == &#39;H&#39;:</span>
          <span class="c1">#nH += 1</span>

      <span class="c1">#if atom.element != &#39;C&#39; or atom.freeValences or atom.chirality:# or nH == 4:</span>
        <span class="c1">#for neighbour in atom.neighbours:</span>
          <span class="c1">#if neighbour.element == &#39;H&#39;:</span>
            <span class="c1">#continue</span>
          <span class="c1">#nX, nY, nZ = neighbour.coords</span>
          <span class="c1">#if nX &gt; x:</span>
            <span class="c1">#dY = max(0.0001, abs(nY - y))</span>
            <span class="c1">#currD = 1/dY</span>
            <span class="c1">#if currD &gt; rightBond:</span>
              <span class="c1">#rightBond = currD</span>
          <span class="c1">#elif nX &lt; x:</span>
            <span class="c1">#dY = max(0.0001, abs(nY - y))</span>
            <span class="c1">#currD = 1/dY</span>
            <span class="c1">#if currD &gt; rightBond:</span>
              <span class="c1">#leftBond = currD</span>

        <span class="c1">#adj += 9</span>
        <span class="c1">#if nH &gt; 1:</span>
          <span class="c1">#adj += 9</span>

    <span class="c1"># In local coords</span>
    <span class="k">if</span> <span class="n">rightBond</span> <span class="o">&gt;</span> <span class="n">leftBond</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rightBond</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">adj</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">),</span>
                        <span class="n">QPointF</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="n">adj</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rightBond</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">),</span>
                        <span class="n">QPointF</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">adj</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="n">adj</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">bondItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span><span class="p">:</span>
      <span class="n">bondItem</span><span class="o">.</span><span class="n">syncToBond</span><span class="p">()</span>

    <span class="n">groupItems</span> <span class="o">=</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">groupItems</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">:</span>
      <span class="n">groupItems</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">syncGroup</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">autoChirality</span><span class="p">:</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">autoSetChirality</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
        <span class="n">neighbour</span><span class="o">.</span><span class="n">autoSetChirality</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span><span class="o">.</span><span class="n">syncLabel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1">#if self.compoundView.showSkeletalFormula and self.atom.element == &#39;H&#39;:</span>
      <span class="c1">#return NULL_RECT</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span></div>

<div class="viewcode-block" id="AtomItem.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">compoundView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span>
    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>

    <span class="n">scene</span> <span class="o">=</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">scene</span>

    <span class="k">for</span> <span class="n">bondItem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span><span class="p">):</span>
      <span class="n">bondItem</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">atomViews</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>

    <span class="c1"># Delete the master atom, not the var one</span>
    <span class="n">masterAtom</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">masterAtom</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
      <span class="n">masterAtom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span>
    <span class="k">del</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="AtomItem.deselect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.deselect">[docs]</a>  <span class="k">def</span> <span class="nf">deselect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">selectedViews</span>

    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
      <span class="n">selected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bondItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span><span class="p">:</span>
      <span class="n">bondItem</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.select"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.select">[docs]</a>  <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">selectedViews</span>
    <span class="n">selected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bondItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondItems</span><span class="p">:</span>
      <span class="n">atomItemA</span><span class="p">,</span> <span class="n">atomItemB</span> <span class="o">=</span> <span class="n">bondItem</span><span class="o">.</span><span class="n">atomItems</span>

      <span class="k">if</span> <span class="n">atomItemA</span><span class="o">.</span><span class="n">selected</span> <span class="ow">and</span> <span class="n">atomItemB</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
        <span class="n">bondItem</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.hoverEnterEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.hoverEnterEvent">[docs]</a>  <span class="k">def</span> <span class="nf">hoverEnterEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.hoverLeaveEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.hoverLeaveEvent">[docs]</a>  <span class="k">def</span> <span class="nf">hoverLeaveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">)</span>

    <span class="n">mods</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span>
    <span class="n">button</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span>
    <span class="n">haveCtrl</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span>
    <span class="n">haveShift</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SHIFT</span>

    <span class="k">if</span> <span class="n">haveCtrl</span> <span class="ow">or</span> <span class="n">haveShift</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
        <span class="n">view</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.mouseMoveEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.mouseMoveEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="n">mods</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span>
    <span class="n">haveCtrl</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span>

    <span class="k">if</span> <span class="n">haveCtrl</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">freeDrag</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">freeDrag</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="AtomItem.mouseDoubleClickEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.mouseDoubleClickEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span><span class="o">.</span><span class="n">hover</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">queryAtomName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomLabel</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">mods</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span>
    <span class="n">button</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span>
    <span class="n">haveCtrl</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span>
    <span class="n">haveShift</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SHIFT</span>

    <span class="k">if</span> <span class="n">haveCtrl</span> <span class="ow">or</span> <span class="n">haveShift</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">nAtoms</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">nPrev</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">])</span>

      <span class="k">while</span> <span class="n">nAtoms</span> <span class="o">!=</span> <span class="n">nPrev</span><span class="p">:</span>
        <span class="n">nPrev</span> <span class="o">=</span> <span class="n">nAtoms</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
          <span class="n">atoms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>

        <span class="n">nAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

      <span class="n">viewDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">atomViews</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">atomView</span> <span class="o">=</span> <span class="n">viewDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="n">atomView</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">atomView</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>


    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>


<div class="viewcode-block" id="AtomItem.mouseReleaseEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.mouseReleaseEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span>
    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>

    <span class="n">tl</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">br</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x1</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">y1</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">x2</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">y2</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">d2</span> <span class="o">=</span> <span class="n">RADIUS</span><span class="o">/</span><span class="mf">2.0</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>


      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeBonds</span><span class="p">:</span>

        <span class="n">elemA</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">element</span>
        <span class="n">elemB</span> <span class="o">=</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">element</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="n">elemA</span><span class="p">,</span> <span class="n">elemB</span><span class="p">])</span> <span class="ow">in</span> <span class="n">DISALLOWED</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="n">varAtomA</span> <span class="ow">in</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
          <span class="n">bond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">getBond</span><span class="p">(</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span> <span class="ow">and</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">setBondType</span><span class="p">(</span> <span class="n">BOND_CHANGE_DICT</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Bond</span><span class="p">((</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">),</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">varAtomA</span><span class="p">)</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">varAtomB</span><span class="p">)</span>

      <span class="c1">#neighbourhood = set()</span>
      <span class="c1">#for atom in atoms:</span>
      <span class="c1">#  neighbourhood.update(atom.neighbours)</span>

      <span class="c1">#if atoms:</span>
      <span class="c1">#  #if atoms == neighbourhood:</span>
      <span class="c1">#  #  self.variant.minimise2d([atoms.pop(),])</span>
      <span class="c1">#  #else:</span>
      <span class="c1">#  self.variant.minimise2d([atom,])</span>


      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">atomA</span><span class="p">,</span> <span class="n">atomB</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>

        <span class="k">if</span> <span class="n">atomA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>
          <span class="n">atomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">atomB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>
          <span class="n">atomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">showSkeletalFormula</span><span class="p">:</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">alignMolecule</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">alignMolecule</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span> <span class="c1"># Render new objs</span>

    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtomItem.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomItem.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="n">textAlign</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span>
    <span class="n">qRect</span> <span class="o">=</span> <span class="n">QRectF</span>
    <span class="n">qBrush</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QBrush</span>
    <span class="n">qPoint</span> <span class="o">=</span> <span class="n">QPointF</span>
    <span class="n">qPoly</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPolygonF</span>

    <span class="n">showChargeSymbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showChargeSymbols</span>
    <span class="n">showChiralities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showChiralities</span>

    <span class="n">highlights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlights</span>
    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>

    <span class="n">r</span>  <span class="o">=</span> <span class="mf">9.0</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="mf">15.0</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">RADIUS</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span>

    <span class="n">drawText</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawText</span>
    <span class="n">drawEllipse</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawEllipse</span>
    <span class="n">drawLine</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span>
    <span class="n">drawPoly</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawPolygon</span>

    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">ELEMENT_FONT</span><span class="p">)</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">ELEMENT_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span>  <span class="n">ELEMENT_DEFAULT</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
      <span class="c1"># SpecView</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">container</span><span class="p">:</span>
        <span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">_hexToRgba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">mainApp</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">foregroundColor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">_hexToRgba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">mainApp</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
      <span class="c1"># Analysis</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">glWidget</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Needs rewriting - analysisProfile does not exist&quot;</span><span class="p">)</span>
        <span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">()</span>
        <span class="n">backgroundColor</span><span class="o">.</span><span class="n">setRgbF</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">_hexToRgba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">spectrumWindow</span><span class="o">.</span><span class="n">analysisProfile</span><span class="o">.</span><span class="n">bgColor</span><span class="p">))</span>
        <span class="n">foregroundColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">black</span>

      <span class="c1"># Fallback alternative</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">black</span>
        <span class="n">foregroundColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">black</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">backgroundColor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">backgroundColor</span>
      <span class="n">foregroundColor</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">blue</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showSkeletalFormula</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hover</span><span class="p">:</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="n">qBrush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradient2</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="n">qBrush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradient</span><span class="p">)</span>

      <span class="n">brush</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">RadialGradientPattern</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">brush</span> <span class="o">=</span> <span class="n">backgroundColor</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">foregroundColor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
      <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">r2</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
      <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">r2</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">highlights</span><span class="p">:</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">)</span>
        <span class="n">drawEllipse</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r3</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">foregroundColor</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">drawEllipse</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">showChiralities</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">bonds</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>

        <span class="n">angles</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">getBondAngles</span><span class="p">()</span>
        <span class="n">angles</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">PI</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">]</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">round</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angles</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">diffs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">delta</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">diffs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">/</span><span class="mf">2.0</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showSkeletalFormula</span><span class="p">:</span>

      <span class="n">skeletalColor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showSkeletalFormulaColor</span>
      <span class="c1">#nH = 0</span>
      <span class="c1">#for neighbour in atom.neighbours:</span>
        <span class="c1">#if neighbour.element == &#39;H&#39;:</span>
          <span class="c1">#nH += 1</span>

      <span class="n">nDouble</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
          <span class="n">nDouble</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="c1">#if elem == &#39;C&#39; and len(atom.freeValences) == 0 and nH &lt; 4 and nDouble &lt; len(atom.bonds):</span>
      <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nDouble</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
        <span class="n">transparent</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">transparent</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">transparent</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">)</span>
          <span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">showChiralities</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">CHIRAL_FONT</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
              <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">CHIRAL_COLOR</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">foregroundColor</span><span class="p">)</span>

            <span class="n">chirality</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span>

            <span class="k">if</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">):</span>
              <span class="n">chirality</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">chirality</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="n">fontMetric</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="n">chirality</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
            <span class="n">chiralityX</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">chiralityY</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">chiralityX</span><span class="p">,</span> <span class="n">chiralityY</span><span class="p">),</span> <span class="n">chirality</span><span class="p">)</span>

        <span class="k">return</span>

      <span class="c1">#if elem == &#39;H&#39;:</span>
        <span class="c1">#for n in atom.neighbours:</span>
          <span class="c1">#if n.element != &#39;C&#39;:</span>
            <span class="c1">#return</span>

      <span class="n">font</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
      <span class="n">smallFont</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
      <span class="n">font</span><span class="o">.</span><span class="n">setPointSizeF</span><span class="p">(</span><span class="n">font</span><span class="o">.</span><span class="n">pointSize</span><span class="p">()</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>
      <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
      <span class="n">fontMetric</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>
      <span class="n">bbox</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">tightBoundingRect</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
      <span class="n">width</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
      <span class="n">hydrogenWidth</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
      <span class="n">h2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span>
      <span class="n">w2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">skeletalColor</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
          <span class="c1"># SpecView</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">container</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">foregroundColor</span>
          <span class="c1"># Analyis</span>
          <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">glWidget</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">foregroundColor</span>
          <span class="c1"># Fallback</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">darkGray</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">color</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">darkGray</span>

      <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">getBondAngles</span><span class="p">()</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span>

        <span class="k">if</span> <span class="n">angles</span><span class="p">:</span>
          <span class="n">startAngle</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">startAngle</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">)</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">qPoly</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
              <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
              <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
              <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

            <span class="n">drawPoly</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">foregroundColor</span><span class="p">)</span>


          <span class="n">poly</span> <span class="o">=</span> <span class="n">qPoly</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

          <span class="n">drawPoly</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">)</span>
          <span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">backgroundColor</span><span class="p">)</span>
        <span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">textPoint</span> <span class="o">=</span> <span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">w2</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h2</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">drawText</span><span class="p">(</span><span class="n">textPoint</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
        <span class="c1">#hydrogenText= hydrogenNr = None</span>
        <span class="c1">#if nH != 0:</span>
          <span class="c1">#hydrogenText = &#39;H&#39;</span>
        <span class="c1">#if nH &gt; 1:</span>
          <span class="c1">#hydrogenNr = &quot;%d&quot; % nH</span>
        <span class="c1">#if hydrogenText:</span>
          <span class="c1">#nrWidth = 0</span>
          <span class="c1">#if hydrogenNr:</span>
            <span class="c1">#painter.setFont(smallFont)</span>
            <span class="c1">#fontMetric = QtGui.QFontMetricsF(smallFont)</span>
            <span class="c1">#nrWidth = fontMetric.width(hydrogenNr)</span>
            <span class="c1">#if self.rightBond:</span>
              <span class="c1">#textPoint = qPoint(x-width/2-nrWidth, y+h2+bbox.height()/3)</span>
            <span class="c1">#else:</span>
              <span class="c1">#textPoint = qPoint(x+width/2+hydrogenWidth, y+h2+bbox.height()/3)</span>
            <span class="c1">#drawText(textPoint, hydrogenNr)</span>
            <span class="c1">#painter.setFont(font)</span>
          <span class="c1">#if self.rightBond:</span>
            <span class="c1">#textPoint = qPoint(x-width/2-nrWidth-hydrogenWidth, y+h2)</span>
          <span class="c1">#else:</span>
            <span class="c1">#textPoint = qPoint(x+width/2, y+h2)</span>
          <span class="c1">#drawText(textPoint, hydrogenText)</span>

        <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">foregroundColor</span><span class="p">)</span>

        <span class="n">charge</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span>

        <span class="k">if</span> <span class="n">showChiralities</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>

            <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">CHIRAL_FONT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
              <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">CHIRAL_COLOR</span><span class="p">)</span>

            <span class="n">chirality</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span>
            <span class="k">if</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">):</span>
              <span class="n">chirality</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">chirality</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="n">fontMetric</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="n">chirality</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
            <span class="n">chiralityX</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">chiralityY</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">chiralityX</span><span class="p">,</span> <span class="n">chiralityY</span><span class="p">),</span> <span class="n">chirality</span><span class="p">)</span>


          <span class="c1">#elif atom.stereo:</span>
          <span class="c1">#  painter.setFont(CHIRAL_FONT)</span>
          <span class="c1">#  painter.setPen(CHIRAL_COLOR)</span>
          <span class="c1">#  drawText(qPoint(x+r, y+r+4), &#39;*&#39;)</span>

        <span class="k">if</span> <span class="n">showChargeSymbols</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">charge</span><span class="p">:</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">smallFont</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">charge</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
              <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">NEG_COLOR</span>

            <span class="k">elif</span> <span class="n">charge</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">POS_COLOR</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>

            <span class="k">elif</span> <span class="n">charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">POS_COLOR</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">+&#39;</span> <span class="o">%</span> <span class="n">charge</span>

            <span class="k">else</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">NEG_COLOR</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">charge</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">skeletalColor</span><span class="p">:</span>
              <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">CHARGE_BG_COLOR</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rightBond</span><span class="p">:</span>
              <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
              <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
              <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

      <span class="n">fontMetric</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>
      <span class="n">bbox</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">tightBoundingRect</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
      <span class="n">h2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span>
      <span class="n">w2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span>

      <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">getBondAngles</span><span class="p">()</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span>

        <span class="k">if</span> <span class="n">angles</span><span class="p">:</span>
          <span class="n">startAngle</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">startAngle</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">)</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">qPoly</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
              <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
              <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
              <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

            <span class="n">drawPoly</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>


          <span class="n">poly</span> <span class="o">=</span> <span class="n">qPoly</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

          <span class="n">drawPoly</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>


      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">HIGHLIGHT</span><span class="p">)</span>
          <span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>


        <span class="n">drawEllipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">textPoint</span> <span class="o">=</span> <span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">w2</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h2</span><span class="p">)</span>
        <span class="n">drawText</span><span class="p">(</span><span class="n">textPoint</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>

        <span class="n">charge</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span>

        <span class="k">if</span> <span class="n">showChiralities</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">CHIRAL_FONT</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">CHIRAL_COLOR</span><span class="p">)</span>
            <span class="n">chirality</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span>

            <span class="k">if</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">):</span>
              <span class="n">chirality</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">chirality</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="n">fontMetric</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="n">painter</span><span class="o">.</span><span class="n">font</span><span class="p">())</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="n">chirality</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">fontMetric</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
            <span class="n">chiralityX</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">r2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">chiralityY</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">r2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">chiralityX</span><span class="p">,</span> <span class="n">chiralityY</span><span class="p">),</span> <span class="n">chirality</span><span class="p">)</span>

          <span class="c1">#elif atom.stereo:</span>
          <span class="c1">#  painter.setFont(CHIRAL_FONT)</span>
          <span class="c1">#  painter.setPen(CHIRAL_COLOR)</span>
          <span class="c1">#  drawText(qPoint(x+r, y+r+4), &#39;*&#39;)</span>

        <span class="k">if</span> <span class="n">showChargeSymbols</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">charge</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">charge</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
              <span class="n">color</span> <span class="o">=</span> <span class="n">NEG_COLOR</span>

            <span class="k">elif</span> <span class="n">charge</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">color</span> <span class="o">=</span> <span class="n">POS_COLOR</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>

            <span class="k">elif</span> <span class="n">charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">color</span> <span class="o">=</span> <span class="n">POS_COLOR</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">+&#39;</span> <span class="o">%</span> <span class="n">charge</span>

            <span class="k">else</span><span class="p">:</span>
              <span class="n">color</span> <span class="o">=</span> <span class="n">NEG_COLOR</span>
              <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">charge</span><span class="p">)</span>

            <span class="n">painter</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">CHARGE_FONT</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">CHARGE_BG_COLOR</span><span class="p">)</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">drawText</span><span class="p">(</span><span class="n">qPoint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">highlights</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="BondItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem">[docs]</a><span class="k">class</span> <span class="nc">BondItem</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">compoundView</span><span class="p">,</span> <span class="n">bond</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">BondItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="c1"># QtWidgets.QGraphicsItem.__init__(self)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>

    <span class="n">compoundView</span><span class="o">.</span><span class="n">bondItems</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">effect</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsDropShadowEffect</span><span class="p">(</span><span class="n">compoundView</span><span class="p">)</span>
    <span class="n">effect</span><span class="o">.</span><span class="n">setBlurRadius</span><span class="p">(</span><span class="n">SHADOW_RADIUS</span><span class="p">)</span>
    <span class="n">effect</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">SHADOW_COLOR</span><span class="p">)</span>
    <span class="n">effect</span><span class="o">.</span><span class="n">setOffset</span><span class="p">(</span><span class="o">*</span><span class="n">SHADOW_OFFSET</span><span class="p">)</span>

    <span class="c1">#self.setGraphicsEffect(effect)</span>
    <span class="c1">#self.setFlag(ItemIsSelectable)</span>
    <span class="c1">#self.setFlag(ItemIsMovable)</span>

    <span class="c1">#self.setCacheMode(self.NoCache)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptedMouseButtons</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setZValue</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span> <span class="o">=</span> <span class="n">compoundView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bond</span> <span class="o">=</span> <span class="n">bond</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomItems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceCoordinateCache</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">NULL_RECT</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">syncToBond</span><span class="p">()</span>

<div class="viewcode-block" id="BondItem.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">atomItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomItems</span><span class="p">:</span>
      <span class="n">atomItem</span><span class="o">.</span><span class="n">bondItems</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">compoundView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span>
    <span class="k">del</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">bondItems</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bond</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bond</span><span class="o">.</span><span class="n">deleteAll</span><span class="p">()</span>
    <span class="k">del</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="BondItem.select"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.select">[docs]</a>  <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="BondItem.deselect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.deselect">[docs]</a>  <span class="k">def</span> <span class="nf">deselect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="BondItem.syncToBond"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.syncToBond">[docs]</a>  <span class="k">def</span> <span class="nf">syncToBond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">bond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond</span>

    <span class="n">atomA</span><span class="p">,</span> <span class="n">atomB</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>

    <span class="n">atomDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">atomViews</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomItems</span> <span class="o">=</span> <span class="p">[</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atomA</span><span class="p">],</span> <span class="n">atomDict</span><span class="p">[</span><span class="n">atomB</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">atomItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomItems</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomItem</span><span class="o">.</span><span class="n">bondItems</span><span class="p">:</span>
        <span class="n">atomItem</span><span class="o">.</span><span class="n">bondItems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">za</span> <span class="o">=</span> <span class="n">atomA</span><span class="o">.</span><span class="n">coords</span>
    <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">zb</span> <span class="o">=</span> <span class="n">atomB</span><span class="o">.</span><span class="n">coords</span>

    <span class="c1"># Model curation</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">xb</span><span class="o">-</span><span class="n">xa</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">yb</span><span class="o">-</span><span class="n">ya</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">zb</span><span class="o">-</span><span class="n">za</span>

    <span class="n">angleA</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="o">-</span><span class="n">dy</span><span class="p">)</span>

    <span class="n">xg</span> <span class="o">=</span> <span class="n">BOND_SEP</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angleA</span><span class="p">)</span>
    <span class="n">yg</span> <span class="o">=</span> <span class="n">BOND_SEP</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angleA</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">atomA</span><span class="o">.</span><span class="n">isLabile</span> <span class="ow">or</span> <span class="n">atomB</span><span class="o">.</span><span class="n">isLabile</span><span class="p">:</span>
      <span class="n">isLabile</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">showChargeSymbols</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DashLine</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">isLabile</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="n">style</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span>

    <span class="n">stereoA</span> <span class="o">=</span> <span class="n">atomA</span><span class="o">.</span><span class="n">stereo</span>
    <span class="n">stereoB</span> <span class="o">=</span> <span class="n">atomB</span><span class="o">.</span><span class="n">stereo</span>
    <span class="k">if</span> <span class="n">stereoA</span> <span class="ow">or</span> <span class="n">stereoB</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">stereoA</span><span class="p">:</span> <span class="c1"># if they both are...</span>
        <span class="n">zbase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">stereoA</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>
        <span class="n">nStereo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stereoA</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">zbase</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">stereoB</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atomA</span><span class="p">)</span>
        <span class="n">nStereo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stereoB</span><span class="p">)</span>

      <span class="k">if</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="n">nStereo</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">zstep</span> <span class="o">=</span> <span class="n">BOND_STEREO_DICT</span><span class="p">[</span><span class="n">nStereo</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">zstep</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">zstep</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">zbase</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond</span><span class="o">.</span><span class="n">direction</span>
    <span class="k">if</span> <span class="n">direction</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="n">atomA</span><span class="p">:</span>
        <span class="n">direct</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">direct</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">direct</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Geometry</span>

    <span class="c1"># Set global position using first point</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">ya</span><span class="p">))</span>

    <span class="c1"># Draw local relative to origin</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">,</span> <span class="n">zstep</span><span class="p">,</span> <span class="n">zbase</span><span class="p">,</span> <span class="n">direct</span><span class="p">)</span>

    <span class="c1"># Setup render coords</span>

    <span class="n">nLines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BOND_TYPE_VALENCES</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span><span class="p">])</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">BOND_SEP</span> <span class="o">*</span> <span class="p">(</span><span class="n">nLines</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.75</span>

    <span class="k">if</span> <span class="n">zstep</span><span class="p">:</span>
      <span class="n">pad</span> <span class="o">+=</span> <span class="n">BOND_SEP</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">direct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">pad</span> <span class="o">+=</span> <span class="n">BOND_SEP</span><span class="o">*</span><span class="mi">2</span>

    <span class="n">rect</span> <span class="o">=</span> <span class="n">QRectF</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                  <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="BondItem.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1">#if self.compoundView.showSkeletalFormula:</span>
      <span class="c1">#for atom in self.bond.varAtoms:</span>
        <span class="c1">#if atom.element == &#39;H&#39;:</span>
          <span class="c1">#for n in atom.neighbours:</span>
            <span class="c1">#if n.element != &#39;C&#39;:</span>
              <span class="c1">#return NULL_RECT</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span></div>

<div class="viewcode-block" id="BondItem.getDistToBond"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.getDistToBond">[docs]</a>  <span class="k">def</span> <span class="nf">getDistToBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>

    <span class="n">xm</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
    <span class="n">ym</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

    <span class="n">atomItemA</span><span class="p">,</span> <span class="n">atomItemB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomItems</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">atomItemA</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
    <span class="n">xa</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
    <span class="n">ya</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">atomItemB</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
    <span class="n">xb</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
    <span class="n">yb</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

    <span class="n">xb</span> <span class="o">-=</span> <span class="n">xa</span>
    <span class="n">yb</span> <span class="o">-=</span> <span class="n">ya</span>

    <span class="n">lb</span> <span class="o">=</span> <span class="n">hypot</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">)</span>

    <span class="n">xb</span> <span class="o">/=</span> <span class="n">lb</span>
    <span class="n">yb</span> <span class="o">/=</span> <span class="n">lb</span>

    <span class="n">xm</span> <span class="o">-=</span> <span class="n">xa</span>
    <span class="n">ym</span> <span class="o">-=</span> <span class="n">ya</span>

    <span class="n">dp</span> <span class="o">=</span> <span class="n">xb</span><span class="o">*</span><span class="n">xm</span> <span class="o">+</span> <span class="n">yb</span><span class="o">*</span><span class="n">ym</span>

    <span class="n">xb</span> <span class="o">*=</span> <span class="n">dp</span>
    <span class="n">yb</span> <span class="o">*=</span> <span class="n">dp</span>

    <span class="n">xb</span> <span class="o">-=</span> <span class="n">xm</span>
    <span class="n">yb</span> <span class="o">-=</span> <span class="n">ym</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">hypot</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="BondItem.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">selectedViews</span><span class="p">)</span>

    <span class="n">mods</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span>
    <span class="n">button</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span>
    <span class="n">haveCtrl</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span>
    <span class="n">haveShift</span> <span class="o">=</span> <span class="n">mods</span> <span class="o">&amp;</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SHIFT</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDistToBond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">atomItemA</span><span class="p">,</span> <span class="n">atomItemB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomItems</span>

    <span class="k">if</span> <span class="n">haveCtrl</span> <span class="ow">or</span> <span class="n">haveShift</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atomItemA</span><span class="o">.</span><span class="n">selected</span> <span class="ow">and</span> <span class="n">atomItemB</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
        <span class="n">atomItemA</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
        <span class="n">atomItemB</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">atomItemA</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">atomItemB</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">atomItemA</span><span class="o">.</span><span class="n">selected</span> <span class="ow">and</span> <span class="n">atomItemB</span><span class="o">.</span><span class="n">selected</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
        <span class="n">view</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
      <span class="n">atomItemA</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
      <span class="n">atomItemB</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

    <span class="n">atomItemA</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">atomItemB</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="BondItem.mouseDoubleClickEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.mouseDoubleClickEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

    <span class="n">bond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond</span>

    <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDistToBond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapToScene</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">varAtom1</span><span class="p">,</span> <span class="n">varAtom2</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>

    <span class="n">atomA</span> <span class="o">=</span> <span class="n">varAtom1</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">atomB</span> <span class="o">=</span> <span class="n">varAtom2</span><span class="o">.</span><span class="n">atom</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>

      <span class="n">varAtomA</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomA</span><span class="p">)</span>
      <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">varAtomA</span> <span class="ow">and</span> <span class="n">varAtomB</span><span class="p">:</span>
        <span class="n">common</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">bonds</span> <span class="o">&amp;</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">bonds</span>
        <span class="k">if</span> <span class="n">common</span><span class="p">:</span>
          <span class="n">bond</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

          <span class="k">if</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span> <span class="ow">and</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">setBondType</span><span class="p">(</span> <span class="n">BOND_CHANGE_DICT</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
            <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

          <span class="k">elif</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span><span class="s1">&#39;triple&#39;</span><span class="p">,</span><span class="s1">&#39;quadruple&#39;</span><span class="p">):</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">setBondType</span><span class="p">(</span> <span class="s1">&#39;single&#39;</span> <span class="p">)</span>
            <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
            <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>


    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">autoChirality</span><span class="p">:</span>
      <span class="n">varAtom1</span><span class="o">.</span><span class="n">autoSetChirality</span><span class="p">()</span>
      <span class="n">varAtom2</span><span class="o">.</span><span class="n">autoSetChirality</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span></div>

<div class="viewcode-block" id="BondItem.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.BondItem.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
      <span class="n">color</span> <span class="o">=</span> <span class="n">HIGHLIGHT</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
      <span class="c1"># SpecView</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">container</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">_hexToRgba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">mainApp</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
      <span class="c1"># Analysis</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">glWidget</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Needs rewriting - analysisProfile does not exist&quot;</span><span class="p">)</span>
        <span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">()</span>
        <span class="n">backgroundColor</span><span class="o">.</span><span class="n">setRgbF</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">_hexToRgba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glWidget</span><span class="o">.</span><span class="n">spectrumWindow</span><span class="o">.</span><span class="n">analysisProfile</span><span class="o">.</span><span class="n">bgColor</span><span class="p">))</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">black</span>
      <span class="c1"># Fallback</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">bondColor</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">bondColor</span>

    <span class="n">style</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">,</span> <span class="n">zstep</span><span class="p">,</span> <span class="n">zbase</span><span class="p">,</span> <span class="n">direct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>
    <span class="n">bondType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span>
    <span class="n">drawLine</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span>

    <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>

    <span class="c1">#if self.compoundView.showSkeletalFormula:</span>
      <span class="c1">#for atom in self.bond.varAtoms:</span>
        <span class="c1">#if atom.element == &#39;H&#39;:</span>
          <span class="c1">#for n in atom.neighbours:</span>
            <span class="c1">#if n.element != &#39;C&#39;:</span>
              <span class="c1">#return</span>

    <span class="k">if</span> <span class="n">bondType</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;single&#39;</span><span class="p">,</span><span class="s1">&#39;dative&#39;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;dative&#39;</span><span class="p">:</span>
        <span class="n">xindent</span> <span class="o">=</span> <span class="mf">3.5</span><span class="o">*</span><span class="n">yg</span>
        <span class="n">yindent</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.5</span><span class="o">*</span><span class="n">xg</span>

        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
          <span class="n">x1</span> <span class="o">=</span> <span class="n">dx</span><span class="o">-</span><span class="n">xindent</span><span class="o">*</span><span class="mf">1.5</span>
          <span class="n">y1</span> <span class="o">=</span> <span class="n">dy</span><span class="o">-</span><span class="n">yindent</span><span class="o">*</span><span class="mf">1.5</span>
          <span class="n">x0</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="n">x0</span> <span class="o">=</span> <span class="n">xindent</span><span class="o">*</span><span class="mf">1.5</span>
          <span class="n">y0</span> <span class="o">=</span> <span class="n">yindent</span><span class="o">*</span><span class="mf">1.5</span>
          <span class="n">x1</span> <span class="o">=</span> <span class="n">dx</span>
          <span class="n">y1</span> <span class="o">=</span> <span class="n">dy</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">dx</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">dy</span>

      <span class="k">if</span> <span class="n">zstep</span><span class="p">:</span>
        <span class="n">drawPoly</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawPolygon</span>
        <span class="n">dashPattern</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">zbase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># A basis</span>
          <span class="k">if</span> <span class="n">zstep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># dashed line</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DotLine</span><span class="p">)</span>
            <span class="n">pen</span><span class="o">.</span><span class="n">setDashPattern</span><span class="p">(</span><span class="n">dashPattern</span><span class="p">)</span>
            <span class="n">pen</span><span class="o">.</span><span class="n">setCapStyle</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FlatCap</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>

            <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span>
                     <span class="n">QPointF</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))</span>

          <span class="k">else</span><span class="p">:</span> <span class="c1">#</span>
            <span class="c1"># solid triangle, points at B</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">+</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">+</span><span class="n">yg</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">-</span><span class="n">yg</span><span class="p">)</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>

            <span class="n">drawPoly</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># B basis</span>
          <span class="k">if</span> <span class="n">zstep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># dashed line</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DotLine</span><span class="p">)</span>
            <span class="n">pen</span><span class="o">.</span><span class="n">setDashPattern</span><span class="p">(</span><span class="n">dashPattern</span><span class="p">)</span>
            <span class="n">pen</span><span class="o">.</span><span class="n">setCapStyle</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FlatCap</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>

            <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span>
                     <span class="n">QPointF</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))</span>

          <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solid triangle, points at A</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span> <span class="n">xg</span><span class="p">,</span>  <span class="n">yg</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="o">-</span><span class="n">yg</span><span class="p">)</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>

            <span class="n">drawPoly</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span>
                 <span class="n">QPointF</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;dative&#39;</span><span class="p">:</span>
        <span class="n">drawPoly</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">drawPolygon</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">)</span>
        <span class="n">pen</span><span class="o">.</span><span class="n">setJoinStyle</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">RoundJoin</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
          <span class="n">xc</span> <span class="o">=</span> <span class="n">dx</span><span class="o">-</span><span class="n">xindent</span>
          <span class="n">yc</span> <span class="o">=</span> <span class="n">dy</span><span class="o">-</span><span class="n">yindent</span>
          <span class="n">p1</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="o">-</span><span class="n">xindent</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">xg</span><span class="p">,</span> <span class="n">yc</span><span class="o">-</span><span class="n">yindent</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">yg</span><span class="p">)</span>
          <span class="n">p2</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="o">-</span><span class="n">xindent</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">xg</span><span class="p">,</span> <span class="n">yc</span><span class="o">-</span><span class="n">yindent</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">yg</span><span class="p">)</span>
          <span class="n">p3</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="n">xc</span> <span class="o">=</span> <span class="n">xindent</span>
          <span class="n">yc</span> <span class="o">=</span> <span class="n">yindent</span>
          <span class="n">p1</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xindent</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">xg</span><span class="p">,</span> <span class="n">yc</span><span class="o">+</span><span class="n">yindent</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">yg</span><span class="p">)</span>
          <span class="n">p2</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xindent</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">xg</span><span class="p">,</span> <span class="n">yc</span><span class="o">+</span><span class="n">yindent</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">yg</span><span class="p">)</span>
          <span class="n">p3</span> <span class="o">=</span> <span class="n">QPointF</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">)</span>

        <span class="n">drawPoly</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>

      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span> <span class="n">xg</span><span class="p">,</span>  <span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">+</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">+</span><span class="n">yg</span><span class="p">))</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="o">-</span><span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">-</span><span class="n">yg</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;singleplanar&#39;</span><span class="p">:</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span><span class="p">:</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
      <span class="n">xg</span> <span class="o">*=</span> <span class="mf">2.0</span>
      <span class="n">yg</span> <span class="o">*=</span> <span class="mf">2.0</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span> <span class="n">xg</span><span class="p">,</span>  <span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">+</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">+</span><span class="n">yg</span><span class="p">))</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="o">-</span><span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">-</span><span class="n">yg</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;quadruple&#39;</span><span class="p">:</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span> <span class="n">xg</span><span class="p">,</span>  <span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">+</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">+</span><span class="n">yg</span><span class="p">))</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="o">-</span><span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">-</span><span class="n">yg</span><span class="p">))</span>
      <span class="n">xg</span> <span class="o">*=</span> <span class="mf">3.0</span>
      <span class="n">yg</span> <span class="o">*=</span> <span class="mf">3.0</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span> <span class="n">xg</span><span class="p">,</span>  <span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">+</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">+</span><span class="n">yg</span><span class="p">))</span>
      <span class="n">drawLine</span><span class="p">(</span><span class="n">QPointF</span><span class="p">(</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="o">-</span><span class="n">yg</span><span class="p">),</span>
               <span class="n">QPointF</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">xg</span><span class="p">,</span> <span class="n">dy</span><span class="o">-</span><span class="n">yg</span><span class="p">))</span></div></div>



  <span class="c1"># Smiles</span>


<span class="n">organicAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;Cl&quot;</span><span class="p">,</span> <span class="s2">&quot;Br&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">])</span>
<span class="n">cnos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="importSmiles"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.importSmiles">[docs]</a><span class="k">def</span> <span class="nf">importSmiles</span><span class="p">(</span><span class="n">smilesString</span><span class="p">,</span> <span class="n">compoundName</span><span class="o">=</span><span class="s1">&#39;Unnamed&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

  <span class="n">compound</span> <span class="o">=</span> <span class="n">Compound</span><span class="p">(</span><span class="n">compoundName</span><span class="p">)</span>
  <span class="n">var</span> <span class="o">=</span> <span class="n">Variant</span><span class="p">(</span><span class="n">compound</span><span class="p">)</span>
  <span class="n">compound</span><span class="o">.</span><span class="n">defaultVars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

  <span class="n">aromatics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="n">exludeHydrogens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="n">rings</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">branch</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">chirals</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">_addStereo</span><span class="p">(</span><span class="n">varAtom1</span><span class="p">,</span> <span class="n">varAtom2</span><span class="p">):</span>

    <span class="n">varAtom1</span><span class="o">.</span><span class="n">stereo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varAtom2</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtom1</span><span class="o">.</span><span class="n">stereo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">chirals</span><span class="p">[</span><span class="n">varAtom1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">varAtom1</span><span class="o">.</span><span class="n">stereo</span>
        <span class="n">varAtom1</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>

      <span class="c1"># del chirals[varAtom1]</span>

  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smilesString</span><span class="p">)</span>

  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">hIndex</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
  <span class="n">configList</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">lastDouble</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">addOrder</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
    <span class="n">element</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chiral</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">numH</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">isAromatic</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">prev</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">coords</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">char</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">continue</span>

    <span class="k">if</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">organicAtoms</span><span class="p">:</span>
      <span class="n">element</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">char</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">organicAtoms</span><span class="p">:</span>
      <span class="n">element</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">element</span> <span class="ow">in</span> <span class="n">cnos</span><span class="p">)</span> <span class="ow">and</span>  <span class="n">char</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
        <span class="n">isAromatic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>

      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">while</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> <span class="c1"># isotope label</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="n">element</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">element</span> <span class="ow">in</span> <span class="n">cnos</span><span class="p">)</span> <span class="ow">and</span>  <span class="n">char</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
        <span class="n">isAromatic</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">chiral</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">chiral</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;H+-]&#39;</span><span class="p">:</span>
        <span class="n">element</span> <span class="o">+=</span> <span class="n">char</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">numH</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
          <span class="n">numH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
          <span class="n">charge</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
          <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


      <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>

        <span class="k">while</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
          <span class="n">charge</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
          <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
      <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;double&#39;</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
      <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;triple&#39;</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
      <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;aromatic&#39;</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
      <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>

    <span class="k">elif</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>

      <span class="k">if</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">ringKey</span> <span class="o">=</span> <span class="n">char</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ringKey</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">while</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
          <span class="n">ringKey</span> <span class="o">+=</span> <span class="n">char</span>

          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">smilesString</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">ringKey</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
        <span class="n">varAtomB</span><span class="p">,</span> <span class="n">bondTypeB</span> <span class="o">=</span> <span class="n">rings</span><span class="p">[</span><span class="n">ringKey</span><span class="p">]</span>
        <span class="n">Bond</span><span class="p">((</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">prev</span><span class="p">),</span>  <span class="n">bondTypeB</span><span class="p">,</span>  <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bondTypeB</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
          <span class="n">lastDouble</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prev</span> <span class="ow">in</span> <span class="n">chirals</span><span class="p">:</span>
          <span class="n">_addStereo</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">varAtomB</span> <span class="ow">in</span> <span class="n">chirals</span><span class="p">:</span>
          <span class="n">_addStereo</span><span class="p">(</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>

        <span class="n">var</span><span class="o">.</span><span class="n">minimise2d</span><span class="p">(</span><span class="n">maxCycles</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ringKey</span> <span class="ow">in</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">stereo</span><span class="p">:</span>
          <span class="n">index</span> <span class="o">=</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">stereo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ringKey</span><span class="p">)</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span>

        <span class="k">if</span> <span class="n">ringKey</span> <span class="ow">in</span> <span class="n">prev</span><span class="o">.</span><span class="n">stereo</span><span class="p">:</span>
          <span class="n">index</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">stereo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ringKey</span><span class="p">)</span>
          <span class="n">prev</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">varAtomB</span>

        <span class="k">del</span> <span class="n">rings</span><span class="p">[</span><span class="n">ringKey</span><span class="p">]</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">rings</span><span class="p">[</span><span class="n">ringKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span><span class="p">,</span> <span class="n">bondType</span>

        <span class="k">if</span> <span class="n">prev</span> <span class="ow">in</span> <span class="n">chirals</span><span class="p">:</span>
          <span class="n">_addStereo</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">ringKey</span><span class="p">)</span>

      <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
      <span class="n">branch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">branch</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">branch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
      <span class="n">configList</span> <span class="o">+=</span> <span class="n">char</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span>
      <span class="n">configList</span> <span class="o">+=</span> <span class="n">char</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
      <span class="c1"># TBD proper coordinate-based, clock or anti</span>
      <span class="n">prev</span><span class="o">.</span><span class="n">setChirality</span><span class="p">(</span><span class="s1">&#39;RS&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
      <span class="n">bondType</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
      <span class="n">bondType</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">element</span><span class="p">:</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

      <span class="n">angle</span> <span class="o">=</span> <span class="mf">1.57</span>
      <span class="k">if</span> <span class="n">prev</span><span class="p">:</span>
        <span class="n">prev</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
        <span class="n">freeValences</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">freeValences</span>

        <span class="k">if</span> <span class="n">freeValences</span><span class="p">:</span>
          <span class="n">numVal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freeValences</span><span class="p">)</span>
          <span class="n">m</span> <span class="o">=</span> <span class="n">numVal</span><span class="o">//</span><span class="mi">2</span>

          <span class="k">if</span> <span class="n">numVal</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle1</span> <span class="o">=</span> <span class="n">freeValences</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">angle2</span> <span class="o">=</span> <span class="n">freeValences</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">angle1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle2</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">angle1</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle2</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

          <span class="k">else</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">freeValences</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

      <span class="n">x</span> <span class="o">+=</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
      <span class="n">y</span> <span class="o">+=</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

      <span class="n">varAtom</span> <span class="o">=</span> <span class="n">VarAtom</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>  <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
      <span class="n">addOrder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varAtom</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">chiral</span><span class="p">:</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">prev</span><span class="p">,]</span>
        <span class="n">chirals</span><span class="p">[</span><span class="n">varAtom</span><span class="p">]</span> <span class="o">=</span> <span class="n">chiral</span>

      <span class="k">if</span> <span class="n">isAromatic</span><span class="p">:</span>
        <span class="n">aromatics</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">varAtom</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">numH</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numH</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">angles</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mf">0.0</span>

          <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
          <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

          <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;H</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hIndex</span>
          <span class="n">hIndex</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">masterAtom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
          <span class="n">varAtomH</span> <span class="o">=</span> <span class="n">VarAtom</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">masterAtom</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
          <span class="n">Bond</span><span class="p">((</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">varAtomH</span><span class="p">),</span>  <span class="s1">&#39;single&#39;</span><span class="p">,</span>  <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">chirals</span><span class="p">:</span>
            <span class="n">_addStereo</span><span class="p">(</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">varAtomH</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">numH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exludeHydrogens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">varAtom</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">prev</span> <span class="ow">and</span> <span class="n">bondType</span><span class="p">:</span>
        <span class="n">Bond</span><span class="p">((</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">prev</span><span class="p">),</span>  <span class="n">bondType</span><span class="p">,</span>  <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
          <span class="n">lastDouble</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">)</span>

        <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        <span class="n">prev</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>

      <span class="k">for</span> <span class="n">varAtomB</span> <span class="ow">in</span> <span class="n">chirals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">varAtomB</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
          <span class="n">_addStereo</span><span class="p">(</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">lastDouble</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">configList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">configList</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">lastDouble</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">coords</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>

        <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">da</span> <span class="o">=</span> <span class="mf">1.57</span>
        <span class="n">nudge</span> <span class="o">=</span> <span class="mf">30.0</span>

        <span class="k">if</span> <span class="n">config</span> <span class="o">==</span> <span class="s1">&#39;/</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span>
          <span class="n">x3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">da</span><span class="p">)</span>
          <span class="n">y3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">da</span><span class="p">)</span>

          <span class="n">x1</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">x2</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">y1</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">y2</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">varAtomA</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span>

        <span class="k">elif</span> <span class="n">config</span> <span class="o">==</span> <span class="s1">&#39;//&#39;</span><span class="p">:</span>
          <span class="n">x3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">da</span><span class="p">)</span>
          <span class="n">y3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">da</span><span class="p">)</span>

          <span class="n">x1</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">y1</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">varAtomA</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span>

          <span class="n">x3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">da</span><span class="p">)</span>
          <span class="n">y3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">da</span><span class="p">)</span>

          <span class="n">x2</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">y2</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span>

        <span class="k">elif</span> <span class="n">config</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">:</span>

          <span class="n">x3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">da</span><span class="p">)</span>
          <span class="n">y3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">da</span><span class="p">)</span>

          <span class="n">x1</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">y1</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">varAtomA</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span>

          <span class="n">x3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">da</span><span class="p">)</span>
          <span class="n">y3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">da</span><span class="p">)</span>

          <span class="n">x2</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">y2</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span>

        <span class="k">elif</span> <span class="n">config</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">/&#39;</span><span class="p">:</span>
          <span class="n">x3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">da</span><span class="p">)</span>
          <span class="n">y3</span> <span class="o">=</span> <span class="n">nudge</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">da</span><span class="p">)</span>

          <span class="n">x1</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">x2</span> <span class="o">+=</span> <span class="n">x3</span>
          <span class="n">y1</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">y2</span> <span class="o">+=</span> <span class="n">y3</span>
          <span class="n">varAtomA</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span>

        <span class="n">lastDouble</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="n">prev</span> <span class="o">=</span> <span class="n">varAtom</span>


    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="c1"># set aromatics</span>

  <span class="k">if</span> <span class="n">aromatics</span><span class="p">:</span>
    <span class="n">rings</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getRings</span><span class="p">(</span><span class="n">aromatics</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">varAtoms2</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">varAtoms2</span> <span class="o">&amp;</span> <span class="n">aromatics</span> <span class="o">==</span> <span class="n">varAtoms2</span><span class="p">:</span>
        <span class="n">varAtoms3</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">addOrder</span> <span class="k">if</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtoms2</span><span class="p">]</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getCentroid</span><span class="p">(</span><span class="n">varAtoms3</span><span class="p">)</span>
        <span class="n">dAngle</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varAtoms3</span><span class="p">))</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">va</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varAtoms3</span><span class="p">):</span>
          <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
          <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
          <span class="n">va</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
          <span class="n">angle</span> <span class="o">+=</span> <span class="n">dAngle</span>

        <span class="n">AtomGroup</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="n">varAtoms2</span><span class="p">,</span> <span class="n">AROMATIC</span><span class="p">)</span>
        <span class="n">var</span><span class="o">.</span><span class="n">minimise2d</span><span class="p">(</span><span class="n">varAtoms2</span><span class="p">,</span> <span class="n">maxCycles</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>


  <span class="c1"># add H</span>
  <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnos</span><span class="p">:</span>
      <span class="k">continue</span>

    <span class="k">if</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">exludeHydrogens</span><span class="p">:</span>
      <span class="k">continue</span>

    <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
    <span class="n">newAtoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

    <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">):</span>
      <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">34.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
      <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">34.0</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;H</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hIndex</span>
      <span class="n">hIndex</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="n">masterAtom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">hydrogen</span> <span class="o">=</span> <span class="n">VarAtom</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">masterAtom</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
      <span class="n">Bond</span><span class="p">((</span><span class="n">hydrogen</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">),</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


  <span class="n">compound</span><span class="o">.</span><span class="n">center</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">))</span>
  <span class="n">var</span><span class="o">.</span><span class="n">minimise2d</span><span class="p">(</span><span class="n">maxCycles</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
  <span class="n">var</span><span class="o">.</span><span class="n">minimise3d</span><span class="p">(</span><span class="n">maxCycles</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
  <span class="n">var</span><span class="o">.</span><span class="n">minimise2d</span><span class="p">(</span><span class="n">maxCycles</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
  <span class="n">var</span><span class="o">.</span><span class="n">checkBaseValences</span><span class="p">()</span>
  <span class="c1">#var.shuffleStereo()</span>
  <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newNmrChain</span><span class="p">(</span><span class="n">compoundName</span><span class="p">)</span>
      <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">newNmrResidue</span><span class="p">(</span><span class="n">compoundName</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">fetchNmrAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">nmrAtom</span><span class="o">.</span><span class="n">_compoundViewAtom</span> <span class="o">=</span> <span class="n">atom</span>
      <span class="n">nmrResidue</span><span class="o">.</span><span class="n">_compoundViewCompound</span> <span class="o">=</span> <span class="n">compound</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">compound</span></div>

<div class="viewcode-block" id="setCompound"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.setCompound">[docs]</a><span class="k">def</span> <span class="nf">setCompound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Set the compound on the graphic scene. &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">compound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="p">:</span>

      <span class="k">if</span> <span class="n">replace</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">compound</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variants</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">variant2</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">variant2</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">variant2</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">==</span> <span class="s1">&#39;neutral&#39;</span><span class="p">):</span>
              <span class="n">variant</span> <span class="o">=</span> <span class="n">variant2</span>
              <span class="k">break</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variant2</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">variant2</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">variant</span> <span class="o">=</span> <span class="n">variant2</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">variant</span> <span class="o">=</span> <span class="n">variants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">variant</span> <span class="o">=</span>  <span class="n">Variant</span><span class="p">(</span><span class="n">compound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">centerView</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">resetView</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">variant</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAddPoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">copyVarAtoms</span><span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">centerView</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">resetView</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">centerView</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">resetView</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span></div>



<div class="viewcode-block" id="VarAtom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom">[docs]</a><span class="k">class</span> <span class="nc">VarAtom</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variantA</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">freeValences</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">chirality</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">isLabile</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">variantA</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># Means all vars</span>
      <span class="n">variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>
      <span class="n">variant</span> <span class="o">=</span> <span class="n">variants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">otherVars</span> <span class="o">=</span> <span class="n">variants</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">variant</span> <span class="o">=</span> <span class="n">variantA</span>
      <span class="n">otherVars</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isVariable</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">isVariable</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">compound</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isLabile</span> <span class="o">=</span> <span class="n">isLabile</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomGroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">elementDict</span><span class="p">:</span>
      <span class="n">variant</span><span class="o">.</span><span class="n">elementDict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">variant</span><span class="o">.</span><span class="n">elementDict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">variant</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">freeValences</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">freeValences</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">updateNeighbours</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">otherVars</span><span class="p">:</span>
      <span class="n">VarAtom</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">freeValences</span><span class="p">,</span> <span class="n">chirality</span><span class="p">,</span>
              <span class="n">coords</span><span class="p">,</span>  <span class="n">isLabile</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span>

      <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>

    <span class="n">variant</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">isVariable</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">aName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;VarAtom </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aName</span><span class="p">)</span>

<div class="viewcode-block" id="VarAtom.setStereo"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setStereo">[docs]</a>  <span class="k">def</span> <span class="nf">setStereo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stereoVarAtoms</span><span class="p">):</span>
    <span class="c1"># Clockwise rule relative to first</span>

    <span class="n">nStereo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nStereo</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
      <span class="n">stereoVarAtoms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">stereoVarAtoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">stereoVarAtoms</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">):</span>
        <span class="c1"># print &quot;Attempt to set stereo set to non-neighbours&quot;</span>
        <span class="k">return</span>

    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nStereo</span><span class="p">:</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">elif</span> <span class="n">varAtom</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereoVarAtoms</span>

      <span class="k">else</span><span class="p">:</span> <span class="c1"># all vars same, as far as possible, respecting a/b forms</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">variant</span>
        <span class="n">stereoVarAtoms2</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">stereoVarAtoms</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">stereoVarAtoms2</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stereoVarAtoms2</span><span class="p">)</span> <span class="o">==</span> <span class="n">nStereo</span><span class="p">:</span>
          <span class="n">stereo</span> <span class="o">=</span> <span class="n">stereoVarAtoms2</span>

          <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">chirality</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirality</span><span class="p">:</span>
            <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereo</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">rest</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,]</span> <span class="o">+</span> <span class="n">rest</span></div>

<div class="viewcode-block" id="VarAtom.toggleAromatic"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.toggleAromatic">[docs]</a>  <span class="k">def</span> <span class="nf">toggleAromatic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAromatic</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">unsetAromatic</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">,])</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">setAromatic</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">,])</span></div>

<div class="viewcode-block" id="VarAtom.isHydrogen"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.isHydrogen">[docs]</a>  <span class="k">def</span> <span class="nf">isHydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span></div>

<div class="viewcode-block" id="VarAtom.isAromatic"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.isAromatic">[docs]</a>  <span class="k">def</span> <span class="nf">isAromatic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="VarAtom.getRings"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getRings">[docs]</a>  <span class="k">def</span> <span class="nf">getRings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rings</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>

      <span class="n">prev</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">prevSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>

      <span class="n">nextAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">va</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">prev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">va</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">prev</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nextAtoms</span><span class="p">:</span>
        <span class="n">nextAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">nextAtoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">isAromatic</span><span class="p">:</span>
              <span class="k">continue</span>

        <span class="k">if</span> <span class="n">varAtom</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
          <span class="n">rings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">varAtom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prevSet</span><span class="p">:</span>
          <span class="n">nextSet</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">varAtom</span><span class="p">,]</span>
          <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextSet</span><span class="p">)</span>

    <span class="n">filteredRings</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rings</span><span class="p">:</span>
      <span class="n">rings</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ring</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span>
      <span class="n">minSz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">minRing</span> <span class="o">=</span> <span class="n">rings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">filteredRings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">minRing</span><span class="p">)</span>

      <span class="n">uniqueAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">ring</span>
        <span class="k">for</span> <span class="n">ring2</span> <span class="ow">in</span> <span class="n">filteredRings</span><span class="p">:</span>
          <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span> <span class="o">-</span> <span class="n">ring2</span>
          <span class="n">nUnique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nUnique</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">unique</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uniqueAtoms</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">ua</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ua</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
              <span class="k">break</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
          <span class="n">uniqueAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
          <span class="n">filteredRings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>

<span class="c1">#      for ring in rings:</span>
<span class="c1">#        if len(ring) &lt; minSz+2:</span>
<span class="c1">#        filteredRings.add(ring)</span>

    <span class="k">return</span> <span class="n">filteredRings</span></div>


<div class="viewcode-block" id="VarAtom.setLabile"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setLabile">[docs]</a>  <span class="k">def</span> <span class="nf">setLabile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isLabile</span> <span class="o">!=</span> <span class="n">value</span><span class="p">):</span>
      <span class="n">neighbourhood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span>

      <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
      <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="c1"># Set as labile only if the neighbours are the same as this var atom&#39;s</span>
      <span class="c1"># automatically includes its self</span>

      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">varAtom</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">neighbourhoodB</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">neighbourhoodB</span><span class="o">!=</span> <span class="n">neighbourhood</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">varAtom</span><span class="o">.</span><span class="n">isLabile</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="VarAtom.setCoords"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setCoords">[docs]</a>  <span class="k">def</span> <span class="nf">setCoords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>

    <span class="c1"># Compound wide for now</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="VarAtom.setName"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setName">[docs]</a>  <span class="k">def</span> <span class="nf">setName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="VarAtom.setChirality"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setChirality">[docs]</a>  <span class="k">def</span> <span class="nf">setChirality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chirality</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">variant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span>
    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">chirality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">nVal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
      <span class="n">nNei</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">nVal</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">chirality</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">if</span> <span class="n">nVal</span> <span class="o">&gt;</span> <span class="n">nNei</span><span class="p">:</span>
        <span class="n">chirality</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">chirality</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">autoVar</span><span class="p">:</span>
      <span class="n">variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>
      <span class="n">variants</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>
      <span class="n">variants</span> <span class="o">=</span> <span class="p">[</span><span class="n">variant</span><span class="p">,]</span> <span class="o">+</span> <span class="n">variants</span>
      <span class="c1"># this one must be first - so it is not deleted</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">variants</span> <span class="o">=</span> <span class="p">[</span><span class="n">variant</span><span class="p">,]</span>

    <span class="k">if</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="n">varAtom</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span>

      <span class="n">varDict</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varDict</span><span class="p">:</span>
          <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">varDict</span><span class="p">:</span>
        <span class="n">vars2</span> <span class="o">=</span> <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">var</span> <span class="o">=</span> <span class="n">vars2</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="n">var</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>

      <span class="n">varDict</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varDict</span><span class="p">:</span>
          <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">varDict</span><span class="p">:</span>
        <span class="n">vars2</span> <span class="o">=</span> <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">var</span> <span class="o">=</span> <span class="n">vars2</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="n">var</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">var</span> <span class="o">=</span> <span class="n">Variant</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="n">vars2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
          <span class="n">vars2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
          <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="n">varA</span><span class="p">,</span> <span class="n">varB</span> <span class="o">=</span> <span class="n">vars2</span>

        <span class="k">if</span> <span class="n">variant</span> <span class="ow">is</span> <span class="n">varA</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">chirality</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">varA</span><span class="p">,</span> <span class="n">varB</span> <span class="o">=</span> <span class="n">varB</span><span class="p">,</span> <span class="n">varA</span>

        <span class="k">elif</span> <span class="n">variant</span> <span class="ow">is</span> <span class="n">varB</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">chirality</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">varA</span><span class="p">,</span> <span class="n">varB</span> <span class="o">=</span> <span class="n">varB</span><span class="p">,</span> <span class="n">varA</span>

        <span class="n">varAtomA</span> <span class="o">=</span> <span class="n">varA</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
        <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">varB</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>

        <span class="n">varAtomA</span><span class="o">.</span><span class="n">chirality</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="n">varAtomB</span><span class="o">.</span><span class="n">chirality</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span><span class="p">:</span>
          <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span>

          <span class="k">if</span> <span class="n">chirality</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">stereoA</span> <span class="o">=</span> <span class="p">[</span><span class="n">varA</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">]]</span>
            <span class="n">stereoB</span> <span class="o">=</span> <span class="p">[</span><span class="n">varB</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">]]</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">stereoA</span> <span class="o">=</span> <span class="p">[</span><span class="n">varA</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">]]</span>
            <span class="n">stereoB</span> <span class="o">=</span> <span class="p">[</span><span class="n">varB</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">]</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">]]</span>

          <span class="n">varAtomA</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereoA</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereoB</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">chirality</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="n">varAtom</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="n">varDict</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varDict</span><span class="p">:</span>
          <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">varDict</span><span class="p">:</span>
        <span class="n">vars2</span> <span class="o">=</span> <span class="n">varDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">var</span> <span class="o">=</span> <span class="n">vars2</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="n">var</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="c1"># Once all set</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span></div>

<div class="viewcode-block" id="VarAtom.getContext"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getContext">[docs]</a>  <span class="k">def</span> <span class="nf">getContext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1"># Get all of the (master) atoms surrounding this one</span>

    <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">])</span></div>

<div class="viewcode-block" id="VarAtom.setCharge"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setCharge">[docs]</a>  <span class="k">def</span> <span class="nf">setCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>
    <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">defaultVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">baseValences</span>

    <span class="n">neighbourhood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">autoVar</span><span class="p">:</span>
      <span class="n">variants</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">variants</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">variants</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="p">,]</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
      <span class="n">varAtom</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">neighbourhood</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">nVal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">COVALENT_ELEMENTS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">charge</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">nVal</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span>
        <span class="n">targetVal</span> <span class="o">=</span> <span class="n">defaultVal</span><span class="o">+</span><span class="n">charge</span>

      <span class="k">elif</span> <span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="n">COVALENT_ELEMENTS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">targetVal</span> <span class="o">=</span> <span class="n">defaultVal</span><span class="o">+</span><span class="n">charge</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">targetVal</span> <span class="o">=</span> <span class="n">defaultVal</span>

      <span class="c1"># add any extra</span>
      <span class="k">while</span> <span class="n">nVal</span> <span class="o">&lt;</span> <span class="n">targetVal</span><span class="p">:</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">nVal</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="c1"># remove exess unbound</span>
      <span class="k">while</span> <span class="n">nVal</span> <span class="o">&gt;</span> <span class="n">targetVal</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="n">nVal</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">break</span>

      <span class="c1"># otherwise remove extra H</span>
      <span class="k">if</span> <span class="n">nVal</span> <span class="o">&gt;</span> <span class="n">targetVal</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
          <span class="n">atomA</span><span class="p">,</span> <span class="n">atomB</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">atomA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">atomA</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">):</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">nVal</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">atomB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">atomB</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">):</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">nVal</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">atomA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">atomA</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">):</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">nVal</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">atomB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">atomB</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">):</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">nVal</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="n">nVal</span> <span class="o">==</span> <span class="n">targetVal</span><span class="p">:</span>
            <span class="k">break</span>

      <span class="c1"># otherwise remove anything</span>
      <span class="k">if</span> <span class="n">nVal</span> <span class="o">&gt;</span> <span class="n">targetVal</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
          <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
          <span class="n">nVal</span> <span class="o">-=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="n">nVal</span> <span class="o">==</span> <span class="n">targetVal</span><span class="p">:</span>
            <span class="k">break</span>

      <span class="n">varAtom</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

      <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span></div>

<div class="viewcode-block" id="VarAtom.getBondAngles"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getBondAngles">[docs]</a>  <span class="k">def</span> <span class="nf">getBondAngles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
      <span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
      <span class="n">varAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="n">varAtom</span> <span class="o">=</span> <span class="n">varAtoms</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

      <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

      <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>

      <span class="n">angle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>
      <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">angles</span></div>

<div class="viewcode-block" id="VarAtom.getBondAngle"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getBondAngle">[docs]</a>  <span class="k">def</span> <span class="nf">getBondAngle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">):</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>

    <span class="n">angle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">angle</span></div>

<div class="viewcode-block" id="VarAtom.getBondToAtom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getBondToAtom">[docs]</a>  <span class="k">def</span> <span class="nf">getBondToAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span> <span class="ow">and</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bond</span>

    <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="VarAtom.getAtomDist"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getAtomDist">[docs]</a>  <span class="k">def</span> <span class="nf">getAtomDist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">):</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>

    <span class="k">return</span> <span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span></div>

<div class="viewcode-block" id="VarAtom.setVariable"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.setVariable">[docs]</a>  <span class="k">def</span> <span class="nf">setVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setVariable</span><span class="p">(</span><span class="n">boolean</span><span class="p">)</span></div>

<div class="viewcode-block" id="VarAtom.updateValences"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.updateValences">[docs]</a>  <span class="k">def</span> <span class="nf">updateValences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">defaultVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">baseValences</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">defaultVal</span><span class="p">:</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="o">/</span><span class="n">defaultVal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="o">=</span> <span class="p">[</span><span class="n">gap</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">defaultVal</span><span class="p">)]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBondAngles</span><span class="p">()</span>

      <span class="n">numVal</span> <span class="o">=</span> <span class="n">defaultVal</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">numVal</span> <span class="o">-=</span> <span class="n">BOND_TYPE_VALENCES</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span><span class="p">]</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="ow">in</span> <span class="n">COVALENT_ELEMENTS</span><span class="p">:</span>
        <span class="n">numVal</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span>

      <span class="k">if</span> <span class="n">numVal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAromatic</span><span class="p">():</span>
        <span class="n">numVal</span> <span class="o">-=</span> <span class="mi">1</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numVal</span>

      <span class="k">if</span> <span class="n">bound</span><span class="p">:</span>
        <span class="n">bound</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">bound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span>
        <span class="n">gaps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bound</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">bound</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bound</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">gaps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numVal</span><span class="p">):</span>
          <span class="n">size</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">gaps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
          <span class="n">sizeB</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span>

          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">sizeB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">begin</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>

          <span class="n">gaps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizeB</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
          <span class="n">gaps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">PI</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freeValences</span> <span class="o">=</span> <span class="p">[</span><span class="n">gap</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numVal</span><span class="p">)]</span></div>


<div class="viewcode-block" id="VarAtom.updateNeighbours"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.updateNeighbours">[docs]</a>  <span class="k">def</span> <span class="nf">updateNeighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
      <span class="n">atoms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">!=</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
      <span class="n">changed</span> <span class="o">=</span> <span class="n">atoms</span> <span class="o">^</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
          <span class="n">atom</span><span class="o">.</span><span class="n">setLabile</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>

          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
              <span class="n">h</span><span class="o">.</span><span class="n">setLabile</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
              <span class="n">h</span><span class="o">.</span><span class="n">setLabile</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>


      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hydrogens</span><span class="p">:</span>
        <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">unsetAtomsProchiral</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">unsetAtomsEquivalent</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">setAtomsProchiral</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">setAtomsEquivalent</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">=</span> <span class="n">atoms</span></div>

<div class="viewcode-block" id="VarAtom.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">variant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span>
    <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>

    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
      <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">elementDict</span><span class="p">:</span>
      <span class="n">variant</span><span class="o">.</span><span class="n">elementDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">variant</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
    <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Remove any vars that have identical atoms</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">,</span> <span class="n">va</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="n">variant</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">atoms2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span><span class="p">,</span> <span class="n">va</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">atoms2</span> <span class="o">==</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">):</span>
      <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">variant</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

  <span class="c1"># Snap the atom to one of the specified angles. The angle is chosen based on collisions with already placed atoms.</span>
<div class="viewcode-block" id="VarAtom.snapToGrid"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.snapToGrid">[docs]</a>  <span class="k">def</span> <span class="nf">snapToGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prevAtom</span><span class="p">,</span> <span class="n">bondLength</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span> <span class="n">prevAngle</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">remainingAtoms</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">ignoreHydrogens</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>

    <span class="n">prevX</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">prevY</span> <span class="o">=</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">oldX</span><span class="p">,</span> <span class="n">oldY</span><span class="p">,</span> <span class="n">oldZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prevAngle</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">prevAngle</span> <span class="o">=</span> <span class="mi">210</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)):</span>
      <span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">radians</span><span class="p">((</span><span class="n">prevAngle</span> <span class="o">+</span> <span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span>

    <span class="n">minD</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">minI</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">minPen</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">allAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">remainingAtoms</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">prevX</span> <span class="o">+</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">prevY</span> <span class="o">+</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
      <span class="n">pen</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">allAtoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span> <span class="o">==</span> <span class="bp">self</span> <span class="ow">or</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ignoreHydrogens</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">):</span>
          <span class="k">continue</span>
        <span class="n">atomDist</span> <span class="o">=</span> <span class="n">hypot</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span> <span class="o">-</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">atomDist</span> <span class="o">&lt;</span> <span class="n">bondLength</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atomDist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pen</span> <span class="o">*=</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="n">atomDist</span> <span class="o">&lt;</span> <span class="mf">0.000001</span><span class="p">:</span>
              <span class="n">atomDist</span> <span class="o">=</span> <span class="mf">0.000001</span>
          <span class="n">pen</span> <span class="o">*=</span> <span class="mi">2</span><span class="o">*</span><span class="n">bondLength</span><span class="o">/</span><span class="n">atomDist</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">minPen</span> <span class="ow">or</span> <span class="n">pen</span> <span class="o">&lt;</span> <span class="n">minPen</span><span class="p">:</span>
        <span class="n">minPen</span> <span class="o">=</span> <span class="n">pen</span>
        <span class="n">minI</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">bestX</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">bestY</span> <span class="o">=</span> <span class="n">y</span>
      <span class="k">if</span> <span class="n">pen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">bestX</span><span class="p">,</span> <span class="n">bestY</span><span class="p">,</span> <span class="n">oldZ</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">degrees</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">minI</span><span class="p">])</span></div>

<div class="viewcode-block" id="VarAtom.getPreferredBondAngles"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getPreferredBondAngles">[docs]</a>  <span class="k">def</span> <span class="nf">getPreferredBondAngles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">neighbours</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ignoredAtoms</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">ignoreHydrogens</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">bonds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span>
    <span class="n">nBonds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ringAtoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nHydrogens</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">neighbours</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">nHydrogens</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">ignoreHydrogens</span><span class="p">:</span>
      <span class="n">nBonds</span> <span class="o">-=</span> <span class="n">nHydrogens</span>

    <span class="n">rings</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRings</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
        <span class="c1"># Hydrogens receive a special treatment.</span>
        <span class="c1">#if not ignoreHydrogens:</span>
          <span class="c1">#if nBonds == 4:</span>
            <span class="c1">#if nHydrogens == 2:</span>
              <span class="c1">#angles = [70, 160, -70, -160]</span>
            <span class="c1">#if nHydrogens == 1:</span>
              <span class="c1">#angles = [180]</span>
          <span class="c1">#return angles</span>
        <span class="n">ringSize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="n">ringAngle</span> <span class="o">=</span> <span class="p">((</span><span class="n">ringSize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="p">)</span><span class="o">/</span><span class="n">ringSize</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ringAngle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nBonds</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
          <span class="n">angle</span> <span class="o">/=</span> <span class="n">nBonds</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreHydrogens</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">360</span><span class="o">-</span><span class="n">angle</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">angle</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="p">]:</span>
            <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">angle</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">]:</span>
            <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">:</span>
          <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">angle</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">angles</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Triple bonds or two double bonds have a 180 degrees angle.</span>
      <span class="n">nDouble</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span><span class="p">:</span>
          <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">180</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
          <span class="n">nDouble</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">nDouble</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">):</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">180</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">prevAngle</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">prevAngle</span> <span class="o">&lt;</span> <span class="mi">180</span> <span class="ow">or</span> <span class="mi">270</span> <span class="o">&lt;=</span> <span class="n">prevAngle</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)):</span>
        <span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">nBonds</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">neighbourAngles</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">ignoredAtoms</span><span class="p">:</span><span class="c1"># and (not ignoreHydrogens or neighbour.element != &#39;H&#39;):</span>
          <span class="n">neighbourAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
          <span class="n">neighbourAngle</span> <span class="o">-=</span> <span class="n">prevAngle</span>
          <span class="n">neighbourAngles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbourAngle</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">nBonds</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbourAngles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">67.5</span><span class="p">,</span> <span class="mf">172.5</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mf">67.5</span><span class="p">,</span> <span class="mf">172.5</span><span class="p">]</span>
      <span class="k">elif</span> <span class="n">nBonds</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nBonds</span><span class="p">):</span>
          <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">360</span><span class="o">/</span><span class="n">nBonds</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">neighbourAngle</span> <span class="ow">in</span> <span class="n">neighbourAngles</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">neighbourAngle</span><span class="o">-</span><span class="mi">120</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">neighbourAngle</span><span class="o">+</span><span class="mi">240</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)):</span>
            <span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
          <span class="k">break</span>

    <span class="k">return</span> <span class="n">angles</span></div>

<div class="viewcode-block" id="VarAtom.findAtomsInBranch"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.findAtomsInBranch">[docs]</a>  <span class="k">def</span> <span class="nf">findAtomsInBranch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstAtomInBranch</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">firstAtomInBranch</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">temporarySelfAdd</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">temporarySelfAdd</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">firstAtomInBranch</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">neighbours</span><span class="p">:</span>
      <span class="n">neighbour</span> <span class="o">=</span> <span class="n">neighbours</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">neighbour</span> <span class="o">==</span> <span class="bp">self</span> <span class="ow">or</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="k">for</span> <span class="n">neighbour2</span> <span class="ow">in</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">neighbour2</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">neighbour2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neighbour2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">atoms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">neighbour</span><span class="o">.</span><span class="n">findAtomsInBranch</span><span class="p">(</span><span class="n">neighbour2</span><span class="p">,</span> <span class="n">atoms</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">temporarySelfAdd</span><span class="p">:</span>
      <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">atoms</span></div>

  <span class="c1"># Returns a list of atoms sorted by their respective branch lengths, shortest first.</span>
<div class="viewcode-block" id="VarAtom.getBranchesSortedByLength"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getBranchesSortedByLength">[docs]</a>  <span class="k">def</span> <span class="nf">getBranchesSortedByLength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">branchLens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
      <span class="n">branchLens</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findAtomsInBranch</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span> <span class="n">a</span><span class="p">])</span>
    <span class="n">branchLens</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branchLens</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">branches</span></div>

<div class="viewcode-block" id="VarAtom.atomInSameRing"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.atomInSameRing">[docs]</a>  <span class="k">def</span> <span class="nf">atomInSameRing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>

    <span class="n">selfRings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRings</span><span class="p">()</span>
    <span class="n">atomRings</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">getRings</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfRings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomRings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">atomRings</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">selfRings</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="VarAtom.snapRings"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.snapRings">[docs]</a>  <span class="k">def</span> <span class="nf">snapRings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rings</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">):</span>

    <span class="n">skippedAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
      <span class="k">for</span> <span class="n">ringAtom</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ringAtom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">ringAtom</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
            <span class="n">neighbours</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ringAtom</span><span class="p">)</span>
          <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ringAtom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">skippedAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ringAtom</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">ringAtom</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">prevAngle</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">snapRingToGrid</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">,</span> <span class="n">skippedAtoms</span><span class="p">)</span>
      <span class="n">skippedAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">ringAtom</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ringAtom</span> <span class="ow">in</span> <span class="n">skippedAtoms</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="n">ringAtomRings</span> <span class="o">=</span> <span class="n">ringAtom</span><span class="o">.</span><span class="n">getRings</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">ringAtomRings</span><span class="p">:</span>
          <span class="n">ringAtomRings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ringAtomRing</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">ringAtomRings</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ringAtomRing</span><span class="p">:</span>
              <span class="k">break</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">ringAtomRings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ringAtomRing</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ringAtomRings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">ringAtomRings</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ringAtomRings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ring</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
          <span class="n">ringAtomNeighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ringAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="n">ringAtom</span><span class="o">.</span><span class="n">snapRings</span><span class="p">(</span><span class="n">ringAtomRings</span><span class="p">,</span> <span class="n">ringAtomNeighbours</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">)</span></div>

<div class="viewcode-block" id="VarAtom.autoSetChirality"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.autoSetChirality">[docs]</a>  <span class="k">def</span> <span class="nf">autoSetChirality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">variants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span>
    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">stereo</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]:</span>
      <span class="k">return</span>

    <span class="n">chirality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStereochemistry</span><span class="p">()</span>
    <span class="c1"># Make the automatically set chirality lower case to be able to distinguish it from user specified chirality.</span>
    <span class="k">if</span> <span class="n">chirality</span><span class="p">:</span>
      <span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirality</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirality</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
      <span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBranchesSortedByLength</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">branches</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
      <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">branches</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">branches</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>

        <span class="k">if</span> <span class="n">stereo</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">setStereo</span><span class="p">(</span><span class="n">stereo</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
      <span class="n">varAtom</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">vAChirality</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">chirality</span>
      <span class="k">if</span> <span class="n">stereo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">stereo</span><span class="p">:</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">atom</span><span class="p">))</span>

      <span class="n">chirality</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">getStereochemistry</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">chirality</span><span class="p">:</span>
        <span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">vAChirality</span> <span class="ow">and</span> <span class="n">vAChirality</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">vAChirality</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">chirality</span> <span class="ow">and</span> <span class="n">vAChirality</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">chirality</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="n">chirality</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">getStereochemistry</span><span class="p">()</span>
            <span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vAChirality</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">chirality</span><span class="p">:</span>
              <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Stereochemistry of </span><span class="si">%s</span><span class="s2"> different even after attempted swap. (</span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">vAChirality</span><span class="p">,</span> <span class="n">chirality</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">chirality</span> <span class="o">=</span> <span class="n">chirality</span></div>

<div class="viewcode-block" id="VarAtom.getStereochemistry"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getStereochemistry">[docs]</a>  <span class="k">def</span> <span class="nf">getStereochemistry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">neighbours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span>
    <span class="n">nNeighbours</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>

    <span class="n">stereochemistry</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">nNeighbours</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
      <span class="n">nHydrogens</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
          <span class="n">nHydrogens</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">nHydrogens</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">stereochemistry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStereochemistryRS</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">nNeighbours</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="n">bond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBondToAtom</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbour</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">stereochemistry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStereochemistryEZ</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stereochemistry</span></div>

<div class="viewcode-block" id="VarAtom.getStereochemistryRS"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getStereochemistryRS">[docs]</a>  <span class="k">def</span> <span class="nf">getStereochemistryRS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPriorities</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">prio</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="n">lowPrio</span> <span class="o">=</span> <span class="n">prio</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">refBondAngle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">prio</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">secondBondAngle</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">prio</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">refBondAngle</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>
    <span class="n">thirdBondAngle</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">prio</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">refBondAngle</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">secondBondAngle</span> <span class="o">&lt;</span> <span class="n">thirdBondAngle</span><span class="p">:</span>
      <span class="n">stereo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">secondBondAngle</span> <span class="o">&gt;</span> <span class="n">thirdBondAngle</span><span class="p">:</span>
      <span class="n">stereo</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="n">lowPrioIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lowPrio</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lowPrioIndex</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
      <span class="n">stereo</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">lowPrioIndex</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">lowHighAngle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">lowPrio</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">lowHighAngle</span> <span class="o">&gt;</span> <span class="n">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">stereo</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>


    <span class="k">if</span> <span class="n">stereo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;R&quot;</span>
    <span class="k">if</span> <span class="n">stereo</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;S&quot;</span>
    <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="VarAtom.getStereochemistryEZ"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getStereochemistryEZ">[docs]</a>  <span class="k">def</span> <span class="nf">getStereochemistryEZ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

    <span class="n">selfPrio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPriorities</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">selfPrio</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="n">otherPrio</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">getPriorities</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">otherPrio</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="n">angleMain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">selfHighPrio</span> <span class="o">=</span> <span class="n">selfLowPrio</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">otherHighPrio</span> <span class="o">=</span> <span class="n">otherLowPrio</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">selfPrio</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">selfHighPrio</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">selfHighPrio</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">selfLowPrio</span> <span class="o">=</span> <span class="n">atom</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">otherPrio</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">otherHighPrio</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">otherHighPrio</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">otherLowPrio</span> <span class="o">=</span> <span class="n">atom</span>
    <span class="n">angleHighPrio</span> <span class="o">=</span> <span class="n">selfHighPrio</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">otherHighPrio</span><span class="p">)</span>
    <span class="n">angleLowPrio</span> <span class="o">=</span> <span class="n">selfHighPrio</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">otherLowPrio</span><span class="p">)</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angleMain</span> <span class="o">-</span> <span class="n">angleHighPrio</span><span class="p">)</span>
    <span class="n">altDiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angleMain</span> <span class="o">-</span> <span class="n">angleLowPrio</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="o">-</span><span class="n">diff</span><span class="p">))</span>
    <span class="n">altDiff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">altDiff</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PI</span><span class="o">-</span><span class="n">altDiff</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">altDiff</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;Z&#39;</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">altDiff</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;E&#39;</span>

    <span class="k">return</span> <span class="bp">None</span></div>

  <span class="c1"># This function returns a list of neighbours ranked according to Cahn-Ingold-Prelog rules (not taking more than the fourth level of neighbours into account.</span>
  <span class="c1"># The neighbour with highest priority is first in the returned list.</span>
<div class="viewcode-block" id="VarAtom.getPriorities"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getPriorities">[docs]</a>  <span class="k">def</span> <span class="nf">getPriorities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">firstList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFirstNeighbourPriorities</span><span class="p">()</span>
    <span class="n">foundSimilar</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">firstList</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">otherItem</span> <span class="ow">in</span> <span class="n">firstList</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):]:</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">otherItem</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">foundSimilar</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="n">foundSimilar</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">foundSimilar</span><span class="p">:</span>
      <span class="n">secondList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSecondNeighbourPriorities</span><span class="p">()</span>
      <span class="n">thirdList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getThirdNeighbourPriorities</span><span class="p">()</span>
      <span class="n">fourthList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFourthNeighbourPriorities</span><span class="p">()</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstList</span><span class="p">)</span>

    <span class="n">prioList</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>

    <span class="k">while</span> <span class="n">prio</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
      <span class="n">item</span> <span class="o">=</span> <span class="n">firstList</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">prio</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">prioList</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prio</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">nextItem</span> <span class="o">=</span> <span class="n">firstList</span><span class="p">[</span><span class="n">prio</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nextItem</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">prioList</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">prio</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">continue</span>

        <span class="n">similar</span> <span class="o">=</span> <span class="p">[</span><span class="n">prio</span><span class="p">,</span> <span class="n">prio</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">while</span> <span class="n">prio</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">firstList</span><span class="p">[</span><span class="n">prio</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">firstList</span><span class="p">[</span><span class="n">prio</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">similar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prio</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="n">nSim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">similar</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">nSim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">newN</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nSim</span><span class="p">):</span>
            <span class="n">this</span> <span class="o">=</span> <span class="n">similar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">similar</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">secondList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">secondList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">thirdList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">thirdList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
            <span class="n">fourthList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">fourthList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
              <span class="k">return</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">secondList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">secondList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">secondList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">secondList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">thirdList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thirdList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">thirdList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">thirdList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fourthList</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fourthList</span><span class="p">[</span><span class="n">this</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))):</span>
              <span class="n">temp</span> <span class="o">=</span> <span class="n">similar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
              <span class="n">similar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">similar</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
              <span class="n">similar</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
              <span class="n">newN</span> <span class="o">=</span> <span class="n">i</span>
          <span class="n">nSim</span> <span class="o">=</span> <span class="n">newN</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">similar</span><span class="p">:</span>
          <span class="n">prioList</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span><span class="o">=</span><span class="n">firstList</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">prio</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">prioList</span></div>

  <span class="c1"># This should actually be the atomic number, but here the mass number of the main isotope is used instead. Should still</span>
  <span class="c1"># sort in the same order.</span>
<div class="viewcode-block" id="VarAtom.priorityNumber"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.priorityNumber">[docs]</a>  <span class="k">def</span> <span class="nf">priorityNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">ELEMENT_ISO_ABUN</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ELEMENT_ISO_ABUN</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="VarAtom.getFirstNeighbourPriorities"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getFirstNeighbourPriorities">[docs]</a>  <span class="k">def</span> <span class="nf">getFirstNeighbourPriorities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">priorityList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">priorityNumber</span><span class="p">()</span>
      <span class="n">priorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">neighbour</span><span class="p">,</span> <span class="n">p</span><span class="p">])</span>

    <span class="n">priorityList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">priorityList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">neighbour</span><span class="p">:</span> <span class="n">neighbour</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">priorityList</span></div>

<div class="viewcode-block" id="VarAtom.getSecondNeighbourPriorities"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getSecondNeighbourPriorities">[docs]</a>  <span class="k">def</span> <span class="nf">getSecondNeighbourPriorities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">priorityList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maxLen</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFirstNeighbourPriorities</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">localPriorityList</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">prio</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">getFirstNeighbourPriorities</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
          <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>
        <span class="n">bond</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getBondToAtom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">isAromatic</span><span class="p">():</span>
          <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>
          <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span><span class="p">:</span>
            <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>

      <span class="n">localPriorityList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">neighbour</span><span class="p">:</span> <span class="n">neighbour</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

      <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">maxLen</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">maxLen</span><span class="p">:</span>
        <span class="n">maxLen</span> <span class="o">=</span> <span class="n">l</span>

      <span class="n">priorityList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">)</span>

    <span class="n">maxLen</span> <span class="o">-=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">localPriorityList</span> <span class="ow">in</span> <span class="n">priorityList</span><span class="p">:</span>
      <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">maxLen</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

      <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">score</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">priorityList</span></div>

<div class="viewcode-block" id="VarAtom.getThirdNeighbourPriorities"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getThirdNeighbourPriorities">[docs]</a>  <span class="k">def</span> <span class="nf">getThirdNeighbourPriorities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">priorityList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maxLen</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSecondNeighbourPriorities</span><span class="p">():</span>

      <span class="n">localPriorityList</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">prio</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">getFirstNeighbourPriorities</span><span class="p">():</span>
          <span class="k">if</span> <span class="n">atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
            <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>
          <span class="n">bond</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getBondToAtom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">isAromatic</span><span class="p">():</span>
            <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span><span class="p">:</span>
              <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>

      <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">maxLen</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">maxLen</span><span class="p">:</span>
        <span class="n">maxLen</span> <span class="o">=</span> <span class="n">l</span>

      <span class="n">priorityList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">)</span>

    <span class="n">maxLen</span> <span class="o">-=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">localPriorityList</span> <span class="ow">in</span> <span class="n">priorityList</span><span class="p">:</span>
      <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">maxLen</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

      <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">score</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">priorityList</span></div>

<div class="viewcode-block" id="VarAtom.getFourthNeighbourPriorities"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.VarAtom.getFourthNeighbourPriorities">[docs]</a>  <span class="k">def</span> <span class="nf">getFourthNeighbourPriorities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">priorityList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maxLen</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">nextNeighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getThirdNeighbourPriorities</span><span class="p">():</span>

      <span class="n">localPriorityList</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">prio</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">getFirstNeighbourPriorities</span><span class="p">():</span>
          <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span> <span class="n">prio</span><span class="p">])</span>

      <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">maxLen</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">maxLen</span><span class="p">:</span>
        <span class="n">maxLen</span> <span class="o">=</span> <span class="n">l</span>

      <span class="n">priorityList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">)</span>

    <span class="n">maxLen</span> <span class="o">-=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">localPriorityList</span> <span class="ow">in</span> <span class="n">priorityList</span><span class="p">:</span>
      <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">localPriorityList</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">maxLen</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

      <span class="n">localPriorityList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">score</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">priorityList</span></div></div>
<div class="viewcode-block" id="vectorsSubtract"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.vectorsSubtract">[docs]</a><span class="k">def</span> <span class="nf">vectorsSubtract</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Subtract vectors v1 and v2.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;length of v1 != length of v2&#39;</span><span class="p">)</span>

  <span class="n">v</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">v</span></div>

<div class="viewcode-block" id="dotProduct"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.dotProduct">[docs]</a><span class="k">def</span> <span class="nf">dotProduct</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; The inner product between v1 and v2.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="p">)):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;v1 and v2 must be same length&#39;</span><span class="p">)</span>

  <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="crossProduct"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.crossProduct">[docs]</a><span class="k">def</span> <span class="nf">crossProduct</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Returns the cross product of v1 and v2.</span>
<span class="sd">  Both must be 3-dimensional vectors.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;v1 and v2 must be of length 3&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">[</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span></div>


<div class="viewcode-block" id="Variant"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant">[docs]</a><span class="k">class</span> <span class="nc">Variant</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">templateVarAtoms</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">compound</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Auto derived</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Auto derived</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomGroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">templateVarAtoms</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">copyAtoms</span><span class="p">(</span><span class="n">templateVarAtoms</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>


  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;Variant </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<div class="viewcode-block" id="Variant.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">):</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="k">del</span> <span class="bp">self</span>

    <span class="n">nVars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">isVariable</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span> <span class="o">==</span> <span class="n">nVars</span><span class="p">):</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">isVariable</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Variant.setDefault"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.setDefault">[docs]</a>  <span class="k">def</span> <span class="nf">setDefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">defaultVars</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">defaultVars</span>
    <span class="n">current</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defaultVars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
        <span class="n">defaultVars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
      <span class="n">defaultVars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
      <span class="n">defaultVars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="Variant.getRings"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.getRings">[docs]</a>  <span class="k">def</span> <span class="nf">getRings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtoms</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">variant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Variant.getRings: Input VarAtom does not belong to Variant&#39;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">)</span>
    <span class="n">rings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span> <span class="o">=</span> <span class="n">varAtoms</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
      <span class="n">rings</span> <span class="o">+=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">getRings</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">varAtoms2</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
        <span class="n">varAtoms</span> <span class="o">=</span> <span class="n">varAtoms</span> <span class="o">-</span> <span class="n">varAtoms2</span>

    <span class="k">return</span> <span class="n">rings</span></div>

<div class="viewcode-block" id="Variant.checkBaseValences"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.checkBaseValences">[docs]</a>  <span class="k">def</span> <span class="nf">checkBaseValences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">baseValances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">)</span> <span class="o">-</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">charge</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">baseValances</span> <span class="o">+=</span> <span class="n">BOND_TYPE_VALENCES</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">isAromatic</span><span class="p">():</span>
        <span class="n">baseValances</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">baseValences</span> <span class="o">!=</span> <span class="n">baseValances</span><span class="p">:</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setBaseValences</span><span class="p">(</span><span class="n">baseValances</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variant.shuffleStereo"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.shuffleStereo">[docs]</a>  <span class="k">def</span> <span class="nf">shuffleStereo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">stereo</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span>

      <span class="k">if</span> <span class="n">stereo</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stereo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">va</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stereo</span><span class="p">):</span>
          <span class="n">indices</span><span class="p">[</span><span class="n">va</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">sortList</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">va</span><span class="o">.</span><span class="n">neighbours</span><span class="p">),</span><span class="n">va</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">va</span><span class="p">)</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">stereo</span><span class="p">]</span>
        <span class="n">sortList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">stereo</span>

        <span class="n">perms</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">],</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">d</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">],</span> <span class="p">[</span><span class="n">d</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">c</span><span class="p">]]</span>

        <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sortList</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
            <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
            <span class="k">break</span></div>


<div class="viewcode-block" id="Variant.deduceStereo"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.deduceStereo">[docs]</a>  <span class="k">def</span> <span class="nf">deduceStereo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">center</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

      <span class="n">vecs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vectorsSubtract</span><span class="p">(</span><span class="n">va</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">center</span><span class="p">),</span> <span class="n">va</span><span class="p">)</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">]</span>
      <span class="n">vec1</span><span class="p">,</span> <span class="n">va1</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="n">dotProds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">vec1</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="n">va</span><span class="p">)</span> <span class="k">for</span> <span class="n">vec</span><span class="p">,</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
      <span class="n">dotProds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

      <span class="n">dp</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">va2</span> <span class="o">=</span> <span class="n">dotProds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="n">norm</span> <span class="o">=</span> <span class="n">crossProduct</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">)</span>
      <span class="n">len1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm</span><span class="p">))</span>

      <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">dp</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">dotProds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">len2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">vec</span><span class="p">))</span><span class="o">*</span><span class="n">len1</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">dotProduct</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span><span class="o">/</span><span class="n">len2</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">crossProduct</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span>  <span class="n">sqrt</span><span class="p">(</span><span class="n">dotProduct</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cp</span><span class="p">))</span><span class="o">/</span><span class="n">len2</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">angle</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span>

      <span class="n">angles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

      <span class="n">stereo</span> <span class="o">=</span> <span class="p">[</span><span class="n">va1</span><span class="p">,]</span>
      <span class="n">stereo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">]</span>
      <span class="n">stereo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">va2</span><span class="p">,]</span>

      <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereo</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">shuffleStereo</span><span class="p">()</span></div>


<div class="viewcode-block" id="Variant.addLink"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.addLink">[docs]</a>  <span class="k">def</span> <span class="nf">addLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linkType</span><span class="p">,</span> <span class="n">replaceAtoms</span><span class="p">):</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1">#existing = self.elementDict[LINK]</span>
    <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">replaceAtoms</span> <span class="k">if</span> <span class="n">va</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
    <span class="n">oxygens</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">replaceAtoms</span> <span class="k">if</span> <span class="n">va</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hydrogens</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">linkH</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">linkO</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">context</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">oxygens</span><span class="p">:</span>
      <span class="n">oNeighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">oNeighbours</span><span class="p">:</span>
          <span class="n">linkH</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">atom</span>
          <span class="n">linkO</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">atom</span>
          <span class="n">oNeighbours</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">oNeighbours</span><span class="p">:</span>
            <span class="n">boundAtom</span> <span class="o">=</span> <span class="n">oNeighbours</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">bound</span> <span class="o">=</span> <span class="n">boundAtom</span><span class="o">.</span><span class="n">atom</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">boundAtom</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span>
          <span class="k">break</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">linkH</span><span class="p">:</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">hydrogens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">linkH</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">atom</span>
      <span class="n">hNeighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">hNeighbours</span><span class="p">:</span>
        <span class="n">boundAtom</span> <span class="o">=</span> <span class="n">hNeighbours</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">boundAtom</span><span class="o">.</span><span class="n">atom</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">boundAtom</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span>

    <span class="n">variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>
    <span class="n">newAtom</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">bound</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">va2</span> <span class="ow">in</span> <span class="n">va</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">va2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">va2</span>

    <span class="n">linkMasterAtom</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">getAtom</span><span class="p">(</span><span class="n">LINK</span><span class="p">,</span> <span class="n">linkType</span><span class="p">)</span>

    <span class="c1"># Replace terminal Hs</span>
    <span class="k">if</span> <span class="n">linkO</span><span class="p">:</span>
      <span class="n">oldOtherH</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">oldOtherH</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">context</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
      <span class="n">oldOtherH</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">linkH</span><span class="p">)</span>

    <span class="c1"># New middle Hs</span>
    <span class="n">newOtherH</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atom</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">oldOtherH</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
      <span class="n">atomH</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">linkH</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">atomH</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">atomO</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="n">linkO</span><span class="p">:</span>
        <span class="n">atomO</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">linkO</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">atomO</span><span class="p">:</span>
          <span class="k">continue</span>

      <span class="n">atomB</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">contextB</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="n">bound</span><span class="p">:</span>
        <span class="n">atomB</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">bound</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">atomB</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">contextB</span> <span class="o">=</span> <span class="n">atomB</span><span class="o">.</span><span class="n">getContext</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">contextB</span> <span class="o">!=</span> <span class="n">context</span><span class="p">:</span>
          <span class="k">continue</span>

      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
      <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atomH</span><span class="p">)</span>
      <span class="n">coordsH</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">if</span> <span class="n">atomO</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">atomO</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atomO</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">atomH</span><span class="o">.</span><span class="n">coords</span>

        <span class="k">for</span> <span class="n">atomH2</span> <span class="ow">in</span> <span class="n">oldOtherH</span><span class="p">:</span>
          <span class="n">varAtomH2</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomH2</span><span class="p">)</span>
          <span class="n">coordsH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varAtomH2</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
          <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">varAtomH2</span><span class="p">)</span>

      <span class="n">newVar</span> <span class="o">=</span> <span class="n">Variant</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span>

      <span class="n">varAtom</span> <span class="o">=</span> <span class="n">VarAtom</span><span class="p">(</span><span class="n">newVar</span><span class="p">,</span> <span class="n">linkMasterAtom</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>


      <span class="k">if</span> <span class="n">atomB</span><span class="p">:</span>
        <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">newVar</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">bound</span><span class="p">]</span>
        <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">getBond</span><span class="p">(</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
        <span class="n">newAtom</span> <span class="o">=</span> <span class="n">varAtom</span>

      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">newH</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newOtherH</span><span class="p">):</span>
        <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">newVar</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">bound</span><span class="p">]</span>
        <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
        <span class="n">varAtom</span> <span class="o">=</span> <span class="n">VarAtom</span><span class="p">(</span><span class="n">newVar</span><span class="p">,</span> <span class="n">newH</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coordsH</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">getBond</span><span class="p">(</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

      <span class="n">newVar</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
      <span class="n">newVar</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>

    <span class="c1"># Try auto amide name</span>
    <span class="k">if</span> <span class="n">bound</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bound</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">newOtherH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;H&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">:</span>
        <span class="n">newOtherH</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newAtom</span></div>

<div class="viewcode-block" id="Variant.getBond"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.getBond">[docs]</a>  <span class="k">def</span> <span class="nf">getBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="n">varAtomA</span> <span class="ow">in</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
      <span class="n">common</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varAtomA</span><span class="o">.</span><span class="n">bonds</span> <span class="o">&amp;</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Bond</span><span class="p">((</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">),</span> <span class="n">autoVar</span><span class="o">=</span><span class="n">autoVar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variant.updatePolyLink"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.updatePolyLink">[docs]</a>  <span class="k">def</span> <span class="nf">updatePolyLink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">linkNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LINK</span><span class="p">,</span> <span class="p">[])]</span>

    <span class="n">prevLink</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linkNames</span> <span class="k">if</span> <span class="s1">&#39;prev&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">nextLink</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linkNames</span> <span class="k">if</span> <span class="s1">&#39;next&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">prevLink</span> <span class="ow">and</span> <span class="n">nextLink</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">=</span> <span class="s1">&#39;middle&#39;</span>
    <span class="k">elif</span> <span class="n">prevLink</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">=</span> <span class="s1">&#39;end&#39;</span>
    <span class="k">elif</span> <span class="n">nextLink</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span>
    <span class="k">elif</span> <span class="n">linkNames</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">=</span> <span class="s1">&#39;linked&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">=</span> <span class="s1">&#39;free&#39;</span></div>

<div class="viewcode-block" id="Variant.updateDescriptor"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.updateDescriptor">[docs]</a>  <span class="k">def</span> <span class="nf">updateDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescriptor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Variant.getCommonIsoMass"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.getCommonIsoMass">[docs]</a>  <span class="k">def</span> <span class="nf">getCommonIsoMass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">mass</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
      <span class="n">mass</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">ELEMENT_ISO_ABUN</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span>  <span class="n">mass</span></div>

<div class="viewcode-block" id="Variant.getMolFormula"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.getMolFormula">[docs]</a>  <span class="k">def</span> <span class="nf">getMolFormula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="n">counts</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">elements</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
      <span class="n">elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
      <span class="n">elements</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
      <span class="n">elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
      <span class="n">elements</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="n">formula</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">elem</span>

      <span class="n">formula</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">formula</span></div>

<div class="viewcode-block" id="Variant.getDescriptor"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.getDescriptor">[docs]</a>  <span class="k">def</span> <span class="nf">getDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccpnStyle</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">ccpnStyle</span><span class="p">:</span>
      <span class="n">prot</span> <span class="o">=</span> <span class="s1">&#39;prot&#39;</span>
      <span class="n">deprot</span> <span class="o">=</span> <span class="s1">&#39;deprot&#39;</span>
      <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;link&#39;</span>
      <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
      <span class="n">joinStr</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">prot</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
      <span class="n">deprot</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
      <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      <span class="n">joinStr</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>

    <span class="n">neutral</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>

    <span class="n">equivVars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span><span class="p">]</span>

    <span class="n">hAtomVars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stereoTypes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">equivVars</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stereoTypes</span><span class="p">:</span>
          <span class="n">stereoTypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">stereoTypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">isVariable</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hAtomVars</span><span class="p">:</span>
            <span class="n">hAtomVars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

          <span class="n">hAtomVars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tagsLink</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tagsStereo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tagsProton</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Links</span>

    <span class="n">linkAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LINK</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">genLinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">linkAtoms</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;prev&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;next&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">genLinks</span><span class="p">:</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">])</span>
      <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">link</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
      <span class="n">tagsLink</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">link</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="c1"># Protonation</span>
    <span class="n">isNeutral</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">va</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Names of variable atoms</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">hAtomVars</span><span class="p">:</span>

      <span class="c1"># Vars that have this hydrogen</span>
      <span class="n">varsA</span> <span class="o">=</span> <span class="n">hAtomVars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

      <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">varsA</span><span class="p">:</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prot</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">tagsProton</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prot</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">deprot</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">tagsProton</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">deprot</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="c1"># stereochemistry</span>

    <span class="k">if</span> <span class="n">ccpnStyle</span><span class="p">:</span>
      <span class="n">stereoDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stereoTypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;stereo_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stereoDict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>
          <span class="n">tagsStereo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;stereo_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stereoDict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stereoTypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
          <span class="n">tagsStereo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="c1">#if isNeutral and not (tagsStereo or tagsLink):</span>
    <span class="c1">#  tags = []</span>
    <span class="c1">#  tagsProton = []</span>

    <span class="k">if</span> <span class="n">ccpnStyle</span><span class="p">:</span>
      <span class="n">tagNames</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">sortDict</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sortDict</span><span class="p">:</span>
          <span class="n">sortDict</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">sortDict</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

      <span class="n">cats</span> <span class="o">=</span> <span class="p">[(</span><span class="n">VAR_TAG_ORDER</span><span class="p">[</span><span class="n">cat</span><span class="p">],</span> <span class="n">cat</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">sortDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
      <span class="n">cats</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cat</span> <span class="o">==</span> <span class="s1">&#39;link&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">ccpMolType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span><span class="s1">&#39;RNA&#39;</span><span class="p">,</span><span class="s1">&#39;DNA&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">cat</span> <span class="o">==</span> <span class="n">neutral</span><span class="p">:</span>
          <span class="n">tagNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neutral</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">names</span> <span class="o">=</span> <span class="n">sortDict</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
          <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
          <span class="n">tagStr</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
          <span class="n">tagNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat</span><span class="p">,</span><span class="n">sep</span><span class="p">,</span><span class="n">tagStr</span><span class="p">))</span>

      <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">joinStr</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tagNames</span><span class="p">))</span> <span class="ow">or</span> <span class="n">neutral</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">isNeutral</span><span class="p">:</span>
        <span class="n">defaultH</span> <span class="o">=</span> <span class="n">neutral</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">defaultH</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>

      <span class="n">tagsProton</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="n">tagsProton</span> <span class="o">=</span> <span class="n">joinStr</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tagsProton</span><span class="p">])</span> <span class="ow">or</span> <span class="n">defaultH</span>
      <span class="n">tagsStereo</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="n">tagsStereo</span> <span class="o">=</span> <span class="n">joinStr</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tagsStereo</span><span class="p">])</span> <span class="ow">or</span> <span class="s1">&#39;default&#39;</span>
      <span class="n">tagsLink</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="n">tagsLink</span> <span class="o">=</span> <span class="n">joinStr</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tagsLink</span><span class="p">])</span> <span class="ow">or</span> <span class="s1">&#39;none&#39;</span>

      <span class="k">return</span> <span class="n">tagsProton</span><span class="p">,</span> <span class="n">tagsLink</span><span class="p">,</span> <span class="n">tagsStereo</span></div>

<div class="viewcode-block" id="Variant.copyAtoms"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.copyAtoms">[docs]</a>  <span class="k">def</span> <span class="nf">copyAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtoms</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tempNames</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">cx</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">cx</span> <span class="o">+=</span> <span class="n">x</span>
      <span class="n">cy</span> <span class="o">+=</span> <span class="n">y</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mf">1.0</span>

    <span class="n">cx</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">cy</span> <span class="o">/=</span> <span class="n">n</span>

    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">newAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">addList</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">]</span>
    <span class="n">addList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">addList</span><span class="p">:</span>

      <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;prev&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="s1">&#39;middle&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
          <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s1">&#39;next&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="s1">&#39;middle&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
          <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyLink</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

      <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">cx</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">cy</span>

      <span class="n">bonds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
      <span class="n">groups</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">tempNames</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;@</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span>

      <span class="n">masterAtom</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">getAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">isVariable</span><span class="p">)</span>
      <span class="n">masterAtom</span><span class="o">.</span><span class="n">baseValences</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">baseValences</span>

      <span class="n">newAtom</span> <span class="o">=</span> <span class="n">VarAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masterAtom</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">,</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="n">dy</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">isLabile</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
      <span class="n">newAtoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newAtom</span><span class="p">)</span>

      <span class="n">mapping</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">newAtom</span>

    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
      <span class="n">atomA</span><span class="p">,</span> <span class="n">atomB</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>
      <span class="n">newAtomA</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomA</span><span class="p">)</span>
      <span class="n">newAtomB</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">newAtomA</span> <span class="ow">and</span> <span class="n">newAtomB</span><span class="p">:</span>
        <span class="n">Bond</span><span class="p">((</span><span class="n">newAtomA</span><span class="p">,</span> <span class="n">newAtomB</span><span class="p">),</span> <span class="n">bondType</span><span class="o">=</span><span class="n">bond</span><span class="o">.</span><span class="n">bondType</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>

      <span class="n">newAtomsG</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">varAtom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
          <span class="k">break</span>

        <span class="n">newAtomsG</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">varAtom</span><span class="p">])</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">AtomGroup</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="n">newAtomsG</span><span class="p">,</span> <span class="n">groupType</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">groupType</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">:</span>
        <span class="n">stereo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">varAtom2</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">stereo</span><span class="p">:</span>
          <span class="n">newAtom</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varAtom2</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">newAtom</span><span class="p">:</span>
            <span class="n">stereo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newAtom</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="n">mapping</span><span class="p">[</span><span class="n">varAtom</span><span class="p">]</span><span class="o">.</span><span class="n">setStereo</span><span class="p">(</span><span class="n">stereo</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">newAtoms</span></div>

<div class="viewcode-block" id="Variant.minimise2d"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.minimise2d">[docs]</a>  <span class="k">def</span> <span class="nf">minimise2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">maxCycles</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">bondLength</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">drawFunc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>


    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

    <span class="n">allAtoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span>

      <span class="n">atoms</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>


    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">shuffle</span>

    <span class="n">cx</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cz</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">x</span> <span class="o">+=</span> <span class="n">random</span><span class="p">()</span>
      <span class="n">y</span> <span class="o">+=</span> <span class="n">random</span><span class="p">()</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
      <span class="n">cx</span> <span class="o">+=</span> <span class="n">x</span>
      <span class="n">cy</span> <span class="o">+=</span> <span class="n">y</span>
      <span class="n">cz</span> <span class="o">+=</span> <span class="n">x</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
    <span class="n">cx</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">cy</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">cz</span> <span class="o">/=</span> <span class="n">n</span>

    <span class="c1">#self.minimise3d(atoms, maxCycles*5, bondLength, drawFunc)</span>
    <span class="c1">#self.center(atoms, (cx, cy, cz))</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">distances2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bondLengths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">getBond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBond</span>

    <span class="n">aromatics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">elem</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">element</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">))</span>

      <span class="k">for</span> <span class="n">atomGroup</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atomGroup</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
          <span class="n">aromatics</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atomGroup</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">varAtom2</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="n">elem2</span> <span class="o">=</span> <span class="n">varAtom2</span><span class="o">.</span><span class="n">element</span>

        <span class="k">if</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">elem2</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
          <span class="n">bl</span> <span class="o">=</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">bondLength</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">bond</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varAtom2</span><span class="o">.</span><span class="n">bonds</span> <span class="o">&amp;</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

          <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span><span class="s1">&#39;triple&#39;</span><span class="p">):</span>
            <span class="n">bl</span> <span class="o">=</span> <span class="mf">0.87</span> <span class="o">*</span> <span class="n">bondLength</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">bl</span> <span class="o">=</span> <span class="n">bondLength</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">varAtom2</span><span class="p">,</span> <span class="n">varAtom</span><span class="p">])</span>
        <span class="n">bondLengths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bl</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">aromatics</span><span class="p">:</span>
      <span class="n">varAtoms</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">varAtoms</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">))</span>
      <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">distances2</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dist</span>

    <span class="n">b2</span> <span class="o">=</span> <span class="n">bondLength</span><span class="o">*</span><span class="n">bondLength</span>
    <span class="n">r2limit</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">b2</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxCycles</span><span class="p">):</span>
      <span class="n">change</span> <span class="o">=</span> <span class="mf">0.0</span>

      <span class="n">g</span> <span class="o">=</span> <span class="mf">0.005</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxCycles</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="n">maxCycles</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">vx</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">allAtoms</span><span class="p">:</span> <span class="c1"># only neighbours?</span>
          <span class="k">if</span> <span class="n">atom2</span> <span class="ow">is</span> <span class="n">atom</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">coords</span>

          <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">x2</span>
          <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">y2</span>
          <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>
          <span class="n">pair</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span> <span class="n">atom2</span><span class="p">])</span>

          <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">distances2</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">distances2</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

          <span class="k">elif</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">bondLengths</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

          <span class="k">elif</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="n">r2limit</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mf">5e6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r2</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span>

          <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
          <span class="n">vx</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">g</span>
          <span class="n">vy</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">g</span>

        <span class="n">x</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="n">vx</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="n">vy</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">)</span>

        <span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">change</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>
        <span class="n">change</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">%</span><span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">drawFunc</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span><span class="p">))</span>
        <span class="n">drawFunc</span><span class="p">()</span>

      <span class="n">shuffle</span><span class="p">(</span><span class="n">allAtoms</span><span class="p">)</span>

      <span class="c1"># quit early if nothing happens</span>
      <span class="k">if</span> <span class="n">change</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># updates all vars</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">drawFunc</span><span class="p">:</span>
      <span class="n">drawFunc</span><span class="p">()</span></div>

<div class="viewcode-block" id="Variant.getCentroid"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.getCentroid">[docs]</a>  <span class="k">def</span> <span class="nf">getCentroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">xs</span> <span class="o">+=</span> <span class="n">x1</span>
      <span class="n">ys</span> <span class="o">+=</span> <span class="n">y1</span>
      <span class="n">zs</span> <span class="o">+=</span> <span class="n">z1</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
      <span class="n">xs</span> <span class="o">/=</span> <span class="n">n</span>
      <span class="n">ys</span> <span class="o">/=</span> <span class="n">n</span>
      <span class="n">zs</span> <span class="o">/=</span> <span class="n">n</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variant.center"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.center">[docs]</a>  <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span>

    <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
      <span class="n">x0</span><span class="p">,</span>  <span class="n">y0</span><span class="p">,</span>  <span class="n">z0</span> <span class="o">=</span> <span class="n">origin</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">z0</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCentroid</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">xs</span> <span class="o">-=</span> <span class="n">x0</span>
    <span class="n">ys</span> <span class="o">-=</span> <span class="n">y0</span>
    <span class="n">zs</span> <span class="o">-=</span> <span class="n">z0</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

      <span class="n">x1</span> <span class="o">-=</span> <span class="n">xs</span>
      <span class="n">y1</span> <span class="o">-=</span> <span class="n">ys</span>
      <span class="n">z1</span> <span class="o">-=</span> <span class="n">zs</span>

      <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span></div>

<div class="viewcode-block" id="Variant.minimise3d"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.minimise3d">[docs]</a>  <span class="k">def</span> <span class="nf">minimise3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">maxCycles</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bondLength</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">drawFunc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">shuffle</span>

    <span class="n">allAtoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span>

      <span class="n">atoms</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">aromatics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">bl</span> <span class="o">=</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">))</span>

      <span class="k">for</span> <span class="n">varAtom2</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">varAtom3</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>

          <span class="k">if</span> <span class="n">varAtom2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">varAtom3</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mf">3.0</span><span class="p">:</span>
              <span class="n">distances</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">varAtom2</span><span class="p">,</span> <span class="n">varAtom3</span><span class="p">])]</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="mf">0.8660254</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">distances</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">varAtom2</span><span class="p">,</span> <span class="n">varAtom3</span><span class="p">])]</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">aromatics</span><span class="p">:</span>
      <span class="n">varAtoms</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">varAtoms</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">))</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">neighbours</span>
          <span class="n">distances</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">varAtomA</span><span class="p">])]</span> <span class="o">=</span> <span class="n">bondLength</span>
          <span class="n">distances</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">])]</span> <span class="o">=</span> <span class="n">bondLength</span>
          <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">n</span>
          <span class="n">distances</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">])]</span> <span class="o">=</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">cx</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cz</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">x</span> <span class="o">+=</span> <span class="n">random</span><span class="p">()</span>
      <span class="n">y</span> <span class="o">+=</span> <span class="n">random</span><span class="p">()</span>
      <span class="n">z</span> <span class="o">+=</span> <span class="n">random</span><span class="p">()</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
      <span class="n">cx</span> <span class="o">+=</span> <span class="n">x</span>
      <span class="n">cy</span> <span class="o">+=</span> <span class="n">y</span>
      <span class="n">cz</span> <span class="o">+=</span> <span class="n">z</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
    <span class="n">cx</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">cy</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="n">cz</span> <span class="o">/=</span> <span class="n">n</span>

    <span class="n">b2</span> <span class="o">=</span> <span class="n">bondLength</span><span class="o">*</span><span class="n">bondLength</span>
    <span class="n">r2limit</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">b2</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxCycles</span><span class="p">):</span>
      <span class="n">change</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">g</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="n">maxCycles</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="k">continue</span>


        <span class="n">vx</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>

        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">allAtoms</span><span class="p">:</span> <span class="c1"># only neighbours?</span>
          <span class="k">if</span> <span class="n">atom2</span> <span class="ow">is</span> <span class="n">atom</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">coords</span>

          <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">x2</span>
          <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">y2</span>
          <span class="n">dz</span> <span class="o">=</span> <span class="n">z</span><span class="o">-</span><span class="n">z2</span>
          <span class="n">r2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="n">dz</span><span class="o">*</span><span class="n">dz</span><span class="p">))</span>

          <span class="n">pair</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span> <span class="n">atom2</span><span class="p">])</span>
          <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">r2</span><span class="p">))</span>
            <span class="n">vx</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dl</span><span class="o">/</span><span class="n">r2</span>
            <span class="n">vy</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">*</span><span class="n">dl</span><span class="o">/</span><span class="n">r2</span>
            <span class="n">vz</span> <span class="o">+=</span> <span class="n">dz</span><span class="o">*</span><span class="n">dl</span><span class="o">/</span><span class="n">r2</span>

          <span class="k">elif</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">bondLength</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">r2</span><span class="p">))</span>
            <span class="n">vx</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dl</span><span class="o">/</span><span class="n">r2</span>
            <span class="n">vy</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">*</span><span class="n">dl</span><span class="o">/</span><span class="n">r2</span>
            <span class="n">vz</span> <span class="o">+=</span> <span class="n">dz</span><span class="o">*</span><span class="n">dl</span><span class="o">/</span><span class="n">r2</span>

          <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">b2</span><span class="o">/</span><span class="p">(</span><span class="n">r2</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">vx</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="n">f</span>
            <span class="n">vy</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">*</span><span class="n">f</span>
            <span class="n">vz</span> <span class="o">+=</span> <span class="n">dz</span><span class="o">*</span><span class="n">f</span>

          <span class="n">f</span> <span class="o">=</span> <span class="n">dz</span><span class="o">/</span><span class="n">r2</span>
          <span class="n">vz</span> <span class="o">+=</span> <span class="n">g</span><span class="o">*</span><span class="n">dz</span><span class="o">*</span><span class="n">f</span>

        <span class="n">x</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="n">vx</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="n">vy</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="n">vz</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">change</span> <span class="o">+=</span> <span class="n">vx</span>
        <span class="n">change</span> <span class="o">+=</span> <span class="n">vy</span>
        <span class="n">change</span> <span class="o">+=</span> <span class="n">vz</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">%</span><span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">drawFunc</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span><span class="p">))</span>
        <span class="n">drawFunc</span><span class="p">()</span>
      <span class="n">shuffle</span><span class="p">(</span><span class="n">allAtoms</span><span class="p">)</span>

      <span class="c1"># quit early if nothing happens</span>
      <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">setCoords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="c1"># updates all vars</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">drawFunc</span><span class="p">:</span>
      <span class="n">drawFunc</span><span class="p">()</span></div>

  <span class="c1"># This function snaps the atoms in atoms to suitable bond angles. When determining where to place atoms</span>
  <span class="c1"># only already placed atoms are taken into account (i.e. those that are not present in atoms)</span>
<div class="viewcode-block" id="Variant.snapAtomsToGrid"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.snapAtomsToGrid">[docs]</a>  <span class="k">def</span> <span class="nf">snapAtomsToGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prevAtom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ignoreHydrogens</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bondLength</span><span class="o">=</span><span class="mf">50.0</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="n">prevX</span> <span class="o">=</span> <span class="n">prevY</span> <span class="o">=</span> <span class="n">prevZ</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">chiralities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chiralities</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">chiralities</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span><span class="p">))</span>

    <span class="c1"># Make a separate list of hydrogens, which will be placed last.</span>
    <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">atomsTemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomsTemp</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="c1">#if ignoreHydrogens:</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="n">hydrogens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

    <span class="n">atom</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">neighbour</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">molCnt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">prevAngle</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># prevAtom is an already positioned atom and is used as a reference for placing its neighbouring atoms.</span>
    <span class="k">if</span> <span class="n">prevAtom</span><span class="p">:</span>
      <span class="n">prevX</span><span class="p">,</span> <span class="n">prevY</span><span class="p">,</span> <span class="n">prevZ</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">coords</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span> <span class="ow">and</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="n">atom</span> <span class="o">=</span> <span class="n">neighbour</span>
          <span class="k">break</span>
      <span class="c1"># Find a reference angle to an already placed atom.</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">neighbour</span> <span class="o">!=</span> <span class="n">prevAtom</span> <span class="ow">and</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span> <span class="ow">and</span> <span class="n">neighbour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour</span><span class="p">))</span>
          <span class="k">break</span>

      <span class="c1"># If a reference atom was submitted and it is in a ring snap the ring before proceeding to other atoms.</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="n">prevAtom</span>
      <span class="n">rings</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">getRings</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ring</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="n">atom</span><span class="o">.</span><span class="n">snapRings</span><span class="p">(</span><span class="n">rings</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">)</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">while</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="c1"># Find an atom with an already placed neighbour</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span> <span class="ow">and</span> <span class="n">neighbour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">prevX</span><span class="p">,</span> <span class="n">prevY</span><span class="p">,</span> <span class="n">prevZ</span> <span class="o">=</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">coords</span>
            <span class="n">prevAtom</span> <span class="o">=</span> <span class="n">neighbour</span>
            <span class="n">neighbours2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">neighbour</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Try to find a reference angle (if the neighbour has a neighbour that has been placed).</span>
            <span class="k">for</span> <span class="n">neighbour2</span> <span class="ow">in</span> <span class="n">neighbours2</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">neighbour2</span> <span class="o">!=</span> <span class="n">atom</span> <span class="ow">and</span> <span class="n">neighbour2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ignoreHydrogens</span> <span class="ow">or</span> <span class="n">neighbour2</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">):</span>
                <span class="n">prevAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">degrees</span><span class="p">(</span><span class="n">neighbour</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour2</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">prevAngle</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="k">break</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">prevAtom</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">if</span> <span class="n">atom</span> <span class="ow">and</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>
        <span class="c1"># Start by placing the atom involved in most rings. This can help avoid clashes.</span>
        <span class="n">atomWithMostRings</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mostRings</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
          <span class="n">nRings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">getRings</span><span class="p">())</span>
          <span class="k">if</span> <span class="n">nRings</span> <span class="o">&gt;</span> <span class="n">mostRings</span><span class="p">:</span>
            <span class="n">atomWithMostRings</span> <span class="o">=</span> <span class="n">atom</span>
            <span class="n">mostRings</span> <span class="o">=</span> <span class="n">nRings</span>
        <span class="k">if</span> <span class="n">mostRings</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">atom</span> <span class="o">=</span> <span class="n">atomWithMostRings</span>
          <span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">atom</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Set default coordinates since this is the first atom.</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">molCnt</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">molCnt</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">prevAtom</span><span class="p">:</span>
        <span class="n">prevChiral</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">chirality</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getPreferredBondAngles</span><span class="p">(</span><span class="n">prevAngle</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">atoms</span> <span class="o">+</span> <span class="p">[</span><span class="n">atom</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">prevChiral</span> <span class="ow">and</span> <span class="n">prevChiral</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">prevNeighbour</span> <span class="ow">in</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getBondToAtom</span><span class="p">(</span><span class="n">prevNeighbour</span><span class="p">)</span><span class="o">.</span><span class="n">bondType</span><span class="o">==</span><span class="s1">&#39;double&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prevNeighbour</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
              <span class="n">prio</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getPriorities</span><span class="p">()</span>
              <span class="n">prioIndex</span> <span class="o">=</span> <span class="n">prio</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">prioIndex</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prioIndex</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">prio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prevNeighbour</span><span class="p">):</span>
                <span class="n">selfHeavy</span> <span class="o">=</span> <span class="bp">True</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">selfHeavy</span> <span class="o">=</span> <span class="bp">False</span>
              <span class="n">prevPrio</span> <span class="o">=</span> <span class="n">prevNeighbour</span><span class="o">.</span><span class="n">getPriorities</span><span class="p">()</span>
              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prevPrio</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prevAtom</span> <span class="o">!=</span> <span class="n">p</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="n">prevAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">degrees</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">prevNeighbour</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">angles</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getPreferredBondAngles</span><span class="p">(</span><span class="n">prevAngle</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">atoms</span> <span class="o">+</span> <span class="p">[</span><span class="n">atom</span><span class="p">],</span> <span class="n">ignoreHydrogens</span><span class="p">)</span>
                    <span class="n">prevHeavyNeighbourAngle</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">prevNeighbour</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">selfHeavy</span> <span class="ow">and</span> <span class="n">prevChiral</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="ow">not</span> <span class="n">selfHeavy</span> <span class="ow">and</span> <span class="n">prevChiral</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)):</span>
                      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">prevAngle</span><span class="o">-</span><span class="n">prevHeavyNeighbourAngle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="nb">round</span><span class="p">(</span><span class="n">prevAngle</span><span class="o">-</span><span class="n">prevHeavyNeighbourAngle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                  <span class="k">break</span>
              <span class="k">break</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">prevAtom</span> <span class="ow">or</span> <span class="n">prevX</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">prevY</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prevX</span><span class="p">,</span> <span class="n">prevY</span><span class="p">,</span> <span class="n">prevZ</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">prevAtom</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="n">prevAngle</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">bonds</span> <span class="o">&amp;</span> <span class="n">atom</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">bond</span> <span class="o">=</span> <span class="n">bonds</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Variant.snapAtomsToGrid: Cannot find bond between atoms to snap (</span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">prevAtom</span><span class="p">)</span>
          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
          <span class="n">bl</span> <span class="o">=</span> <span class="n">bondLength</span> <span class="o">*</span> <span class="mf">0.87</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">bl</span> <span class="o">=</span> <span class="n">bondLength</span>

        <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">snapToGrid</span><span class="p">(</span><span class="n">prevAtom</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">ignoreHydrogens</span><span class="p">)</span>
        <span class="n">prevAngle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">+</span> <span class="n">prevAngle</span><span class="p">)</span><span class="o">%</span><span class="mi">360</span>

      <span class="n">rings</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">getRings</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ring</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">snapRings</span><span class="p">(</span><span class="n">rings</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">)</span>

    <span class="c1"># Place the hydrogens</span>
    <span class="k">if</span> <span class="n">hydrogens</span><span class="p">:</span>
      <span class="k">while</span> <span class="n">hydrogens</span><span class="p">:</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">hydrogens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c1"># If placing hydrogens bound to a ring make sure that the prevAtom</span>
        <span class="c1"># is also in a ring. This makes it possible to avoid hydrogens</span>
        <span class="c1"># inside the ring.</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">getRings</span><span class="p">():</span>
          <span class="k">for</span> <span class="n">prevAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getRings</span><span class="p">():</span>
              <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">prevAtom</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">prevX</span><span class="p">,</span> <span class="n">prevY</span><span class="p">,</span> <span class="n">prevZ</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">neighbour</span> <span class="o">!=</span> <span class="n">atom</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
            <span class="n">prevAngle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">degrees</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">angles</span> <span class="o">=</span> <span class="n">prevAtom</span><span class="o">.</span><span class="n">getPreferredBondAngles</span><span class="p">(</span><span class="n">prevAngle</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">hydrogens</span> <span class="o">+</span> <span class="p">[</span><span class="n">atom</span><span class="p">],</span> <span class="n">ignoreHydrogens</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">atom</span><span class="o">.</span><span class="n">snapToGrid</span><span class="p">(</span><span class="n">prevAtom</span><span class="p">,</span> <span class="n">bondLength</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">hydrogens</span><span class="p">,</span> <span class="n">ignoreHydrogens</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chiralities</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
          <span class="n">sc</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getStereochemistry</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">sc</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">):</span>
              <span class="n">temp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
              <span class="n">a</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
              <span class="n">a</span><span class="o">.</span><span class="n">stereo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span></div>




  <span class="c1"># Snap the atoms in a ring to the preferred bond angles.</span>
<div class="viewcode-block" id="Variant.snapRingToGrid"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.snapRingToGrid">[docs]</a>  <span class="k">def</span> <span class="nf">snapRingToGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">prevAngle</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bondLength</span><span class="o">=</span><span class="mf">45.0</span><span class="p">,</span> <span class="n">skippedAtoms</span><span class="o">=</span><span class="nb">set</span><span class="p">([])):</span>

<span class="c1">#    ringAtoms = set(ring)</span>
    <span class="n">ringAtoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ringSize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ringAtoms</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ringSize</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Variant.snapRingToGrid: Ring size must be larger than 2&#39;</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">prevAtom</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">ringAngle</span> <span class="o">=</span> <span class="p">((</span><span class="n">ringSize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="p">)</span><span class="o">/</span><span class="n">ringSize</span>

    <span class="k">if</span> <span class="n">anchor</span> <span class="ow">and</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">ringAtoms</span><span class="p">:</span>
      <span class="n">ringAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">skippedAtom</span> <span class="ow">in</span> <span class="n">skippedAtoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">skippedAtom</span> <span class="ow">in</span> <span class="n">ringAtoms</span><span class="p">:</span>
        <span class="n">ringAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">skippedAtom</span><span class="p">)</span>

    <span class="c1"># Find a suitable angle of the &quot;anchor atom&quot; relative to a neighbour outside the ring.</span>
    <span class="k">if</span> <span class="n">anchor</span><span class="p">:</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="n">anchor</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">neighbours</span>
      <span class="n">nNeighbours</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
          <span class="n">nNeighbours</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="n">angle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ringAngle</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">nNeighbours</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">/=</span> <span class="n">nNeighbours</span> <span class="o">-</span> <span class="mi">2</span>
      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angle</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">prevAngle</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">ring</span> <span class="ow">and</span> <span class="n">neighbour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ringAtoms</span><span class="p">:</span>
            <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour</span><span class="p">))</span>
            <span class="k">break</span>
          <span class="k">if</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">skippedAtoms</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">getAtomDist</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">bondLength</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
              <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">neighbour</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">prevAngle</span><span class="p">:</span>
            <span class="n">prevAngle</span> <span class="o">=</span> <span class="mi">330</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="n">ringAtoms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">prevAngle</span> <span class="o">=</span> <span class="mi">330</span>
      <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">ringAngle</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skippedAtoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">skippedNeighbours</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">&amp;</span> <span class="n">skippedAtoms</span>

      <span class="k">if</span> <span class="n">skippedNeighbours</span><span class="p">:</span>
        <span class="n">sortedSkippedAtoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">skippedAtoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="c1">#        for skippedNeighbour in skippedNeighbours:</span>
<span class="c1">#          if sortedSkippedAtoms.index(skippedNeighbour) != 0:</span>
<span class="c1">#            ringAngle = -ringAngle</span>
<span class="c1">#            break</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">ringAngle</span><span class="p">,</span>  <span class="n">ringAngle</span><span class="p">]</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">prevAtom</span> <span class="o">=</span> <span class="n">atom</span>
    <span class="k">while</span> <span class="n">ringAtoms</span><span class="p">:</span>
      <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prevAtom</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">&amp;</span> <span class="n">ring</span> <span class="o">-</span> <span class="n">skippedAtoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ringAtoms</span><span class="p">:</span>
            <span class="k">break</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ringAtoms</span><span class="p">:</span>
          <span class="n">neighbours</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">&amp;</span> <span class="n">ring</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">neighbour</span> <span class="o">=</span> <span class="n">neighbours</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">nextNeighbours</span> <span class="o">=</span> <span class="n">neighbour</span><span class="o">.</span><span class="n">neighbours</span> <span class="o">&amp;</span> <span class="n">ring</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ringAtoms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">nextNeighbours</span><span class="p">:</span>
              <span class="n">nextNeighbours</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">nextNeighbour</span> <span class="o">=</span> <span class="n">nextNeighbours</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">prevAtom</span> <span class="o">=</span> <span class="n">neighbour</span>
            <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">neighbour</span><span class="o">.</span><span class="n">getBondAngle</span><span class="p">(</span><span class="n">nextNeighbour</span><span class="p">))</span>
      <span class="n">oldPrevAngle</span> <span class="o">=</span> <span class="n">prevAngle</span>
      <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">snapToGrid</span><span class="p">(</span><span class="n">prevAtom</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">,</span> <span class="n">prevAngle</span><span class="p">,</span> <span class="n">angles</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">anchor</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">((</span><span class="n">oldPrevAngle</span> <span class="o">+</span> <span class="n">ringAngle</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="n">prevAngle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">ringAngle</span><span class="p">]</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">ringAngle</span><span class="p">]</span>
      <span class="n">prevAngle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">+</span> <span class="n">prevAngle</span><span class="p">)</span><span class="o">%</span><span class="mi">360</span>
      <span class="n">ringAtoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
      <span class="n">prevAtom</span> <span class="o">=</span> <span class="n">atom</span></div>

<div class="viewcode-block" id="Variant.autoNameAtoms"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Variant.autoNameAtoms">[docs]</a>  <span class="k">def</span> <span class="nf">autoNameAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtoms</span><span class="p">):</span>

    <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span>
    <span class="n">nonH</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">varAtoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="n">LINK</span><span class="p">)]</span>
    <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">varAtoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">nonH</span><span class="p">:</span>
      <span class="n">nAtoms</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">nPrev</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="n">nonH</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">atom</span><span class="p">,])</span>
      <span class="n">orderList</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">]</span>

      <span class="k">while</span> <span class="n">nAtoms</span> <span class="o">!=</span> <span class="n">nPrev</span><span class="p">:</span>
        <span class="n">nPrev</span> <span class="o">=</span> <span class="n">nAtoms</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">atomB</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atomB</span><span class="o">.</span><span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="n">LINK</span><span class="p">):</span>
              <span class="k">continue</span>

            <span class="k">if</span> <span class="n">atomB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
              <span class="n">orderList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>
              <span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>

        <span class="n">nAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderList</span><span class="p">):</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s1">&#39;@</span><span class="si">%d%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

      <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">orderList</span><span class="p">:</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

        <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hydrogens</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">):</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s1">&#39;@</span><span class="si">%d%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atomB</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atomB</span><span class="o">.</span><span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="n">LINK</span><span class="p">):</span>
            <span class="k">continue</span>

          <span class="n">totalH</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atomB</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>

          <span class="n">name</span> <span class="o">=</span> <span class="n">nameBase</span> <span class="o">=</span> <span class="s1">&#39;H</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomB</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">atomB</span><span class="o">.</span><span class="n">element</span><span class="p">):])</span>

          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">totalH</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">totalH</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nameBase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
              <span class="n">name</span> <span class="o">=</span> <span class="n">nameBase</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">number</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">name</span> <span class="o">=</span> <span class="n">nameBase</span> <span class="o">+</span> <span class="n">number</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
              <span class="n">number</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">nameBase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">nameBase</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">number</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">nameBase</span> <span class="o">+</span> <span class="n">number</span>
              <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="n">atomB</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
              <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;H</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomB</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
              <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;H</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
          <span class="k">break</span></div></div>

<span class="c1">################</span>


<div class="viewcode-block" id="Atom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Atom">[docs]</a><span class="k">class</span> <span class="nc">Atom</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">isVariable</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">compound</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isVariable</span> <span class="o">=</span> <span class="n">isVariable</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">baseValences</span> <span class="o">=</span> <span class="n">ELEMENT_DATA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>  <span class="n">ELEMENT_DEFAULT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">defaultName</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">if</span> <span class="n">isVariable</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">variant</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>


  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">return</span> <span class="s1">&#39;&lt;Atom </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Atom.setName"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Atom.setName">[docs]</a>  <span class="k">def</span> <span class="nf">setName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">prevName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultName</span><span class="p">()</span>
      <span class="c1">#raise Exception(&#39;Atom name &quot;%s&quot; already in use&#39; % name)</span>
      <span class="c1">#return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="n">var</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">variant</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">neighbours</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isVariable</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">prevName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">:</span>
      <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;Atom Dict missing&quot;</span><span class="p">,</span> <span class="n">prevName</span><span class="p">)</span>
      <span class="n">nn</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
      <span class="n">nn</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">prevName</span><span class="p">]</span>

    <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;prev&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;next&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
          <span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s1">&#39;link_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Atom.defaultName"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Atom.defaultName">[docs]</a>  <span class="k">def</span> <span class="nf">defaultName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">atoms</span>
    <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">])</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">return</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Atom.setBaseValences"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Atom.setBaseValences">[docs]</a>  <span class="k">def</span> <span class="nf">setBaseValences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">baseValences</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span></div>

<div class="viewcode-block" id="Atom.setVariable"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Atom.setVariable">[docs]</a>  <span class="k">def</span> <span class="nf">setVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>


    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">isVariable</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isVariable</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">isVariable</span> <span class="o">=</span> <span class="n">value</span>
      <span class="c1"># if it is variable need duplicate vars +/- this atom</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">isLabile</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="k">for</span> <span class="n">varA</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="c1"># If a var has this atom</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varA</span><span class="o">.</span><span class="n">atomDict</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">varAtomA</span> <span class="o">=</span> <span class="n">varA</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="p">[</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">va</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>

        <span class="c1"># make a copy without this atom</span>
        <span class="n">atomsA</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varA</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>
        <span class="n">atomsA</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">varAtomA</span><span class="p">)</span>


        <span class="n">var</span> <span class="o">=</span> <span class="n">Variant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="p">,</span> <span class="n">atomsA</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">atomB</span> <span class="ow">in</span> <span class="n">bound</span><span class="p">:</span>
          <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">varAtomB</span><span class="p">:</span>
            <span class="n">varAtomB</span><span class="o">.</span><span class="n">setCharge</span><span class="p">(</span><span class="n">varAtomB</span><span class="o">.</span><span class="n">charge</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">isVariable</span> <span class="o">=</span> <span class="n">value</span>
      <span class="c1"># If it is not variable only need the one eqiv var with this atom</span>

      <span class="k">for</span> <span class="n">varA</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
        <span class="c1"># If a var has this atom</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varA</span><span class="o">.</span><span class="n">atomDict</span><span class="p">:</span>
          <span class="k">continue</span>


        <span class="c1"># Remove other vars that are the same, save this atom</span>
        <span class="n">atomsA</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varA</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span>
        <span class="n">atomsA</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">varB</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">varB</span> <span class="ow">is</span> <span class="n">varA</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">atomsB</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">varB</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span>

          <span class="k">if</span> <span class="n">atomsA</span> <span class="o">==</span> <span class="n">atomsB</span><span class="p">:</span>
            <span class="n">varB</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>
      <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">]</span>
      <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span></div>

<div class="viewcode-block" id="Atom.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Atom.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">:</span>
      <span class="c1"># Delete all vars with same link</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># deletes bonds and updates any neighbours</span>

    <span class="n">compound</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">compound</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
      <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span>

    <span class="k">del</span> <span class="bp">self</span></div></div>

<div class="viewcode-block" id="AtomGroup"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomGroup">[docs]</a><span class="k">class</span> <span class="nc">AtomGroup</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">varAtoms</span><span class="p">,</span> <span class="n">groupType</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="n">compound</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">groupType</span> <span class="o">=</span> <span class="n">groupType</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subGroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">variant</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">existing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">orphaned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">:</span>
        <span class="n">existing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">orphaned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">varAtom</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
            <span class="n">varAtoms2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">varAtoms2</span><span class="p">):</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtoms2</span> <span class="o">-</span> <span class="n">varAtoms</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="n">varAtoms</span> <span class="o">-</span> <span class="n">varAtoms2</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">existing</span><span class="p">:</span>
      <span class="c1"># Check union with single other group; replace any</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">!=</span> <span class="n">AROMATIC</span><span class="p">:</span>
          <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

      <span class="c1"># Subgroups only allowed if fill current completely</span>
      <span class="c1"># Subgroups must be defined first</span>
      <span class="k">elif</span> <span class="n">orphaned</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">!=</span> <span class="n">AROMATIC</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subGroups</span> <span class="o">=</span> <span class="n">existing</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">atomGroups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">atomGroups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
          <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">varAtomA</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">varAtomB</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">):</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;aromatic&#39;</span>

        <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

<div class="viewcode-block" id="AtomGroup.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.AtomGroup.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
      <span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">atomGroups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">atomGroups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">varAtomA</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">varAtomB</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">):</span>
          <span class="n">bond</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">varAtom</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="k">del</span> <span class="bp">self</span></div></div>


<span class="n">BOND_TYPE_VALENCES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;single&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;aromatic&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quadruple&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                      <span class="s1">&#39;triple&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;singleplanar&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dative&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

<span class="n">BOND_STEREO_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="c1"># tetrahedral</span>
                    <span class="mi">5</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># trigonal bipyramidal</span>
                    <span class="mi">6</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># octahedral</span>
                    <span class="mi">7</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># pentagonal bipyramidal</span>
                    <span class="p">}</span>
<div class="viewcode-block" id="Bond"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond">[docs]</a><span class="k">class</span> <span class="nc">Bond</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtoms</span><span class="p">,</span> <span class="n">bondType</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="n">varAtoms</span>

    <span class="k">if</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">variant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">variant</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;VarAtom mismatch in bond formation </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varAtomA</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">variant</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">compound</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">varAtomA</span> <span class="k">if</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;dative&#39;</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">bondType</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">removeDuplicates</span><span class="p">()</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span> <span class="c1"># Need this before auto varing</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="n">variant</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateNeighbours</span><span class="p">()</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateNeighbours</span><span class="p">()</span>

    <span class="n">nameA</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">name</span>
    <span class="n">nameB</span> <span class="o">=</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">name</span>
    <span class="n">atomA</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">atom</span>
    <span class="n">atomB</span> <span class="o">=</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">atom</span>

    <span class="n">elementA</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">element</span>
    <span class="n">elementB</span> <span class="o">=</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">element</span>

    <span class="n">nameLink</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">nameH</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">elementA</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nameA</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">):</span>
      <span class="n">nameLink</span> <span class="o">=</span> <span class="p">(</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">elementB</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nameB</span> <span class="o">==</span> <span class="n">LINK</span><span class="p">):</span>
      <span class="n">nameLink</span> <span class="o">=</span> <span class="p">(</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">varAtomA</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">elementA</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nameB</span><span class="p">:</span>
      <span class="n">nameH</span> <span class="o">=</span> <span class="p">(</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">elementB</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nameA</span><span class="p">:</span>
      <span class="n">nameH</span> <span class="o">=</span> <span class="p">(</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">varAtomA</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nameLink</span><span class="p">:</span>
      <span class="n">varAtom1</span><span class="p">,</span> <span class="n">varAtom2</span> <span class="o">=</span> <span class="n">nameLink</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">varAtom2</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">varAtom2</span><span class="o">.</span><span class="n">element</span>
      <span class="n">varAtom1</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LINK</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">nameH</span> <span class="ow">and</span> <span class="n">autoVar</span><span class="p">:</span>
      <span class="n">varAtom1</span><span class="p">,</span> <span class="n">varAtom2</span> <span class="o">=</span> <span class="n">nameH</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">varAtom2</span><span class="o">.</span><span class="n">name</span>
      <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">varAtom2</span><span class="o">.</span><span class="n">element</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">varAtom2</span><span class="o">.</span><span class="n">element</span><span class="p">):]</span>

      <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">firstName</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">varAtom2</span><span class="o">.</span><span class="n">neighbours</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">variant</span><span class="o">.</span><span class="n">autoNameAtoms</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">autoVar</span><span class="p">:</span>
      <span class="n">failedVars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">variant</span><span class="p">:</span>
          <span class="n">atomDict</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span>
          <span class="n">varAtomC</span> <span class="o">=</span> <span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomA</span><span class="p">)</span>
          <span class="n">varAtomD</span> <span class="o">=</span> <span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomB</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">varAtomC</span> <span class="ow">and</span> <span class="n">varAtomD</span><span class="p">:</span> <span class="c1"># Both exist in this var</span>
            <span class="n">getBond</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getBond</span><span class="p">(</span><span class="n">varAtomC</span><span class="p">,</span> <span class="n">varAtomD</span><span class="p">,</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">getBond</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">varAtomC</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varAtomD</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
                <span class="n">failedVars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

          <span class="k">elif</span> <span class="n">varAtomC</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">varAtomC</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
            <span class="n">varAtomC</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span> <span class="c1"># E.g. proton not in this link var</span>

          <span class="k">elif</span> <span class="n">varAtomD</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">varAtomD</span><span class="o">.</span><span class="n">neighbours</span><span class="p">:</span>
            <span class="n">varAtomD</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span> <span class="c1"># E.g. proton not in this link var</span>

      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">failedVars</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">elementA</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span> <span class="ow">and</span> <span class="n">elementB</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkCarboxylVar</span><span class="p">(</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">elementB</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span> <span class="ow">and</span> <span class="n">elementA</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkCarboxylVar</span><span class="p">(</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">varAtomA</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">elementA</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="n">elementB</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkAmineVar</span><span class="p">(</span><span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">elementB</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="n">elementA</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkAmineVar</span><span class="p">(</span><span class="n">varAtomB</span><span class="p">,</span> <span class="n">varAtomA</span><span class="p">)</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>


  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">aNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">]</span>
    <span class="n">aNames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">aName</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aNames</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&lt;Bond </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span><span class="p">)</span>

<div class="viewcode-block" id="Bond.checkCarboxylVar"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond.checkCarboxylVar">[docs]</a>  <span class="k">def</span> <span class="nf">checkCarboxylVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oAtom</span><span class="p">,</span> <span class="n">hAtom</span><span class="p">):</span>

    <span class="n">neighbours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">oAtom</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>
    <span class="n">neighbours</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">hAtom</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">neighbours</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">other</span> <span class="o">=</span> <span class="n">neighbours</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
      <span class="n">neighbours2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">neighbours</span><span class="p">)</span>
      <span class="n">neighbours2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">oAtom</span><span class="p">)</span>
      <span class="n">variant</span> <span class="o">=</span> <span class="n">oAtom</span><span class="o">.</span><span class="n">variant</span>
      <span class="n">compound</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">compound</span>
      <span class="n">bondsC</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">neighbours2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
          <span class="n">bondsO</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
          <span class="n">common</span> <span class="o">=</span> <span class="n">bondsO</span> <span class="o">&amp;</span> <span class="n">bondsC</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">common</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">bondType</span> <span class="o">!=</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

          <span class="n">hAtom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">setVariable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

          <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">oAtom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
              <span class="n">varAtom</span><span class="o">.</span><span class="n">setCharge</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

          <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
            <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bond.checkAmineVar"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond.checkAmineVar">[docs]</a>  <span class="k">def</span> <span class="nf">checkAmineVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nAtom</span><span class="p">,</span> <span class="n">hAtom</span><span class="p">):</span>

    <span class="n">neighbours</span> <span class="o">=</span> <span class="n">nAtom</span><span class="o">.</span><span class="n">neighbours</span>
    <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">neighbours</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hydrogens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
      <span class="n">compound</span> <span class="o">=</span> <span class="n">nAtom</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">compound</span>
      <span class="n">hAtom</span><span class="o">.</span><span class="n">setVariable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">nAtom</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
          <span class="n">varAtom</span><span class="o">.</span><span class="n">setCharge</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updatePolyLink</span><span class="p">()</span>
        <span class="n">var</span><span class="o">.</span><span class="n">updateDescriptor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bond.setBondType"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond.setBondType">[docs]</a>  <span class="k">def</span> <span class="nf">setBondType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bondType</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">bondType</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span><span class="p">:</span>
      <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
      <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span>
      <span class="n">nValPrev</span> <span class="o">=</span> <span class="n">BOND_TYPE_VALENCES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bondType</span><span class="p">]</span>
      <span class="n">nValNext</span> <span class="o">=</span> <span class="n">BOND_TYPE_VALENCES</span><span class="p">[</span><span class="n">bondType</span><span class="p">]</span>
      <span class="n">added</span> <span class="o">=</span> <span class="n">nValNext</span> <span class="o">-</span> <span class="n">nValPrev</span>

      <span class="k">while</span> <span class="n">added</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
          <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="p">:</span>
          <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">added</span> <span class="o">-=</span> <span class="mi">1</span>

      <span class="k">while</span> <span class="n">added</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">added</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="k">if</span> <span class="n">bondType</span> <span class="o">==</span> <span class="s1">&#39;dative&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="n">varAtomA</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">varAtomB</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">varAtomA</span>

      <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
        <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
        <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="n">bondType</span></div>

<div class="viewcode-block" id="Bond.removeDuplicates"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond.removeDuplicates">[docs]</a>  <span class="k">def</span> <span class="nf">removeDuplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span>

    <span class="n">nVals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BOND_TYPE_VALENCES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bondType</span><span class="p">])</span>

    <span class="c1"># Could trap errors here</span>

    <span class="n">commonBonds</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">bonds</span> <span class="o">&amp;</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">bonds</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">commonBonds</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">commonBonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bond</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
          <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bond.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">compound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">varAtomA</span><span class="p">,</span> <span class="n">varAtomB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span>
    <span class="n">varAtomA</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">freeValences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="n">varAtomA</span><span class="o">.</span><span class="n">atomGroups</span> <span class="o">|</span> <span class="n">varAtomB</span><span class="o">.</span><span class="n">atomGroups</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">:</span>
          <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateValences</span><span class="p">()</span>

    <span class="n">varAtomA</span><span class="o">.</span><span class="n">updateNeighbours</span><span class="p">()</span>
    <span class="n">varAtomB</span><span class="o">.</span><span class="n">updateNeighbours</span><span class="p">()</span>

    <span class="k">del</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Bond.deleteAll"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Bond.deleteAll">[docs]</a>  <span class="k">def</span> <span class="nf">deleteAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span>

    <span class="n">delBonds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">atoms2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">va</span><span class="o">.</span><span class="n">atom</span> <span class="k">for</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">atoms</span> <span class="o">==</span> <span class="n">atoms2</span><span class="p">:</span>
          <span class="n">delBonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">delBonds</span><span class="p">:</span>

      <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="loadCompoundPickle"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.loadCompoundPickle">[docs]</a><span class="k">def</span> <span class="nf">loadCompoundPickle</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
 <span class="k">pass</span></div>

<div class="viewcode-block" id="Compound"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound">[docs]</a><span class="k">class</span> <span class="nc">Compound</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">variants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atomGroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">defaultVars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ccpCode</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ccpMolType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Compound.hasSubGraph"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.hasSubGraph">[docs]</a>  <span class="k">def</span> <span class="nf">hasSubGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">fragement</span><span class="p">):</span>

    <span class="k">pass</span></div>

<div class="viewcode-block" id="Compound.getAtom"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.getAtom">[docs]</a>  <span class="k">def</span> <span class="nf">getAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">isVariable</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>


    <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="p">:</span>
      <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">isVariable</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;atomatom&#39;</span><span class="p">,</span><span class="n">atom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atom</span></div>

<div class="viewcode-block" id="Compound.getCcpMolType"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.getCcpMolType">[docs]</a>  <span class="k">def</span> <span class="nf">getCcpMolType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="Compound.save"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.save">[docs]</a>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="Compound.delete"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">):</span>
      <span class="n">var</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">del</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Compound.center"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.center">[docs]</a>  <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">origin</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
      <span class="n">x0</span><span class="p">,</span>  <span class="n">y0</span><span class="p">,</span>  <span class="n">z0</span> <span class="o">=</span> <span class="n">origin</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">z0</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">xs</span> <span class="o">+=</span> <span class="n">x1</span>
        <span class="n">ys</span> <span class="o">+=</span> <span class="n">y1</span>
        <span class="n">zs</span> <span class="o">+=</span> <span class="n">z1</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
      <span class="n">xs</span> <span class="o">/=</span> <span class="n">n</span>
      <span class="n">ys</span> <span class="o">/=</span> <span class="n">n</span>
      <span class="n">zs</span> <span class="o">/=</span> <span class="n">n</span>

      <span class="n">xs</span> <span class="o">-=</span> <span class="n">x0</span>
      <span class="n">ys</span> <span class="o">-=</span> <span class="n">y0</span>
      <span class="n">zs</span> <span class="o">-=</span> <span class="n">z0</span>

      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
          <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

          <span class="n">x1</span> <span class="o">-=</span> <span class="n">xs</span>
          <span class="n">y1</span> <span class="o">-=</span> <span class="n">ys</span>
          <span class="n">z1</span> <span class="o">-=</span> <span class="n">zs</span>

          <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span></div>

<div class="viewcode-block" id="Compound.setAromatic"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.setAromatic">[docs]</a>  <span class="k">def</span> <span class="nf">setAromatic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unsetAromatic</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

    <span class="c1"># TBD check ring</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="bp">None</span><span class="p">,])</span>

      <span class="n">rings</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">getRings</span><span class="p">(</span><span class="n">varAtoms</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">varAtoms2</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
        <span class="n">AtomGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtoms2</span><span class="p">,</span> <span class="n">AROMATIC</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.unsetAromatic"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.unsetAromatic">[docs]</a>  <span class="k">def</span> <span class="nf">unsetAromatic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

   <span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">])</span>

   <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
     <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
       <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">AROMATIC</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
         <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>


<div class="viewcode-block" id="Compound.setAtomGroup"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.setAtomGroup">[docs]</a>  <span class="k">def</span> <span class="nf">setAtomGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">groupType</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unsetAtomGroup</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">groupType</span><span class="p">)</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
      <span class="n">atomsB</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="n">elem</span><span class="p">]</span>
      <span class="n">nAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomsB</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">nAtoms</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">continue</span>

      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="n">varAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atomsB</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">varAtoms</span><span class="p">:</span>
          <span class="c1"># This var cannot support group</span>
          <span class="k">continue</span>

        <span class="n">AtomGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varAtoms</span><span class="p">,</span> <span class="n">groupType</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.unsetAtomGroup"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.unsetAtomGroup">[docs]</a>  <span class="k">def</span> <span class="nf">unsetAtomGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">groupType</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">groupType</span> <span class="o">==</span> <span class="n">groupType</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="Compound.setAtomsEquivalent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.setAtomsEquivalent">[docs]</a>  <span class="k">def</span> <span class="nf">setAtomsEquivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setAtomGroup</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">EQUIVALENT</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.setAtomsProchiral"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.setAtomsProchiral">[docs]</a>  <span class="k">def</span> <span class="nf">setAtomsProchiral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setAtomGroup</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">PROCHIRAL</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.unsetAtomsEquivalent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.unsetAtomsEquivalent">[docs]</a>  <span class="k">def</span> <span class="nf">unsetAtomsEquivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unsetAtomGroup</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">EQUIVALENT</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.unsetAtomsProchiral"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.unsetAtomsProchiral">[docs]</a>  <span class="k">def</span> <span class="nf">unsetAtomsProchiral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unsetAtomGroup</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">PROCHIRAL</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compound.resolveTempAtomNames"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.resolveTempAtomNames">[docs]</a>  <span class="k">def</span> <span class="nf">resolveTempAtomNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomDict</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">renameVarAtoms</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
            <span class="n">renameVarAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varAtom</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">varAtom</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

      <span class="k">if</span> <span class="n">renameVarAtoms</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">autoNameAtoms</span><span class="p">(</span><span class="n">renameVarAtoms</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.copyVarAtoms"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.copyVarAtoms">[docs]</a>  <span class="k">def</span> <span class="nf">copyVarAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">atoms</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="n">var</span><span class="o">.</span><span class="n">copyAtoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">resolveTempAtomNames</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Compound.copyCompound"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.copyCompound">[docs]</a>  <span class="k">def</span> <span class="nf">copyCompound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compoundB</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">refVar</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">coords</span><span class="p">:</span>
      <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">atomVarsA</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">]</span>
    <span class="n">polyLinks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">polyLink</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="s1">&#39;free&#39;</span><span class="p">])</span>
    <span class="n">newRefAtoms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">atomsA</span><span class="p">,</span> <span class="n">varA</span> <span class="ow">in</span> <span class="n">atomVarsA</span><span class="p">:</span>

      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">varB</span> <span class="ow">in</span> <span class="n">compoundB</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">polyLinks</span> <span class="ow">and</span> <span class="p">(</span><span class="n">varB</span><span class="o">.</span><span class="n">polyLink</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="s1">&#39;free&#39;</span><span class="p">)):</span>
          <span class="k">continue</span>

        <span class="n">atomsB</span> <span class="o">=</span> <span class="n">varB</span><span class="o">.</span><span class="n">varAtoms</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">refVar</span> <span class="ow">and</span> <span class="n">varA</span> <span class="ow">is</span> <span class="n">refVar</span><span class="p">:</span>
            <span class="n">newRefAtoms</span> <span class="o">=</span> <span class="n">varA</span><span class="o">.</span><span class="n">copyAtoms</span><span class="p">(</span><span class="n">atomsB</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

          <span class="k">else</span><span class="p">:</span>
            <span class="n">varA</span><span class="o">.</span><span class="n">copyAtoms</span><span class="p">(</span><span class="n">atomsB</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="n">varC</span> <span class="o">=</span> <span class="n">Variant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomsA</span><span class="p">)</span>
          <span class="n">varC</span><span class="o">.</span><span class="n">copyAtoms</span><span class="p">(</span><span class="n">atomsB</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">resolveTempAtomNames</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">isModified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">newRefAtoms</span></div>

<div class="viewcode-block" id="Compound.addHydrogens"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.widgets.html#ccpn.ui.gui.widgets.CompoundView.Compound.addHydrogens">[docs]</a>  <span class="k">def</span> <span class="nf">addHydrogens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">hydrogens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">varAtom</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">varAtoms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="n">newAtoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">varAtom</span><span class="o">.</span><span class="n">coords</span>

        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varAtom</span><span class="o">.</span><span class="n">freeValences</span><span class="p">):</span>
          <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">34.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
          <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">34.0</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

          <span class="n">masterAtom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
          <span class="n">VarAtom</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">masterAtom</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="c1"># All vars</span>

          <span class="n">hydrogen</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">atomDict</span><span class="p">[</span><span class="n">masterAtom</span><span class="p">]</span>
          <span class="n">newAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hydrogen</span><span class="p">)</span>
          <span class="n">hydrogens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hydrogen</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">newAtom</span> <span class="ow">in</span> <span class="n">newAtoms</span><span class="p">:</span>
          <span class="n">Bond</span><span class="p">((</span><span class="n">varAtom</span><span class="p">,</span> <span class="n">newAtom</span><span class="p">),</span> <span class="n">autoVar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hydrogens</span></div></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Application</span> <span class="kn">import</span> <span class="n">TestApplication</span>
  <span class="kn">from</span> <span class="nn">ccpn.ui.gui.popups.Dialog</span> <span class="kn">import</span> <span class="n">CcpnDialog</span>

  <span class="n">app</span> <span class="o">=</span> <span class="n">TestApplication</span><span class="p">()</span>
  <span class="n">popup</span> <span class="o">=</span> <span class="n">CcpnDialog</span><span class="p">(</span><span class="n">windowTitle</span><span class="o">=</span><span class="s1">&#39;Test Table&#39;</span><span class="p">,</span> <span class="n">setLayout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="n">smilesText</span> <span class="o">=</span> <span class="s1">&#39;CC(=O)OC1=CC=CC=C1C(=O)O&#39;</span>
  <span class="n">compoundView</span> <span class="o">=</span> <span class="n">CompoundView</span><span class="p">(</span><span class="n">popup</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smilesText</span><span class="p">,)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">compoundView</span><span class="o">.</span><span class="n">compound</span>
  <span class="k">print</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">groupType</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">])</span>
  <span class="k">print</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">varAtoms</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">])</span>
  <span class="k">print</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">subGroups</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">atomGroups</span><span class="p">])</span>
  <span class="n">popup</span><span class="o">.</span><span class="n">getLayout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">compoundView</span><span class="p">)</span>
  <span class="n">compoundView</span><span class="o">.</span><span class="n">centerView</span><span class="p">()</span>
  <span class="n">compoundView</span><span class="o">.</span><span class="n">updateAll</span><span class="p">()</span>

  <span class="n">popup</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  <span class="n">popup</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
  <span class="n">app</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>