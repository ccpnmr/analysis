<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.util.Common &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.util.Common</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Miscellaneous common utilities</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>


<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:32:57 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b3 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:41 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>
<span class="sd">&quot;&quot;&quot;Common utilities</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Constants</span>


<span class="c1"># Max value used for random integer. Set to be expressible as a signed 32-bit integer.</span>
<span class="n">maxRandomInt</span> <span class="o">=</span> <span class="mi">2000000000</span>

<span class="n">WHITESPACE_AND_NULL</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x0b</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x0c</span><span class="s1">&#39;</span><span class="p">}</span>

<span class="c1"># valid characters for file names</span>
<span class="c1"># NB string.ascii_letters and string.digits are not compatible</span>
<span class="c1"># with Python 2.1 (used in ObjectDomain)</span>
<span class="n">defaultFileNameChar</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
<span class="n">separatorFileNameChar</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
<span class="n">validFileNamePartChars</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>
                          <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;</span>
                          <span class="o">+</span> <span class="n">defaultFileNameChar</span><span class="p">)</span>
<span class="n">validCcpnFileNameChars</span> <span class="o">=</span> <span class="n">validFileNamePartChars</span> <span class="o">+</span> <span class="s1">&#39;-.&#39;</span> <span class="o">+</span> <span class="n">separatorFileNameChar</span>


<span class="c1"># # Not used - Rasmus 20/2/2017</span>
<span class="c1"># Sentinel = collections.namedtuple(&#39;Sentinel&#39;, [&#39;value&#39;])</span>


<div class="viewcode-block" id="convertStringToFileName"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.convertStringToFileName">[docs]</a><span class="k">def</span> <span class="nf">convertStringToFileName</span><span class="p">(</span><span class="n">fileNameString</span><span class="p">,</span> <span class="n">validChars</span><span class="o">=</span><span class="n">validCcpnFileNameChars</span><span class="p">,</span>
                            <span class="n">defaultChar</span><span class="o">=</span><span class="n">defaultFileNameChar</span><span class="p">):</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fileNameString</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validChars</span><span class="p">:</span>
            <span class="n">ll</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultChar</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span></div>


<div class="viewcode-block" id="getCcpFileString"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.getCcpFileString">[docs]</a><span class="k">def</span> <span class="nf">getCcpFileString</span><span class="p">(</span><span class="n">fileNameString</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes an input string to the one used for a component of file names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">convertStringToFileName</span><span class="p">(</span><span class="n">fileNameString</span><span class="p">,</span> <span class="n">validFileNamePartChars</span><span class="p">,</span>
                                   <span class="n">defaultFileNameChar</span><span class="p">)</span></div>


<div class="viewcode-block" id="incrementName"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.incrementName">[docs]</a><span class="k">def</span> <span class="nf">incrementName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add &#39;_1&#39; to name or change suffix &#39;_n&#39; to &#39;_(n+1) &quot;&quot;&quot;</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_1&#39;</span></div>


<div class="viewcode-block" id="recursiveImport"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.recursiveImport">[docs]</a><span class="k">def</span> <span class="nf">recursiveImport</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">modname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ignoreModules</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; recursively import all .py files</span>
<span class="sd">    (not starting with &#39;__&#39; and not containing internal &#39;.&#39; in their name)</span>
<span class="sd">    from directory dirname and all its subdirectories, provided they</span>
<span class="sd">    contain &#39;__init__.py&#39;</span>
<span class="sd">    Serves to check that files compile without error</span>

<span class="sd">    modname is the module name (dot-separated) corresponding to the directory</span>
<span class="sd">    dirName.</span>
<span class="sd">    If modname is None, dirname must be on the pythonPath</span>

<span class="sd">    Note that there are potential problems if the files we want are not</span>
<span class="sd">    the ones encountered first on the pythonPath</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Must be imported here, as entire file must be importable from Python 2 NefIo</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Path</span>

    <span class="n">listdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">listdir</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;__init__.py&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">ignoreModules</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ignoreModules</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">modname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>

    <span class="n">listdir2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">:</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">head</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ignoreModules</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.py&#39;</span> <span class="ow">and</span> <span class="n">head</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">listdir2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># import directory and underlying directories</span>
    <span class="k">if</span> <span class="n">modname</span><span class="p">:</span>
        <span class="c1"># Note that files is never empty, so module is lowest level not toplevel</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[</span><span class="n">ff</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># We want log output, not an Exception in all cases here</span>
                <span class="kn">from</span> <span class="nn">.Logging</span> <span class="kn">import</span> <span class="n">getLogger</span>

                <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Import failed for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">ff</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir2</span><span class="p">:</span>
        <span class="n">newdirname</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">joinPath</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newdirname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">recursiveImport</span><span class="p">(</span><span class="n">newdirname</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignoreModules</span><span class="p">)</span></div>


<div class="viewcode-block" id="isWindowsOS"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.isWindowsOS">[docs]</a><span class="k">def</span> <span class="nf">isWindowsOS</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span></div>


<div class="viewcode-block" id="parseSequenceCode"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.parseSequenceCode">[docs]</a><span class="k">def</span> <span class="nf">parseSequenceCode</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;split sequence code into (seqCode,seqInsertCode, offset) tuple&quot;&quot;&quot;</span>

    <span class="c1"># sequenceCodePattern = re.compile(&#39;(\d+)?(.*?)(\+\d+|\-\d+)?$&#39;)</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">sequenceCodePattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># special case: entire string matches offset modifier and is misread</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>  <span class="c1"># None or an integer</span>
            <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Text string, possibly empty</span>
            <span class="n">tt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>  <span class="c1"># None or an integer</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="splitIntFromChars"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.splitIntFromChars">[docs]</a><span class="k">def</span> <span class="nf">splitIntFromChars</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert a string with a leading integer optionally followed by characters</span>
<span class="sd">    into an (integer,string) tuple&quot;&quot;&quot;</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">ii</span><span class="p">:]</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">number</span><span class="p">,</span> <span class="n">chars</span></div>


<div class="viewcode-block" id="dictionaryProduct"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.dictionaryProduct">[docs]</a><span class="k">def</span> <span class="nf">dictionaryProduct</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;multiply input {a:x}, {b:y} to result {(a,b):x*y} dictionary&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">dict1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">dict2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[(</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">*</span> <span class="n">val2</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="uniquify"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.uniquify">[docs]</a><span class="k">def</span> <span class="nf">uniquify</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get list of unique elements in sequence, in order of first appearance&quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequence</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span></div>


<div class="viewcode-block" id="isClose"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.isClose">[docs]</a><span class="k">def</span> <span class="nf">isClose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">relTolerance</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">absTolerance</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Are a and b identical within reasonable floating point tolerance?</span>
<span class="sd">    Uses sum of relative (relTolerance) and absolute (absTolerance) difference</span>

<span class="sd">    Inspired by numpy.isclose()&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">absTolerance</span> <span class="o">+</span> <span class="n">relTolerance</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span></div>

<div class="viewcode-block" id="isIterable"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.isIterable">[docs]</a><span class="k">def</span> <span class="nf">isIterable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s2">&quot;Returns True if obj is iterable&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">iter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="getTimeStamp"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.getTimeStamp">[docs]</a><span class="k">def</span> <span class="nf">getTimeStamp</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get iso-formtted timestamp&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span></div>


<div class="viewcode-block" id="getUuid"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.getUuid">[docs]</a><span class="k">def</span> <span class="nf">getUuid</span><span class="p">(</span><span class="n">programName</span><span class="p">,</span> <span class="n">timeStamp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get UUid following the NEF convention&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeStamp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">getTimeStamp</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">programName</span><span class="p">,</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxRandomInt</span><span class="p">))</span></div>


<div class="viewcode-block" id="name2IsotopeCode"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.name2IsotopeCode">[docs]</a><span class="k">def</span> <span class="nf">name2IsotopeCode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get standard isotope code matching atom name or axisCode string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Constants</span><span class="o">.</span><span class="n">isotopeRecords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="isotopeCode2Nucleus"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.isotopeCode2Nucleus">[docs]</a><span class="k">def</span> <span class="nf">isotopeCode2Nucleus</span><span class="p">(</span><span class="n">isotopeCode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isotopeCode</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">record</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">isotopeRecords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">isotopeCode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span></div>

    <span class="c1"># for tag,val in sorted(Constants.DEFAULT_ISOTOPE_DICT.items()):</span>
    <span class="c1">#   if val == isotopeCode:</span>
    <span class="c1">#     return tag</span>
    <span class="c1"># else:</span>
    <span class="c1">#   return None</span>


<div class="viewcode-block" id="name2ElementSymbol"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.name2ElementSymbol">[docs]</a><span class="k">def</span> <span class="nf">name2ElementSymbol</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get standard element symbol matching name or axisCode</span>

<span class="sd">    NB, the first letter takes precedence, so e.g. &#39;CD&#39; returns &#39;C&#39; (carbon)</span>
<span class="sd">    rather than &#39;CD&#39; (Cadmium)&quot;&quot;&quot;</span>

    <span class="c1"># NB, We deliberately do NOT use &#39;value in Constants.DEFAULT_ISOTOPE_DICT&#39;</span>
    <span class="c1"># We want to avoid elements that are in the dict but have value None.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">Constants</span><span class="o">.</span><span class="n">isotopeRecords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">break</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="bp">None</span></div>


<div class="viewcode-block" id="checkIsotope"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.checkIsotope">[docs]</a><span class="k">def</span> <span class="nf">checkIsotope</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert isotope specifier string to most probable isotope code - defaulting to &#39;1H&#39;</span>

<span class="sd">    This function is intended for external format isotope specifications, *not* for</span>
<span class="sd">    axisCodes or atom names, hence the difference to name2ElementSymbol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">defaultIsotope</span> <span class="o">=</span> <span class="s1">&#39;1H&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">defaultIsotope</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Constants</span><span class="o">.</span><span class="n">isotopeRecords</span><span class="p">:</span>
        <span class="c1"># Superfluous but should speed things up</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">for</span> <span class="n">isotopeCode</span> <span class="ow">in</span> <span class="n">Constants</span><span class="o">.</span><span class="n">isotopeRecords</span><span class="p">:</span>
        <span class="c1"># NB checking this first means that e.g. &#39;H13C&#39; returns &#39;13C&#39; rather than &#39;1H&#39;</span>
        <span class="k">if</span> <span class="n">isotopeCode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">isotopeCode</span>

    <span class="c1"># NB order of checking means that e.g. &#39;CA&#39; returns Calcium rather than Carbon</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
              <span class="ow">or</span> <span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
            <span class="c1"># special case</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;2H&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">defaultIsotope</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="axisCodeMatch"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.axisCodeMatch">[docs]</a><span class="k">def</span> <span class="nf">axisCodeMatch</span><span class="p">(</span><span class="n">axisCode</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get refAxisCode that best matches axisCode &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">indx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_axisCodeMapIndices</span><span class="p">([</span><span class="n">axisCode</span><span class="p">],</span> <span class="n">refAxisCodes</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We have a match</span>
            <span class="k">return</span> <span class="n">refAxisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></div>


<div class="viewcode-block" id="axisCodeMapping"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.axisCodeMapping">[docs]</a><span class="k">def</span> <span class="nf">axisCodeMapping</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get {axisCode:refAxisCode} mapping dictionary</span>
<span class="sd">    all axisCodes must match, or dictionary will be empty</span>
<span class="sd">    NB a series of single-letter axisCodes (e.g. &#39;N&#39;, &#39;HCN&#39;) can be passed in as a string&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mapIndices</span> <span class="o">=</span> <span class="n">_axisCodeMapIndices</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mapIndices</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">refAxisCode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refAxisCodes</span><span class="p">):</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">mapIndices</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">indx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">axisCodes</span><span class="p">[</span><span class="n">indx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">refAxisCode</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="reorder"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.reorder">[docs]</a><span class="k">def</span> <span class="nf">reorder</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;reorder values in axisCode order to refAxisCode order, by matching axisCodes</span>

<span class="sd">    NB, the result will be the length of refAxisCodes, with additional Nones inserted</span>
<span class="sd">    if this is longer than the values.</span>

<span class="sd">    NB if there are multiple matches possible, one is chosen by heuristics&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length mismatch between </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">axisCodes</span><span class="p">))</span>
    <span class="n">remapping</span> <span class="o">=</span> <span class="n">_axisCodeMapIndices</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remapping</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="k">def</span> <span class="nf">_axisCodeMapIndices</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get mapping tuple so that axisCodes[result[ii]] matches refAxisCodes[ii]</span>
<span class="sd">    all axisCodes must match, but result can contain None if refAxisCodes is longer</span>
<span class="sd">    if axisCodes contain duplicates, you will get one of possible matches&quot;&quot;&quot;</span>

    <span class="c1">#CCPNINTERNAL - used in multiple places to map display order and spectrum order</span>

    <span class="n">lenDifference</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">refAxisCodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lenDifference</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># Set up match matrix</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">axisCodes</span><span class="p">:</span>
        <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">axisCodesCompare</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mismatch</span><span class="o">=-</span><span class="mi">999999</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">refAxisCodes</span><span class="p">])</span>

    <span class="c1"># find best mapping</span>
    <span class="n">maxScore</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axisCodes</span><span class="p">)</span>
    <span class="n">bestscore</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">results</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">)))</span> <span class="o">+</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">lenDifference</span>
    <span class="k">for</span> <span class="n">permutation</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">permutation</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">jj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="n">matches</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">bestscore</span><span class="p">:</span>
            <span class="n">bestscore</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">permutation</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">==</span> <span class="n">maxScore</span><span class="p">:</span>
            <span class="c1"># it cannot get any higher</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permutation</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1"># Pick the first of the equally good matches as the default answer</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Multiple matches - try to select on pairs of bound atoms</span>
            <span class="c1"># NB we do not need to be rigorous as this is only used to resolve ambiguity</span>
            <span class="c1"># NB this is necessary to do a correct match of e.g. Hc, Ch, H to Hc, Hc1, Ch1</span>
            <span class="n">boundCodeDicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tryCodes</span> <span class="ow">in</span> <span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">:</span>
                <span class="n">boundCodes</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">boundCodeDicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boundCodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tryCodes</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tryCodes</span><span class="p">)):</span>
                            <span class="n">code2</span> <span class="o">=</span> <span class="n">tryCodes</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">code2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                                        <span class="n">code2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">code2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                                        <span class="n">code</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="n">code2</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
                                    <span class="c1"># Matches pair of bound atoms - e.g. Hc1, Ch1</span>
                                    <span class="n">boundCodes</span><span class="p">[</span><span class="n">tryCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tryCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code2</span><span class="p">)</span>
                                    <span class="n">boundCodes</span><span class="p">[</span><span class="n">tryCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tryCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">boundCodeDicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">boundCodeDicts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># bound pairs on both sides - check for matching pairs</span>
                <span class="n">bestscore</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">permutation</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">boundCodeDicts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="n">permutation</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">==</span> <span class="n">boundCodeDicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">permutation</span><span class="p">[</span><span class="n">idx2</span><span class="p">]):</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">bestscore</span><span class="p">:</span>
                        <span class="n">bestscore</span> <span class="o">=</span> <span class="n">score</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">permutation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="axisCodesCompare"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.axisCodesCompare">[docs]</a><span class="k">def</span> <span class="nf">axisCodesCompare</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">code2</span><span class="p">,</span> <span class="n">mismatch</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score code, code2 for matching. Score is length of common prefix, or &#39;mismatch&#39; if None&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">code2</span> <span class="ow">or</span> <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">code2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">mismatch</span>
    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">code2</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
        <span class="c1"># &#39;fidX...&#39; &#39;delay&#39;, etc. must match exactly</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">mismatch</span>
    <span class="k">elif</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MQ&#39;</span><span class="p">):</span>
        <span class="c1"># &#39;MQxy...&#39; must match exactly</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">mismatch</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">code2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">code2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="c1"># Match against a single upper-case letter on one side. Always OK</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Partial match of two strings with at least two significant chars each</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">code2</span><span class="p">)))</span> <span class="ow">or</span> <span class="n">mismatch</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Only first letter matches, second does not</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Hn&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">code2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Hcn&#39;</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Hcn&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">code2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Hn&#39;</span><span class="p">))):</span>
                <span class="c1"># Hn must matches Hcn</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># except as above we need at least two char match</span>

                <span class="c1"># TODO:ED check matching codes when each contain more than 1 character; dict?</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1">#mismatch</span>
        <span class="k">elif</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;J&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># &#39;Jab&#39; matches &#39;J&#39; or &#39;Jab...&#39;, but NOT &#39;Ja...&#39;</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">mismatch</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">score</span></div>


<div class="viewcode-block" id="doAxisCodesMatch"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.doAxisCodesMatch">[docs]</a><span class="k">def</span> <span class="nf">doAxisCodesMatch</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if axisCodes match refAxisCodes else False&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">refAxisCodes</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">axisCodesCompare</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">refAxisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="stringifier"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.stringifier">[docs]</a><span class="k">def</span> <span class="nf">stringifier</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get stringifier function, that will format an object x according to</span>

<span class="sd">    &lt;str(x): field1=x.field1, field2=x.field2, ...&gt;</span>

<span class="sd">    All floating point values encountered will be formatted according to floatFormat&quot;&quot;&quot;</span>

    <span class="c1"># Unfortunately necessary as this package must be read from v2io</span>
    <span class="c1"># and python 2 does not have keyword-only arguments</span>
    <span class="c1"># What we should do is the function definition below:</span>
    <span class="c1"># def stringifier(*fields, floatFormat=None):</span>
    <span class="k">if</span> <span class="s1">&#39;floatFormat&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">floatFormat</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;floatFormat&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">floatFormat</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown options: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

    <span class="c1"># Proper body of function starts here</span>
    <span class="k">if</span> <span class="n">floatFormat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># use default formatter, avoiding continuous creation of new ones</span>
        <span class="n">localFormatter</span> <span class="o">=</span> <span class="n">stdLocalFormatter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">localFormatter</span> <span class="o">=</span> <span class="n">LocalFormatter</span><span class="p">(</span><span class="n">overrideFloatFormat</span><span class="o">=</span><span class="n">floatFormat</span><span class="p">)</span>

    <span class="n">fieldFormats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="c1"># String will be &#39;field1={_obj.field1}</span>
        <span class="n">fieldFormats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{0}={{_obj.{0}!r}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

    <span class="n">formatString</span> <span class="o">=</span> <span class="s1">&#39;&lt;{_obj.pid!s}| &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fieldFormats</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">formatter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">localFormatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_string</span><span class="o">=</span><span class="n">formatString</span><span class="p">,</span> <span class="n">_obj</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">formatter</span></div>


<div class="viewcode-block" id="contains_whitespace"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.contains_whitespace">[docs]</a><span class="k">def</span> <span class="nf">contains_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">]</span></div>


<div class="viewcode-block" id="resetSerial"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.resetSerial">[docs]</a><span class="k">def</span> <span class="nf">resetSerial</span><span class="p">(</span><span class="n">apiObject</span><span class="p">,</span> <span class="n">newSerial</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ADVANCED Reset serial of object to newSerial, resetting parent link</span>
<span class="sd">    and the nextSerial of the parent.</span>

<span class="sd">    Raises ValueError for objects that do not have a serial</span>
<span class="sd">    (or, more precisely, where the _wrappedData does not have a serial).&quot;&quot;&quot;</span>

    <span class="c1"># NB, needed both from V2 NefIo and V3, hence putting nit here,</span>
    <span class="c1"># even though it uses V2 objects</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">apiObject</span><span class="p">,</span> <span class="s1">&#39;serial&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot reset serial, </span><span class="si">%s</span><span class="s2"> does not have a &#39;serial&#39; attribute&quot;</span>
                         <span class="o">%</span> <span class="n">apiObject</span><span class="p">)</span>
    <span class="n">downlink</span> <span class="o">=</span> <span class="n">apiObject</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_metaclass</span><span class="o">.</span><span class="n">parentRole</span><span class="o">.</span><span class="n">otherRole</span><span class="o">.</span><span class="n">name</span>

    <span class="n">parentDict</span> <span class="o">=</span> <span class="n">apiObject</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">__dict__</span>
    <span class="n">downdict</span> <span class="o">=</span> <span class="n">parentDict</span><span class="p">[</span><span class="n">downlink</span><span class="p">]</span>
    <span class="n">oldSerial</span> <span class="o">=</span> <span class="n">apiObject</span><span class="o">.</span><span class="n">serial</span>
    <span class="n">serialDict</span> <span class="o">=</span> <span class="n">parentDict</span><span class="p">[</span><span class="s1">&#39;_serialDict&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">newSerial</span> <span class="o">==</span> <span class="n">oldSerial</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">elif</span> <span class="n">newSerial</span> <span class="ow">in</span> <span class="n">downdict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot reset serial to </span><span class="si">%s</span><span class="s2"> - value already in use&quot;</span> <span class="o">%</span> <span class="n">newSerial</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxSerial</span> <span class="o">=</span> <span class="n">serialDict</span><span class="p">[</span><span class="n">downlink</span><span class="p">]</span>
        <span class="n">apiObject</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newSerial</span>
        <span class="n">downdict</span><span class="p">[</span><span class="n">newSerial</span><span class="p">]</span> <span class="o">=</span> <span class="n">apiObject</span>
        <span class="k">del</span> <span class="n">downdict</span><span class="p">[</span><span class="n">oldSerial</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">newSerial</span> <span class="o">&gt;</span> <span class="n">maxSerial</span><span class="p">:</span>
            <span class="n">serialDict</span><span class="p">[</span><span class="n">downlink</span><span class="p">]</span> <span class="o">=</span> <span class="n">newSerial</span>
        <span class="k">elif</span> <span class="n">oldSerial</span> <span class="o">==</span> <span class="n">maxSerial</span><span class="p">:</span>
            <span class="n">serialDict</span><span class="p">[</span><span class="n">downlink</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">downdict</span><span class="p">)</span></div>


<div class="viewcode-block" id="makeIterableList"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.makeIterableList">[docs]</a><span class="k">def</span> <span class="nf">makeIterableList</span><span class="p">(</span><span class="n">inList</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take a list of lists and concatenate into a single list.</span>
<span class="sd">    Remove any None&#39;s from the list</span>
<span class="sd">    :param inList:</span>
<span class="sd">    :return single list:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inList</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inList</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inList</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">inList</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">inList</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<span class="k">def</span> <span class="nf">_truncateText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="s1">&#39; , &#39;</span><span class="p">,</span> <span class="n">maxWords</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="s2">&quot;Splits the text by the given splitter. If more then maxWords, it return the maxWord plus dots, otherwise just the text&quot;</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">splitter</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxWords</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">splitter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[:</span><span class="n">maxWords</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">_traverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tree_types</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    used to flat the state in a long list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tree_types</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subvalue</span> <span class="ow">in</span> <span class="n">_traverse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tree_types</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">subvalue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_getChildren</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walks in a tree like obj and put all children/parents in list of list eg: [[Parent,child...,],...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">att</span><span class="o">.</span><span class="n">_pluralLinkName</span><span class="p">):</span>
                <span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_getChildren</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">path</span><span class="p">[:]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">children</span>


<div class="viewcode-block" id="LocalFormatter"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.LocalFormatter">[docs]</a><span class="k">class</span> <span class="nc">LocalFormatter</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overrides the string formatter to change the float formatting&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overrideFloatFormat</span><span class="o">=</span><span class="s1">&#39;.6g&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocalFormatter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overrideFloatFormat</span> <span class="o">=</span> <span class="n">overrideFloatFormat</span>

<div class="viewcode-block" id="LocalFormatter.convert_field"><a class="viewcode-back" href="../../../ccpn/ccpn.util.html#ccpn.util.Common.LocalFormatter.convert_field">[docs]</a>    <span class="k">def</span> <span class="nf">convert_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">conversion</span><span class="p">):</span>
        <span class="c1"># do any conversion on the resulting object</span>
        <span class="c1"># NB, conversion parameter is not used</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overrideFloatFormat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># Deliberate. We do NOT want to catch tuple subtypes here</span>
            <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;,)&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;)&#39;</span>
            <span class="k">return</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_field</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">end</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="c1"># Deliberate. We do NOT want to catch list subtypes here</span>
            <span class="k">return</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_field</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
        <span class="k">elif</span> <span class="n">conversion</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">conversion</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">conversion</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">conversion</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ascii</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="c1"># Likely we are in Python 2.</span>
                <span class="c1"># As ascii behaves like Python 2 repr, this should be the correct workaround</span>
                <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown conversion specifier {0!s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conversion</span><span class="p">))</span></div></div>


<span class="n">stdLocalFormatter</span> <span class="o">=</span> <span class="n">LocalFormatter</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>