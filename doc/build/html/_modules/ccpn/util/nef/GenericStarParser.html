<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.util.nef.GenericStarParser &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.util.nef.GenericStarParser</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Star-type file parser, agnostic between cif, mmcif, star, nef, etc.</span>

<span class="sd">Returns a nested data structure that matches the file,</span>
<span class="sd">with DataExtent, DataBlock, SaveFrame, and Loop objects.</span>
<span class="sd">Additional support for distinguishing between None, True, False, and int/float values</span>
<span class="sd">and the strings that match their representations.</span>

<span class="sd">For behaviour better suited to NmrStar and NEf see ./StarIo.py</span>

<span class="sd">Usage:</span>

<span class="sd">parse(text, mode) to parse a text representation to nested objects</span>

<span class="sd">parseFile(fileName, mode) to load and parse a file</span>

<span class="sd">starObject.toString() will convert any object in the object structure,</span>
<span class="sd">complete with contents, to a string that can then be written to file.</span>


<span class="sd">Reading behaviour</span>
<span class="sd">=================</span>

<span class="sd">follows the specification in</span>
<span class="sd">International Tables for Crystallography volume G section 2.1</span>
<span class="sd">with the following exceptions:</span>

<span class="sd">  - Nested loops are NOT supported</span>

<span class="sd">  - Global blocks are treated as simple data blocks. If the first data block in the file is</span>
<span class="sd">    a global_, is is named &#39;global_&#39;; globals elsewhere are named global_1, global_2, etc.</span>
<span class="sd">    This may cause trouble downstream if there is a DataBlock named e.g. &#39;data_global_1&#39;.</span>

<span class="sd">The object structure returned is:</span>

<span class="sd">::</span>

<span class="sd">    DataExtent</span>
<span class="sd">      DataBlock</span>
<span class="sd">        Item</span>
<span class="sd">        Loop</span>
<span class="sd">        SaveFrame</span>
<span class="sd">          Item</span>
<span class="sd">          Loop</span>

<span class="sd">DataExtent, DataBlock and SaveFrame are Python OrderedDict with an additional &#39;name&#39; attribute</span>
<span class="sd">DataBlocks and SaveFrames are entered in their container using their name as the key.</span>

<span class="sd">Loop is an object with a &#39;columns&#39; list, a &#39;data&#39; list-of-row-OrderedDict, and a name attribute</span>
<span class="sd">set equal to the name of the first column. A loop is entered in its container under each</span>
<span class="sd">column name, so that e.g. aSaveFrame[&#39;_Loopx.loopcol1&#39;] and aSaveFrame[&#39;_Loopx.loopcol2&#39;] both</span>
<span class="sd">exist and both correspond to the same loop object.</span>

<span class="sd">Items are entered as a string key - string value pair.</span>

<span class="sd">All tags are preserved &#39;as is&#39; (i.e. without stripping leading &#39;_&#39;, &#39;data_&#39;, or &#39;save_&#39;),</span>
<span class="sd">basically to avoid the theoretical risk that a SaveFrame name might clash with</span>
<span class="sd">an item name or loop column, or a DataBlock with a Global. Duplicate tags raise an error.</span>

<span class="sd">Quoted values are returned as str,</span>
<span class="sd">whereas unquoted values are returned as a str subtype UnquotedValue(str)</span>
<span class="sd">This allows later distinction between null, unknown, saveframe_reference and the</span>
<span class="sd">equivalent quoted strings.</span>



<span class="sd">Writing behaviour</span>
<span class="sd">=================</span>

<span class="sd">follows the specification in</span>
<span class="sd">International Tables for Crystallography volume G section 2.1</span>
<span class="sd">with the following exceptions and additions.</span>

<span class="sd">  - Strings of type UnquotedValue are written as-is, without quoting them.</span>

<span class="sd">  - Note that e.g. &#39; &quot;say&quot; &#39;what&#39;?&#39;    or    &quot; &#39;say&quot;&#39;&quot;what&quot;?&quot; are</span>
<span class="sd">    valid quoted strings according to the standard, since  the end-quote marker</span>
<span class="sd">    is a quotation marker FOLLOWED BY WHITESPACE.</span>

<span class="sd">  - Strings that cannot be quoted on one line (e.g.   &#39;&#39;&#39; &quot;say&quot; &#39;what&#39; &#39;&#39;&#39;   )</span>
<span class="sd">    are converted to  multiline strings by appending a newline</span>

<span class="sd">  - Strings with internal linebreaks but no terminal linebreak</span>
<span class="sd">    are converted by appending a linebreak</span>

<span class="sd">  - Strings that cannot be quoted as multiline strings because they contain</span>
<span class="sd">    a line starting with &#39;;&#39; are converted by prepending a space (&#39; &#39;) to each line</span>

<span class="sd">  - Values None, True, False, NaN, Infinity and -Infinity are converted to</span>
<span class="sd">    UNQUOTED strings &#39;.&#39;, &#39;true&#39;, &#39;false&#39;, &#39;NaN&#39;, &#39;Infinity&#39; and &#39;-Infinity&#39;, respectively.</span>

<span class="sd">  - Normal (not unquoted) strings that evaluate to a float are written in quotes.</span>
<span class="sd">    Also the literal strings &#39;.&#39;, &#39;true&#39;, &#39;false&#39;, &#39;NaN&#39;, &#39;Infinity&#39; and &#39;-Infinity&#39;</span>
<span class="sd">    are always written in quotes.</span>

<span class="sd">    This makes it possible (but NOT mandatory) to distinguish the null,  boolean and float values</span>
<span class="sd">    from the equivalent strings</span>

<span class="sd">The toString functions in this module will work with loop rows implemented as</span>
<span class="sd">either tuples, lists, or OrderedDicts, and accept an optional tag prefix for</span>
<span class="sd">DataBlocks, SaveFrames, and Loops, to prepend to item and column names.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># NB must be Python 2.7 and 3.x compatible</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>


<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:33:01 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b3 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: Rasmus Fogh $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:41 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Python 3</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># python 2.7</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip_longest</span> <span class="k">as</span> <span class="n">zip_longest</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">getTokenIterator</span>

<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_MULTILINE</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_COMMENT</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_GLOBAL</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_SAVE_FRAME</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_SAVE_FRAME_REF</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_LOOP_STOP</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_DATA_BLOCK</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_LOOP</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_BAD_CONSTRUCT</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_DATA_NAME</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_SQUOTE_STRING</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_DQUOTE_STRING</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_NULL</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_UNKNOWN</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_SQUARE_BRACKET</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_STRING</span>
<span class="kn">from</span> <span class="nn">.StarTokeniser</span> <span class="kn">import</span> <span class="n">TOKEN_BAD_TOKEN</span>


<span class="c1"># Constants for converting values to string</span>
<span class="c1"># NB - these can be overridden by pre-converting all values to</span>
<span class="c1"># UnquotedValue containing proper quotation marks</span>
<span class="n">_quoteStartStrings</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;save_&#39;</span><span class="p">,</span> <span class="s1">&#39;loop_&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_&#39;</span><span class="p">,</span> <span class="s1">&#39;data_&#39;</span><span class="p">,</span> <span class="s1">&#39;global_&#39;</span>
    <span class="p">]</span>
<span class="n">startComment</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>
<span class="n">_quoteStrings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="s1">&#39;Infinity&#39;</span><span class="p">,</span> <span class="s1">&#39;-Infinity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
<span class="n">_containsWhiteSpace</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
<span class="n">_containsSingleEndQuote</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&#39;\s&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
<span class="n">_containsDoubleEndQuote</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&quot;\s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
<span class="c1"># _floatingPointFormat = &#39;%.3g&#39;</span>
<span class="n">_floatingPointFormat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.10g</span><span class="s1">&#39;</span>
<span class="n">_defaultIndent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">_defaultSeparator</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">2</span>

<span class="c1"># Options corresponding to the supported parser modes: &#39;standard&#39;, &#39;lenient&#39;, &#39;strict&#39;, and &#39;IUCr&#39;</span>
<span class="n">_parserModeOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lenient&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;enforceSaveFrameStop&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;enforceLoopStop&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;padIncompleteLoops&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">&#39;allowSquareBracketStrings&#39;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="s1">&#39;strict&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;enforceSaveFrameStop&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">&#39;enforceLoopStop&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">&#39;padIncompleteLoops&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;allowSquareBracketStrings&#39;</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
    <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;enforceSaveFrameStop&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">&#39;enforceLoopStop&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;padIncompleteLoops&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;allowSquareBracketStrings&#39;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
    <span class="s1">&#39;IUCr&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;enforceSaveFrameStop&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">&#39;enforceLoopStop&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;padIncompleteLoops&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s1">&#39;allowSquareBracketStrings&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
    <span class="p">}</span>


<div class="viewcode-block" id="parse"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.parse">[docs]</a><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse STAR text string &#39;text&#39;.</span>
<span class="sd">    Standard settings allow skipping &#39;stop_&#39; tags and strings starting with &#39;[&#39; or &#39;]&#39;,</span>
<span class="sd">    but require &#39;save_&#39; termination of SaveFrames and throw an error if the number of loop</span>
<span class="sd">    values do not match the number of columns.</span>

<span class="sd">    &#39;strict&#39; and &#39;lenient&#39; modes are available; mode=&#39;IUCr&#39; follows the IUCr standard, which</span>
<span class="sd">    is like standard except that strings starting with &#39;[&#39; and &#39;]&#39; are not allowed</span>

<span class="sd">    See GeneralStarParser class for details and control of individual settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_parserModeOptions</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;illegal parser mode : </span><span class="si">%s</span><span class="s2">  Only modes &#39;lenient&#39;, &#39;strict&#39;, &#39;standard&#39;, &#39;IUCr&#39; allowed&quot;</span>
                <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">GeneralStarParser</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span></div>


<div class="viewcode-block" id="parseFile"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.parseFile">[docs]</a><span class="k">def</span> <span class="nf">parseFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load generic STAR file and parse the contents&quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">parse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnquotedValue"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.UnquotedValue">[docs]</a><span class="k">class</span> <span class="nc">UnquotedValue</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A plain string - the only difference is the type: &#39;UnquotedValue&#39;.</span>
<span class="sd">    Used to distinguish values from STAR files that were not quoted.</span>
<span class="sd">    STAR special values (like null,  unknown, ...) are only recognised if unquoted strings&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="c1"># Constants for I/O of standard values</span>
<span class="n">NULLSTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">UNKNOWNSTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
<span class="n">TRUESTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">)</span>
<span class="n">FALSESTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">)</span>
<span class="n">NANSTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>
<span class="n">PLUSINFINITYSTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;Infinity&#39;</span><span class="p">)</span>
<span class="n">MINUSINFINITYSTRING</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="s1">&#39;-Infinity&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="StarSyntaxError"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.StarSyntaxError">[docs]</a><span class="k">class</span> <span class="nc">StarSyntaxError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="NamedOrderedDict"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.NamedOrderedDict">[docs]</a><span class="k">class</span> <span class="nc">NamedOrderedDict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NamedOrderedDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(name=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">, name=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">tt</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="NamedOrderedDict.addItem"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.NamedOrderedDict.addItem">[docs]</a>    <span class="k">def</span> <span class="nf">addItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: duplicate key name </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="StarContainer"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.StarContainer">[docs]</a><span class="k">class</span> <span class="nc">StarContainer</span><span class="p">(</span><span class="n">NamedOrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DataBlock or SaveFrame containing items and loops&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StarContainer.multiColumnValues"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.StarContainer.multiColumnValues">[docs]</a>    <span class="k">def</span> <span class="nf">multiColumnValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get tuple of orderedDict of values for columns.</span>
<span class="sd">        Will work whether columns are in a loop or single values</span>
<span class="sd">        If columns match a single loop or nothing, return the loop data.</span>
<span class="sd">        Otherwise return a tuple with a single OrderedDict.</span>
<span class="sd">        If no column matches return None</span>
<span class="sd">        If columns match more than one loop throw an error&quot;&quot;&quot;</span>
        <span class="n">valueDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
        <span class="n">testSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">valueDict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">testSet</span><span class="p">:</span>
            <span class="c1"># None of the column names match</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Loop</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">testSet</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">testSet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># All columns match a single loop (or nothing) return the loop data</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">testSet</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> columns </span><span class="si">%s</span><span class="s2"> must match either multiple items or a single loop&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No column matches a loop. return a single dict</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">valueDict</span><span class="p">,)</span></div>

    <span class="k">def</span> <span class="nf">_contentToString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">_defaultIndent</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">_defaultSeparator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns content of either DataBlock or SaveFrame as a string&quot;&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Set item formatting</span>
        <span class="c1"># tagwidth = max(len(tt[0]) for tt in self.items()</span>
        <span class="c1">#                if isinstance(tt[1], str) and &#39;\n&#39; not in tt[1])</span>
        <span class="n">tagwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">)),</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tagPrefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagPrefix</span>
        <span class="k">if</span> <span class="n">tagPrefix</span><span class="p">:</span>
            <span class="c1"># tagwidth += len(tagPrefix)</span>
            <span class="n">itemFormat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s%%</span><span class="s1">-</span><span class="si">%s</span><span class="s1">s</span><span class="si">%s%%</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">tagPrefix</span><span class="p">,</span> <span class="n">tagwidth</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itemFormat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%%</span><span class="s1">-</span><span class="si">%s</span><span class="s1">s</span><span class="si">%s%%</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">tagwidth</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>

        <span class="c1"># convert contents</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">SaveFrame</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span> <span class="o">+</span> <span class="n">_defaultIndent</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Loop</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="c1"># NB Loops can be contained in self once for each column.</span>
                    <span class="c1"># This if statement ensures we only get them once</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itemFormat</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">valueToStarString</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataExtent"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.DataExtent">[docs]</a><span class="k">class</span> <span class="nc">DataExtent</span><span class="p">(</span><span class="n">NamedOrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Top level container for general STAR object tree&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Root&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataExtent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DataExtent.toString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.DataExtent.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">_defaultSeparator</span><span class="p">):</span>
        <span class="n">blockSeparator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n\n\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">blockSeparator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div></div>


<span class="c1"># An object that cannot appear inside a Star file. Used as sentinel</span>
<span class="n">sentinel</span> <span class="o">=</span> <span class="n">DataExtent</span><span class="p">()</span>


<span class="c1"># # Not Python 2 compatible</span>
<span class="c1"># # We insert these afterwards as we want the functions at the top of the file</span>
<span class="c1"># # but can only annotate after DataExtent is created</span>
<span class="c1"># parse.__annotations__[&#39;return&#39;] = DataExtent</span>
<span class="c1"># parseFile.__annotations__[&#39;return&#39;] = DataExtent</span>

<div class="viewcode-block" id="DataBlock"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.DataBlock">[docs]</a><span class="k">class</span> <span class="nc">DataBlock</span><span class="p">(</span><span class="n">StarContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DataBlock for general STAR object tree&quot;&quot;&quot;</span>

    <span class="c1"># Tag prefix for string output, which is prefixed to item names before writing.</span>
    <span class="c1"># Can be set in subclass instances</span>
    <span class="n">tagPrefix</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="DataBlock.toString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.DataBlock.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">_defaultSeparator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert DataBlock to string, for writing&quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data_&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1"># End of </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contentToString</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span>
                                               <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SaveFrame"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.SaveFrame">[docs]</a><span class="k">class</span> <span class="nc">SaveFrame</span><span class="p">(</span><span class="n">StarContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SaveFrame for general STAR object tree&quot;&quot;&quot;</span>

    <span class="c1"># Tag prefix for string output, which is prefixed to item names before writing.</span>
    <span class="c1"># Can be set in subclass instances</span>
    <span class="n">tagPrefix</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="SaveFrame.toString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.SaveFrame.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">_defaultIndent</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">_defaultSeparator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert SaveFrame to string, for writing&quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;save_&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s%s</span><span class="se">\n\n</span><span class="si">%s%s</span><span class="s1">save_</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contentToString</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span> <span class="o">+</span> <span class="n">_defaultIndent</span><span class="p">,</span>
                                                       <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">),</span> <span class="n">indent</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="LoopRow"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.LoopRow">[docs]</a><span class="k">class</span> <span class="nc">LoopRow</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loop row - OrderedDict with additional functionality&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns value of attribute &#39;name&#39;, or None if attribute is not defined</span>

<span class="sd">        Will treat a series of attributes &#39;foo_1&#39;, &#39;foo_2&#39;, &#39;foo_3&#39;, etc. as a single</span>
<span class="sd">        tuple attribute &#39;foo&#39; &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_1&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">extractMatchingNameSequence</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets attribute &#39;name&#39; to value</span>

<span class="sd">        Will treat a series of attributes &#39;foo_1&#39;, &#39;foo_2&#39;, &#39;foo_3&#39;, etc. as a single</span>
<span class="sd">        tuple attribute &#39;foo&#39; &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_1&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">extractMatchingNameSequence</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tag </span><span class="si">%s</span><span class="s2">, values </span><span class="si">%s</span><span class="s2"> do not match columns: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no attribute(s) matching </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span></div>


<div class="viewcode-block" id="Loop"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.Loop">[docs]</a><span class="k">class</span> <span class="nc">Loop</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Loop for general STAR object tree</span>
<span class="sd">    Attributes are:</span>

<span class="sd">    - name: string</span>

<span class="sd">    - columns:  List of string column headers</span>

<span class="sd">    - data: List-of-rows, where rows are OrderedDicts &quot;&quot;&quot;</span>

    <span class="c1"># Tag prefix for string output, which is prefixed to column names before writing.</span>
    <span class="c1"># Can be set in subclass instances.</span>
    <span class="n">tagPrefix</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
            <span class="c1"># print (&#39;@~~@~&#39;, type(columns), list(columns), list(columns) == list(x for x in columns))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Column names&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>

<div class="viewcode-block" id="Loop.newRow"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.Loop.newRow">[docs]</a>    <span class="k">def</span> <span class="nf">newRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add new row, initialised from values&quot;&quot;&quot;</span>

        <span class="c1"># Use internal attribute for speed, columns do not change</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>

        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">LoopRow</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal fields in row input: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                 <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">LoopRow</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Row passed </span><span class="si">%s</span><span class="s2"> values for </span><span class="si">%s</span><span class="s2"> columns&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">LoopRow</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span></div>

<div class="viewcode-block" id="Loop.addColumn"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.Loop.addColumn">[docs]</a>    <span class="k">def</span> <span class="nf">addColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columnName</span><span class="p">,</span> <span class="n">paddingValue</span><span class="o">=</span><span class="n">sentinel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add new column to loop. if paddingValue is set, including to None, rows with None&quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>
        <span class="k">if</span> <span class="n">columnName</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: duplicate column name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columnName</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">paddingValue</span> <span class="ow">is</span> <span class="n">sentinel</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Cannot add columns when loop contains data&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columnName</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">columnName</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddingValue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columnName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Loop.removeColumn"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.Loop.removeColumn">[docs]</a>    <span class="k">def</span> <span class="nf">removeColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columnName</span><span class="p">,</span> <span class="n">removeData</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove column from loop. Will NOT work properly if called during parsing.&quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>
        <span class="k">if</span> <span class="n">columnName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: column named </span><span class="si">%s</span><span class="s2"> does not exist&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columnName</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">removeData</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">row</span><span class="p">[</span><span class="n">columnName</span><span class="p">]</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">columnName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Cannot remove columns when loop contains data&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">columnName</span><span class="p">)</span></div>

<div class="viewcode-block" id="Loop.toString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.Loop.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">_defaultIndent</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">_defaultSeparator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stringifier function for loop.</span>

<span class="sd">        Accepts (subtypes of) Loop with data as sequence of rows,</span>
<span class="sd">        where rows can be tuples, lists, or OrderedDicts.</span>
<span class="sd">        In all cases the values must be in the order given by the columns attribute&quot;&quot;&quot;</span>

        <span class="c1"># main body format</span>
        <span class="n">lineFormat</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">_defaultIndent</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># Start tag</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;loop_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="c1"># Write column headers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagPrefix</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineFormat</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagPrefix</span> <span class="o">+</span> <span class="n">col</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineFormat</span> <span class="o">%</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>

            <span class="c1"># First convert to strings to get correct columns widths</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">OrderedDict</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="n">valueToStarString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Must be a sequence of some kind. This will break for non-ordered dicts</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="n">valueToStarString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

            <span class="n">columnWidths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-*s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wdth</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">wdth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columnWidths</span><span class="p">))</span>
                <span class="c1"># Remove trailing spaces from last column:</span>
                <span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineFormat</span> <span class="o">%</span>
                             <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
                             <span class="p">)</span>

        <span class="c1"># Add stop_</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;stop_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="valueToStarString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.valueToStarString">[docs]</a><span class="k">def</span> <span class="nf">valueToStarString</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">quoteNumberStrings</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert value to properly quoted STAR string</span>

<span class="sd">    if quoteNumberStrings, strings that evaluate to a float (e.g. &#39;1&#39;, &#39;2.7e5&#39;, ...)</span>
<span class="sd">    are put in quotes&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NULLSTRING</span>

    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TRUESTRING</span>

    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FALSESTRING</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">UnquotedValue</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">NANSTRING</span>

        <span class="k">elif</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PLUSINFINITYSTRING</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MINUSINFINITYSTRING</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_floatingPointFormat</span> <span class="o">%</span> <span class="n">value</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># if quoteNumberStrings is true: quote, depending on content</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">quoteNumberStrings</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">junk</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">matchesNumber</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">matchesNumber</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matchesNumber</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">_containsWhiteSpace</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">matchesNumber</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_quoteStrings</span> <span class="ow">or</span>
                    <span class="n">startComment</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_quoteStartStrings</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">_containsSingleEndQuote</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="c1"># E.g. string like &quot;&quot;&quot; &quot;say&quot; &#39;what&#39;?&quot;&quot;&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">_containsDoubleEndQuote</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="c1"># E.g. string like &quot;&quot;&quot; &#39;say&#39; &quot;what&quot;?&quot;&quot;&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Cannot be quoted on one line (e.g. &quot;&quot;&quot; &#39;say&#39; &quot;what&quot; &quot;&quot;&quot;)</span>
                    <span class="c1"># CHANGE VALUE to make it writable as multiline quote</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="c1"># Multiline quote. Done at the end to allow for modified values</span>
            <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># Fix strings with &#39;;&#39; starting line</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">):</span>
                    <span class="c1"># NB CHANGES VALUE</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">;</span><span class="si">%s</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">; &#39;</span> <span class="o">%</span> <span class="n">value</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="GeneralStarParser"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.GeneralStarParser">[docs]</a><span class="k">class</span> <span class="nc">GeneralStarParser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Parser for text corresponding to a STAR file with one or more data blocks,</span>
<span class="sd">    producing a nested object structure matching the file (see module documentation for details:</span>

<span class="sd">    ::</span>

<span class="sd">      DataExtent</span>
<span class="sd">        DataBlock</span>
<span class="sd">          Loop</span>
<span class="sd">          Item</span>
<span class="sd">        SaveFrame</span>
<span class="sd">          Loop</span>
<span class="sd">          Item</span>

<span class="sd">    Parameters (default values correspond to the International Tables for Crystallography standard):</span>

<span class="sd">    - *text* Text to parse</span>

<span class="sd">    - *enforceSaveFrameStop* : True. Raise an error for missing &#39;save_&#39; terminators - Yes/No</span>

<span class="sd">    - *enforceLoopStop* : False. Raise an error for missing &#39;stop_&#39; terminators - Yes/No</span>

<span class="sd">    - *padIncompleteLoops* : False.  Pad final loop row with &#39;.&#39; for missing values - Yes/No</span>

<span class="sd">    - *allowSquareBracketStrings* : False.  Allow values starting &#39;[&#39; or &#39;]&#39; - Yes/No</span>

<span class="sd">    - *lowerCaseTags* : True. Convert all data and object names to lower case</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">enforceSaveFrameStop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">enforceLoopStop</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">padIncompleteLoops</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allowSquareBracketStrings</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lowerCaseTags</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enforceSaveFrameStop</span> <span class="o">=</span> <span class="n">enforceSaveFrameStop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforceLoopStop</span> <span class="o">=</span> <span class="n">enforceLoopStop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padIncompleteLoops</span> <span class="o">=</span> <span class="n">padIncompleteLoops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowSquareBracketStrings</span> <span class="o">=</span> <span class="n">allowSquareBracketStrings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowerCaseTags</span> <span class="o">=</span> <span class="n">lowerCaseTags</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokeniser</span> <span class="o">=</span> <span class="n">getTokenIterator</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalsCounter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_addDataBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_addSaveFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">SaveFrame</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_closeLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">Loop</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Loop</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Implementation error, loop not correctly put on stack&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Loop stop_ </span><span class="si">%s</span><span class="s2"> outside loop&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="n">columnCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columnCount</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot; loop lacks column names&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="n">columnCount</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">padIncompleteLoops</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING Token </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> is missing </span><span class="si">%s</span><span class="s2"> values. Last row was: </span><span class="si">%s</span><span class="s2">&quot;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                             <span class="n">columnCount</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="n">columnCount</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;loop </span><span class="si">%s</span><span class="s2"> is missing </span><span class="si">%s</span><span class="s2"> values&quot;</span>
                                               <span class="o">%</span> <span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="p">(</span><span class="n">columnCount</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="n">columnCount</span><span class="p">))),</span> <span class="n">value</span><span class="p">)</span>
                            <span class="p">)</span>

            <span class="c1"># Make rows:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">*</span> <span class="n">columnCount</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">NULLSTRING</span><span class="p">):</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">tt</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># empty loops appear here. We allow them, but that could change</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_addLoopField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceLoopStop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Illegal token </span><span class="si">%s</span><span class="s2"> in unclosed loop&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Dataname among loop values. Interpreted as loop stop followed by new item start</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeLoop</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="c1"># name loop after first column</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_processComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Comments are ignored</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_processGlobal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalsCounter</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;global_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalsCounter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globalsCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NB globalsCounter is incremented in _processDataBlock for the first increment</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;global_&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processDataBlock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_processDataBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">globalsCounter</span><span class="p">:</span>
            <span class="c1"># to ensure the name global_ is only used if a global is the first dataBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globalsCounter</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Terminate open elements</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceLoopStop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Loop terminated by </span><span class="si">%s</span><span class="s2"> instead of stop_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Close loop and pop it off the stack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeLoop</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SaveFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceSaveFrameStop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;SaveFrame terminated by </span><span class="si">%s</span><span class="s2"> instead of save_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">DataBlock</span><span class="p">):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Add new DataBlock</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">DataExtent</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowerCaseTags</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addDataBlock</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Parser error at token </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_closeSaveFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

        <span class="n">lowerValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Terminate loop</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceLoopStop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Loop terminated by </span><span class="si">%s</span><span class="s2"> instead of stop_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Close loop and pop it off the stack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeLoop</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># terminate saveframe</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SaveFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lowerValue</span> <span class="o">==</span> <span class="s1">&#39;save_&#39;</span><span class="p">:</span>
                <span class="c1"># Simple terminator. Close save frame</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1">#</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceSaveFrameStop</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;SaveFrame terminated by </span><span class="si">%s</span><span class="s2"> instead of save_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># New saveframe start. We are missing the terminator, but close and continue anyway</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">DataBlock</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lowerValue</span> <span class="o">==</span> <span class="s1">&#39;save_&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; found out of context&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_openSaveFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

        <span class="c1"># Add new SaveFrame</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowerCaseTags</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">DataBlock</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addSaveFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;saveframe start out of context: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_openLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

        <span class="c1"># Terminate open elements</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># NB, nested loops are not supported</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Loop terminated by </span><span class="si">%s</span><span class="s2"> instead of stop_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforceLoopStop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Loop terminated b+y </span><span class="si">%s</span><span class="s2"> instead of stop_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Close loop and pop it off the stack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeLoop</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">SaveFrame</span><span class="p">,</span> <span class="n">DataBlock</span><span class="p">)):</span>
            <span class="c1"># NB Loop naming and adding to container is done when first column name is read</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Loop</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;loop_&#39;</span><span class="p">))</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;loop_ out of context&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_processBadToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Illegal token of type</span><span class="si">% s</span><span class="s2">:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>

<div class="viewcode-block" id="GeneralStarParser.processDataName"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.GeneralStarParser.processDataName">[docs]</a>    <span class="k">def</span> <span class="nf">processDataName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

        <span class="n">useValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowerCaseTags</span> <span class="k">else</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">SaveFrame</span><span class="p">,</span> <span class="n">DataBlock</span><span class="p">)):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">useValue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addLoopField</span><span class="p">(</span><span class="n">useValue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span>
                    <span class="s2">&quot;Found item name </span><span class="si">%s</span><span class="s2">: Must be in DataBlock, SaveFrame, or Loop header)&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="GeneralStarParser.processValue"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.GeneralStarParser.processValue">[docs]</a>    <span class="k">def</span> <span class="nf">processValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Value half of tag, value pair</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">append</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;Data value </span><span class="si">%s</span><span class="s2"> must be in item or loop_&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">,</span>
                                                         <span class="n">value</span><span class="p">))</span>
            <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeneralStarParser.parse"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.GeneralStarParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Speed optimisation:</span>
        <span class="n">processValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processValue</span>

        <span class="c1"># NBNB This list must be in sync with numerical values of tk.type, as returned from the tokeniser</span>
        <span class="n">processFunctions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_SQUOTE_STRING</span><span class="p">]</span> <span class="o">=</span> <span class="n">processValue</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_DQUOTE_STRING</span><span class="p">]</span> <span class="o">=</span> <span class="n">processValue</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_MULTILINE</span><span class="p">]</span> <span class="o">=</span> <span class="n">processValue</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_DATA_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processDataName</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_LOOP</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openLoop</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_LOOP_STOP</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closeLoop</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_COMMENT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processComment</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_GLOBAL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processGlobal</span>
        <span class="n">processFunctions</span><span class="p">[</span><span class="n">TOKEN_DATA_BLOCK</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processDataBlock</span>

        <span class="n">unquotedValueTags</span> <span class="o">=</span> <span class="p">(</span><span class="n">TOKEN_STRING</span><span class="p">,</span> <span class="n">TOKEN_NULL</span><span class="p">,</span> <span class="n">TOKEN_UNKNOWN</span><span class="p">,</span> <span class="n">TOKEN_SAVE_FRAME_REF</span><span class="p">)</span>
        <span class="c1"># quotedValueTags = (TOKEN_SQUOTE_STRING, TOKEN_DQUOTE_STRING, TOKEN_MULTILINE)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">DataExtent</span><span class="p">()</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Token counter</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokeniser</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">typ</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">tk</span>

                <span class="k">if</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">unquotedValueTags</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">UnquotedValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">processValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">processFunctions</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">TOKEN_SAVE_FRAME</span><span class="p">:</span>
                            <span class="c1"># save_ string</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_closeSaveFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_openSaveFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TOKEN_BAD_CONSTRUCT</span><span class="p">,</span> <span class="n">TOKEN_BAD_TOKEN</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_processBadToken</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">TOKEN_SQUARE_BRACKET</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowSquareBracketStrings</span><span class="p">:</span>
                                <span class="n">processValue</span><span class="p">(</span><span class="n">UnquotedValue</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_processBadToken</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="s2">&quot;Unknown token type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">typ</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># End of data - clean up stack</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">StarSyntaxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;File ends with item name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeLoop</span><span class="p">(</span><span class="s1">&#39;&lt;End-of-File&gt;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SaveFrame</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">DataBlock</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">DataExtent</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorMessage</span><span class="p">(</span><span class="s2">&quot;stack not empty at end of file&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;ERROR at token </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">_errorMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make standard error message&quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;Error in context: </span><span class="si">%s</span><span class="s2">, at token </span><span class="si">%s</span><span class="s2">, line: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">lineCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">lineCount</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="c1"># This line contains the current tag - go to the next tag</span>
                    <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                        <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This line contains the last of the tags - it is the line we want</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># nothing found here - try next line</span>
                    <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">tags</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>  <span class="c1">#</span></div>


<div class="viewcode-block" id="extractMatchingNameSequence"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.nef.html#ccpn.util.nef.GenericStarParser.extractMatchingNameSequence">[docs]</a><span class="k">def</span> <span class="nf">extractMatchingNameSequence</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">matchNames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get list of matchNames matching &#39;name_1&#39;, &#39;name_2&#39;, ..., in order.&quot;&quot;&quot;</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">matchNames</span><span class="p">:</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">tag</span><span class="p">))</span>
    <span class="n">ll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">cif</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">cif</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>