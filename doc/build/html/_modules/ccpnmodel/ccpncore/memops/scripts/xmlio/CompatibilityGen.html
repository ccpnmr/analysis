<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module Documentation here</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:33:25 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b5 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:48 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib</span> <span class="kn">import</span> <span class="n">Conversion</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops</span> <span class="kn">import</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.format.xml</span> <span class="kn">import</span> <span class="n">XmlGen</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.metamodel</span> <span class="kn">import</span> <span class="n">Constants</span> <span class="k">as</span> <span class="n">metaConstants</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.metamodel</span> <span class="kn">import</span> <span class="n">MetaModel</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.metamodel</span> <span class="kn">import</span> <span class="n">XmlModelIo</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.metamodel.ModelPortal</span> <span class="kn">import</span> <span class="n">ModelPortal</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.scripts.core</span> <span class="kn">import</span> <span class="n">PyFileModelAdapt</span>

<span class="n">compDataModule</span> <span class="o">=</span> <span class="s1">&#39;ccpnmodel.ccpncore.memops.format.compatibility&#39;</span>
<span class="n">defaultInfoFile</span> <span class="o">=</span> <span class="s1">&#39;MapInfo.py&#39;</span>

<span class="n">implTemplate</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metaConstants</span><span class="o">.</span><span class="n">modellingPackageName</span><span class="p">,</span>
                              <span class="n">metaConstants</span><span class="o">.</span><span class="n">implementationPackageName</span><span class="p">)</span>
<span class="n">stringTypeName</span> <span class="o">=</span> <span class="n">implTemplate</span> <span class="o">%</span> <span class="s1">&#39;String&#39;</span>

<span class="n">ignoreTags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accessedPackages&#39;</span><span class="p">,</span> <span class="s1">&#39;codeStubs&#39;</span><span class="p">,</span> <span class="s1">&#39;constructorCodeStubs&#39;</span><span class="p">,</span> <span class="s1">&#39;postConstructorCodeStubs&#39;</span><span class="p">,</span>
              <span class="s1">&#39;destructorCodeStubs&#39;</span><span class="p">,</span>
              <span class="s1">&#39;postDestructorCodeStubs&#39;</span><span class="p">,</span> <span class="s1">&#39;documentation&#39;</span><span class="p">,</span> <span class="s1">&#39;hicard&#39;</span><span class="p">,</span> <span class="s1">&#39;importedPackages&#39;</span><span class="p">,</span>
              <span class="s1">&#39;isAutomatic&#39;</span><span class="p">,</span> <span class="s1">&#39;isOrdered&#39;</span><span class="p">,</span> <span class="s1">&#39;isUnique&#39;</span><span class="p">,</span> <span class="s1">&#39;partitionsChildren&#39;</span><span class="p">,</span> <span class="s1">&#39;subtypes&#39;</span><span class="p">}</span>

<span class="n">nameTags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;baseName&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="LocalXmlGen"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.memops.scripts.xmlio.html#ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen.LocalXmlGen">[docs]</a><span class="k">class</span> <span class="nc">LocalXmlGen</span><span class="p">(</span><span class="n">XmlGen</span><span class="o">.</span><span class="n">XmlGen</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
  
    <span class="bp">self</span><span class="o">.</span><span class="n">addModelFlavour</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">baseName</span> <span class="o">=</span> <span class="s1">&#39;xml&#39;</span>
  
    <span class="k">for</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    
    <span class="nb">super</span><span class="p">(</span><span class="n">LocalXmlGen</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span></div>


<div class="viewcode-block" id="makeUpgrade"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.memops.scripts.xmlio.html#ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen.makeUpgrade">[docs]</a><span class="k">def</span> <span class="nf">makeUpgrade</span><span class="p">(</span><span class="n">fromVersionTag</span><span class="p">,</span> <span class="n">toVersionTag</span><span class="p">,</span> <span class="n">toTopPackage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">modelPortal</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">includePackageNames</span><span class="o">=</span><span class="p">(),</span> <span class="n">excludePackageNames</span><span class="o">=</span><span class="p">(),</span> <span class="n">infoFileName</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Make upgrade or downgrade map code from fromVersion to toVersion</span>
<span class="sd">  Will look for the models in ccpnmodel.versionDir</span>
<span class="sd">  and place the compatibility code in e.g.</span>
<span class="sd">  ccpncore/memops/format/compatibility/upgrade/v_2_0_3/MapInfo.py</span>
<span class="sd">  ccpncore/memops/format/compatibility/downgrade/v_2_2_1/MapInfo.py</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="n">infoFileName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">infoFileName</span> <span class="o">=</span> <span class="n">defaultInfoFile</span>

  <span class="n">fromVersion</span> <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">fromVersionTag</span><span class="p">)</span>
  <span class="n">toVersion</span> <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="n">toVersionTag</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">fromVersion</span> <span class="o">==</span> <span class="n">toVersion</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Trying to make compatibility between identical versions: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">fromVersion</span><span class="p">,</span> <span class="n">toVersion</span><span class="p">))</span>
  
  <span class="k">if</span> <span class="n">toTopPackage</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">toTopPackage</span> <span class="o">=</span> <span class="n">XmlModelIo</span><span class="o">.</span><span class="n">readModel</span><span class="p">(</span><span class="n">versionTag</span><span class="o">=</span><span class="n">toVersionTag</span><span class="p">,</span>
                                       <span class="n">includePackageNames</span><span class="o">=</span><span class="n">includePackageNames</span><span class="p">,</span>
                                       <span class="n">excludePackageNames</span><span class="o">=</span><span class="n">excludePackageNames</span><span class="p">)</span>

  <span class="n">fromTopPackage</span> <span class="o">=</span> <span class="n">XmlModelIo</span><span class="o">.</span><span class="n">readModel</span><span class="p">(</span><span class="n">versionTag</span><span class="o">=</span><span class="n">fromVersion</span><span class="p">,</span>
                                      <span class="n">includePackageNames</span><span class="o">=</span><span class="n">includePackageNames</span><span class="p">,</span>
                                      <span class="n">excludePackageNames</span><span class="o">=</span><span class="n">excludePackageNames</span><span class="p">)</span>

  <span class="c1"># full name for map info file</span>
  <span class="n">mapInfoFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">getPathToImport</span><span class="p">(</span><span class="n">compDataModule</span><span class="p">),</span> <span class="n">fromVersion</span><span class="o">.</span><span class="n">getDirName</span><span class="p">(),</span>
                             <span class="n">infoFileName</span><span class="p">)</span>
  <span class="n">conversionInfo</span> <span class="o">=</span> <span class="n">Conversion</span><span class="o">.</span><span class="n">getConversionInfo</span><span class="p">(</span><span class="n">fromVersion</span><span class="p">,</span> <span class="n">toVersion</span><span class="p">)</span>

  <span class="n">makeCompatibility</span><span class="p">(</span><span class="n">fromTopPackage</span><span class="p">,</span> <span class="n">toTopPackage</span><span class="p">,</span> <span class="n">modelPortal</span><span class="o">=</span><span class="n">modelPortal</span><span class="p">,</span>
                    <span class="n">elementPairings</span><span class="o">=</span><span class="n">conversionInfo</span><span class="p">[</span><span class="s1">&#39;elementPairings&#39;</span><span class="p">],</span>
                    <span class="n">fileName</span><span class="o">=</span><span class="n">mapInfoFile</span><span class="p">)</span></div>

<div class="viewcode-block" id="dirNameFromVersionString"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.memops.scripts.xmlio.html#ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen.dirNameFromVersionString">[docs]</a><span class="k">def</span> <span class="nf">dirNameFromVersionString</span><span class="p">(</span><span class="n">versionString</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; generate directory name from version string</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">versionString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="versionFromDir"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.memops.scripts.xmlio.html#ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen.versionFromDir">[docs]</a><span class="k">def</span> <span class="nf">versionFromDir</span><span class="p">(</span><span class="n">topDir</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Get current version string for directory tree rooted in topDir</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops</span> <span class="kn">import</span> <span class="n">Version</span>
  <span class="n">versionFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topDir</span><span class="p">,</span> <span class="s1">&#39;python/memops/general/Constants.py&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">versionFile</span><span class="p">):</span>
    <span class="n">versionFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">topDir</span><span class="p">,</span> <span class="s1">&#39;python/ccpncore/memops/Version.py&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">versionFile</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;currentModelVersion = &#39;</span><span class="p">):</span>
      <span class="k">exec</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">locals</span><span class="p">(),</span> <span class="nb">globals</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">Version</span><span class="o">.</span><span class="n">currentModelVersion</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span>  <span class="bp">None</span></div>
    
  
<div class="viewcode-block" id="makeCompatibility"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.memops.scripts.xmlio.html#ccpnmodel.ccpncore.memops.scripts.xmlio.CompatibilityGen.makeCompatibility">[docs]</a><span class="k">def</span> <span class="nf">makeCompatibility</span><span class="p">(</span><span class="n">fromModel</span><span class="p">,</span> <span class="n">toModel</span><span class="p">,</span> <span class="n">modelPortal</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">elementPairings</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;CompatibilityMapInfo.py&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Make compatibility info for converting fromModel to toModel.</span>
<span class="sd">  elementPairings is a list of (oldGuid, newGuid) pairs that</span>
<span class="sd">  map elements from the two models. Note that several old guids</span>
<span class="sd">  can map to a single new guid and vice versa.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ccpn.util.Logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
    <span class="n">loggerfunc</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">loggerfunc</span> <span class="o">=</span> <span class="k">print</span>
  
  <span class="n">comparison</span> <span class="o">=</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">compareModels</span><span class="p">(</span><span class="n">fromModel</span><span class="p">,</span> <span class="n">toModel</span><span class="p">,</span>
                                       <span class="n">elementPairings</span><span class="o">=</span><span class="n">elementPairings</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">modelPortal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">modelPortal</span> <span class="o">=</span> <span class="n">ModelPortal</span><span class="p">(</span><span class="n">toModel</span><span class="p">)</span>
    <span class="n">PyFileModelAdapt</span><span class="o">.</span><span class="n">processModel</span><span class="p">(</span><span class="n">modelPortal</span><span class="p">)</span>
  <span class="n">xmlGen</span> <span class="o">=</span> <span class="n">LocalXmlGen</span><span class="p">(</span><span class="n">modelPortal</span><span class="o">=</span><span class="n">modelPortal</span><span class="p">)</span>
  <span class="n">xmlGen</span><span class="o">.</span><span class="n">processModel</span><span class="p">()</span>
  <span class="n">globalMapping</span> <span class="o">=</span> <span class="n">xmlGen</span><span class="o">.</span><span class="n">globalMap</span>

  <span class="n">dirName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirName</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
  
  <span class="n">dict1</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;dict1&#39;</span><span class="p">]</span>
  <span class="n">dict2</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;dict2&#39;</span><span class="p">]</span>
  <span class="c1"># write elements to skip or delay</span>
  <span class="n">skips</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">elems</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;unique1&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
    <span class="c1"># elements unique in old model</span>
    <span class="k">if</span> <span class="n">ee</span><span class="o">.</span><span class="n">container</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">AbstractDataType</span><span class="p">):</span>
        <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ee</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span>
                      <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaPackage</span><span class="p">):</span>
        <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ee</span><span class="o">.</span><span class="n">shortName</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        
      <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaOperation</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaConstraint</span><span class="p">)):</span>
        <span class="c1"># nothing to do here</span>
        <span class="k">continue</span>
      
      <span class="c1">#NBNB elif ee.isDerived and ee.changeability == ImpConstants.frozen:</span>
      <span class="k">elif</span> <span class="n">ee</span><span class="o">.</span><span class="n">isDerived</span><span class="p">:</span>
        <span class="c1"># derived class element. Ignore</span>
        <span class="k">continue</span>
      
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaRole</span><span class="p">):</span>
        <span class="c1"># ee is a missing role of a still existing ComplexDataType</span>
        
        <span class="n">vt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">valueType</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">container</span>
        <span class="k">if</span> <span class="n">vt</span><span class="o">.</span><span class="n">container</span> <span class="ow">in</span> <span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">accessedPackages</span><span class="p">:</span>
          <span class="c1"># interpackage link in wrong direction. Not in maps. Must be skipped</span>
          <span class="c1"># Should not matter, but skip rather than ignore in case of model changes.</span>
          <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> 
                        <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
 
        <span class="k">elif</span> <span class="n">ee</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">!=</span> <span class="n">metaConstants</span><span class="o">.</span><span class="n">no_hierarchy</span><span class="p">:</span>
          <span class="c1"># parent or child link. Delay is not defined - must be skipped</span>
          <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> 
                        <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
 
        <span class="k">elif</span> <span class="n">vt</span><span class="o">.</span><span class="n">guid</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;dict2&#39;</span><span class="p">]:</span>
          <span class="c1"># The valueType also still exists</span>
                         
          <span class="n">dd</span> <span class="o">=</span> <span class="n">XmlGen</span><span class="o">.</span><span class="n">getRoleMap</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">globalMapping</span><span class="p">)</span>
          <span class="n">elemMap</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">loggerfunc</span> <span class="p">(</span><span class="s1">&#39;WARNING, no map found for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ee</span><span class="p">)</span>
            
          <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;eType&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
              <span class="n">xx</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elemMap</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span>
 
            <span class="k">if</span> <span class="n">elemMap</span><span class="p">:</span>
              <span class="c1"># put as delay</span>
              <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span>
                             <span class="n">elemMap</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="c1"># cannot create map, skip</span>
              <span class="n">loggerfunc</span> <span class="p">(</span><span class="s1">&#39;WARNING, incomplete map found for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ee</span><span class="p">)</span>
              <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> 
                            <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
 
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># ee valueType does not exist. Skip.</span>
          <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
           <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
          <span class="p">)</span>
 
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaAttribute</span><span class="p">):</span>
        
        <span class="n">cc</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">container</span>
 
        <span class="n">vt</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">valueType</span>
        <span class="n">superVts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vt</span><span class="o">.</span><span class="n">getAllSupertypes</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">guid</span> <span class="ow">in</span> <span class="n">dict2</span><span class="p">]</span>
        <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="n">superVts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">guid</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">guid</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;dict2&#39;</span><span class="p">]</span> 
            <span class="ow">or</span> <span class="n">vt</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;MetaDataType&#39;</span> <span class="ow">and</span> <span class="n">superVts</span><span class="p">):</span>
 
          <span class="n">dd</span> <span class="o">=</span> <span class="n">XmlGen</span><span class="o">.</span><span class="n">getAttrMap</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">globalMapping</span><span class="p">,</span> 
                                 <span class="n">valueTypeGuid</span><span class="o">=</span><span class="n">valueTypeGuid</span><span class="p">)</span>
          <span class="n">elemMap</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;eType&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
              <span class="n">xx</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elemMap</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span>
        
          <span class="k">if</span> <span class="n">elemMap</span><span class="p">:</span>
            <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span>
                           <span class="n">elemMap</span><span class="p">,</span> <span class="n">valueTypeGuid</span><span class="p">))</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">loggerfunc</span> <span class="p">(</span><span class="s1">&#39;WARNING, no map found for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ee</span><span class="p">)</span>
            <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
  
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># ee valueType does not exist and can not be substituted. Skip.</span>
          <span class="n">skips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

  <span class="n">skips</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Packages, classElements and AbstractDataTypes skipped in new model</span>
<span class="s1"># (prefix, typeName, elemName, newGuid, elemType)</span>
<span class="s1">skipElements = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">skips</span><span class="p">:</span> 
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">),))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      
  <span class="n">delays</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># classElements skipped in new model, but available for simple data transfer</span>
<span class="s1"># (prefix, typeName, elemName, newGuid, elemMap, valueTypeGuid)</span>
<span class="s1">delayElements = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">delays</span><span class="p">:</span> 
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  
  <span class="c1"># write new elements</span>
  <span class="n">mandatory</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">optional</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">elems</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;unique2&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
  
    <span class="c1">#if ee.container not in elems:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaConstraint</span><span class="p">):</span>
      <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ee</span><span class="o">.</span><span class="n">qualifiedName</span><span class="p">(),</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">))</span>
      
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">ClassElement</span><span class="p">):</span>
    
      <span class="c1">#NBNB if not (ee.isDerived and ee.changeability == ImpConstants.frozen):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">ee</span><span class="o">.</span><span class="n">isDerived</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">container</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">locard</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span>
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ee</span><span class="o">.</span><span class="n">defaultValue</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">ee</span><span class="o">.</span><span class="n">isImplementation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ee</span><span class="o">.</span><span class="n">isDerived</span><span class="p">):</span>
          <span class="n">mandatory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">optional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">AbstractDataType</span><span class="p">):</span>
      <span class="n">optional</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ee</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">))</span>
      
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaPackage</span><span class="p">):</span>
      <span class="n">optional</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ee</span><span class="o">.</span><span class="n">shortName</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">guid</span><span class="p">))</span>

  <span class="n">mandatory</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">optional</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">constraints</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># MetaConstraints added in new model</span>
<span class="s1"># (qualifiedName, guid)</span>
<span class="s1">newConstraints = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span> 
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Mandatory classElements added in new model</span>
<span class="s1"># New ClassElements with locard !=0, no default, not derived or Implementation</span>
<span class="s1"># (prefix, typeName, elemName, newGuid)</span>
<span class="s1">newMandatories = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">mandatory</span><span class="p">:</span> 
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Packages, classElements and AbstractDataTypes added in new model</span>
<span class="s1"># Optional, i.e. excluding mandatory classElements given above</span>
<span class="s1"># (prefix, typeName, elemName, newGuid)</span>
<span class="s1">newElements = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">optional</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">),))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
  <span class="c1"># </span>
  <span class="n">typeChanges</span> <span class="o">=</span> <span class="p">[]</span> 
  <span class="n">allDiffs</span> <span class="o">=</span> <span class="p">[]</span>
  
  <span class="n">neutraliseElements</span> <span class="o">=</span> <span class="p">[]</span>
  
  <span class="n">renames</span> <span class="o">=</span> <span class="p">{}</span>
  
  <span class="k">for</span> <span class="n">oldGuid</span><span class="p">,</span> <span class="n">newGuid</span><span class="p">,</span> <span class="n">diffs</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;differ&#39;</span><span class="p">]:</span>
    
    <span class="n">usediffs</span> <span class="o">=</span> <span class="n">diffs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ignoreTags</span><span class="p">)</span>
        
    <span class="n">oldobj</span> <span class="o">=</span> <span class="n">dict1</span><span class="p">[</span><span class="n">oldGuid</span><span class="p">]</span>
    <span class="n">newobj</span> <span class="o">=</span> <span class="n">dict2</span><span class="p">[</span><span class="n">newGuid</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaPackage</span><span class="p">):</span>
      <span class="k">if</span> <span class="s1">&#39;shortName&#39;</span> <span class="ow">in</span> <span class="n">usediffs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MemopsError</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Change in shortName not implemented&quot;</span>
                           <span class="o">%</span> <span class="n">newobj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">ClassElement</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">AbstractDataType</span><span class="p">)):</span>
    
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">ClassElement</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newobj</span><span class="o">.</span><span class="n">isDerived</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">oldobj</span><span class="o">.</span><span class="n">isDerived</span> <span class="ow">or</span> <span class="n">newobj</span><span class="o">.</span><span class="n">changeability</span> <span class="o">==</span> <span class="n">metaConstants</span><span class="o">.</span><span class="n">frozen</span><span class="p">)):</span>
          <span class="c1"># derived non-settable element, or both sides derived. Ignore</span>
          <span class="k">continue</span> 
        
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">oldobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaRole</span><span class="p">)</span> <span class="ow">and</span> 
          <span class="n">oldobj</span><span class="o">.</span><span class="n">valueType</span><span class="o">.</span><span class="n">container</span> <span class="ow">in</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">accessedPackages</span><span class="p">):</span>
          <span class="c1"># interpackage link in wrong direction. Not in maps. Must be skipped</span>
          <span class="k">continue</span>
        
        <span class="k">elif</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">isDerived</span><span class="p">:</span>
          <span class="c1"># newObj cannot be derived at this point.</span>
          <span class="c1"># We cannot use old derived elements, as the derivation function may</span>
          <span class="c1"># no longer work by the time it is called</span>
          <span class="n">cc</span> <span class="o">=</span> <span class="n">newobj</span><span class="o">.</span><span class="n">container</span>
          <span class="n">neutraliseElements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span>  <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
                                     <span class="n">newobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">newobj</span><span class="o">.</span><span class="n">guid</span><span class="p">))</span>
          <span class="k">continue</span>
          
      <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">usediffs</span><span class="p">:</span>
        <span class="n">usediffs</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">nameTags</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaRole</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">newobj</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">metaConstants</span><span class="o">.</span><span class="n">parent_hierarchy</span><span class="p">):</span>
          <span class="c1"># ignore parent role renamings, handle everything else   </span>
             
          <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">ClassElement</span><span class="p">):</span>
            <span class="c1"># rename if not a parent role</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">container</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">renames</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">newGuid</span><span class="p">)</span>
          
          <span class="k">else</span><span class="p">:</span>
            <span class="c1"># isinstance(newobj, MetaModel.AbstractDataType)</span>
            <span class="n">shortName</span> <span class="o">=</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span>
            <span class="n">oldobjName</span> <span class="o">=</span>  <span class="n">oldobj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">shortName</span><span class="p">,</span> <span class="n">oldobjName</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">renames</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">newGuid</span><span class="p">)</span>
            
            <span class="c1"># add renames for oldobj classElements - their XML tags will change</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldobj</span><span class="p">,</span><span class="n">MetaModel</span><span class="o">.</span><span class="n">ComplexDataType</span><span class="p">):</span>
              <span class="n">accessedPackages</span> <span class="o">=</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">accessedPackages</span>
              <span class="n">ll</span> <span class="o">=</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">attributes</span>
              <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldobj</span><span class="p">,</span><span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaClass</span><span class="p">):</span>
                <span class="n">ll</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">roles</span>
                          <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">valueType</span><span class="o">.</span><span class="n">container</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accessedPackages</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">isDerived</span><span class="p">:</span>
                  <span class="k">continue</span>
                <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">isImplementation</span><span class="p">:</span>
                  <span class="k">continue</span>
                <span class="n">newElem</span> <span class="o">=</span> <span class="n">newobj</span><span class="o">.</span><span class="n">getElement</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newElem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">guid</span> <span class="o">==</span> <span class="n">newElem</span><span class="o">.</span><span class="n">guid</span><span class="p">:</span>
                  <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">shortName</span><span class="p">,</span> <span class="n">oldobjName</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">tt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
                    <span class="n">renames</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">guid</span><span class="p">)</span>
            
                            
      <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">ClassElement</span><span class="p">)</span> 
          <span class="ow">and</span> <span class="s1">&#39;valueType&#39;</span> <span class="ow">in</span> <span class="n">usediffs</span><span class="p">):</span>
        <span class="c1"># change of valueType</span>
        
        <span class="n">newvt</span> <span class="o">=</span> <span class="n">newobj</span><span class="o">.</span><span class="n">valueType</span>
        <span class="n">oldvt</span> <span class="o">=</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">valueType</span>
        
        <span class="k">if</span> <span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oldvt</span><span class="o">.</span><span class="n">getAllSupertypes</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">guid</span> <span class="o">==</span> <span class="n">newvt</span><span class="o">.</span><span class="n">guid</span><span class="p">]):</span>
            <span class="c1"># and oldvt.guid in globalMapping[&#39;mapsByGuid&#39;]):</span>
          <span class="c1"># relaxation: change from subtype to supertype - always OK</span>
          <span class="c1"># NB standard treatment only works if the old type is still present in the new map</span>
          <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span>
          <span class="k">if</span> <span class="n">oldvt</span><span class="o">.</span><span class="n">guid</span> <span class="ow">in</span> <span class="n">globalMapping</span><span class="p">[</span><span class="s1">&#39;mapsByGuid&#39;</span><span class="p">]:</span>
            <span class="c1"># old valueType is still around and can be used</span>
            <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="c1"># oldvt no longer around - switch to new vt</span>
            <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="n">newvt</span><span class="o">.</span><span class="n">guid</span>
          
        <span class="k">elif</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">newvt</span><span class="o">.</span><span class="n">getAllSupertypes</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">guid</span> <span class="o">==</span> <span class="n">oldvt</span><span class="o">.</span><span class="n">guid</span><span class="p">]:</span>
          <span class="c1"># restriction - change from supertype to subtype - delay</span>
          <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;delay&#39;</span>
          <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaAttribute</span><span class="p">):</span>
            <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="n">oldvt</span><span class="o">.</span><span class="n">guid</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="bp">None</span>
          
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldvt</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaDataType</span><span class="p">):</span>
          <span class="c1"># </span>
          
          <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;delay&#39;</span>
          <span class="n">oldTypecode</span> <span class="o">=</span> <span class="n">oldvt</span><span class="o">.</span><span class="n">typeCodes</span><span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">]</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">useBaseType</span> <span class="o">=</span> <span class="n">newobj</span><span class="o">.</span><span class="n">metaObjFromQualName</span><span class="p">(</span><span class="n">implTemplate</span> <span class="o">%</span> <span class="n">oldTypecode</span><span class="p">)</span>
          <span class="k">except</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MemopsError</span><span class="p">:</span>
            <span class="n">useBaseType</span> <span class="o">=</span> <span class="n">newobj</span><span class="o">.</span><span class="n">metaObjFromQualName</span><span class="p">(</span><span class="n">stringTypeName</span><span class="p">)</span>
          <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="n">useBaseType</span><span class="o">.</span><span class="n">guid</span>
                  
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">oldobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaRole</span><span class="p">)</span> <span class="ow">and</span> 
              <span class="n">oldobj</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">container</span> <span class="ow">is</span> <span class="n">oldvt</span><span class="o">.</span><span class="n">container</span><span class="p">):</span>
          <span class="c1"># incompatible intrapackage crosslink - delay</span>
          <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;delay&#39;</span>
          <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># incompatible ComplexDataType or exolink - nothing doing</span>
          <span class="c1">#action = &#39;skip&#39;</span>
          <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;delay&#39;</span>
          <span class="n">valueTypeGuid</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="n">cc</span> <span class="o">=</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">container</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">MetaRole</span><span class="p">):</span>
          <span class="n">dd</span> <span class="o">=</span> <span class="n">XmlGen</span><span class="o">.</span><span class="n">getRoleMap</span><span class="p">(</span><span class="n">oldobj</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">globalMapping</span><span class="p">)</span>
          <span class="n">elemMap</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;eType&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
              <span class="n">xx</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elemMap</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span>
 
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># isinstance(newobj, MetaModel.MetaAttribute)</span>
          <span class="n">dd</span> <span class="o">=</span> <span class="n">XmlGen</span><span class="o">.</span><span class="n">getAttrMap</span><span class="p">(</span><span class="n">oldobj</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">globalMapping</span><span class="p">,</span> 
                                 <span class="n">valueTypeGuid</span><span class="o">=</span><span class="n">valueTypeGuid</span><span class="p">)</span>
          <span class="n">elemMap</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;eType&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">):</span>
              <span class="n">xx</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elemMap</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span>
 
        <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">oldobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> 
              <span class="n">newobj</span><span class="o">.</span><span class="n">guid</span><span class="p">,</span> <span class="n">elemMap</span><span class="p">,</span> <span class="n">valueTypeGuid</span><span class="p">)</span>
        
        <span class="n">typeChanges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usediffs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">usediffs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;valueType&#39;</span><span class="p">)</span>
        
      <span class="k">if</span> <span class="n">usediffs</span><span class="p">:</span>
        <span class="n">allDiffs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">oldobj</span><span class="o">.</span><span class="n">qualifiedName</span><span class="p">(),</span> <span class="n">newobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">oldGuid</span><span class="p">,</span> <span class="n">newGuid</span><span class="p">,</span>
                         <span class="n">diffs</span><span class="p">))</span>
  
  <span class="n">neutraliseElements</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">allDiffs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">typeChanges</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="n">namematch</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;namematch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
  <span class="n">namematch</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  
        
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Class elements that exist in both models but that require handcode for</span>
<span class="s1"># transfer. E.g. elements that go from derived to non-derived.</span>
<span class="s1"># Note that old derivation functions can not be relied on to work during</span>
<span class="s1"># data transfer</span>
<span class="s1"># (prefix, typeName, elemName, newGuid, elemType)</span>
<span class="s1">neutraliseElements = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">neutraliseElements</span><span class="p">:</span> 
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Differences between equivalent classElements and AbstractDataTypes :</span>

<span class="s1"># name changes</span>
<span class="s1"># (prefix, typeName, elemName, newName, newGuid</span>
<span class="s1">renames = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

  <span class="c1"># NBNB kludge around the impossibility of sorting strings with None</span>
  <span class="k">for</span> <span class="n">tt1</span><span class="p">,</span> <span class="n">tt2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">renames</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tt1</span><span class="o">+</span><span class="n">tt2</span><span class="p">),))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># ValueType changes</span>
<span class="s1"># change types are : &#39;ignore&#39;: do nothing, &#39;delay&#39;: available for calculation</span>
<span class="s1"># (prefix, typeName, elemName, action, newGuid, elemMap, valueTypeGuid)</span>
<span class="s1">typeChanges = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">typeChanges</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Different elements with matching qualifiedNames</span>
<span class="s1"># (element.qName, differentTags, oldGuid, newGuid</span>
<span class="s1">nameMatches = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">namematch</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Differences for matching elements, </span>
<span class="s1"># excluding those where only names and/or valueTypes differ</span>
<span class="s1"># (oldElem.qName, newElem.name, oldGuid, newGuid, differentTags</span>
<span class="s1">allDiffs = [</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">allDiffs</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  
  <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
           
  
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>